<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Tech1 | Chalnl&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="AcWing Django æ¡†æ¶è¯¾ Django é¡¹ç›®åˆ›å»º å¯åŠ¨åˆå§‹é¡¹ç›® django-admin startproject acappï¼šåœ¨å½“å‰ç›®å½•ä¸‹åˆ›å»ºåä¸ºacappçš„djangoé¡¹ç›® python3 manage.py runserver 0.0.0.0:8000 ï¼šå¯åŠ¨é¡¹ç›® æ‰“å¼€settings.pyï¼Œæ‰¾åˆ°ALLOWED_HOSTS=[]ï¼Œä¿®æ”¹æˆALLOWED_HOSTS=[&quot;è‡ªå·±çš„æœåŠ¡å™¨çš„å…¬ç½‘IP&quot;] é€šè¿‡è‡ªå·±çš„æœåŠ¡å™¨">
<meta name="author" content="Sulv">
<link rel="canonical" href="https://Hugo-Chalnl.github.io/en/posts/tech/tech1/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.js" onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://Hugo-Chalnl.github.io/img/Q.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://Hugo-Chalnl.github.io/img/Q.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://Hugo-Chalnl.github.io/img/Q.gif">
<link rel="apple-touch-icon" href="https://Hugo-Chalnl.github.io/img/Q.gif">
<link rel="mask-icon" href="https://Hugo-Chalnl.github.io/img/Q.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script defer src="https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js"></script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<meta property="og:title" content="Tech1" />
<meta property="og:description" content="AcWing Django æ¡†æ¶è¯¾ Django é¡¹ç›®åˆ›å»º å¯åŠ¨åˆå§‹é¡¹ç›® django-admin startproject acappï¼šåœ¨å½“å‰ç›®å½•ä¸‹åˆ›å»ºåä¸ºacappçš„djangoé¡¹ç›® python3 manage.py runserver 0.0.0.0:8000 ï¼šå¯åŠ¨é¡¹ç›® æ‰“å¼€settings.pyï¼Œæ‰¾åˆ°ALLOWED_HOSTS=[]ï¼Œä¿®æ”¹æˆALLOWED_HOSTS=[&quot;è‡ªå·±çš„æœåŠ¡å™¨çš„å…¬ç½‘IP&quot;] é€šè¿‡è‡ªå·±çš„æœåŠ¡å™¨" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://Hugo-Chalnl.github.io/en/posts/tech/tech1/" />
<meta property="og:image" content="https://Hugo-Chalnl.github.io/posts/tech/tech1/1.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-21T12:20:21+08:00" />
<meta property="article:modified_time" content="2023-02-21T12:20:21+08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://Hugo-Chalnl.github.io/posts/tech/tech1/1.png" />
<meta name="twitter:title" content="Tech1"/>
<meta name="twitter:description" content="AcWing Django æ¡†æ¶è¯¾ Django é¡¹ç›®åˆ›å»º å¯åŠ¨åˆå§‹é¡¹ç›® django-admin startproject acappï¼šåœ¨å½“å‰ç›®å½•ä¸‹åˆ›å»ºåä¸ºacappçš„djangoé¡¹ç›® python3 manage.py runserver 0.0.0.0:8000 ï¼šå¯åŠ¨é¡¹ç›® æ‰“å¼€settings.pyï¼Œæ‰¾åˆ°ALLOWED_HOSTS=[]ï¼Œä¿®æ”¹æˆALLOWED_HOSTS=[&quot;è‡ªå·±çš„æœåŠ¡å™¨çš„å…¬ç½‘IP&quot;] é€šè¿‡è‡ªå·±çš„æœåŠ¡å™¨"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [

        {
          "@type": "ListItem",
          "position":  1 ,
          "name": "ğŸ“šæ–‡ç« ",
          "item": "https://Hugo-Chalnl.github.io/en/posts/"
        },

        {
          "@type": "ListItem",
          "position":  2 ,
          "name": "ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯",
          "item": "https://Hugo-Chalnl.github.io/en/posts/tech/"
        }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Tech1",
      "item": "https://Hugo-Chalnl.github.io/en/posts/tech/tech1/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Tech1",
  "name": "Tech1",
  "description": "AcWing Django æ¡†æ¶è¯¾ Django é¡¹ç›®åˆ›å»º å¯åŠ¨åˆå§‹é¡¹ç›® django-admin startproject acappï¼šåœ¨å½“å‰ç›®å½•ä¸‹åˆ›å»ºåä¸ºacappçš„djangoé¡¹ç›® python3 manage.py runserver 0.0.0.0:8000 ï¼šå¯åŠ¨é¡¹ç›® æ‰“å¼€settings.pyï¼Œæ‰¾åˆ°ALLOWED_HOSTS=[]ï¼Œä¿®æ”¹æˆALLOWED_HOSTS=[\u0026quot;è‡ªå·±çš„æœåŠ¡å™¨çš„å…¬ç½‘IP\u0026quot;] é€šè¿‡è‡ªå·±çš„æœåŠ¡å™¨",
  "keywords": [
    ""
  ],
  "articleBody": "AcWing Django æ¡†æ¶è¯¾ Django é¡¹ç›®åˆ›å»º å¯åŠ¨åˆå§‹é¡¹ç›® django-admin startproject acappï¼šåœ¨å½“å‰ç›®å½•ä¸‹åˆ›å»ºåä¸ºacappçš„djangoé¡¹ç›®\npython3 manage.py runserver 0.0.0.0:8000 ï¼šå¯åŠ¨é¡¹ç›®\næ‰“å¼€settings.pyï¼Œæ‰¾åˆ°ALLOWED_HOSTS=[]ï¼Œä¿®æ”¹æˆALLOWED_HOSTS=[\"è‡ªå·±çš„æœåŠ¡å™¨çš„å…¬ç½‘IP\"] é€šè¿‡è‡ªå·±çš„æœåŠ¡å™¨å…¬ç½‘IP:8000 æ‰“å¼€Djangoé¡µé¢ åˆ›å»ºç®¡ç†å‘˜ç™»å½•é¡µé¢ åœ¨ä¸€çº§acappæ–‡ä»¶å¤¹ä¸‹ï¼Œpython3 manage.py startapp XXXï¼ŒXXXæ˜¯å¯ä»¥è‡ªå®šä¹‰çš„appåï¼Œè¿™é‡Œç”¨gameç¤ºä¾‹ï¼Œè¿™æ—¶å€™ä¼šå¤šä¸€ä¸ªæ–‡ä»¶å¤¹gameï¼Œæ ‘å½¢ç»“æ„å¦‚å›¾ï¼š |-- game | |-- __init__.py | |-- admin.py # ç®¡ç†å‘˜é¡µé¢ | |-- apps.py # ç”¨çš„ä¸å¤š | |-- migrations # å­˜å‚¨æ•°æ®åº“ | | `-- __init__.py | |-- models.py # å®šä¹‰ç½‘ç«™é‡Œçš„æ•°æ®åº“è¡¨ | |-- tests.py | `-- views.py # è§†å›¾ï¼Œå³å‡½æ•° python3 manage.py migrateï¼šå°†æ‰€æœ‰ä¿®æ”¹æ›´æ–°è¿›æ•°æ®åº“ åˆ›å»ºä¸€ä¸ª ç®¡ç†å‘˜ç”¨æˆ·ï¼š $ python3 manage.py createsuperuser \u003e Username (leave blank to use 'acs'): admin \u003e Email address: \u003e Password: 123456 \u003e Password (again): 123456 \u003e Superuser created successfully. ç„¶ååˆ©ç”¨è¯¥ ç®¡ç†å‘˜ç”¨æˆ· ç™»å½• admin é¡µé¢ï¼Œå³å¯æˆåŠŸç™»é™†\nåˆ›å»ºç”¨æˆ·ç™»å½•é¡µé¢ game ä¸‹çš„å„ä¸ªæ–‡ä»¶ä½œç”¨ templatesç›®å½•ï¼šç®¡ç† html æ–‡ä»¶ urlsç›®å½•ï¼šç®¡ç†è·¯ç”±ï¼Œå³é“¾æ¥ä¸å‡½æ•°çš„å¯¹åº”å…³ç³» (æ¥æ”¶é“¾æ¥ï¼Œè°ƒç”¨ç›¸å¯¹åº”çš„å‡½æ•°) viewsç›®å½•ï¼šç®¡ç† http å‡½æ•°ï¼ˆæ¥æ”¶æµè§ˆå™¨è¯·æ±‚ï¼Œè¿”å›å­—ç¬¦ä¸²è‡³æµè§ˆå™¨ï¼‰ modelsç›®å½•ï¼šç®¡ç†æ•°æ®åº“æ•°æ® staticç›®å½•ï¼šç®¡ç†é™æ€æ–‡ä»¶ consumersç›®å½•ï¼šç®¡ç†websocketå‡½æ•° å®ç°ä¸€ä¸ªè·¯ç”±é‡å®šå‘ url è¾“å…¥ç½‘å€ -\u003e acapp.urls -\u003e game.urls -\u003e game.views.index -\u003e å±•ç¤ºé¡µé¢ game.views\nè¿™å…¶ä¸­ï¼ŒHttpResponse()å†…éƒ¨ä½¿ç”¨htmlçš„è¯­æ³•ï¼Œè¿”å›çš„å“åº”å°±ç›´æ¥ç”¨è¿™ä¸ªå­—ç¬¦ä¸²ä½œä¸ºé¡µé¢ï¼Œè½¬æ¢æˆhtml\nfrom django.http import HttpResponse def index(request): line1 = ' ç¬¬ä¸€ä¸ªç½‘é¡µ ' return HttpResponse(line1) game.urls\nè¿™å…¶ä¸­ï¼Œpath('PATH', function, name)çš„å«ä¹‰æ˜¯ï¼Œåœ¨ç”¨æˆ·è®¿é—®ç½‘ç«™çš„æ—¶å€™ï¼Œå¦‚æœæ˜¯ç½‘ç«™/game/PATHï¼Œå°±ä¼šè°ƒç”¨functionï¼Œåå­—ä¸ºnameï¼Œè¿™æ˜¯åœ¨/game/ç›®å½•ä¸‹çš„è°ƒç”¨ï¼Œæ‰€ä»¥è¿™ä¸ªPATHæ˜¯åœ¨/game/çš„åŸºç¡€ä¸Šçš„ç›¸å¯¹è·¯å¾„ï¼Œæ‰€ä»¥ä»–çš„ç»å¯¹è·¯å¾„æ˜¯ç½‘ç«™/game/PATH\nfrom django.urls import path from game.views import index urlpatterns = [ path(\"\", index, name=\"index\"), ] acapp.urls\nè¿™å…¶ä¸­ï¼Œpath('PATH', include('game.urls'))çš„å«ä¹‰æ˜¯ï¼šåœ¨ç”¨æˆ·è®¿é—®ç½‘ç«™çš„æ—¶å€™ï¼Œå¦‚æœæ˜¯ç½‘ç«™/PATHï¼Œå°±ä¼šèµ°åˆ°/game/urlsï¼Œå¹¶æ ¹æ®/game/urls.pyæ¥è·‘è·¯ç”±ï¼Œå°±æ˜¯è¯´ï¼Œç”¨æˆ·åœ¨è®¿é—®ç½‘ç«™/çš„æ—¶å€™ï¼Œç”±äºæ­¤æ—¶è°ƒç”¨çš„å‡½æ•°æ˜¯include('game.urls')ï¼Œæ‰€ä»¥è®¿é—®ç½‘ç«™/ç›¸å½“äºæ ¹æ®game/urlsè®¿é—®\nfrom django.contrib import admin from django.urls import path, include urlpatterns = [ path('', include('game.urls')), path('admin/', admin.site.urls), ] ç„¶åç›´æ¥æ‰“å¼€ ip:socket å¯ä»¥ç›´æ¥æ˜¾ç¤º index è¿”å›çš„ç½‘é¡µ\nåˆ›å»ºèœå•ç•Œé¢ 3. åˆ›å»ºèœå•ç•Œé¢ | è®²ä¹‰ 3.1 ä¸Šè¯¾ç¬”è®° | å¤§å®¶å¥½ä»Šå¤©æ˜¯ 3.1 ä¸Šè¯¾ç¬”è®° | æ  æ„å»ºé¡¹ç›®æ¡†æ¶ é¡¹ç›®ç³»ç»Ÿè®¾è®¡ menuï¼šèœå•é¡µé¢ playgroundï¼šæ¸¸æˆç•Œé¢ settingsï¼šè®¾ç½®ç•Œé¢ é¡¹ç›®æ–‡ä»¶ç»“æ„ . |-- README.md |-- acapp | |-- __init__.py # æ–‡ä»¶å¤¹åœ¨åŠ ä¸Š __init__.py æ–‡ä»¶åï¼Œpython ä¾¿å¯ä»¥é€šè¿‡ import æ¥å¼•ç”¨è¯¥æ–‡ä»¶å¤¹ | |-- asgi.py | |-- settings.py | |-- urls.py | `-- wsgi.py |-- db.sqlite3 |-- game | |-- __init__.py | |-- admin.py | |-- apps.py | |-- migrations | | `-- __init__.py | |-- models | | `-- __init__.py | |-- static | | |-- css | | | `-- game.css # ä¸€èˆ¬ä¸€ä¸ªå·¥ç¨‹ï¼Œåªæœ‰ä¸€ä¸ª css æ–‡ä»¶å°±è¶³å¤Ÿäº† | | |-- image | | | `-- menu | | | `-- background.gif | | `-- js | | |-- dist | | | `-- game.js | | `-- src | | `-- zbase.js # æ€»çš„ js æ–‡ä»¶ï¼Œå‘½åä»¥ z å¼€å¤´ä¼šè‡ªåŠ¨åœ¨å­—å…¸åºæœ€å | |-- templates | | `-- multiends | | `-- web.html | |-- tests.py | |-- urls | | |-- __init__.py | | |-- index.py | | |-- menu | | | |-- __init__.py | | | `-- index.py | | |-- playground | | | |-- __init__.py | | | `-- index.py | | `-- settings | | |-- __init__.py | | `-- index.py | `-- views | |-- __init__.py | |-- index.py | |-- menu | | `-- __init__.py | |-- playground | | `-- __init__.py | `-- settings | `-- __init__.py |-- manage.py `-- scripts `-- compress_game_js.sh js æ–‡ä»¶ç®¡ç† ä¸€èˆ¬ä¸€ä¸ªå·¥ç¨‹ä¼šæœ‰å¾ˆå¤šä¸ª .js æºæ–‡ä»¶ï¼Œä¸ºäº†åŠ å¿«ç½‘ç»œçš„ä¼ è¾“ï¼Œä¹Ÿä¸ºäº†æ¯æ¬¡å†™æ–°çš„ .js æ–‡ä»¶ä¸ç”¨æ¯ä¸ª html éƒ½é¢å¤–å¼•å…¥ä¸€æ¬¡\nè€ƒè™‘ç”¨ä¸€ä¸ª src æºæ–‡ä»¶å¤¹æ¥å­˜å‚¨æ‰€æœ‰çš„ .js æºæ–‡ä»¶\nç„¶åç”¨ dist æ–‡ä»¶å¤¹æ¥å­˜æ”¾ç”± src ä¸‹æ‰€æœ‰æºæ–‡ä»¶æ•´åˆç”Ÿæˆçš„ä¸€ä¸ªç›®æ ‡ .js æ–‡ä»¶\nè¿™æ ·æ—¢å®ç°äº†å¿«é€Ÿä¼ è¾“çš„å¥½å¤„ï¼Œä¹Ÿæ–¹ä¾¿äº†åç»­ç¼–å†™ html æ–‡ä»¶æ—¶ï¼Œå¼•å…¥ .js çš„ä¾¿åˆ©\nåˆ›å»ºä¸€ä¸ªè„šæœ¬å®ç°ä¸Šè¿° æ•´åˆ çš„åŠŸèƒ½ ~/acapp/scripts/compress_game_js.sh\n#! /bin/bash JS_PATH=/home/acs/acapp/game/static/js/ JS_PATH_DIST=${JS_PATH}dist/ JS_PATH_SRC=${JS_PATH}src/ find $JS_PATH_SRC -type f -name '*.js' | sort | xargs cat \u003e ${JS_PATH_DIST}game.js html æ–‡ä»¶ç®¡ç† åœ¨ templates æ–‡ä»¶å¤¹ä¸‹åˆ›å»º menuã€playgroundã€settingsã€multiends å››ä¸ªæ–‡ä»¶å¤¹ï¼Œç”¨äºå­˜å‚¨ä¸‰ä¸ªæ¨¡å—å’Œç»ˆç«¯çš„ html æ–‡ä»¶\nåœ¨ multiends ä¸‹åˆ›å»º web.html æ–‡ä»¶\n{% load static %} views è§†å›¾ç®¡ç† åœ¨ views æ–‡ä»¶å¤¹ä¸‹æ–°å»ºä¸‰ä¸ªæ¨¡å—çš„è§†å›¾æ–‡ä»¶å¤¹\nå†™ä¸€ä¸ª index.py æ–‡ä»¶ï¼Œç›®çš„æ˜¯åœ¨ web ç«¯è¢«è®¿é—®æ—¶ï¼Œè¿”å›ä¸Šé¢å†™çš„ web.html æ–‡ä»¶\nfrom django.shortcuts import render def index(request): return render(request, \"multiends/web.html\") urls è·¯ç”±ç®¡ç† /-- \"\" -- index / -- \"menu/\" -- menu.index / \"\" --\u003e \"game.url\" --\u003e / \\ -- \"playground/\" -- playground.index id:scoket -\u003e \\-- \"settings/\" -- settings.index \\ \\ \"/admin\" -- åˆ°è¾¾ç®¡ç†å‘˜é¡µé¢ ~/acapp/acapp/urls.py from django.contrib import admin from django.urls import path, include urlpatterns = [ path('', include('game.urls.index')), path('admin/', admin.site.urls), ] ~/acapp/game/urls/index.py from django.urls import path, include from game.views.index import index urlpatterns = [ path(\"\", index, name=\"index\"), path(\"menu/\", include(\"game.urls.menu.index\")), path(\"playground/\", include(\"game.urls.playground.index\")), path(\"settings/\", include(\"game.urls.settings.index\")) ] ç½‘é¡µæ¸²æŸ“æµç¨‹ æ ¹æ®ç”¨æˆ·çš„é“¾æ¥ï¼Œé¦–å…ˆè¿›å…¥acapp/urls.pyï¼Œæ ¹æ®pathå†è¿›å…¥game/urls/index.pyï¼Œå†æ ¹æ®pathè¿›å…¥ä¸‹ä¸€å±‚urlæˆ–è°ƒç”¨ç›¸å¯¹åº”çš„viewsä¸­çš„index.pyå‡½æ•°ï¼Œå‡½æ•°æ¥æ”¶å‚æ•°ï¼Œåœ¨ç½‘é¡µç«¯æ¸²æŸ“templates/multiendsä¸‹çš„web.htmlï¼Œhtmlä¸­æœ‰JSæ‰§è¡Œ\næ³¨æ„ï¼šæœ¬é¡¹ç›®ä¸ºå‰åç«¯åˆ†ç¦»ï¼Œå³é€šè¿‡JSåœ¨clientä¸­æ¸²æŸ“é¡¹ç›®(åŠ¨æ€ç”Ÿæˆé¡µé¢)ï¼Œè€Œä¸æ˜¯åœ¨serveræ¸²æŸ“é¡¹ç›®\nä¿®æ”¹å…¨å±€é…ç½® è®¾ç½®æ—¶åŒº ä¿®æ”¹é¡¹ç›®çš„ UTC æ—¶é—´ä¸º CN æ—¶é—´\n$ vim /acapp/settings.py ****** TIME_ZONE = 'Asia/Shanghai' # åŸæ¥é»˜è®¤æ˜¯ UTC ****** æ·»åŠ é…ç½®æ–‡ä»¶ å°†æ–°åˆ›å»ºçš„ game ä¸‹çš„ apps.py ä¸­çš„ GameConfig åŠ åˆ° settings.py ä¸‹\n$ vim /acapp/settings.py ****** INSTALLED_APPS = [ 'game.apps.GameConfig', ...... ] ****** å£°æ˜å°†é™æ€æ–‡ä»¶è·¯å¾„ STATIC_ROOT å’Œ MEDIA_ROOT\n$ vim /acapp/settings.py ****** import os ...... STATIC_ROOT = os.path.join(BASE_DIR, 'static') STATIC_URL = '/static/' MEDIA_ROOT = os.path.join(BASE_DIR, 'media') MEDIA_URL = '/media/' ****** åˆ›å»ºèœå• menu ç•Œé¢ æ­å»ºèœå• menu ç•Œé¢çš„æ¡†æ¶ æˆ‘ä»¬é‡‡ç”¨çš„ å‰åç«¯åˆ†ç¦»å¼ å¼€å‘ï¼Œæ‰€æœ‰çš„ html æ¸²æŸ“éƒ½è¦æ±‚åœ¨å‰ç«¯å®Œæˆ\nå¼€å‘æµç¨‹å°±æ˜¯ï¼Œå…ˆåœ¨ html é‡Œåˆ›å»ºå¥½ä¸€ä¸ªæœ‰ id çš„ div\nç„¶ååˆ©ç”¨ js æ–‡ä»¶ï¼Œæ•è·åˆ°è¯¥ divï¼Œå¹¶è¿›è¡Œ æ¸²æŸ“\n/templates/multiends/web.html ... ... js/src/zbase.js class AcGame { constructor(id) { this.id = id; this.$ac_game = $('#' + id); this.menu = new AcGameMenu(this); } } js/src/menu/zbase.js class AcGameMenu { constructor(root) { this.root = root; this.$menu = $(` `); this.root.$ac_game.append(this.$menu); } css/game.css .ac-game-menu { width: 100%; height: 100%; background-image: url('/static/image/menu/background.gif'); background-size: 100% 100%; user-select: none; } è¿™é‡Œçš„ ä»£ç é€»è¾‘ å¦‚ä¸‹ï¼š\nhtml é¡µé¢æ‰§è¡Œåˆ° js ä»£ç ï¼Œåˆ©ç”¨ AcGameç±» åˆ›å»ºå¯¹è±¡ ac_game åŒæ—¶ä¼ é€’å‚æ•° div çš„ id AcGame å¼€å§‹æ‰§è¡Œæ„é€ å‡½æ•°ï¼Œåœ¨æ„é€ å‡½æ•°ä¸­ï¼Œæ•è· html æ ‡ç­¾ï¼Œå¹¶åˆ©ç”¨ AcGameMenuç±» åˆ›å»ºå¯¹è±¡ menuï¼Œå¹¶å°†æ•´ä¸ªå¯¹è±¡ä½œä¸ºå‚æ•°ä¸‹ä¼  AcGameMenu å¼€å§‹æ‰§è¡Œæ„é€ å‡½æ•°ï¼Œç„¶ååˆ›å»º html ä»£ç ï¼ŒåŠ åˆ°æ•è·åˆ°çš„ html ä»£ç ä¸‹ æœ€ç»ˆæˆåŠŸæ¸²æŸ“å‡ºèƒŒæ™¯å›¾ç‰‡ è®¾ç½®èœå• menu é¡µé¢çš„å†…å®¹ ä¸»è¦å†…å®¹å°±æ˜¯åœ¨ä¸»é¡µé¢ä¸­ï¼Œæ˜¾ç¤ºï¼šå•äººæ¨¡å¼ã€å¤šäººæ¨¡å¼ã€è®¾ç½®ï¼Œä¸‰ä¸ªæŒ‰é’®çš„é€‰é¡¹ js/src/menu/zbase.js\nclass AcGameMenu { constructor(root) { this.root = root; this.$menu = $(` å•äººæ¨¡å¼ å¤šäººæ¨¡å¼ è®¾ç½® `); this.root.$ac_game.append(this.$menu); this.$single_mode = this.$menu.find('.ac-game-menu-field-item-single-mode'); this.$multi_mode = this.$menu.find('.ac-game-menu-field-item-multi-mode'); this.$settings_mode = this.$menu.find('.ac-game-menu-field-item-settings-mode'); } } css/game.css .ac-game-menu { width: 100%; height: 100%; background-image: url('/static/image/menu/background.gif'); background-size: 100% 100%; user-select: none; } .ac-game-menu-field { width: 20vw; position: relative; top: 40vh; left: 19vh; } .ac-game-menu-field-item { height: 7vh; width: 18vw; color: white; font-size: 6vh; font-style: italic; padding: 2vh; margin: 1vh 0; cursor: pointer; text-align: center; background-color: rgba(39, 21, 28, 0.6); border-radius: 10px; letter-spacing: 0.5vw; } .ac-game-menu-field-item:hover { transform: scale(1.2); transition: 100ms; } æ·»åŠ  â€˜å•äººæ¨¡å¼â€™ ç›‘å¬å‡½æ•° â€”â€” æ‰“å¼€æ¸¸æˆç•Œé¢ åŠŸèƒ½ è¿™é‡Œè¦å®ç°çš„ é€»è¾‘ï¼š\nç‚¹å‡» â€˜å•äººæ¨¡å¼â€™ æŒ‰é’®è§¦å‘ click äº‹ä»¶ï¼Œéšå³è§¦å‘ç›‘å¬å‡½æ•°ï¼Œå¼€å§‹æ‰§è¡Œ å…³é—­ menu é¡µé¢ æ‰“å¼€ playground é¡µé¢ å› æ­¤ï¼Œæˆ‘ä»¬å…ˆç®€æ˜“çš„å®ç°ä¸€ä¸ª playground é¡µé¢ï¼Œæ–¹ä¾¿è°ƒè¯•è¯¥åŠŸèƒ½ js/src/playground/zbase.js\nclass AcGamePlayground { constructor(root) { this.root = root; this.$playground = $(`æ¸¸æˆç•Œé¢`); this.hide(); this.root.$ac_game.append(this.$playground); this.start(); } start() { } show() { //æ‰“å¼€ playground ç•Œé¢ this.$playground.show(); } hide() { //å…³é—­ playground ç•Œé¢ this.$playground.hide(); } } åœ¨å®ç°ç›‘å¬å‡½æ•°åŠŸèƒ½ä¹‹å‰ï¼Œå…ˆåœ¨ /src/zbase.js å³ä¸» js æ–‡ä»¶ä¸‹ï¼Œåˆ©ç”¨ AcGamePlayground ç±»åˆ›å»ºå¥½ playground å¯¹è±¡\nè¿™æ ·æˆ‘ä»¬å°±èƒ½åœ¨å‰ç«¯ï¼Œæ¸²æŸ“å‡ºä¸¤ä¸ªç•Œé¢äº†ï¼Œåˆ†åˆ«æ˜¯ï¼šmenu å’Œ playground\njs/src/zbase.js class AcGame { constructor(id) { this.id = id; this.$ac_game = $('#' + id); this.menu = new AcGameMenu(this); // æŠŠ playground å¯¹è±¡ä¹Ÿå»ºå¥½ï¼Œè¿™æ ·æˆ‘ä»¬å°±åŒæ—¶æœ‰ä¸¤ä¸ªç•Œé¢äº† this.playground = new AcGamePlayground(this); this.start(); } start() { } } ç„¶åï¼Œæˆ‘ä»¬å¼€å§‹å®ç° ac-game-menu-field-item-single-mode æ ‡ç­¾çš„ click äº‹ä»¶çš„ç›‘å¬å‡½æ•°\nå…¶åŠŸèƒ½ä¹‹å‰è®²è¿‡äº†ï¼Œå°±æ˜¯å…³é—­ menu é¡µé¢ï¼Œæ‰“å¼€ playground é¡µé¢\njs/src/menu/zbase.js class AcGameMenu { constructor(root) { this.root = root; this.$menu = $(` å•äººæ¨¡å¼ å¤šäººæ¨¡å¼ è®¾ç½® `); this.root.$ac_game.append(this.$menu); this.$single_mode = this.$menu.find('.ac-game-menu-field-item-single-mode'); this.$multi_mode = this.$menu.find('.ac-game-menu-field-item-multi-mode'); this.$settings_mode = this.$menu.find('.ac-game-menu-field-item-settings-mode'); this.start(); } start() { this.add_listening_events(); } add_listening_events() { let outer = this; this.$single_mode.click(function(){ outer.hide(); // å…³é—­ä¸»é¡µé¢ outer.root.playground.show(); // æ‰“å¼€æ¸¸æˆç•Œé¢ }); } show() { //æ˜¾ç¤ºmenuç•Œé¢ this.$menu.show(); } hide() { //éšè—menuç•Œé¢ this.$menu.hide(); } } åˆ›å»ºæ¸¸æˆç•Œé¢ è‹¥ä¿®æ”¹staticæ–‡ä»¶å¤¹ä¸‹çš„ç›¸å…³æ–‡ä»¶ï¼Œéœ€åœ¨~/acappä¸‹æ‰§è¡Œ./scripts/compress_game_js.shæ¥æ‰“åŒ…æ–‡ä»¶\nå‰ç«¯çš„æ¨¡å—åŒ–å¼•å…¥ ç”±äºåœ¨ html ä»£ç éƒ¨åˆ†ï¼Œæ˜¯å°†æ•´ä¸ª game.js æ–‡ä»¶å¼•å…¥\nè¿™æ ·ä¼šå¯¼è‡´åœ¨ game.js ä¸­å®šä¹‰çš„å˜é‡ï¼Œä¼šå˜æˆæ•´ä¸ªç½‘é¡µçš„ å…¨å±€å˜é‡ï¼ˆä¹‹åå¯èƒ½ä¼šå¼•èµ·å˜é‡é‡åçš„è¯¸å¤šé—®é¢˜ï¼‰\nå› æ­¤ï¼Œæˆ‘ä»¬è€ƒè™‘ä½¿ç”¨ æ¨¡å—åŒ–å¼•å…¥ çš„åŠŸèƒ½ï¼Œè®©ç½‘é¡µåªå¼•å…¥åœ¨ html ä¸­éœ€è¦çš„éƒ¨åˆ†\nä¿®æ”¹ web.html\n...... ...... æ­¤å¤–ï¼Œè¿˜æœ‰ä¿®æ”¹å¼•å…¥çš„ç±»ï¼Œåœ¨å‰é¢åŠ ä¸Š exportï¼Œå¦‚ä¸‹ä¿®æ”¹ js/src/zbase.js\nexport class AcGame { ...... } è¿™æ ·ï¼Œåœ¨å…¨å±€ä¸­ï¼Œåªä¼šå‡ºç°å¼•å…¥çš„æ¨¡å—ï¼Œå…¶ä»–çš„ .js ä»£ç ä¸ä¼šå‡ºç°åœ¨å…¨å±€ä¸­\næ„å»ºæ¸¸æˆç•Œé¢æ¡†æ¶ static/js/src/playground/zbase.js ...... this.$playground = $(``); ...... game.css ...... .ac-game-playground { height: 100%; width: 100%; user-select: none; // ç¦ç”¨å³é”®å¼¹èœå• } å®ç°æ¸¸æˆå¼•æ“æ¡†æ¶ æ¸¸æˆä¸­ï¼Œç‰©ä½“åœ¨ç§»åŠ¨ï¼Œå…¶å®ç°åŸç†æ˜¯ï¼šæ¯ä¸€ä¸ªåŠ¨ä½œéƒ½ä¼šæ¸²æŸ“å¤šå¼ å›¾ç‰‡å‡ºæ¥ï¼Œç„¶åå›¾ç‰‡å¿«é€Ÿçš„åˆ‡æ¢ï¼Œä»è€Œå®ç°åŠ¨çš„è¿‡ç¨‹\nå› æ­¤ï¼Œéœ€è¦å…ˆå®ç°ä¸€ä¸ªæ¸¸æˆå¼•æ“çš„åŸºç±» AcGameObject ï¼Œä½¿å¾—æ¯å¸§èƒ½æ¸²æŸ“ä¸€å¼ å›¾ç‰‡å‡ºæ¥\nè¯¥åŸºç±»éœ€è¦å…·å¤‡çš„åŠŸèƒ½æœ‰ï¼š\nstart() åœ¨æ¸¸æˆå¼€å§‹çš„ç¬¬ä¸€å¸§æ—¶éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼ˆä¸€èˆ¬æ˜¯åˆ›å»ºå¯¹è±¡ï¼‰ update() åœ¨æ¸¸æˆå¼€å§‹åçš„æ¯ä¸€å¸§å‡ä¼šæ‰§è¡Œçš„ä»»åŠ¡ï¼ˆä¸€èˆ¬æ˜¯æ¸²æŸ“å½“å‰å¯¹è±¡çš„å„ç§çŠ¶æ€ï¼‰ on_destroy() åˆ æ‰è¯¥ç‰©ä½“å‰éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼ˆä¸€èˆ¬æ˜¯åˆ æ‰åŠ¨ç”»ï¼Œæˆ–è€…ç»™å¯¹æ‰‹åŠ åˆ†ï¼‰ destroy() åˆ æ‰è¯¥ç‰©ä½“ æ ¹æ®ä¸Šè¿°é€»è¾‘ï¼Œæˆ‘ä»¬å°±å¯ä»¥åŸºæœ¬æ­å»ºå‡ºæ¥ä¸€ä¸ªæ¸¸æˆå¼•æ“çš„åŸºç±»äº†ï¼Œå…·ä½“å¦‚ä¸‹ï¼š /static/js/playground/ac_game_object/zbase.js\nlet AC_GAME_OBJECTS = []; // ç”¨äºè®°å½•å½“å‰ç”»å¸ƒä¸­ï¼Œéœ€è¦æ¸²æŸ“çš„å¯¹è±¡æœ‰å“ªäº› class AcGameObject { constructor() { AC_GAME_OBJECTS.push(this); // å°†å½“å‰æ–°å»ºçš„å¯¹è±¡ï¼ŒåŠ å…¥åˆ°å…¨å±€çš„ç”»å¸ƒä¸­å»ï¼Œå‚ä¸æ¸²æŸ“ this.has_called_start = false; // æ˜¯å¦æ‰§è¡Œè¿‡ start å‡½æ•° this.timedelta = 0; // å½“å‰å¸§è·ç¦»ä¸Šä¸€å¸§çš„æ—¶é—´é—´éš” // è¯¥æ•°æ®è®°å½•æ˜¯ä¸ºäº†åç»­è®¡ç®—é€Ÿåº¦ç­‰å‚æ•°çš„ } start() { // åªä¼šåœ¨ç¬¬ä¸€å¸§æ‰§è¡Œä¸€æ¬¡ } update() { // æ¯ä¸€å¸§å‡ä¼šæ‰§è¡Œä¸€æ¬¡ } on_destroy() { // åœ¨è¢«é”€æ¯å‰æ‰§è¡Œä¸€æ¬¡ } destroy() { // åˆ æ‰è¯¥ç‰©ä½“ this.on_destroy(); //åˆ æ‰è¯¥ç‰©ä½“å‰ï¼Œæ‰§è¡Œåˆ å‰çš„æ“ä½œ // åœ¨å…¨å±€æ¸²æŸ“ç‰©ä½“ä¸­ï¼Œæ‰¾åˆ°è¯¥ç‰©ä½“ï¼Œå¹¶å°†å…¶åˆ æ‰ for (let i = 0; i \u003c AC_GAME_OBJECTS.length; i ++ ) { if (AC_GAME_OBJECTS[i] === this) { // ä¸‰ç­‰å·ï¼Œåœ¨jsé‡Œé¢å¤–åŠ äº†ä¸€å±‚ç±»å‹ç›¸ç­‰çº¦æŸ AC_GAME_OBJECTS.splice(i, 1); break; } } } } let last_timestamp; let AC_GAME_ANIMATION = function(timestamp) { // å›è°ƒå‡½æ•°ï¼Œå®ç°ï¼šæ¯ä¸€å¸§é‡ç»˜æ—¶ï¼Œéƒ½ä¼šæ‰§è¡Œä¸€é for (let i = 0; i \u003c AC_GAME_OBJECTS.length; i ++ ) { let obj = AC_GAME_OBJECTS[i]; if (!obj.has_called_start) { // å¦‚æœè¿˜æœªæ‰§è¡Œåˆå§‹å¸§åŠ¨ä½œï¼Œå°±å…ˆæ‰§è¡Œ obj.start(); obj.has_called_start = true; } else { // æ‰§è¡Œè¿‡åˆå§‹å¸§ï¼Œå°±æ‰§è¡Œæ¯ä¸€å¸§çš„ä»»åŠ¡ obj.timedelta = timestamp - last_timestamp; obj.update(); } } last_timestamp = timestamp; // æ›´æ–°æœ€åä¸€æ¬¡æ—¶é—´æˆ³ requestAnimationFrame(AC_GAME_ANIMATION); } requestAnimationFrame(AC_GAME_ANIMATION); // JSçš„APIï¼Œå¯ä»¥è°ƒç”¨1å¸§é‡Œé¢çš„å‡½æ•°ã€‚(æœ‰äº›æµè§ˆå™¨çš„ä¸€ç§’å¸§æ•°ä¸ä¸€å®šç›¸ç­‰) æ¥ä¸‹æ¥æ‰€æœ‰çš„ä¸€åˆ‡æ¸¸æˆï¼Œéƒ½æ˜¯åŸºäºè¿™ä¸ªå¼•æ“çš„åŸºç±»å®Œæˆçš„\nå®ç°æ¸¸æˆåœ°å›¾åŠŸèƒ½ ç›®æ ‡ï¼šå®ç°ä¸€ä¸ªæ¯ä¸€ç§’éƒ½åœ¨æ¸²æŸ“çš„çº¯é»‘èƒŒæ™¯\nè™½ç„¶ç°é˜¶æ®µè¦å®ç°çš„åœ°å›¾è¾ƒä¸ºç®€å•ï¼Œä½†ä¸ºäº†åæœŸçš„æ‹“å±•æ€§ï¼Œæ•…è¿˜æ˜¯è€ƒè™‘æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹æ¥å®Œæˆ\nç„¶ååœ¨ js ä¸­ï¼Œå·²ç»å°è£…å¥½äº†ä¸€ä¸ª canvas çš„ api æ¥å¸®åŠ©å®ç°èƒŒæ™¯ç”»å¸ƒï¼Œç›´æ¥è°ƒç”¨å³å¯\nå…ˆé“ºå¼€ç”»å¸ƒï¼Œç„¶åè®¾ç½®ä¸ºé»‘è‰²\nstatic/js/playground/zbase.js class AcGamePlayground { constructor(root) { ...... // $('.playground')å¯¹è±¡å·²ç»åœ¨ css æ–‡ä»¶é‡Œæ¸²æŸ“å‡ºé«˜å®½äº† // ç°åœ¨æŠŠä»–çš„é«˜å®½å­˜ä¸‹æ¥ï¼Œå¾€ä¸‹ä¼ é€’ this.width = this.$playground.width(); this.height = this.$playground.height(); this.game_map = new GameMap(this); ...... } ..... } static/js/playground/game-map/zbase.js class GameMap extends AcGameObject { // ç»§æ‰¿è‡ªæ¸¸æˆå¼•æ“åŸºç±» constructor(playground) { super(); // è‡ªå‡½æ•°åŠŸèƒ½ï¼šè°ƒç”¨åŸºç±»çš„æ„é€ å‡½æ•° this.playground = playground; this.$canvas = $(``); // åˆ›å»ºä¸€ä¸ªcanvasçš„jQueryå¯¹è±¡ï¼Œå°±æ˜¯æˆ‘ä»¬è¦å®ç°çš„ç”»å¸ƒ this.ctx = this.$canvas[0].getContext('2d'); // jQueryå¯¹è±¡æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œç¬¬ä¸€ä¸ªç´¢å¼•æ˜¯htmlå¯¹è±¡ // è®¾ç½®ç”»å¸ƒçš„å®½é«˜ this.ctx.canvas.width = this.playground.width; this.ctx.canvas.height = this.playground.height; this.playground.$playground.append(this.$canvas); } start() { } update() { // æ¸¸æˆåœ°å›¾æ¯å¸§éƒ½è¦æ¸²æŸ“ this.render(); } render() { this.ctx.fillStyle = \"rgba(0, 0, 0, 0.2)\"; this.ctx.fillRect(0, 0, this.ctx.canvas.width, this.ctx.canvas.height); } } å®ç°ç©å®¶æ˜¾ç¤ºåŠŸèƒ½ æ¯›å¯ç‰ˆç©å®¶æ˜¾ç¤ºï¼Œæ¯ä¸ªç©å®¶å®šä¹‰æˆä¸€ä¸ªåœ†ï¼Œç„¶åæ¸²æŸ“åœ¨å‰ç«¯\néœ€è¦å¯¹äºç©å®¶ç±»å®šä¹‰å¤šä¸ªå‚æ•°ï¼Œä»¥æ–¹ä¾¿æ—¥åæ‹“å±•ï¼š\nx å½“å‰ä½ç½®çš„æ¨ªåæ ‡ y å½“å‰ä½ç½®çš„çºµåæ ‡ radius å½“å‰çš„åŠå¾„ speed å½“å‰çš„é€Ÿåº¦ is_me è¯¥å¯¹è±¡æ˜¯å¦æ˜¯å½“å‰ç©å®¶æ“æ§çš„å¯¹è±¡ï¼ˆä¸€æ˜¯åŒºåˆ«äº botï¼ŒäºŒæ˜¯åŒºåˆ«äº æ—¥åè”æœºçš„å…¶ä»–ç©å®¶ï¼‰ static/js/playground/zbase.js class AcGamePlayground { constructor(root) { ...... this.players = []; // å­˜æ”¾å½“å‰æ¸¸æˆä¸­çš„æ‰€æœ‰ç©å®¶ // å°†ç©å®¶åŠ å…¥æ¸¸æˆä¸­ this.players.push(new Player(this, this.width / 2, this.height / 2, this.height * 0.05, \"white\", this.height * 0.15, true)); ...... } ..... } static/js/playground/player/zbase.js class Player extends AcGameObject { constructor(playground, x, y, radius, color, speed, is_me) { super(); // æŠŠä¿¡æ¯éƒ½å­˜ä¸‹æ¥ this.playground = playground; this.ctx = this.playground.game_map.ctx; this.x = x; this.y = y; this.color = color; this.speed = speed; this.radius = radius; this.is_me = is_me; // ç”¨äºæµ®ç‚¹æ•°è¿ç®— this.eps = 0.1; } start() { } update() { this.render(); } render() { // æ¸²æŸ“ä¸€ä¸ªåœ† this.ctx.beginPath(); this.ctx.arc(this.x, this.y, this.radius, 0, 2 * Math.PI, false); this.ctx.fillStyle = this.color; this.ctx.fill(); } on_destroy() { } } å®ç°ç©å®¶ç§»åŠ¨åŠŸèƒ½ ç§»åŠ¨çš„å®ç°é€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯è®©æ¯å¸§æ¸²æŸ“çš„åœ†çš„ä½ç½®å‘ç”Ÿç§»åŠ¨å³å¯\nä¸Šè¿°ç®€å•é€»è¾‘çš„å®ç°å¦‚ä¸‹ï¼š\nclass Player extends AcGameObject { constructor(....) { ... this.vx = 1; this.vy = 1; ... } ... update() { this.x += x; this.y += y; this.render(); } } ç„¶åæˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªå‘é¼ æ ‡ç‚¹å‡»ä½ç½®ç§»åŠ¨çš„åŠŸèƒ½\nè¿™å°±éœ€è¦è®¾ç½®ä¸€ä¸ª click äº‹ä»¶çš„ç›‘å¬å‡½æ•°ï¼Œåˆ†åˆ«ä¼ é€’ï¼š\né¼ æ ‡ç‚¹å‡»äº‹ä»¶ é¼ æ ‡ç‚¹å‡»ä½ç½®çš„æ¨ªåæ ‡ é¼ æ ‡ç‚¹å‡»ä½ç½®çš„çºµåæ ‡ ç„¶åå¼€å§‹è®©åœ†çš„ä½ç½®é€æ­¥å‘é¼ æ ‡ç‚¹å‡»ä½ç½®è¿›è¡Œç§»åŠ¨\nstart() { if (this.is_me) { // å¯¹äºç”¨æˆ·ç©å®¶ï¼ŒåŠ ä¸Šç›‘å¬å‡½æ•° this.add_listening_events(); } } add_listening_events() { let outer = this; // æŠŠé¼ æ ‡å³é”®è°ƒå‡ºèœå•æ çš„åŠŸèƒ½å…³æ‰ this.playground.game_map.$canvas.on(\"contextmenu\", function() { return false; }); // æŠŠå³é”®æ§åˆ¶ç§»åŠ¨åŠŸèƒ½åŠ ä¸Š this.playground.game_map.$canvas.mousedown(function(e) { // å·¦é”®:1 ä¸­é”®:2 å³é”®:3 if (e.which === 3) { outer.move_to(e.clientX, e.clientY); } }); } ç„¶åï¼Œæˆ‘ä»¬æ¥å®ç°ç§»åŠ¨åŠŸèƒ½çš„å‡½æ•° move_to(tx, ty)\nconstructor(...){ ... this.vx = 0; // xæ–¹å‘ä¸Šçš„ç§»åŠ¨é€Ÿåº¦ this.vy = 0; // yæ–¹å‘ä¸Šçš„ç§»åŠ¨é€Ÿåº¦ this.move_length = 0; // å‰©ä½™ç§»åŠ¨è·ç¦» ... } ... get_dist (x1, y1, x2, y2) { // æ±‚ä¸¤ç‚¹çš„æ¬§å‡ é‡Œå¾—è·ç¦» let dx = x2 - x1; let dy = y2 - y1; return Math.sqrt(dx * dx + dy * dy); } move_to(tx, ty) { // è®¡ç®—ç§»åŠ¨è·ç¦» this.move_length = this.get_dist(this.x, this.y, tx, ty); // è®¡ç®—ç§»åŠ¨è§’åº¦ï¼Œapiæ¥å£ï¼šatan2(dy, dx) let angle = Math.atan2(ty - this.y, tx - this.x); // ä½ç§» 1 ä¸ªå•ä½é•¿åº¦ï¼ˆå‘ç€çŸ¢é‡æ–¹å‘ç§»åŠ¨åˆ°å•ä½åœ†ä¸Šï¼‰ this.vx = Math.cos(angle); // æç›´äº’åŒ– this.vy = Math.sin(angle); } update() { // æµ®ç‚¹æ•°ç²¾åº¦è¿ç®— if (this.move_length \u003c this.eps) { this.move_length = 0; this.vx = this.vy = 0; } else { // è®¡ç®—å•ä½å¸§é‡Œçš„ç§»åŠ¨è·ç¦» let moved = Math.min(this.move_length, this.speed * this.timedelta / 1000); this.x += this.vx * moved; this.y += this.vy * moved; // è¿˜è¦å‡æ‰ç§»åŠ¨çš„è·ç¦» this.move_length -= moved; } this.render(); } ... è¿™æ ·å°±å®ç°äº†ç©å®¶çš„ç§»åŠ¨åŠŸèƒ½äº†ï¼Œå¯ä»¥ç™»å½• id:socket è°ƒè¯•è¯¥åŠŸèƒ½\nå®ç°ç«çƒæŠ€èƒ½çš„åŠŸèƒ½ ç«çƒå¯¹è±¡çš„å»ºç«‹ä¸ç©å®¶åŸºæœ¬ä¸€è‡´ï¼Œç›´æ¥ç…§æ¬ï¼Œåœ¨ä»ç»†èŠ‚ä¸Šæ”¹æ”¹å³å¯\njs/src/playground/skill/fireball/zbase.js class FireBall extends AcGameObject { constructor(playground, player, x, y, radius, vx, vy, color, speed, move_length, damage) { super(); this.playground = playground; this.ctx = this.playground.game_map.ctx; this.player = player; this.x = x; this.y = y; this.vx = vx; this.vy = vy; this.radius = radius; this.color = color; this.speed = speed; this.move_length = move.length; this.damage = damage; this.eps = 0.1; } start() { } update() { if (this.move_length \u003c this.eps) { this.destroy(); return false; } else { let moved = Math.min(this.move_length, this.speed * this.timedelta / 1000); this.x += this.vx * moved; this.y += this.vy * moved; this.move_length -= moved; } this.render(); } render() { this.ctx.beginPath(); this.ctx.arc(this.x, this.y, this.radius, 0, 2 * Math * Pi, false); this.ctx.fillStyle = this.color; this.ctx.fill(); } } ç„¶ååœ¨ç©å®¶èº«ä¸Šå®ç°å‘ç«çƒçš„åŠŸèƒ½\nåŸºæœ¬å®ç°é€»è¾‘ï¼šå½“å‰é€‰ä¸­äº†ç«çƒæŠ€èƒ½ï¼Œé¼ æ ‡å·¦é”®ç‚¹å‡»ä¸€å¤„ï¼Œå‘è¯¥å¤„å‘å°„ä¸€ä¸ªç«çƒ\nå› æ­¤ï¼Œä¸ºäº†çŸ¥é“ç”¨æˆ·æ˜¯å¦é€‰æ‹©äº†æŠ€èƒ½ï¼Œéœ€è¦åŠ ä¸€ä¸ªé”®ç›˜è§¦å‘äº‹ä»¶ç›‘å¬å‡½æ•°ï¼Œç„¶ååŠ ä¸€ä¸ªé¼ æ ‡å·¦é”®è§¦å‘äº‹ä»¶ç›‘å¬å‡½æ•°\nç„¶åå‘å°„ä¸€ä¸ªç«çƒå³å¯\njs/src/playground/player/zbase.js constructor(...) { ... this.cur_skill = null; // è®°å½•å½“å‰é€‰æ‹©çš„æŠ€èƒ½ ... } add_listening_events() { ... this.playground.game_map.$canvas.mousedown(function(e) { // å·¦é”®:1 ä¸­é”®:2 å³é”®:3 if (e.which === 3) { outer.move_to(e.clientX, e.clientY); } else if (e.which === 1) { // é¼ æ ‡å·¦é”®äº‹ä»¶ if (outer.cur_skill === \"fireball\") { // å½“å‰å·²ç»é€‰ä¸­ç«çƒæŠ€èƒ½ outer.shoot_fireball(e.clientX, e.clientY); } } outer.cur_skill = null; // æ¸…ç©ºå½“å‰æŠ€èƒ½ }); $(window).keydown(function(e) { if (e.which === 81) { // é”®ç›˜æŒ‰ä¸‹äº‹ä»¶ outer.cur_skill = \"fireball\"; return false; } }); } shoot_fireball(tx, ty) { // ç¡®å®šç«çƒçš„å‚æ•° let x = this.x, y = this.y; // ç«çƒå‘å°„ç‚¹å°±æ˜¯å½“å‰ç©å®¶çš„ä½ç½® let radius = this.playground.height * 0.01; let angle = Math.atan2(ty - this.y, tx - this.x); let vx = Math.cos(angle), vy = Math.sin(angle); let color = \"orange\"; let speed = this.playground.height * 0.5; let move_length = this.playground.height * 1.0; let damage = this.playground.height * 0.01; new FireBall(this.playground, this, x, y, radius, vx, vy, color, speed, move_length, damage); } è¿™æ ·å°±æˆåŠŸå®ç°äº†ç©å®¶å‘å°„ç«çƒçš„åŠŸèƒ½äº†\nå®ç°å•äººæ¨¡å¼ä¸‹çš„äººæœºåŠŸèƒ½ å…ˆåˆ›å»ºå¥½ 5 ä¸ªäººæœº playground/zbase.js\n... //åˆ›å»ºå¥½ 5 ä¸ªäººæœº for (len i = 0; i \u003c 5; i ++ ) { this.players.push(new Player(this, this.width / 2, this.height / 2, this.height * 0.05, \"blue\", this.height * 0.15, false)); } ... è¿™æ ·åˆ›å»ºå‡ºæ¥çš„ 5 ä¸ªäººæœºæ˜¯ä¸ä¼šè¡ŒåŠ¨çš„\næˆ‘ä»¬å†™ä¸€ä¸ªç®€æ˜“çš„ AI ç¨‹åºï¼Œè®©ä»–ä»¬ä¹Ÿä¼šç§»åŠ¨\nè¿™é‡Œå®ç°çš„é€»è¾‘æ˜¯ï¼šæ¯æ¬¡éšæœºä¸€ä¸ªç›®çš„åœ°ï¼Œå‘ç›®çš„åœ°ç§»åŠ¨ï¼Œç„¶åå†éšæœºä¸€ä¸ªç›®çš„åœ°ï¼Œå¾ªç¯ä¸‹å»\næ ¹æ®è¯¥é€»è¾‘ï¼Œä¿®æ”¹ä¸¤ä¸ªå‡½æ•°å³å¯\nplayground/player/zbase.js ... start() { if (this.is_me) { // å¯¹äºç”¨æˆ·ç©å®¶ï¼ŒåŠ ä¸Šç›‘å¬å‡½æ•° this.add_listening_events(); } else { let tx = Math.random() * this.playground.width; let ty = Math.random() * this.playground.height; this.move_to(tx, ty); } } ... update() { if (this.move_length \u003c this.eps) { this.move_length = 0; this.vx = this.vy = 0; if (!this.is_me) { // å¦‚æœæ˜¯äººæœºï¼Œåœä¸‹æ¥æ—¶å†éšæœºä¸€ä¸ªæ–¹å‘å‰è¿› let tx = Math.random() * this.playground.width; let ty = Math.random() * this.playground.height; this.move_to(tx, ty); } } ... } on_destroy() { for (let i = 0; i \u003c this.playground.players.length; i ++ ) { if (this.playground.players[i] === this) { this.playground.players.splice(i, 1); } } } å®ç°æŠ€èƒ½å‘½ä¸­æ•ˆæœï¼ˆç¢°æ’æ£€æµ‹åŠŸèƒ½ï¼‰ å®ç°é€»è¾‘ï¼šæ£€æµ‹ä¸¤ä¸ªåœ†çš„ä¸­å¿ƒè·ç¦»æ˜¯å¦å°äºä¸¤ä¸ªåœ†çš„åŠå¾„ä¹‹å’Œ\nå°äºç­‰äºæ—¶ï¼Œä»£è¡¨å‘ç”Ÿç¢°æ’ï¼Œå¼€å§‹æ‰§è¡Œå‘½ä¸­æ•ˆæœï¼š\nè¢«å‡»ä¸­ç”¨æˆ·æ‰è¡€ è¢«å‡»ä¸­ç”¨æˆ·æ”¶åˆ°å‘åå‡»é€€æ•ˆæœ ç¢°æ’æ£€æµ‹å†™åœ¨ç«çƒç±»é‡Œï¼Œå‡»é€€æ•ˆæœå†™åœ¨ç©å®¶ç±»é‡Œ\nfireball/zbase.js update() { if (...) { ... } else { ... // ç¢°æ’æ£€æµ‹ for (let i = 0; i \u003c this.playground.players.length; i ++ ) { let player = this.playground.players[i]; if (this.player !== player \u0026\u0026 this.is_collision(player)) { // ç¢°æ’å‘ç”Ÿä¸€å®šæ˜¯åœ¨éæ–½æ³•è€…èº«ä¸Š this.attack(player); // ç«çƒå‘½ä¸­ï¼Œç›®æ ‡ç©å®¶æ‰§è¡Œå‡»é€€æ•ˆæœ } } } this.render(); } get_dist(x1, y1, x2, y2) { // è·å¾—ä¸¤ç‚¹çš„æ¬§å‡ é‡Œå¾—è·ç¦» let dx = x2 - x1; let dy = y2 - y1; return Math.sqrt(dx * dx + dy * dy); } is_collision(player) { // æ£€æµ‹ä¸¤ä¸ªåœ†çš„ä¸­å¿ƒè·ç¦»æ˜¯å¦å°äºä¸¤ä¸ªåœ†çš„åŠå¾„ä¹‹å’Œ let distance = this.get_dist(this.x, this.y, player.x, player.y); if (distance \u003c (this.radius + player.radius)) return true; return false; } attack(player) { // ç«çƒå‘½ä¸­ï¼Œç›®æ ‡ç©å®¶æ‰§è¡Œå‡»é€€æ•ˆæœ let angle = Math.atan2(player.y - this.y, player.x - this.x); // è®¡ç®—è§’åº¦ player.is_attacked(angle, this.damage); // ç«çƒå‘½ä¸­ï¼Œç›®æ ‡ç©å®¶æ‰§è¡Œå‡»é€€æ•ˆæœ this.destroy(); // ç«çƒå‘½ä¸­åï¼Œè‡ªç„¶æ¶ˆå¤± } è¢«å‡»é€€çš„æ—¶å€™ï¼ŒåŸæ¥çš„ç§»åŠ¨é€Ÿåº¦åº”è¯¥ç½®ä¸º 0ï¼Œå½“å‰çš„ç§»åŠ¨åº”è¯¥è½¬ä¸ºå‘è¢«å‡»ä¸­æ–¹å‘ä¸Šçš„ç§»åŠ¨ player/zbase.js\nis_attacked(angle, damage) { this.radius -= damage; // å—ä¼¤ï¼ŒåŠå¾„å‡å°‘ if (this.radius \u003c 10) { // å½“åŠå¾„å°äº10åƒç´ æ—¶ï¼Œä»£è¡¨æ­»äº¡ this.destroy(); return false; } // å¼€å§‹æ‰§è¡Œå‡»é€€æ•ˆæœ this.damage_vx = Math.cos(angle); this.damage_vy = Math.sin(angle); this.damage_speed = damage * 100; this.speed *= 0.5; // è¢«å‡»ä¸­ä»¥åç§»åŠ¨é€Ÿåº¦å‡åŠ } update() { if (this.damage_speed \u003e this.eps) { // å½“å‰ä»å¤„äºå‡»é€€æ•ˆæœä¸­ this.vx = this.vy = 0; this.move_length = 0; this.x += this.damage_vx * this.damage_speed * this.timedelta / 1000; this.y += this.damage_vy * this.damage_speed * this.timedelta / 1000; this.damage_speed *= this.friction; // å‡»é€€é€Ÿåº¦ä¹˜ä»¥æ‘©æ“¦ç³»æ•°ï¼Œå·²è¾¾åˆ°å‰Šå‡çš„ç›®çš„ } else { ... } ... } è¢«å‡»ä¸­ä»¥åçš„ç²’å­æ•ˆæœç‰¹æ•ˆ å®ç°é€»è¾‘ï¼šè¢«å‡»ä¸­ä»¥åï¼Œåœ¨ç©å®¶é™„è¿‘éšæœºç”Ÿæˆä¸€äº›ç²’å­å°çƒ\nå› æ­¤æˆ‘ä»¬è¦å…ˆå®ç° ç²’å­å°çƒ å¯¹è±¡\nstatic/js/src/playground/particle/zbase.js class Particle extends AcGameObject { constructor(playground, x, y, radius, vx, vy, color, speed) { super(); this.playground = playground; this.ctx = this.playground.game_map.ctx; this.x = x; this.y = y; this.radius = radius; this.vx = vx; this.vy = vy; this.color = color; this.speed = speed; this.friction = 0.9; } start() { } update() { if (this.speed \u003c this.eps) { this.destroy; return false; } this.x += this.vx * this.speed * this.timedelta / 1000; this.y += this.vy * this.speed * this.timedelta / 1000; this.speed *= this.friction; this.render(); } render() { this.ctx.beginPath(); this.ctx.arc(this.x, this.y, this.radius, 0, 2 * Math.PI, false); this.ctx.fillStyle = this.color; this.ctx.fill(); } } ç„¶åæˆ‘ä»¬åœ¨è¢«å‡»é€€åŠŸèƒ½æ¨¡å—ï¼Œå®ç°ç”Ÿæˆç²’å­å°çƒçš„æ•ˆæœ\nç²’å­å°çƒé‡Šæ”¾å¼§åº¦ä¸º $[0,2Ï€)$ çš„éšæœºæ•° ç²’å­å°çƒçš„ x, y åˆ†é‡æ¯”ç‡æ ¹æ®å¼§åº¦æ¥è®¾å®š ç²’å­å°çƒçš„èµ·å§‹åæ ‡åº”ä¸ç©å®¶çš„åæ ‡ç›¸åŒ ç²’å­å°çƒçš„é¢œè‰²ä¸ç©å®¶é¢œè‰²ç›¸åŒ ç²’å­å°çƒçš„é€Ÿåº¦ä¸ºç©å®¶ç§»åŠ¨é€Ÿåº¦çš„ $10$ å€ js/src/playground/player/zbase.js is_attacked(angle, damage) { // ç²’å­å°çƒæ•ˆæœ for (let i = 0; i \u003c 10 + Math.random() * 5; i ++ ) { let x = this.x, y = this.y; let radius = this.radius * Math.random() * 0.1; let angle = 2 * Math.PI * Math.random(); let vx = Math.cos(angle), vy = Math.sin(angle); let color = this.color; let speed = this.speed * 10; new Particle(this.playground, x, y, radius, vx, vy, color, speed); } ... } ä¸€äº›å°ä¼˜åŒ– äººæœºéšæœºé¢œè‰² js/src/playground/zbase.js constructor(root) { ...... // åˆ›å»ºå¥½ 5 ä¸ªäººæœº for (let i = 0; i \u003c 5; i ++ ) { this.players.push(new Player(this, this.width / 2, this.height / 2, this.height * 0.05, this.get_random_color(), this.height * 0.15, false)); } ...... } get_random_color() { let colors = [\"blue\", \"red\", \"pink\", \"grey\", \"green\"]; return colors[Math.floor(Math.random() * 5)]; } äººæœºAIéšæœºæ”»å‡»æ“ä½œ js/src/playground/player/zbase.js constructor (...) { ... this.spent_time = 0; // åˆå§‹äººæœºå†·å´æ”»å‡»æ—¶é—´ } ... update() { this.spent_time += this.timedelta / 1000; if (!this.is_me \u0026\u0026 this.spent_time \u003e 4 \u0026\u0026 Math.random() * 180 \u003c 1) { let player = this.playground.players[Math.floor(Math.random() * this.playground.players.length)]; this.shoot_fireball(player.x, player.y); } éƒ¨ç½²nginxä¸å¯¹æ¥acappà® Nginxæ˜¯ä»€ä¹ˆï¼Ÿ Nginxæ˜¯ä¸€æ¬¾è‡ªç”±çš„ã€å¼€æºçš„ã€é«˜æ€§èƒ½çš„HTTPæœåŠ¡å™¨å’Œåå‘ä»£ç†æœåŠ¡å™¨\nNginxå¯ä»¥ä½œä¸ºä¸€ä¸ªHTTPæœåŠ¡å™¨è¿›è¡Œç½‘ç«™çš„å‘å¸ƒå¤„ç†ï¼Œå¦å¤–Nginxå¯ä»¥ä½œä¸ºåå‘ä»£ç†è¿›è¡Œè´Ÿè½½å‡è¡¡çš„å®ç°\nNginxä¸­HttpUwsgiModuleçš„ä½œç”¨æ˜¯ä¸uWSGIæœåŠ¡å™¨è¿›è¡Œäº¤æ¢\nuWSGIæ˜¯ä»€ä¹ˆï¼Ÿ uWSGIæ˜¯ä¸€ä¸ªå…¨åŠŸèƒ½çš„HTTPæœåŠ¡å™¨ï¼Œå®ç°äº†WSGIã€uwsgiã€httpç­‰åè®®\nå®ƒè¦åšçš„å°±æ˜¯æŠŠHTTPåè®®è½¬åŒ–æˆè¯­è¨€æ”¯æŒçš„ç½‘ç»œåè®®ã€‚æ¯”å¦‚æŠŠHTTPåè®®è½¬åŒ–æˆWSGIåè®®ï¼Œè®©Pythonå¯ä»¥ç›´æ¥ä½¿ç”¨\nWSGIåè®®æ˜¯Python è¯­è¨€å®šä¹‰çš„ Web æœåŠ¡å™¨å’Œ Web åº”ç”¨ç¨‹åºæˆ–æ¡†æ¶ä¹‹é—´çš„ä¸€ç§ç®€å•è€Œé€šç”¨çš„æ¥å£\nç®€å•æ¥è¯´uWSGIå°±æ˜¯ç”¨æ¥æ²Ÿé€šnginxå’Œdjangoçš„ä¸€åº§æ¡¥æ¢\nNginx+uWSGI+Diango å·¥ä½œæµç¨‹ nginx æ˜¯å¯¹å¤–çš„æœåŠ¡æ¥å£ï¼Œå¤–éƒ¨æµè§ˆå™¨é€šè¿‡urlè®¿é—®nginx\nnginx æ¥æ”¶åˆ°æµè§ˆå™¨å‘é€è¿‡æ¥çš„httpè¯·æ±‚ï¼Œå°†åŒ…è¿›è¡Œè§£æ\nåˆ†æurlï¼Œå¦‚æœæ˜¯é™æ€æ–‡ä»¶è¯·æ±‚å°±ç›´æ¥è®¿é—®ç”¨æˆ·ç»™nginxé…ç½®çš„é™æ€æ–‡ä»¶ç›®å½•ï¼Œç›´æ¥è¿”å›ç”¨æˆ·è¯·æ±‚çš„é™æ€æ–‡ä»¶\nå¦‚æœä¸æ˜¯é™æ€æ–‡ä»¶ï¼Œè€Œæ˜¯ä¸€ä¸ªåŠ¨æ€çš„è¯·æ±‚ï¼Œé‚£ä¹ˆnginxå°±å°†è¯·æ±‚è½¬å‘ç»™uwsgiï¼Œuwsgi æ¥æ”¶åˆ°è¯·æ±‚ä¹‹åå°†åŒ…è¿›è¡Œå¤„ç†ï¼Œå¤„ç†æˆwsgiå¯ä»¥æ¥å—çš„æ ¼å¼ï¼Œå¹¶å‘ç»™wsgiï¼Œwsgi æ ¹æ®è¯·æ±‚è°ƒç”¨åº”ç”¨ç¨‹åºçš„æŸä¸ªæ–‡ä»¶ï¼ŒæŸä¸ªæ–‡ä»¶çš„æŸä¸ªå‡½æ•°ï¼Œæœ€åå¤„ç†å®Œå°†è¿”å›å€¼å†æ¬¡äº¤ç»™wsgiï¼Œwsgiå°†è¿”å›å€¼è¿›è¡Œæ‰“åŒ…ï¼Œæ‰“åŒ…æˆuwsgièƒ½å¤Ÿæ¥æ”¶çš„æ ¼å¼ï¼Œuwsgiæ¥æ”¶wsgi å‘é€çš„è¯·æ±‚ï¼Œå¹¶è½¬å‘ç»™nginx, nginxæœ€ç»ˆå°†è¿”å›å€¼è¿”å›ç»™æµè§ˆå™¨\nuwsgiæœåŠ¡çš„å¼€å¯\u0026\u0026å…³é—­ åœ¨~/acappå¯åŠ¨uwsgiæœåŠ¡ï¼šuwsgi --ini scripts/uwsgi.ini å…³é—­uwsgiæœåŠ¡ï¼šsudo pkill -f uwsgi -9 é’ˆå¯¹ acapp çš„ä¼˜åŒ– æ‰“åŒ…è„šæœ¬ä¼˜åŒ– ç”±äºç°åœ¨ å‘å¸ƒç‰ˆæœ¬çš„è„šæœ¬æ–‡ä»¶ ç”¨çš„æ˜¯æ‰“åŒ…åœ¨æ ¹ç›®å½•é‡Œçš„ static æ–‡ä»¶å¤¹\næ¯æ¬¡ä¿®æ”¹å¥½ static æ–‡ä»¶å¤¹åï¼Œä¸ä»…éœ€è¦å¯¹ js æ–‡ä»¶æ‰“åŒ…ï¼Œè¿˜éœ€è¦å¯¹ static æ–‡ä»¶å¤¹æ‰“åŒ…\nä¸æ”¾æŠŠ â€œå°†staticæ–‡ä»¶å¤¹æ‰“åŒ…â€ çš„ shell ä»£ç ä¸€èµ·åŠ å…¥ js æ‰“åŒ…è„šæœ¬ä¸­ï¼Œä»è€Œå®ç°ä¸€é”®æ‰“åŒ…\nscripts/compress_game_js.sh #! /bin/bash JS_PATH=/home/acs/acapp/game/static/js/ JS_PATH_DIST=${JS_PATH}dist/ JS_PATH_SRC=${JS_PATH}src/ find $JS_PATH_SRC -type f -name '*.js' | sort | xargs cat \u003e ${JS_PATH_DIST}game.js echo \"yes\" | python3 manage.py collectstatic é¼ æ ‡ç‚¹å‡»äº‹ä»¶çš„ç›¸å¯¹åç§» ç”±äºå†™æ¸¸æˆç•Œé¢çš„æ—¶å€™ï¼Œç©å®¶ç§»åŠ¨æ˜¯æŒ‰ç…§é¼ æ ‡ç›¸å¯¹äºå½“å‰æ•´ä¸ªæµè§ˆå™¨å–çš„ä½ç½®å‚æ•° e.clientX\nè€Œ acapp é‡Œï¼Œæ¯ä¸ªåº”ç”¨æ˜¯ä¸€ä¸ªå°çª—å£ï¼Œé¼ æ ‡ç‚¹å‡»ä½ç½®çš„å‚æ•°åº”å½“æ˜¯ ç›¸å¯¹äºæ•´ä¸ªæ¸¸æˆçª—å£çš„ä½ç½®å‚æ•°\næ‰€æœ‰ä¼šå¯¼è‡´å‡ºç°ï¼Œç‚¹å‡»çš„ä½ç½®ä¸ç§»åŠ¨çš„ä½ç½®ä¸åŒï¼Œè¿™é‡Œéœ€è¦åšå‡ºå°ä¼˜åŒ–\nä¼˜åŒ–çš„é€»è¾‘ :\n$clientXâˆ’çª—å£å·¦ä¾§åˆ°æµè§ˆå™¨å·¦ä¾§çš„è·ç¦»=ç©å®¶çš„ç›®æ ‡X$ $clientYâˆ’çª—å£ä¸Šä¾§åˆ°æµè§ˆå™¨ä¸Šä¾§çš„è·ç¦»=ç©å®¶çš„ç›®æ ‡Y$ è¿™å°±è¦ç”¨åˆ°ä¸€ä¸ª js çš„ API äº† : getBoundingClientRect() rectObject = object.getBoundingClientRect(); rectObject.top : å…ƒç´ ä¸Šè¾¹åˆ°è§†çª—ä¸Šè¾¹çš„è·ç¦»; rectObject.right : å…ƒç´ å³è¾¹åˆ°è§†çª—å·¦è¾¹çš„è·ç¦»; rectObject.bottom : å…ƒç´ ä¸‹è¾¹åˆ°è§†çª—ä¸Šè¾¹çš„è·ç¦»; rectObject.left : å…ƒç´ å·¦è¾¹åˆ°è§†çª—å·¦è¾¹çš„è·ç¦»; rectObject.width : æ˜¯å…ƒç´ è‡ªèº«çš„å®½ rectObject.height : æ˜¯å…ƒç´ è‡ªèº«çš„é«˜ player/zbase.js ... add_listening_events() { ... this.playground.game_map.$canvas.mousedown(function(e) { // åˆ›å»º rect å¯¹è±¡ const rect = outer.ctx.canvas.getBoundingClientRect(); if (e.which === 3) { // è°ƒæ•´åç§»é‡ outer.move_to(e.clientX - rect.left, e.clientY - rect.top); } else if (e.which === 1) { if (outer.cur_skill === \"fireball\") { // è°ƒæ•´åç§»é‡ outer.shoot_fireball(e.clientX - rect.left, e.clientY - rect.top); } } ... }); ... } ... å°†èœå•ç•Œé¢é‡æ–°è®¾ä¸ºä¸»ç•Œé¢ js/zbase.js çš„æ³¨é‡Šå–æ¶ˆï¼Œä½¿ä¹‹åˆ›å»ºå‡º menu å¯¹è±¡\njs/playground/zbase.js çš„æ³¨é‡Šå–æ¶ˆï¼Œå¹¶è®¾ç½®é€»è¾‘ï¼Œè®© playground æ‰“å¼€åï¼Œæ‰è¿›è¡Œæ¸¸æˆç•Œé¢åˆå§‹åŒ–\nclass AcGamePlayground { constructor(root) { this.root = root; this.$playground = $(``); this.hide(); // åˆå§‹æ—¶éšè— // æ¸¸æˆç•Œé¢ç”Ÿæˆä»£ç åœ¨ä¸‹é¢å±•ç¤º playground æ—¶æ‰§è¡Œ this.start(); } ... show() { // æ‰“å¼€ playground ç•Œé¢ this.$playground.show(); // å¼€å§‹ç”Ÿæˆæ¸¸æˆç•Œé¢ this.root.$ac_game.append(this.$playground); this.width = this.$playground.width(); this.height = this.$playground.height(); this.game_map = new GameMap(this); this.players = []; // å­˜æ”¾å½“å‰æ¸¸æˆä¸­çš„æ‰€æœ‰ç©å®¶ // å°†ç©å®¶åŠ å…¥æ¸¸æˆä¸­ this.players.push(new Player(this, this.width / 2, this.height / 2, this.height * 0.05, \"white\", this.height * 0.15, true)); // åˆ›å»ºå¥½ 5 ä¸ªäººæœº for (let i = 0; i \u003c 5; i ++ ) { this.players.push(new Player(this, this.width / 2, this.height / 2, this.height * 0.05, this.get_random_color(), this.height * 0.15, false)); } } ... } è°ƒæ•´ css æ–‡ä»¶ï¼Œé€‚åº”çª—å£ åœ¨è®¾ç½® web ç½‘é¡µçš„æ—¶å€™ï¼Œæœ‰äº›è®¾ç½®äº†ç»å¯¹å€¼ï¼Œå¯èƒ½å¯¹äºçª—å£åŒ–çš„ acapp æ˜¾ç¤ºæ•ˆæœå·®\nå°†ä»–ä»¬ä¿®æ”¹æˆç›¸å¯¹æ•°å€¼\ngame.css ... .ac-game-menu-field { ... top: 40%; left: 20%; } .ac-game-menu-field-item { height: 6vh; ... font-size: 4vh; ... } ... åˆ›å»ºè´¦å·ç³»ç»Ÿ 6. åˆ›å»ºè´¦å·ç³»ç»Ÿ | è®²ä¹‰\nç”¨æˆ·åå¯†ç ç™»å½• å®¢æˆ·ç«¯è¯·æ±‚ä¸Djangoå“åº”æµç¨‹ ç”¨æˆ·åœ¨å®¢æˆ·ç«¯é€šè¿‡$.ajaxå‘é€è¯·æ±‚ï¼Œæ ¹æ®urlsè·¯ç”±åˆ°å¯¹åº”çš„viewsä¸­çš„å‡½æ•°ï¼Œå¤„ç†requeståè¿”å›JsonResponse è‡³å®¢æˆ·ç«¯\nå‰æœŸå‡†å¤‡å·¥ä½œ åšå¼€å‘ï¼Œå…ˆå¼€å¯è°ƒè¯•æ¨¡å¼ï¼Œå¦‚æœä¸å¼€å¯ï¼ŒæœåŠ¡å™¨ä¸€æ—¦è¿è¡Œé”™è¯¯ï¼Œå°±åªè¿”å› Error æŠ¥é”™ settings.py\n... DEBUG = True ... ä¸è¿‡ django è‡ªå¸¦çš„ User è¡¨å¹¶ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦è‡ªå·±é¢å¤–å»ºè¡¨\nåˆ›å»ºç”¨æˆ·è¡¨ æ‰€æœ‰çš„æ•°æ®è¡¨éƒ½å­˜åœ¨ models é‡Œ\næˆ‘ä»¬åœ¨ models é‡Œåˆ›å»ºä¸€ä¸ª player æ–‡ä»¶å¤¹ï¼Œç”¨äºå­˜å‚¨æ‰€æœ‰çš„ player ç›¸å…³çš„è¡¨\nç„¶åå¯¹æ–‡ä»¶å¤¹åˆå§‹åŒ– __init__.pyï¼Œæ¥ç€æ‰©å……æˆä¸€ä¸ªæˆ‘ä»¬éœ€è¦çš„æ•°æ®è¡¨\ngame/models/player/player.py from django.db import models from django.contrib.auth.models import User class Player(models.Model): # Player ç±»ç»§æ‰¿è‡ª Model ç±» user = models.OneToOneField(User, on_delete=models.CASCADE) # è¯´æ˜Playeræ˜¯ä»Userè¡¨æ‰©å……è¿‡æ¥çš„ï¼Œæ¯ä¸€ä¸ªplayeréƒ½ä¸ä¸€ä¸ªuseræ˜¯ä¸€ä¸€å¯¹åº”å…³è”å…³ç³» # åä¸€ä¸ªå‚æ•°æ˜¯æŒ‡ï¼Œå½“userè¢«åˆ é™¤åï¼Œå¯¹åº”çš„playerä¹Ÿè¦è¢«åˆ é™¤ # ï¼ˆæ„Ÿè§‰å°±æ˜¯å¤–é”®çš„æ„æ€ï¼‰ photo = models.URLField(max_length=256, blank=True) # ç”¨äºå­˜å‚¨ç”¨æˆ·çš„å¤´åƒçš„url # æŒ‡å®šæ¯ä¸ªplayeræ•°æ®å±•ç¤ºåœ¨å‰å°çš„æ•°æ® def __str__(self): return str(self.user) # å±•ç¤ºç”¨æˆ·çš„ç”¨æˆ·å å°†å®šä¹‰çš„è¡¨ï¼Œæ³¨å†Œåˆ°åå° admin é¡µé¢ä¸­\ngame/admin.py ... from game.models.player.player import Player admin.site.register(Player) ç„¶åå°†åˆ›å»ºçš„æ•°æ®è¡¨æ›´æ–°åˆ° django çš„æ•°æ®åº“ä¸­å»\n$ python3 manage.py makemigrations \u003e Migrations for 'game': \u003e game/migrations/0001_initial.py \u003e - Create model Player $ $ python3 manage.py migrate \u003e Operations to perform: \u003e Apply all migrations: admin, auth, contenttypes, game, sessions \u003e Running migrations: \u003e Applying game.0001_initial... OK ç„¶åé‡å¯ä¸€ä¸‹æœåŠ¡ï¼Œå°±å¯ä»¥åœ¨ç®¡ç†å‘˜é¡µé¢çœ‹åˆ°æ–°å»ºçš„æ•°æ®åº“äº†\nå®ç°å®¢æˆ·ç«¯çš„ç±»å‹åˆ¤åˆ«ï¼ˆACAPP or WEBï¼‰ ç”±äºæˆ‘ä»¬å®ç°çš„é¡¹ç›®æ˜¯å‰åç«¯åˆ†ç¦»ç±»å‹ï¼Œå› æ­¤å¯¹äºä¸åŒçš„å®¢æˆ·ç«¯ï¼Œå‰ç«¯è¦æ§åˆ¶ç”Ÿæˆä¸åŒçš„é¡µé¢\nä¸ºäº†å¢å¼ºæ‰©å±•æ€§ï¼Œæ•…è¿™é‡Œè¦å®ç°å®¢æˆ·ç«¯ç±»å‹çš„åˆ¤åˆ«\nyæ€» å·²ç»æå‰å†™å¥½äº† ACAPP çš„æ¥å£ï¼Œå¦‚æœç”¨æˆ·ç”¨çš„æ˜¯ ACAPP è®¿é—®ï¼Œåˆ™åœ¨æ–°å»ºå¯¹è±¡ ac_game æ—¶ï¼Œä¼šé¢å¤–ä¼ é€’ä¸€ä¸ªå‚æ•°\næˆ‘ä»¬åªéœ€æŒ‰ç…§è¿™ä¸ªæ¥å£å»å®Œæˆæ‰©å……å³å¯\nä¹‹åå†™å°ç¨‹åºä¹‹ç±»çš„åŒç†ï¼Œé¢å¤–ä¼ ä¸€ä¸ªæ¥å£\njs/zbase.js export class AcGame { constructor(id, AcWingOS) { this.id = id; this.$ac_game = $('#' + id); this.AcWingOS = AcWingOS; //å¦‚æœæ˜¯acappç«¯ï¼Œè¯¥å˜é‡å°±ä¼šå¸¦ç€ä¸€ç³»åˆ—yæ€»æä¾›çš„æ¥å£ this.menu = new AcGameMenu(this); this.playground = new AcGamePlayground(this); this.start(); } start() { } } æ„å»ºç™»å½•åŠŸèƒ½æ¡†æ¶ åŸºæœ¬é€»è¾‘ : ç”¨æˆ·è®¿é—®é¡µé¢ -\u003e è¿›å…¥ç™»å½•é¡µé¢ -\u003e æäº¤ç™»å½•ä¿¡æ¯ -\u003e æ ¸å¯¹ç™»å½•ä¿¡æ¯ -\u003e è¿”å›ç™»é™†ç»“æœå’Œå…¶ä»–ä¿¡æ¯\næ¯å®ç°ä¸€ä¸ªå‡½æ•°ï¼Œå°±éœ€è¦å®ç°ä¸‰ä¸ªéƒ¨åˆ†ï¼š\nviews : å®ç°å…·ä½“çš„è°ƒç”¨æ•°æ®åº“çš„é€»è¾‘ urls : å®ç°ä¸€ä¸ªè·¯ç”± js : å‰ç«¯å®ç°GETä¸Šè¿°æ¥å£çš„è¿‡ç¨‹ æ¬²å®ç°æµç¨‹ :\nç”¨æˆ·è®¿é—®ç½‘ç«™ï¼Œé€šè¿‡å…ˆå‰å®Œæˆçš„è·¯ç”±ï¼Œè®¿é—®åˆ° web.html web.html ä¸­çš„ js éƒ¨åˆ†åˆ›å»ºäº†ä¸€ä¸ª AcGame å¯¹è±¡ AcGame å¯¹è±¡åˆ›å»ºçš„è¿‡ç¨‹ä¸­ï¼Œç”Ÿæˆäº† Settings å¯¹è±¡ Settings å¯¹è±¡åˆ›å»ºå®Œæˆåï¼Œè°ƒç”¨ Settings.start() å‡½æ•° Settings.start() å‡½æ•°è°ƒç”¨äº† Settings.getinfo() å‡½æ•° Settings.getinfo() å‡½æ•°ä¸­æ‰§è¡Œäº† ajax å‘ getinfo æ¥å£å‘èµ·ä¸€ä¸ªå«å‚æ•° platform çš„ GET è¯·æ±‚ é€šè¿‡ urls è·¯ç”±çš„å®ç°ï¼Œæœ€ç»ˆå®šä½åˆ° views/settings/getinfo.py æ–‡ä»¶çš„ getinfo(request) å‡½æ•° æ ¹æ®ä¼ é€’è¿‡æ¥çš„ platform å‡½æ•°ï¼Œå®ç°ä¸åŒçš„ JsonResponse è¿”å› Settings.getinfo() æ¥å—åˆ°äº† response å®Œæˆä¸Šè¿°åŸºæœ¬é€»è¾‘ views views/settings/getinfo.py from django.http import JsonResponse from game.models.player.player import Player def getinfo_acapp(request): player = Player.objects.all()[0] # å–å‡ºæ•°æ®åº“ä¸­ç¬¬ä¸€ä¸ªç”¨æˆ·(è°ƒè¯•è¯¥åŠŸèƒ½) return JsonResponse({ 'result': \"success\", 'username': player.user.username, 'photo': player.photo, }) def getinfo_web(request): player = Player.objects.all()[0] # å–å‡ºæ•°æ®åº“ä¸­ç¬¬ä¸€ä¸ªç”¨æˆ·(è°ƒè¯•è¯¥åŠŸèƒ½) return JsonResponse({ 'result': \"success\", 'username': player.user.username, 'photo': player.photo, }) def getinfo(request): # å¤„ç†è¯·æ±‚ platform = request.GET.get('platform') # æ ¹æ®è¯·æ±‚çš„å¹³å°ä¸åŒï¼Œè¿›è¡Œä¸åŒè¿”å›å¤„ç† if platform == \"ACAPP\": return getinfo_acapp(request) elif platform == \"WEB\": return getinfo_web(request) urls urls/settings/index.py from django.urls import path from game.views.settings.getinfo import getinfo urlpatterns = [ path(\"getinfo/\", getinfo, name=\"settings_getinfo\"), ] è·¯ç”±å»ºç«‹å¥½ä»¥åï¼Œè®¿é—® xxxx/settings/getinfoï¼Œå¯ä»¥çœ‹åˆ° getinfo.py è¿”å›çš„ JSON ç±»å‹çš„ JSONResponse\njs ç½‘é¡µåˆšè®¿é—®æ—¶ï¼Œåº”å…ˆå°† menu å…³é—­ï¼Œç„¶åæ‰“å¼€ç™»å½•ç•Œé¢ï¼Œéšæ„å…ˆä¿®æ”¹ä¸€ä¸ªè®© menu åˆå§‹å…³é—­\nstatic/js/src/menu/zbase.js class AcGameMenu { constructor(root) { ... this.$menu.hide(); ... } ... static/js/src/settings/zbase.js class Settings { constructor(root) { this.root = root; this.platform = \"WEB\"; if (this.root.AcWingOS) this.platform = \"ACAPP\"; this.start(); } start() { this.getinfo(); } register() { // æ‰“å¼€æ³¨å†Œç•Œé¢ } login() { // æ‰“å¼€ç™»å½•ç•Œé¢ } getinfo() { let outer = this; $.ajax({ url: \"https://app1117.acapp.acwing.com.cn/settings/getinfo/\", type: \"GET\", data: { platform: outer.platform, }, success: function(resp) { console.log(resp); if (resp.result === \"success\") { // ç™»å½•æˆåŠŸï¼Œå…³é—­ç™»å½•ç•Œé¢ï¼Œæ‰“å¼€ä¸»èœå• outer.hide(); outer.root.menu.show(); } else { outer.login(); } } }); } hide() { } show() { } } ç„¶åä¸è¦å¿˜è®°åœ¨ æ ¹js ä¸‹åˆ›å»ºå¯¹è±¡\nexport class AcGame { constructor(id, AcWingOS) { ... this.settings = new Settings(this); ... } ... } è¿™æ ·åŸºæœ¬æ¡†æ¶å°±å®Œæˆäº†\nå®Œå–„ HTTP è¯·æ±‚çš„å‡½æ•° å¦‚æœç”¨æˆ·æœªç™»å½•ï¼Œè¿”å›ä¿¡æ¯ â€œnot loginâ€\nå¦‚æœç”¨æˆ·ç™»å½•ï¼Œè¿”å›ä¿¡æ¯ â€œsuccessâ€ ä»¥åŠç”¨æˆ·åå’Œå¤´åƒ\nviews/setting/getinfo.py def getinfo_web(request): user = request.user if not user.is_authenticated: # æœªç™»å½• return JsonResponse({ 'result': \"not login\" }) else: # å·²ç™»å½• player = Player.objects.get(user=user) return JsonResponse({ 'result': \"success\", 'username': player.user.username, 'photo': player.photo, }) æ³¨æ„å‰åå°æ˜¯ä¸€ä¸ªç™»å½•ç³»ç»Ÿï¼Œå› æ­¤è¦å…ˆé€€æ‰åå°ï¼Œå†æµ‹è¯•\nå°†ç”¨æˆ·å¤´åƒæ¸²æŸ“åˆ°ç©å®¶ä¸Š å°†è¿”å›çš„ JsonResponse å­˜åˆ° Settings ç±»çš„å˜é‡ä¸­ settings/zbase.js\nclass Settings { constructor(root) { ... this.username = \"\"; this.photo = \"\"; ... } ... getinfo() { let outer = this; $.ajax({ ... success: function(resp) { ... if (resp.result === \"success\") { outer.username = resp.username; outer.photo = resp.photo; ... } .. } }); } } ç„¶ååœ¨ Player é‡ŒæŠŠç”¨æˆ·çš„å¤´åƒæ¸²æŸ“åˆ°å¯¹åº”çš„ç©å®¶ä¸Š\nplayground/player/zbase.js class Player { constructor(...) { ... this.img = new Image(); this.img.src = this.playground.root.settings.photo; } ... render() { if (this.is_me) { this.ctx.save(); this.ctx.beginPath(); this.ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2, false); this.ctx.stroke(); this.ctx.clip(); this.ctx.drawImage(this.img, this.x - this.radius, this.y - this.radius, this.radius * 2, this.radius * 2); this.ctx.restore(); } else { this.ctx.beginPath(); this.ctx.arc(this.x, this.y, this.radius, 0, 2 * Math.PI, false); this.ctx.fillStyle = this.color; this.ctx.fill(); } } ... } å®ç°ç™»å½•ç•Œé¢çš„å‰ç«¯ å…ˆå®Œæˆç™»å½•ç•Œé¢æ˜¾ç¤ºçš„é€»è¾‘\nsettings/zbase.js class Settings { ... register() { // æ‰“å¼€æ³¨å†Œç•Œé¢ this.$login.hide(); this.$register.show(); } login() { // æ‰“å¼€ç™»å½•ç•Œé¢ this.$register.hide(); this.$login.show(); } ... hide() { this.$settings.hide(); } show() { this.$settings.show(); } } å®ç°å‰ç«¯çš„åŸºç¡€æ¡†æ¶ settings/zbase.js class Settings { constructor(root) { ... this.$settings = $(` ç™»å½• ç™»å½• æ³¨å†Œ AcWingä¸€é”®ç™»å½• æ³¨å†Œ æ³¨å†Œ ç™»å½• AcWingä¸€é”®ç™»å½• `); this.$login = this.$settings.find(\".ac-game-settings-login\"); this.$login_username = this.$login.find(\".ac-game-settings-username input\"); this.$login_password = this.$login.find(\".ac-game-settings-password input\"); this.$login_submit = this.$login.find(\".ac-game-settings-submit button\"); this.$login_error_message = this.$login.find(\".ac-game-settings-error-message\"); this.$login_register = this.$login.find(\".ac-game-settings-option\"); this.$login.hide(); this.$register = this.$settings.find(\".ac-game-settings-register\"); this.$register_username = this.$register.find(\".ac-game-settings-username input\"); this.$register_password = this.$register.find(\".ac-game-settings-password-first input\"); this.$register_password_confirm = this.$register.find(\".ac-game-settings-password-second input\"); this.$register_submit = this.$register.find(\".ac-game-settings-submit button\"); this.$register_error_message = this.$register.find(\".ac-game-settings-error-message\"); this.$register_login = this.$register.find(\".ac-game-settings-option\"); this.$register.hide(); this.root.$ac_game.append(this.$settings); ... } ... } å¯¹åº”çš„ css æ–‡ä»¶éƒ¨åˆ†ï¼š\ncss/game.css .ac-game-settings { width: 100%; height: 100%; background-image: url(\"/static/image/menu/background.gif\"); background-size: 100% 100%; user-select: none; } .ac-game-settings-login { height: 41vh; width: 20vw; position: relative; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0, 0, 0, 0.7); border-radius: 5px; } .ac-game-settings-title { color: white; font-size: 3vh; text-align: center; padding-top: 2vh; margin-bottom: 2vh; } .ac-game-settings-username { display: block; height: 7vh; } .ac-game-settings-password { display: block; height: 7vh; } .ac-game-settings-submit { display: block; height: 7vh; } .ac-game-settings-acwing { display: block; height: 7vh; } .ac-game-settings-item { width: 100%; height: 100%; } .ac-game-settings-item \u003e input { width: 90%; line-height: 3vh; position: relative; top: 50%; left: 50%; transform: translate(-50%, -50%); } .ac-game-settings-item \u003e button { color: white; width: 90%; line-height: 3vh; position: relative; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #4CAF50; border-radius: 5px; } .ac-game-settings-error-message { color: red; font-size: 0.8vh; display: inline; float: left; padding-left: 1vw; } .ac-game-settings-option { color: white; font-size: 2vh; display: inline; float: right; padding-right: 1vw; cursor: pointer; } .ac-game-settings-acwing \u003e img { position: relative; top: 50%; left: 50%; transform: translate(-50%, -50%); cursor: pointer; display: block; } .ac-game-settings-acwing \u003e div { color: white; font-size: 1.5vh; text-align: center; display: block; } .ac-game-settings-register { height: 49vh; width: 20vw; position: relative; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0, 0, 0, 0.7); border-radius: 5px; } å®ç°ç™»å½•/æ³¨å†Œçš„ç›¸äº’åˆ‡æ¢ class Settings { constructor(root) { ... } start() { this.getinfo(); this.add_listening_events(); } add_listening_events() { this.add_listening_events_login(); this.add_listening_events_register(); } add_listening_events_login() { let outer = this; this.$login_register.click(function() { outer.register(); // è·³åˆ°æ³¨å†Œç•Œé¢ }); } add_listening_events_register() { let outer = this; this.$register_login.click(function() { outer.login(); // è·³åˆ°ç™»å½•ç•Œé¢ }) } ... } å®ç°ç™»å½•åŠŸèƒ½ views/settings/login.py from django.http import JsonResponse from django.contrib.auth import authenticate, login def signin(request): data = request.GET username = data.get('username') password = data.get('password') user = authenticate(username=username, password=password) if not user: return JsonResponse({ 'result': \"ç”¨æˆ·åæˆ–å¯†ç ä¸æ­£ç¡®\" }) login(request, user) return JsonResponse({ 'result': \"success\" }) urls/settings/index.py from django.urls import path from game.views.settings.getinfo import getinfo from game.views.settings.login import signin urlpatterns = [ path(\"getinfo/\", getinfo, name=\"settings_getinfo\"), path(\"login/\", signin, name=\"settings_login\"), ] settings/zbase.js class Settings{ ... add_listening_events_login() { ... this.$login_submit.click(function() { outer.login_on_remote(); }); } ... login_on_remote() { // åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šç™»å½• let outer = this; let username = this.$login_username.val(); let password = this.$login_password.val(); this.$login_error_message.empty(); $.ajax({ url: \"https://app1117.acapp.acwing.com.cn/settings/login/\", type: \"GET\", data: { username: username, password: password, }, success: function(resp) { console.log(resp); if (resp.result === \"success\") { location.reload(); } else { outer.$login_error_message.html(resp.result); } } }); } } å®ç°ç™»å‡ºåŠŸèƒ½ views/settings/logout.py from django.http import JsonResponse from django.contrib.auth import logout def signout(request): user = request.user if not user.is_authenticated: return JsonResponse({ 'result': \"success\", }) logout(request) return JsonResponse({ 'result': \"success\", }) urls/settings/index.py ... from game.views.settings.logout import signout urlpatterns = [ ... path(\"logout/\", signout, name=\"settings_logout\"), ] settings/zbase.js ... login_on_remote() { // åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šç™»å½• let outer = this; let username = this.$login_username.val(); let password = this.$login_password.val(); this.$login_error_message.empty(); $.ajax({ url: \"https://app1117.acapp.acwing.com.cn/settings/login/\", type: \"GET\", data: { username: username, password: password, }, success: function(resp) { console.log(resp); if (resp.result === \"success\") { location.reload(); } else { outer.$login_error_message.html(resp.result); } } }); } ... å†é¡ºä¾¿å°† menu èœå•é¡µé¢é‡Œçš„ è®¾ç½® æŒ‰é’®ä¹Ÿç»‘å®šä¸Šç™»å‡ºåŠŸèƒ½\nmenu/zbase.js add_listening_events() { let outer = this; ... this.$settings_mode.click(function() { ... outer.root.settings.logout_on_remote(); }); } å®ç°æ³¨å†ŒåŠŸèƒ½ views/settings/register.py from django.http import JsonResponse from django.contrib.auth import login from django.contrib.auth.models import User from game.models.player.player import Player def register(request): data = request.GET username = data.get(\"username\", \"\").strip() password = data.get(\"password\", \"\").strip() password_confirm = data.get(\"password_confirm\", \"\").strip() if not username or not password: return JsonResponse({ 'result': \"ç”¨æˆ·åæˆ–å¯†ç ä¸èƒ½ä¸ºç©º\", }) if password != password_confirm: return JsonResponse({ 'result': \"ä¸¤ä¸ªå¯†ç ä¸ä¸€è‡´\", }) if User.objects.filter(username=username).exists(): return JsonResponse({ 'result': \"ç”¨æˆ·åå·²å­˜åœ¨\", }) user = User(username=username) user.set_password(password) user.save() Player.objects.create(user=user, photo=\"https://cdn.acwing.com/media/user/profile/photo/42832_lg_f999efc3c8.png\") login(request, user) return JsonResponse({ 'result': \"success\", }) urls/settings/index.py ... from game.views.settings.register import register ... urlpatterns = [ ... path(\"register/\", register, name=\"settings_register\"), ] settings/zbase.js ... add_listening_events_register() { ... this.$register_submit.click(function() { outer.register_on_remote(); }); } ... register_on_remote() { // åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šæ³¨å†Œ let outer = this; let username = this.$register_username.val(); let password = this.$register_password.val(); let password_confirm = this.$register_password_confirm.val(); this.$register_error_message.empty(); $.ajax({ url: \"https://app1117.acapp.acwing.com.cn/settings/register/\", type: \"GET\", data: { username: username, password: password, password_confirm: password_confirm, }, success: function(resp) { console.log(resp); if (resp.result === \"success\") { location.reload(); } else { outer.$register_error_message.html(resp.result); } } }) } ... Redisà® Redisæ˜¯ä»€ä¹ˆï¼Ÿ Redis æ˜¯ä¸€æ¬¾å†…å­˜é«˜é€Ÿç¼“å­˜æ•°æ®åº“\nä¸ºä»€ä¹ˆè¦ä½¿ç”¨Redis? æˆ‘ä»¬ç›®å‰ç”¨çš„æ˜¯Djangoè‡ªå¸¦çš„æ•°æ®åº“Sqliteã€‚Djangoæ˜¯å¾ˆå®¹æ˜“å°†æ•°æ®åº“è¿ç§»åˆ°mySQLçš„ã€‚ä½†æ˜¯å­˜å‚¨æ•ˆç‡ä¸å¦‚redisï¼Œå› ä¸ºredisæ˜¯å†…å­˜æ•°æ®åº“ï¼Œæ‰€ä»¥è°ƒç”¨ä¸œè¥¿éƒ½éå¸¸å¿«ï¼Œå­˜çš„æ˜¯ä¸€ä¸ªä¸€ä¸ªçš„ï¼Œè€Œä¸”æ˜¯å•çº¿ç¨‹çš„\nåœ¨Djangoä¸­é›†æˆRedis å®‰è£… django_redis pip install django_redis é…ç½® settings.py CACHES = { 'default': { 'BACKEND': 'django_redis.cache.RedisCache', 'LOCATION': 'redis://127.0.0.1:6379/1', \"OPTIONS\": { \"CLIENT_CLASS\": \"django_redis.client.DefaultClient\", }, }, } USER_AGENTS_CACHE = 'default' å¯åŠ¨ redis-server sudo redis-server /etc/redis/redis.conf åœ¨ Django åå°é‡Œæ“çºµ Redis $ python3 manage.py shell' In [1]: from django.core.cache import cache # å¼•å…¥redis In [2]: cache.keys('*') # æŸ¥è¯¢redisé‡Œæ‰€æœ‰çš„å…³é”®å­— Out[2]: [] In [3]: cache.set('yxc', 1, 5) # æ’å…¥ä¸€ä¸ªkey-valï¼Œå­˜åœ¨ 5 s Out[3]: True In [4]: cache.keys('*') # æŸ¥è¯¢redisé‡Œæ‰€æœ‰çš„å…³é”®å­— Out[4]: ['yxc'] In [5]: cache.set('yxc', 2, None) # æ’å…¥ä¸€ä¸ªkey-valï¼Œä¸ä¼šè¿‡æœŸ Out[5]: True In [6]: cache.set('abc', 3, None) Out[6]: True In [7]: cache.keys('y*') Out[7]: ['yxc'] In [8]: cache.has_key('abc') Out[8]: True In [9]: cache.has_key('abcd') Out[9]: False In [10]: cache.get('yxc') Out[10]: 2 In [11]: cache.delete('yxc') Out[11]: True In [12]: cache.keys('*') Out[12]: ['abc'] In [13]: Webç«¯AcWingä¸€é”®ç™»å½•à® ç”¨æˆ·ç‚¹å‡»AcWingä¸€é”®ç™»å½•ï¼Œé€šè¿‡urls \u0026 viewsè°ƒç”¨apply_codeå‡½æ•°ï¼Œå°†stateæ”¾åˆ°redisä¸­ï¼Œå°†appid \u0026 redirect_uri \u0026 scope \u0026 state ä¼ å…¥apply_code_urlé“¾æ¥ï¼Œè¿”å›å¹¶é‡å®šå‘è‡³apply_code_urlå‘ç”¨æˆ·è¯¢é—®æ˜¯å¦æˆæƒ\nç”¨æˆ·ç‚¹å‡»åŒæ„åï¼Œé‡å®šå‘è‡³redirect_urié“¾æ¥ï¼Œè¿”å›å‚æ•°ä¸ºcodeå’Œstateï¼Œé€šè¿‡urls \u0026 viewsè°ƒç”¨receive_codeå‡½æ•°\nè‹¥éªŒè¯stateå¤±è´¥ï¼Œç›´æ¥é‡å®šå‘è‡³åˆå§‹ç•Œé¢\nè‹¥éªŒè¯stateæˆåŠŸï¼Œå°†appid \u0026 code \u0026 secretå‘é€è‡³AcWingæœåŠ¡å™¨ï¼Œç”³è¯·æˆæƒä»¤ç‰Œaccess_tokenå’Œç”¨æˆ·çš„openid\nè‹¥ç”³è¯·ä»¤ç‰ŒæˆåŠŸï¼Œå°†access_token \u0026 openidå‘é€è‡³AcWingæœåŠ¡å™¨ï¼Œå¾—åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œåˆ›å»ºå¹¶ç™»å½•ç”¨æˆ·ï¼Œæœ€åé‡å®šå‘è‡³åˆå§‹ç•Œé¢\nAcAppç«¯AcWingä¸€é”®ç™»å½•à® å®ç°è”æœºå¯¹æˆ˜à® 7. å®ç°è”æœºå¯¹æˆ˜ | è®²ä¹‰ 7.1 ä¸Šè¯¾ç¬”è®° | å¤§èœç‹— 7.2 ä¸Šè¯¾ç¬”è®° | èŠèŠ± ç»Ÿä¸€é•¿åº¦å•ä½ ç”±äºè”æœºå¯¹æˆ˜çš„æ—¶å€™ï¼Œæ¯ä¸ªç”¨æˆ·çš„å®¢æˆ·ç«¯é•¿å®½ä¸ä¸€æ ·\nåœ¨ä¹‹å‰å®Œæˆçš„æ¸¸æˆç•Œé¢é‡Œï¼Œæˆ‘ä»¬ä¼šæ ¹æ®å½“å‰å®¢æˆ·ç«¯çš„å¤§å°ï¼Œè¿›è¡Œæ¸²æŸ“\nä½†æ˜¯åœ¨è”æœºå¯¹æˆ˜çš„æ—¶å€™ï¼Œåº”å½“è®©æ‰€æœ‰ç©å®¶çš„æ¸¸æˆç•Œé¢ä¿æŒåŒæ­¥æ‰å¯ä»¥\næ‰€æœ‰ï¼Œå°±å¼•å…¥äº† ç»Ÿä¸€é•¿åº¦å•ä½ çš„ç›®æ ‡\nåœ°å›¾æ¸²æŸ“ åœ°å›¾ 16:9 ç­‰æ¯”ä¾‹ç¼©æ”¾ å®ç°é€»è¾‘ï¼šæ ¹æ®å½“å‰ç”¨æˆ·çš„å®¢æˆ·ç«¯å¤§å°ï¼Œç»Ÿä¸€æ¸²æŸ“æˆ 16:9 çš„æ¸¸æˆç•Œé¢ï¼Œä¸”éšç€ç”¨æˆ·è°ƒæ•´çª—å£å¤§å°ï¼Œä¹ŸåŠ¨æ€è°ƒæ•´\njs/src/playground/zbase.js class AcGamePlayground { constructor(root) { ... this.root.$ac_game.append(this.$playground);// æœªæ¥å¯èƒ½ä¼šå¤šæ¬¡ show å› æ­¤æŠŠåˆ›å»ºåœºæ™¯æŒªåˆ°è¿™é‡Œ ... } ... start() { let outer = this; $(window).resize(function() { outer.resize(); }); } resize() { this.width = this.$playground.width(); this.height = this.$playground.height(); let unit = Math.min(this.width / 16, this.height / 9); // ä»¥æœ€å°çš„ä½œä¸ºåŸºå‡†ï¼Œæ¸²æŸ“ this.width = unit * 16; this.height = unit * 9; this.resize(); this.scale = this.height; // resizeæ—¶ï¼Œå…¶ä»–å…ƒç´ çš„æ¸²æŸ“å¤§å°éƒ½ä»¥å½“å‰æ¸²æŸ“çš„é«˜åº¦ä¸ºåŸºå‡†ï¼Œå­˜ä¸º scale å˜é‡ if (this.game_map) this.game_map.resize(); //å¦‚æœæ­¤æ—¶åœ°å›¾å·²åˆ›å»ºï¼Œåˆ™resizeä¸€ä¸‹ } show() { // æ‰“å¼€ playground ç•Œé¢ this.$playground.show(); this.resize(); ... } ... } js/src/playground/game_map/zbase.js class GameMap extends AcGameObject { ... resize() { this.ctx.canvas.width = this.playground.width; this.ctx.canvas.height = this.playground.height; } ... } åœ°å›¾å±…ä¸­ ç›´æ¥æŠŠ canvas å…ƒç´ ï¼Œç”¨ç›¸å¯¹ä½ç½®å±…ä¸­å³å¯\ncss/game.css ... .ac-game-playground { ... background-color: grey; } .ac-game-playground \u003e canvas { position: relative; top: 50%; left: 50%; transform: translate(-50%, -50%); } è§£å†³åœ°å›¾ resize æ—¶ï¼Œä¼šå‡ºç°æ¸å˜æˆé»‘è‰²çš„æƒ…å†µ åŸç”±æ˜¯å› ä¸ºæˆ‘ä»¬çš„å®ç°é€»è¾‘æ˜¯ï¼šæ¯å¸§ä¼šæ¸²æŸ“ä¸€å±‚åŠé€æ˜çš„é»‘è‰²èƒŒæ™¯\nä¹Ÿå°±é€ å°±äº†ä¸€å¼€å§‹ä¼šå‡ºç°ç°å±çš„æƒ…å†µï¼Œè§£å†³æ–¹æ³•å¾ˆç®€å•ï¼Œç›´æ¥ resize å®Œï¼Œå¼ºåˆ¶æ¶‚ä¸€å±‚ä¸é€æ˜çš„é»‘è‰²å³å¯\njs/src/playground/game_map/zbase.js class GameMap extends AcGameObject { ... resize() { this.ctx.canvas.width = this.playground.width; this.ctx.canvas.height = this.playground.height; this.ctx.fillStyle = \"rgba(0, 0, 0, 1)\"; // resize å®Œï¼Œæ¶‚ä¸€å±‚ä¸é€æ˜çš„å³å¯ this.ctx.fillRect(0, 0, this.ctx.canvas.width, this.ctx.canvas.height); } ... } å…ƒç´ æ¸²æŸ“ åœ°å›¾éšç€å°ºå¯¸ç­‰æ¯”ä¾‹æ”¾å¤§ç¼©å°çš„åŒæ—¶ï¼Œåœ°å›¾å†…çš„å…¶ä»–å…ƒç´ ä¹Ÿåº”ä¸èƒŒæ™¯ä¸€åŒç­‰æ¯”ä¾‹æ”¾å¤§ç¼©å°\nå› æ­¤ï¼Œæˆ‘ä»¬åªéœ€æŠŠå…ƒç´ å…¨éƒ¨è®¾ä¸ºç›¸å¯¹å¤§å°å³å¯ï¼Œç”¨æˆ‘ä»¬å…ˆå‰è®¾ç½®çš„ playground.scale å€¼å³å¯\nç©å®¶ Player åˆå§‹åŒ–çš„æ—¶å€™ï¼Œè½¬ä¸ºä¼ é€’ scale çš„æ¯”ä¾‹å€¼\njs/src/playground/zbase.js class AcGamePlayground { ... show() { // æ‰“å¼€ playground ç•Œé¢ ... this.players.push(new Player(this, this.width / 2 / this.scale, 0.5, 0.05, \"white\", 0.15, true)); for (let i = 0; i \u003c 5; i ++ ) { this.players.push(new Player(this, this.width / 2 / this.scale, 0.5, 0.05, this.get_random_color(), 0.15, false)); } } } js/src/playground/player/zbase.js class Player { ... start() { if (this.is_me) { ... } else { let tx = Math.random() * this.playground.width / this.playground.scale; let ty = Math.random() * this.playground.height / this.playground.scale; ... } } add_listening_events() { ... this.playground.game_map.$canvas.mousedown(function(e) { ... if (e.which === 3) { outer.move_to((e.clientX - rect.left) / outer.playground.scale, (e.clientY - rect.top) / outer.playground.scale); } else if (e.which === 1) { if (outer.cur_skill === \"fireball\") { outer.shoot_fireball((e.clientX - rect.left) / outer.playground.scale, (e.clientY - rect.top) / outer.playground.scale); } } ... }); ... } shoot_fireball(tx, ty) { let x = this.x, y = this.y; let radius = 0.01; let angle = Math.atan2(ty - this.y, tx - this.x); let vx = Math.cos(angle), vy = Math.sin(angle); let color = \"orange\"; let speed = 0.5; let move_length = 1.0; let damage = 0.01; new FireBall(this.playground, this, x, y, radius, vx, vy, color, speed, move_length, damage); } ... update() { this.update_move(); this.render(); } update_move() { // æ›´æ–°ç©å®¶ç§»åŠ¨ ... if (!this.is_me \u0026\u0026 this.spent_time \u003e 4 \u0026\u0026 Math.random() * 180 \u003c 1) { ... } if (this.damage_speed \u003e this.eps) { ... } else { if (this.move_length \u003c this.eps) { ... if (!this.is_me) { let tx = Math.random() * this.playground.width / this.playground.scale; let ty = Math.random() * this.playground.height / this.playground.scale; ... } } else { ... } } } render() { let scale = this.playground.scale; if (this.is_me) { ... this.ctx.arc(this.x * scale, this.y * scale, this.radius * scale, 0, Math.PI * 2, false); ... this.ctx.drawImage(this.img, (this.x - this.radius) * scale, (this.y - this.radius) * scale, this.radius * 2 * scale, this.radius * 2 * scale); ... } else { ... this.ctx.arc(this.x * scale, this.y * scale, this.radius * scale, 0, 2 * Math.PI, false); ... } } } ç«çƒ Fireball js/src/playground/skill/fireball/zbase.js class Fireball { ... render() { let scale = this.playground.scale; this.ctx.beginPath(); this.ctx.arc(this.x * scale, this.y * scale, this.radius * scale, 0, 2 * Math.PI, false); this.ctx.fillStyle = this.color; this.ctx.fill(); } } ç²’å­ Particle js/src/playground/particle/zbase.js class Particle { ... render() { let scale = this.playground.scale; this.ctx.beginPath(); this.ctx.arc(this.x * scale, this.y * scale, this.radius * scale, 0, 2 * Math.PI, false); this.ctx.fillStyle = this.color; this.ctx.fill(); } } å¢åŠ â€œè”æœºå¯¹æˆ˜â€æ¨¡å¼ ä¸ºäº†åŒºåˆ†ï¼šç”¨æˆ·è‡ªå·±ï¼Œæœºå™¨äººï¼Œè”æœºç©å®¶\néœ€è¦æŠŠ is_me æ”¹æˆå­—ç¬¦ä¸²ï¼Œç”¨ä»¥è¡¨ç¤ºä¸åŒ Player\nmenu/zbase.js class AcGameMenu{ ... add_listening_events() { ... this.$single_mode.click(function(){ outer.hide(); outer.root.playground.show(\"single mode\"); }); this.$multi_mode.click(function() { outer.hide(); outer.root.playground.show(\"multi mode\"); }); ... } ... } playground/zbase.js class Playground { ... show(mode) { // æ‰“å¼€ playground ç•Œé¢ ... this.players.push(new Player(this, this.width / 2 / this.scale, 0.5, 0.05, \"white\", 0.15, \"me\", this.root.settings.username, this.root.settings.photo))); if (mode === \"single mode\") { for (let i = 0; i \u003c 5; i ++ ) { this.players.push(new Player(this, this.width / 2 / this.scale, 0.5, 0.05, this.get_random_color(), 0.15, \"robot\")); } } else if (mode === \"multi mode\") { } } ... } playground/player/zbase.js class Player extends AcGameObject { constructor(playground, x, y, radius, color, speed, character, username, photo) { ... this.character = character; this.username = username; this.photo = photo; ... if (this.character !== \"robot\") { this.img = new Image(); this.img.src = this.photo; } } ... // åŒç†ï¼Œæ ¹æ®å¯¹åº”çš„é€»è¾‘ï¼Œä¿®æ”¹åé¢æ‰€æœ‰çš„ is_me ä¸º character } Django_channels è°ˆè°ˆWebsocket HTTP/TCP Django_channelsæ˜¯ä»€ä¹ˆï¼Ÿ Django_Channels æ˜¯ä¸€ä¸ªä¸ºDjango æä¾›å¼‚æ­¥æ‰©å±•çš„åº“ï¼Œé€šå¸¸ä¸»è¦ç”¨æ¥æä¾›WebSocket æ”¯æŒå’Œåå°ä»»åŠ¡\nWSS æ˜¯ Web Socket åè®®çš„å®‰å…¨æ¨¡å¼ï¼Œæ”¯æŒ C/S ä¸‹çš„åŒå‘é€šä¿¡ï¼ˆHTTPåè®®åªæ”¯æŒå•å‘é€šä¿¡ï¼‰\né…ç½®Django_channels å®‰è£… channels_redis pip install channels_redis é…ç½® acapp/asgi.py import os from channels.auth import AuthMiddlewareStack from channels.routing import ProtocolTypeRouter, URLRouter from django.core.asgi import get_asgi_application from game.routing import websocket_urlpatterns os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'acapp.settings') application = ProtocolTypeRouter({ \"http\": get_asgi_application(), \"websocket\": AuthMiddlewareStack(URLRouter(websocket_urlpatterns)) }) é…ç½® acapp/settings.py åœ¨ INSTALLED_APPS ä¸­æ·»åŠ  channels ï¼Œæ·»åŠ åå¦‚ä¸‹æ‰€ç¤ºï¼š\nINSTALLED_APPS = [ 'channels', 'game.apps.GameConfig', 'django.contrib.admin', 'django.contrib.auth', 'django.contrib.contenttypes', 'django.contrib.sessions', 'django.contrib.messages', 'django.contrib.staticfiles', ] ç„¶ååœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ï¼š\nASGI_APPLICATION = 'acapp.asgi.application' CHANNEL_LAYERS = { \"default\": { \"BACKEND\": \"channels_redis.core.RedisChannelLayer\", \"CONFIG\": { \"hosts\": [(\"127.0.0.1\", 6379)], }, }, } é…ç½® game/routing.py è¿™ä¸€éƒ¨åˆ†çš„ä½œç”¨ç›¸å½“äº http çš„ urls å†…å®¹å¦‚ä¸‹ï¼š\nfrom django.urls import path websocket_urlpatterns = [ ] ç¼–å†™ game/consumers è¿™ä¸€éƒ¨åˆ†çš„ä½œç”¨ç›¸å½“äº http çš„ views å‚è€ƒç¤ºä¾‹ï¼š\nconsumers/multiplayer/index.py from channels.generic.websocket import AsyncWebsocketConsumer import json class MultiPlayer(AsyncWebsocketConsumer): async def connect(self): await self.accept() print('accept') self.room_name = \"room\" await self.channel_layer.group_add(self.room_name, self.channel_name) async def disconnect(self, close_code): print('disconnect') await self.channel_layer.group_discard(self.room_name, self.channel_name); async def receive(self, text_data): data = json.loads(text_data) print(data) å¯åŠ¨ django_channels åœ¨ ~/acapp ç›®å½•ä¸‹æ‰§è¡Œï¼š\ndaphne -b 0.0.0.0 -p 5015 acapp.asgi:application å»ºç«‹ WSS è¿æ¥ game/routing.py from django.urls import path from game.consumers.multiplayer.index import MultiPlayer websocket_urlpatterns = [ path(\"wss/multiplayer/\", MultiPlayer.as_asgi(), name=\"wss_multiplayer\"), ] playground/zbase.js class AcGamePlayground { ... show(mode) { // æ‰“å¼€ playground ç•Œé¢ ... if (mode === \"single mode\") { ... } else if (mode === \"multi mode\") { this.mps = new MultiPlayerSocket(this); this.mps.ws.onopen = function() { outer.mps.send_create_player(); }; } } } playground/socket/multiplayer/zbase.js class MultiPlayerSocket { constructor(playground) { this.playground = playground; this.ws = new WebSocket(\"wss://app1117.acapp.acwing.com.cn/wss/multiplayer/\"); this.start(); } start() { } send_create_player() { this.ws.send(JSON.stringify({ 'message': 'hello acapp server', })); } receive_create_player() { } } ç¼–å†™åŒæ­¥å‡½æ•° ä¸€å…±éœ€è¦å®Œæˆå››ä¸ªé€šä¿¡ï¼š\nï¼ˆé€šä¿¡çš„é€»è¾‘åŸºæœ¬éƒ½æ˜¯å…ˆåœ¨æœ¬åœ°å®Œæˆï¼Œç„¶åå°†ç»“æœè¿”å›ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å†åˆ†å‘ç»™å…¶ä»–å®¢æˆ·ç«¯ï¼Œè¾¾æˆåŒæ­¥ï¼‰\ncreate-player : åœ¨æ‰€æœ‰ç©å®¶çš„æ¸¸æˆç•Œé¢ï¼Œåˆ›å»ºä¸€ä¸ªæ–°åŠ å…¥çš„ç©å®¶ move-to : åœ¨æ‰€æœ‰ç©å®¶çš„æ¸¸æˆç•Œé¢ï¼Œå°†ä¸€ä¸ªè§’è‰²ç§»åŠ¨åˆ°ä¸€ä¸ªä½ç½® shoot-fireball : åœ¨æ‰€æœ‰ç©å®¶çš„æ¸¸æˆç•Œé¢ï¼Œè®©ä¸€ä¸ªè§’è‰²å‘å°„ä¸€ä¸ªç«çƒ attack : åœ¨æ‰€æœ‰ç©å®¶çš„æ¸¸æˆç•Œé¢ï¼Œè®©ä¸€ä¸ªè§’è‰²è¢«æ”»å‡» ä¸€åœºæ¸¸æˆé‡Œï¼Œæ‰€æœ‰çš„å…ƒç´ ï¼ˆç©å®¶ï¼Œç«çƒç­‰ï¼‰éƒ½éœ€è¦å”¯ä¸€çš„æ ‡è¯†ï¼Œæ¥æ–¹ä¾¿åŒæ­¥\nä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä¿®æ”¹ä¸€ä¸‹æ¸¸æˆå¼•æ“ï¼Œå¯¹äºæ¯ä¸ªå…ƒç´ éƒ½åˆ›å»ºæˆ‘ä»¬éœ€è¦çš„å”¯ä¸€æ ‡è¯†\nplayground/ac-game-object/zbase.js class AcGameObject { constructor() { ... this.uuid = this.create_uuid(); } create_uuid() { let res = \"\"; for (let i = 0; i \u003c 8; i ++ ) { let x = parseInt(Math.floor(Math.random() * 10)); // [0, 10) res += x; } return res; ... } playground/zbase.js class AcGamePlayground { ... show(mode) { ... if (mode === \"single mode\") { ... } else if (mode === \"multi mode\") { this.mps = new MultiPlayerSocket(this); this.mps.uuid = this.players[0].uuid; this.mps.ws.onopen = function() { outer.mps.send_create_player(); }; } } ... } playground/socket/multiplayer/zbase.js class MultiPlayerSocket { ... send_create_player() { let outer = this; this.ws.send(JSON.stringify({ 'event': 'create_player', 'uuid': outer.uuid, })); } } æ¥ç€ï¼Œåˆ©ç”¨é€šä¿¡çš„æ–¹å¼ï¼Œä½¿å¾—æ¯ä¸ªçª—å£å†…ï¼Œé€»è¾‘ä¸Šç›¸åŒçš„å…ƒç´ ï¼Œå…¶ uid ä¹Ÿç›¸åŒå³å¯\nåŸåˆ™æ˜¯ï¼šå“ªä¸ªçª—å£åˆ›å»ºçš„å…ƒç´ ï¼Œå°±ç”¨ä»–åˆ›å»ºæ—¶çš„ uid ä½œä¸ºæ•´ä¸ªé¡¹ç›®è¿è¡Œæ—¶çš„ uid\nç„¶åï¼Œæˆ‘ä»¬æ‰“ç®—ç”¨ redis æ¥å®ç°å­˜å‚¨æ¯ä¸ªæ¸¸æˆæˆ¿é—´ï¼Œä»¥åŠå…ƒç´ ï¼Œå¹¶åˆå§‹é»˜è®¤è®¾å®šæ¯ä¸ªæˆ¿é—´ä¸Šé™ 3 äºº\ncreate-player å‰ç«¯ game/static/js/src/playground/socket/multiplayer/zbase.js class MultiPlayerSocket { constructor(playground) { this.playground = playground; this.ws = new WebSocket(\"wss://app1117.acapp.acwing.com.cn/wss/multiplayer/\"); this.start(); } start() { this.receive(); } receive() { let outer = this; this.ws.onmessage = function(e) { let data = JSON.parse(e.data); let uuid = data.uuid; if (uuid === outer.uuid) return false; let event = data.event; if (event === \"create_player\") { outer.receive_create_player(uuid, data.username, data.photo); } }; } send_create_player(username, photo) { let outer = this; this.ws.send(JSON.stringify({ 'event': 'create_player', 'uuid': outer.uuid, 'username': username, 'photo': photo, })); } receive_create_player(uuid, username, photo) { let player = new Player( this.playground, this.playground.width / 2 / this.playground.scale, 0.5, 0.05, \"white\", 0.15, \"enemy\", username, photo, ); player.uuid = uuid; this.playground.players.push(player); } } åç«¯ settings.py ... ROOM_CAPACITY = 3 consumers/multiplayer/index.py from channels.generic.websocket import AsyncWebsocketConsumer import json from django.conf import settings from django.core.cache import cache class MultiPlayer(AsyncWebsocketConsumer): async def connect(self): self.room_name = None for i in range(1000): # ä¸Šé™ 1k ä¸ªæˆ¿é—´ name = \"room-%d\" % (i) # å½“å‰æˆ¿é—´ä¸ºç©ºï¼Œæˆ–æˆ¿é—´å†…ç©å®¶äººæ•°ä¸åˆ° ROOM_CAPACITY if not cache.has_key(name) or len(cache.get(name)) \u003c settings.ROOM_CAPACITY: self.room_name = name break if not self.room_name: return await self.accept() if not cache.has_key(self.room_name): # å¦‚æœæˆ¿é—´ä¸å­˜åœ¨ï¼Œåˆ™æ–°å»ºæˆ¿é—´ cache.set(self.room_name, [], 3600) # æœ‰æ•ˆæœŸ 1 å°æ—¶ for player in cache.get(self.room_name): # å¯¹è¯¥æˆ¿é—´å·²å­˜åœ¨çš„ç”¨æˆ·ï¼Œåˆ›å»ºåˆ°æ–°åŠ å…¥çš„ç”¨æˆ·çš„æ¸¸æˆç•Œé¢ä¸­ await self.send(text_data=json.dumps({ 'event': \"create_player\", 'uuid': player['uuid'], 'username': player['username'], 'photo': player['photo'], })) await self.channel_layer.group_add(self.room_name, self.channel_name) async def disconnect(self, close_code): print('disconnect') await self.channel_layer.group_discard(self.room_name, self.channel_name); async def create_player(self, data): players = cache.get(self.room_name) players.append({ 'uuid': data['uuid'], 'username': data['username'], 'photo': data['photo'], }) cache.set(self.room_name, players, 3600) # æ›´æ–°æˆ¿é—´å­˜åœ¨æ—¶é—´ä¸º 1 å°æ—¶ï¼ˆæœ€åä¸€æ¬¡åŠ å…¥ä¸€åç©å®¶æ—¶ï¼‰ # ç¾¤å‘æ¶ˆæ¯æ›´æ–° await self.channel_layer.group_send( self.room_name, { 'type': \"group_create_player\", # ç¾¤å‘è¯¥æ¶ˆæ¯åï¼Œä½œä¸ºå®¢æˆ·ç«¯æ¥å—è€…ï¼Œæ‰€æ¥å—ç”¨çš„å‡½æ•°å 'event': \"create_player\", 'uuid': data['uuid'], 'username': data['username'], 'photo': data['photo'], } ) async def group_create_player(self, data): await self.send(text_data=json.dumps(data)) async def receive(self, text_data): data = json.loads(text_data) event = data['event'] if event == \"create_player\": await self.create_player(data) redis è°ƒè¯•è¯­å¥ æ‰“å¼€ shell äº¤äº’\npython3 manage.py shell ç„¶åç”¨ py3 äº¤äº’è¿›è¡Œ cache è°ƒè¯•\nfrom django.core.cache import cache def clear(): for key in cache.keys('*'): cache.delete(key) cache.keys('*') # æŸ¥è¯¢å½“å‰ redis ä¸­æ‰€æœ‰ key cache.get('room-1') # æŸ¥è¯¢å½“å‰ redis ä¸­ key ä¸º room-1 çš„å€¼ åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä¾¿å¯ä»¥åœ¨ä¸åŒçš„çª—å£æ¸²æŸ“åŒä¸€æ‰¹ç©å®¶äº†\nmove-to å‰ç«¯ å®¢æˆ·ç«¯çš„é€šä¿¡çš„å‘å‡ºå’Œæ¥å—å‡½æ•°\ngame/static/js/src/playground/socket/multiplayer/zbase.js class MultiPlayerSocket { ... receive() { let outer = this; this.ws.onmessage = function(e) { ... else if (event === \"move_to\") { outer.receive_move_to(uuid, data.tx, data.ty); } }; } send_move_to(tx, ty) { let outer = this; this.ws.send(JSON.stringify({ 'event': 'move_to', 'uuid': outer.uuid, 'tx': tx, 'ty': ty, })); } get_player(uuid) { let players = this.playground.players; for (let i = 0; i \u003c players.length; i ++ ) { let player = players[i]; if (player.uuid === uuid) { return player; } } return null; } receive_move_to(uuid, tx, ty) { let player = this.get_player(uuid); if (player) { player.move_to(tx, ty); } } } ä¸ºäº†è®©æ¸¸æˆç•Œé¢ä¸­å¯¹äºè¦ç§»åŠ¨çš„å…ƒç´ åšå‡ºç§»åŠ¨åŠ¨ä½œï¼Œéœ€è¦å¯¹ move_to å‡½æ•°åšå‡ºä¸€äº›ä¿®æ”¹\né¦–å…ˆè¦æ ‡è¯†å‡ºå½“å‰ä¸ºå¤šäººæ¨¡å¼ï¼Œç„¶åæ¨¡å¼ä¸ºå¤šäººæ¨¡å¼æ—¶ï¼Œæ¯æ¬¡ç§»åŠ¨éƒ½ä¼šè§¦å‘ä¸€æ¬¡é€šä¿¡\nplayground/zbase.js class AcGamePlayground { ... show(mode) { ... this.mode = mode; } } playground/player/zbase.js class Player extends AcGameObject { ... add_listening_events() { ... this.playground.game_map.$canvas.mousedown(function(e) { ... if (e.which === 3) { let tx = (e.clientX - rect.left) / outer.playground.scale; let ty = (e.clientY - rect.top) / outer.playground.scale; outer.move_to(tx, ty); if (outer.playground.mode === \"multi mode\") { outer.playground.mps.send_move_to(tx, ty); } } ... } ... } åç«¯ consumers/multiplayer/index.py async def move_to(self, data): await self.channel_layer.group_send( self.room_name, { 'type': \"group_send_event\", 'event': \"move_to\", 'uuid': data['uuid'], 'tx': data['tx'], 'ty': data['ty'], } ) async def group_send_event(self, data): await self.send(text_data=json.dumps(data)) async def receive(self, text_data): data = json.loads(text_data) event = data['event'] if event == \"create_player\": await self.create_player(data) elif event == \"move_to\": await self.move_to(data) shoot-fireball å‰ç«¯ ç”¨ä¸€ä¸ªæ•°ç»„æ¥å­˜ä¸€ä¸ªç©å®¶å‘å°„çš„æ‰€æœ‰ç«çƒï¼Œä»¥ä¾¿äºå­å¼¹æ¶ˆå¤±æ—¶ï¼Œå°†ä»–ä»¬æ‰¾å‡ºå¹¶å¯¹åº”åˆ æ‰\nplayground/player/zbase.js class Player extends AcGameObject { constructor(playground, x, y, radius, color, speed, character, username, photo) { ... this.fireballs = []; // å­˜è¯¥ç”¨æˆ·å‘å°„çš„æ‰€æœ‰ç«çƒ } add_listening_events() { ... this.playground.game_map.$canvas.mousedown(function(e) { ... else if (e.which === 1) { let tx = (e.clientX - rect.left) / outer.playground.scale; let ty = (e.clientY - rect.top) / outer.playground.scale; if (outer.cur_skill === \"fireball\") { let fireball = outer.shoot_fireball(tx, ty); if (outer.playground.mode === \"multi mode\") { outer.playground.mps.send_shoot_fireball(tx, ty, fireball.uuid); } } } ... }); $(window).keydown(function(e) { if (e.which === 81) { // é”®ç›˜æŒ‰ä¸‹qäº‹ä»¶ outer.cur_skill = \"fireball\"; return false; } }); } ... shoot_fireball(tx, ty) { ... let fireball = new FireBall(this.playground, this, x, y, radius, vx, vy, color, speed, move_length, damage); this.fireballs.push(fireball); return fireball; } destroy_fireball(uuid) { for (let i = 0; i \u003c this.fireballs.length; i ++ ) { let fireball = this.fireballs[i]; if (fireball.uuid == uuid) { fireball.destroy(); break; } } } ... playground/skill/fireball/zbase.js class FireBall extends AcGameObject { ... on_destory() { let fireballs = this.player.fireballs; for (let i = 0; i \u003c fireballs.length; i ++ ) { if (fireballs[i] === this) { fireballs.splice(i, 1); break; } } } } game/static/js/src/playground/socket/multiplayer/zbase.js class MultiPlayerSocket { ... send_shoot_fireball(tx, ty, ball_uuid) { let outer = this; this.ws.send(JSON.stringify({ 'event': 'move_to', 'uuid': outer.uuid, 'tx': tx, 'ty': ty, 'ball_uuid': ball_uuid; })); } receive_shoot_fireball(uuid, tx, ty, ball_uuid) { let player = this.get_player(uuid); if (player) { let fireball = player.shoot_fireball(tx, ty); fireball.uuid = ball_uuid; } } } åç«¯ consumers/multiplayer/index.py ... class MultiPlayer(AsyncWebsocketConsumer): ... async def shoot_fireball(self, data): await self.channel_layer.group_send( self.room_name, { 'type': \"group_send_event\", 'event': \"shoot_fireball\", 'uuid': data['uuid'], 'tx': data['tx'], 'ty': data['ty'], 'ball_uuid': data['ball_uuid'], } ) async def receive(self, text_data): ... elif event == \"shoot_fireball\": await self.shoot_fireball(data) attack ä¸ºäº†åªè®©ä¸€ä¸ªå®¢æˆ·ç«¯è¿›è¡Œæ”»å‡»å‘½ä¸­çš„åˆ¤æ–­ï¼Œå› æ­¤åªæœ‰å‘å‡ºæ–¹çš„ç«çƒæ‰åšç¢°æ’æ£€æµ‹\nå…¶ä»–å®¢æˆ·ç«¯å¯¹äºè¯¥ç«çƒåªæœ‰åŠ¨ç”»æ•ˆæœ\nåˆç”±äºç¢°æ’æ£€æµ‹æ˜¯åœ¨ä¸€å°å®¢æˆ·ç«¯ä¸Šè¿›è¡Œçš„ï¼Œå› æ­¤å¤šç«¯ä¹‹é—´å¯èƒ½ä¼šå­˜åœ¨åŒæ­¥ä¸Šçš„å»¶è¿Ÿ\nä¸ºæ­¤çš„è§£å†³æ–¹æ³•æ˜¯ï¼šç¢°æ’æ£€æµ‹æˆåŠŸæ—¶ï¼Œå¼ºåˆ¶æŠŠè¢«å‡»ä¸­ç©å®¶ç§»åŠ¨åˆ°å‘èµ·æ–¹å®¢æˆ·ç«¯ä¸­çš„ä½ç½®ï¼Œä»¥é¿å…å‡»ä¸­å»¶è¿Ÿä¸Šå‘ç”Ÿçš„äº‹æƒ…\nå‰ç«¯ playground/skill/fireball/zbase.js class FireBall extends AcGameObject { update() { if (this.move_length \u003c this.eps) { this.destroy(); return false; } this.update_move(); if (this.player.character !== \"enemy\") { this.update_attack(); } this.render(); } attack(player) { ... if (this.playground.mode === \"multi mode\") { this.playground.mps.send_attack(player.uuid, player.x, player.y, angle, this.damage, this.uuid); } ... } ... } playground/player/zbase.js class Player extends AcGameObject { ... receive_attack(x, y, angle, damage, ball_uuid, attacker) { attacker.destroy_fireball(ball_uuid); this.x = x; this.y = y; this.is_attacked(angle, damage); } ... } game/static/js/src/playground/socket/multiplayer/zbase.js class MultiPlayerSocket { ... send_attack(attackee_uuid, x, y, angle, damage, ball_uuid) { let outer = this; this.ws.send(JSON.stringify({ 'event': \"attack\", 'uuid': outer.uuid, 'attackee_uuid': attackee_uuid, 'x': x, 'y': y, 'angle': angle, 'damage': damage, 'ball_uuid': ball_uuid, })); } receive_attack(uuid, attackee_uuid, x, y, angle, damage, ball_uuid) { let attacker = this.get_player(uuid); let attackee = this.get_player(attackee_uuid); if (attacker \u0026\u0026 attackee) { attackee.receive_attack(x, y, angle, damage, ball_uuid, attacker); } } } åç«¯ consumers/multiplayer/index.py ... class MultiPlayer(AsyncWebsocketConsumer): ... async def attack(self, data): await self.channel_layer.group_send( self.room_name, { 'type': \"group_send_event\", 'event': \"attack\", 'uuid': data['uuid'], 'x': data['x'], 'y': data['y'], 'angle': data['angle'], 'damage': data['damage'], 'ball_uuid': data['ball_uuid'], } ) ... æ¸¸æˆçš„å°ä¼˜åŒ– å¤šäººæ¨¡å¼ä¸‹æ¸¸æˆæ²¡æœ‰å¼€å§‹å‰ï¼Œç©å®¶ä¸å¯ä»¥ç§»åŠ¨ ä¸ºæ­¤æˆ‘ä»¬å…ˆå¼•å…¥ä¸€ä¸ªçŠ¶æ€æœºï¼š'waiting' -\u003e 'fighting' -\u003e 'over' æ¥æ ‡è¯†å½“å‰æ¸¸æˆè¿›è¡Œçš„çŠ¶æ€\nç„¶åç”¨ä¸€ä¸ª notice_board è®¡åˆ†æ¿åœ¨å‰ç«¯æ˜¾ç¤ºå‡ºæ¥\nå®ç°çš„é€»è¾‘å°±æ˜¯ï¼šæ¸¸æˆåˆå§‹æ—¶ä¸º waiting çŠ¶æ€ï¼Œæˆ¿é—´å†…äººæ•°æ»¡ 3 äººæ—¶ï¼Œæ‰ä¼šè¿›å…¥ fightingï¼Œè§’è‰²æ­»äº¡æ—¶ä¸º over\nä¸”å‘å°„ç«çƒï¼Œç§»åŠ¨ç­‰è¡Œä¸ºï¼Œå½“ä¸”ä»…å½“ç©å®¶çŠ¶æ€ä¸º fighting æ—¶ï¼Œæ‰å¯ä»¥åš\nç„¶åè®¾å®šç«çƒæŠ€èƒ½çš„ cd ä¸º 3 ç§’ï¼Œä¸”åœ¨æ¸¸æˆè¿›å…¥ fighting æ—¶ï¼Œå…ˆè‡ªåŠ¨è¿›å…¥ cd çŠ¶æ€\nè¿™æ ·å°±å®ç°äº†åˆå§‹ 3 ç§’å†…ï¼Œä»»ä½•ç©å®¶ä¸å¯æ”»å‡»\njs/src/playground/notice_board/zbase.js class NoticeBoard extends AcGameObject { constructor(playground) { super(); this.playground = playground; this.ctx = this.playground.game_map.ctx; this.text = \"å·²å°±ç»ªï¼š0äºº\"; } start() { } write(text) { this.text = text; } update() { this.render(); } render() { this.ctx.font = \"20px serif\"; this.ctx.fillStyle = \"white\"; this.ctx.textAlign = \"center\"; this.ctx.fillText(this.text, this.playground.width / 2, 20); } } js/src/playground/zbase.js class AcGamePlayground { ... show(mode) { ... this.state = \"waiting\"; // waiting -\u003e fighting -\u003e over this.notice_board = new NoticeBoard(this); this.player_count = 0; ... } } js/src/playground/player/zbase.js class Player extends AcGameObject { ... add_listening_events() { ... this.playground.game_map.$canvas.mousedown(function(e) { if (outer.playground.state !== \"fighting\") return false; ... } $(window).keydown(function(e) { if (outer.playground.state !== \"fighting\") return false; ... }); } start() { this.playground.player_count ++ ; this.playground.notice_board.write(\"å·²å°±ç»ªï¼š\" + this.playground.player_count + \"äºº\"); if (this.playground.player_count \u003e= 3) { this.playground.state = \"fighting\"; this.playground.notice_board.write(\"Fighting\"); } ... } ... } æŠ€èƒ½CD ç»™ç«çƒæŠ€èƒ½è®¾ç½® 3s çš„ cdï¼Œå®ç°é€»è¾‘å¾ˆç®€å•ï¼Œè®¾å®šä¸€ä¸ª cool_time å˜é‡ï¼Œæ¯æ¬¡æ¸²æŸ“çš„æ—¶å€™å‡å»ä¸Šæ¬¡æ¸²æŸ“çš„æ—¶é—´é—´éš”\nç„¶å cool_time ä¸º 0 æ—¶ï¼ŒæŠ€èƒ½æ‰å¯ä»¥æˆåŠŸé‡Šæ”¾\nå¦å¤–ä¿®æ”¹å†·å´æ—¶é—´ï¼Œåªç”¨ä¿®æ”¹è‡ªå·±çš„å³å¯\njs/src/playground/player/zbase.js class Player extends AcGameObject { constructor(...) { ... if (this.character === \"me\") { this.fireball_coldtime = 3; // å•ä½ï¼šs } } ... add_listening_events() { ... this.playground.game_map.$canvas.mousedown(function(e) { ... else if (e.which === 1) { ... if (outer.cur_skill === \"fireball\") { ... if (outer.playground.mode === \"multi mode\") { outer.playground.mps.send_shoot_fireball(tx, ty, fireball.uuid); } outer.fireball_coldtime = 3; } } ... }); $(window).keydown(function(e) { ... if (outer.fireball_coldtime \u003e= outer.eps) return false; ... }); } update() { ... if (this.character === \"me\" \u0026\u0026 this.playground.state === \"fighting\") { this.update_coldtime(); } ... } update_coldtime() { this.fireball_coldtime -= this.timedelta / 1000; this.fireball_coldtime = Math.max(0, this.fireball_coldtime); } ... } ç”¨å›¾ç‰‡æ¥æ¸²æŸ“æŠ€èƒ½CD js/src/playground/player/zbase.js class Player extends AcGameObject { constructor(...) { ... if (this.character === \"me\") { this.fireball_coldtime = 3; // å•ä½ï¼šs this.fireball_img = new Image(); this.fireball_img.src = \"https://cdn.acwing.com/media/article/image/2021/12/02/1_9340c86053-fireball.png\"; } } ... render() { ... if (this.character === \"me\" \u0026\u0026 this.playground.state === \"fighting\") { this.render_skill_coldtime(); } } render_skill_coldtime() { let scale = this.playground.scale; let x = 1.5, y = 0.9, r = 0.04; // æ¸²æŸ“æŠ€èƒ½å›¾æ ‡ this.ctx.save(); this.ctx.beginPath(); this.ctx.arc(x * scale, y * scale, r * scale, 0, Math.PI * 2, false); this.ctx.stroke(); this.ctx.clip(); this.ctx.drawImage(this.fireball_img, (x - r) * scale, (y - r) * scale, r * 2 * scale, r * 2 * scale); this.ctx.restore(); // æ¸²æŸ“å†·å´æŒ‡ç¤º if (this.fireball_coldtime \u003e= this.eps){ this.ctx.beginPath(); this.ctx.moveTo(x * scale, y * scale); this.ctx.arc(x * scale, y * scale, r * scale, 0 - Math.PI / 2, Math.PI * 2 * (1 - this.fireball_coldtime / 3) - Math.PI / 2, true); this.ctx.lineTo(x * scale, y * scale); this.ctx.fillStyle = \"rgba(0, 0, 255, 0.6)\"; this.ctx.fill(); } } ... æ·»åŠ ä¸€ä¸ªé—ªç°æŠ€èƒ½ å•æœºéƒ¨åˆ† js/src/playground/player/zbase.js class Player extends AcGameObject { constructor(...) { ... if (this.character === \"me\") { ... this.blink_coldtime = 5; this.blink_img = new Image(); this.blink_img.src = \"https://cdn.acwing.com/media/article/image/2021/12/02/1_daccabdc53-blink.png\"; } } add_listening_events() { ... this.playground.game_map.$canvas.mousedown(function(e) { ... else if (e.which === 1) { ... else if (outer.cur_skill === \"blink\") { outer.blink(tx, ty); // åŒæ­¥å‡½æ•° if (outer.playground.mode === \"multi mode\") { outer.playground.mps.send_blink(tx, ty); } outer.blink_coldtime = 5; } } outer.cur_skill = null; // æ¸…ç©ºå½“å‰æŠ€èƒ½ }); $(window).keydown(function(e) { ... else if (e.which === 70) { // fé”® if (outer.blink_coldtime \u003e= outer.eps) return true; outer.cur_skill = \"blink\"; return false; } }); } ... blink(tx, ty) { let d = this.get_dist(this.x, this.y, tx, ty); d = Math.min(d, 0.5); let angle = Math.atan2(ty - this.y, tx - this.x); this.x += d * Math.cos(angle); this.y += d * Math.sin(angle); this.move_length = 0; // é—ªç°å®Œåœä¸‹æ¥ } ... render_skill_coldtime() { ... x = 1.62, y = 0.9, r = 0.04; // é—ªç°æŠ€èƒ½ // æ¸²æŸ“æŠ€èƒ½å›¾æ ‡ this.ctx.save(); this.ctx.beginPath(); this.ctx.arc(x * scale, y * scale, r * scale, 0, Math.PI * 2, false); this.ctx.stroke(); this.ctx.clip(); this.ctx.drawImage(this.blink_img, (x - r) * scale, (y - r) * scale, r * 2 * scale, r * 2 * scale); this.ctx.restore(); // æ¸²æŸ“å†·å´æŒ‡ç¤º if (this.blink_coldtime \u003e= this.eps){ this.ctx.beginPath(); this.ctx.moveTo(x * scale, y * scale); this.ctx.arc(x * scale, y * scale, r * scale, 0 - Math.PI / 2, Math.PI * 2 * (1 - this.blink_coldtime / 5) - Math.PI / 2, true); this.ctx.lineTo(x * scale, y * scale); this.ctx.fillStyle = \"rgba(0, 0, 255, 0.6)\"; this.ctx.fill(); } } } è”æœºéƒ¨åˆ† game/static/js/src/playground/socket/multiplayer/zbase.js class MultiPlayerSocket { ... send_blink(tx, ty) { let outer = this; this.ws.send(JSON.stringify({ 'event': \"blink\", 'uuid': outer.uuid, 'tx': tx, 'ty': ty, })); } receive_blink(uuid, tx, ty) { let player = this.get_player(uuid); if (player) { player.blink(tx, ty); } } } consumers/multiplayer/index.py ... class MultiPlayer(AsyncWebsocketConsumer): ... async def blink(self, data): await self.channel_layer.group_send( self.room_name, { 'type': \"group_send_event\", 'event': \"blink\", 'uuid': data['uuid'], 'tx': data['tx'], 'ty': data['ty'], } ) å®ç°èŠå¤©ç³»ç»Ÿà® 8.1 ä¸Šè¯¾ç¬”è®° | å¤§èœç‹— ä¼˜åŒ–é”®ç›˜ç»‘å®šäº‹ä»¶ è¿™éƒ¨åˆ†ç®—æ˜¯ä¹‹å‰çš„é—ç•™é—®é¢˜ï¼Œå…ˆå‰çš„ keydown ç›‘å¬äº‹ä»¶ç»‘å®šåœ¨äº† window ä¸Šä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜\nå¦‚æœåœ¨ä¸€ä¸ªæµè§ˆå™¨å†…æ‰“å¼€å¤šä¸ª ACAPPï¼Œæ­¤æ—¶æŒ‰ä¸‹é”®ä½è§¦å‘ keydown äº‹ä»¶ï¼Œä¼šè¢«æµè§ˆå™¨å†…æ‰€æœ‰çš„ ACAPP éƒ½æ•è·åˆ°\nä¹‹å‰å½±å“ä¸å¤§ï¼Œä½†å¯¹æ­¤æ¬¡è¦å®ç°çš„èŠå¤©ç³»ç»Ÿå°±æœ‰ç€è‡´å‘½çš„å½±å“ï¼Œå³æ‰“å¼€ä¸€ä¸ª ACAPP çš„èŠå¤©æ ï¼Œå…¶ä»–éƒ½ä¼šè¢«æ‰“å¼€\næ‰€æœ‰æˆ‘ä»¬è¦å°† keydown ç›‘å¬äº‹ä»¶ç»‘å®šåˆ° canvas ä¸Š\nplayground/player/zbase.js class Player extends AcGameObject { ... add_listening_events() { ... this.playground.game_map.$canvas.keydown(function(e) { if (outer.playground.state !== \"fighting\") return true; if (e.which === 81) { // é”®ç›˜æŒ‰ä¸‹qäº‹ä»¶ if (outer.fireball_coldtime \u003e= outer.eps) return true; outer.cur_skill = \"fireball\"; return false; } else if (e.which === 70) { // fé”® if (outer.blink_coldtime \u003e= outer.eps) return true; outer.cur_skill = \"blink\"; return false; } }); } } playground/game-map/zbase.js class GameMap extends AcGameObject { constructor(playground) { ... this.$canvas = $(``); ... } start() { this.$canvas.focus(); } } æœ¬åœ°å‰ç«¯ è¦å®ç°ä¸¤ä¸ªéƒ¨åˆ†ï¼š 1. æ–‡æœ¬è¾“å…¥æ¡†ï¼ˆè®©ç”¨æˆ·è¾“å…¥è¦å‘é€çš„ä¿¡æ¯ï¼‰ 2. å†å²è®°å½•æ˜¾ç¤ºæ¡†ï¼ˆä¹‹å‰ç”¨æˆ·å‘é€çš„ä¿¡æ¯çš„æ˜¾ç¤ºæ¡†ï¼‰\næ¬²å®ç°é€»è¾‘ï¼šç”¨æˆ·æŒ‰ä¸‹ åï¼Œæ¸¸æˆç•Œé¢å¼¹å‡ºæ–‡æœ¬è¾“å…¥æ¡†ï¼Œç„¶åèšç„¦äºæ–‡æœ¬è¾“å…¥æ¡†ï¼Œä¸”åŒæ—¶å¼¹å‡ºå†å²è®°å½•æ˜¾ç¤ºæ¡† 3 ç§’\nç„¶åç”¨æˆ·è¾“å…¥ä¿¡æ¯åï¼ŒæŒ‰ä¸‹ åå‘å‡ºä¿¡æ¯ï¼Œæ¥ç€ä¿¡æ¯ä¼šæ˜¾ç¤ºåœ¨å†å²è®°å½•æ˜¾ç¤ºæ¡†æœ€ä¸‹æ–¹ï¼Œå¹¶å¼¹å‡ºå†å²è®°å½•æ˜¾ç¤ºæ¡† 3 ç§’\nplayground/chat_field/zbase.js chat field è´Ÿè´£ç®¡ç† æ–‡æœ¬è¾“å…¥æ¡† å’Œ å†å²è®°å½•æ˜¾ç¤ºæ¡†\nclass ChatField { constructor(playground) { this.playground = playground; this.$history = $(``); this.$input = $(``); this.$history.hide(); this.$input.hide(); this.func_id = null; this.playground.$playground.append(this.$history); this.playground.$playground.append(this.$input); this.start(); } start() { this.add_listening_events(); } add_listening_events() { let outer = this; this.$input.keydown(function(e) { if (e.which === 27) { //ESC outer.hide_input(); return false; } else if (e.which === 13) { let username = outer.playground.root.settings.username; let text = outer.$input.val(); if (text) { outer.$input.val(\"\"); outer.add_message(username, text); } return false; } }); } show_history() { let outer = this; this.$history.fadeIn(); if (this.func_id) clearTimeout(this.func_id); this.func_id = setTimeout(function() { outer.$history.fadeOut(); outer.func_id = null; }, 3000); } render_message(message) { return $(`${message}`); } add_message(username, text) { this.show_history(); let message = `[${username}] ${text}`; this.$history.append(this.render_message(message)); this.$history.scrollTop(this.$history[0].scrollHeight); } show_input() { this.show_history(); this.$input.show(); this.$input.focus(); // è¾“å…¥æ—¶ï¼Œèšç„¦äºè¾“å…¥æ¡† } hide_input() { this.$input.hide(); this.playground.game_map.$canvas.focus(); // é€€å‡ºæ—¶ï¼Œèšç„¦å›æ¸¸æˆç•Œé¢ } } playground/zbase.js æŠŠå®ƒåˆ›å»ºå‡ºæ¥\nclass AcGamePlayground { ... show(mode) { //æ‰“å¼€ playground ç•Œé¢ ... else if (mode === \"multi mode\") { this.chat_field = new ChatField(this); ... } } } playground/player/zbase.js æ·»åŠ ç›‘å¬äº‹ä»¶\nclass Player extends AcGameObject { ... add_listening_events() { ... this.playground.game_map.$canvas.keydown(function(e) { if (e.which === 13) { // enter (æ˜¾ç¤ºå¯¹è¯æ¡†) if (outer.playground.mode === \"multi mode\") { outer.playground.chat_field.show_input(); return false; } } else if (e.which === 27) { // escï¼ˆå…³é—­å¯¹è¯æ¡†ï¼‰ if (outer.playground.mode === \"multi mode\") { outer.playground.char_field.hide_input(); return false; } } ... } } } game.css ... .ac-game-chat-field-history { position: absolute; top: 66%; left: 20%; transform: translate(-50%, -50%); width: 20%; height: 32%; color: white; font-size: 2vh; padding: 5px; overflow: auto; } .ac-game-chat-field-history::-webkit-scrollbar { width: 0; } .ac-game-chat-field-input { position: absolute; top: 86%; left: 20%; transform: translate(-50%, -50%); width: 20%; height: 3vh; color: white; font-size: 2vh; background-color: rgba(222,225,230, 0.2); } è”æœºèŠå¤©çª— å‰ç«¯ playground/chat_field/zbase.js class ChatField { ... add_listening_events() { ... this.$input.keydown(function(e) { ... else if (e.which === 13) { ... if (text) { ... outer.playground.mps.send_message(text); } ... } }); } ... } js/src/playground/socket/multiplayer/zbase.js class MultiPlayerSocket { ... send_message(text) { let outer = this; this.ws.send(JSON.stringify({ 'event': \"message\", 'uuid': outer.uuid, 'username': outer.playground.root.settings.username, 'text': text, })); } receive_message(username, text) { this.playground.chat_field.add_message(username, text); } } åç«¯ consumers/multiplayer/index.py ... class MultiPlayer(AsyncWebsocketConsumer): ... async def message(self, data): await self.channel_layer.group_send( self.room_name, { 'type': \"group_send_event\", 'event': \"message\", 'uuid': data['uuid'], 'username': data['username'], 'text': data['text'], } ) å®ç°åŒ¹é…ç³»ç»Ÿà® 9. å®ç°åŒ¹é…ç³»ç»Ÿ | è®²ä¹‰ 9.1 ä¸Šè¯¾ç¬”è®° | ä¸€åªé‡ç”Ÿå½©è‰²é“…ç¬” æœ¬ç« èŠ‚å†…å®¹æ˜¯åˆ©ç”¨ thrift åˆ›å»ºå®¢æˆ·ç«¯-æœåŠ¡ç«¯äº¤äº’çš„æ¥å£\nç„¶ååˆ©ç”¨è¯¥æ¥å£å®Œæˆä¸€ä¸ªåŒ¹é…ç³»ç»Ÿ\nåŒ¹é…ç³»ç»Ÿç”±ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ— + ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ + åŒ¹é…æ±  å®Œæˆ\nåŸºæœ¬ä¸ LinuxåŸºç¡€è¯¾ é‡Œçš„éƒ¨åˆ†å®Œå…¨ä¸€è‡´\nå½“æ—¶æˆ‘ä»¬æ˜¯æ‹¿ cpp æ¥å†™çš„ï¼Œå†™äº†å·®ä¸å¤š 200 è¡Œ\næœ¬èŠ‚ä¼šæ‹¿ py æ¥å®ç°ï¼Œå·®ä¸å¤š 140 è¡Œå³å¯\nthrift æ¥å£æ–‡ä»¶\nnamespace py match_service service Match { i32 add_player(1: i32 score, 2: string uuid, 3: string username, 4: string photo, 5: string channel_name), } ç„¶åç”¨è¯¥æºæ–‡ä»¶ç”Ÿæˆæ¥å£æ–‡ä»¶\næœåŠ¡ç«¯ é…ç½® asgi.py è®©æœåŠ¡ç«¯è¿›ç¨‹å¯ä»¥è°ƒç”¨å®¢æˆ·ç«¯è¿›ç¨‹é‡Œçš„å‡½æ•°\nacapp/acapp/asgi.py import os import django os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'acapp.settings') django.setup() ... from channels.layers import get_channel_layer channel_layer = get_channel_layer() ... acapp/match_system/src/main.py #! /usr/bin/env python3 import glob import sys sys.path.insert(0, glob.glob('../../')[0]) from match_server.match_service import Match from thrift.transport import TSocket from thrift.transport import TTransport from thrift.protocol import TBinaryProtocol from thrift.server import TServer from queue import Queue from time import sleep from threading import Thread from acapp.asgi import channel_layer from asgiref.sync import async_to_sync from django.core.cache import cache queue = Queue() # æ¶ˆæ¯é˜Ÿåˆ— class Player: def __init__(self, score, uuid, username, photo, channel_name): self.score = score self.uuid = uuid self.username = username self.photo = photo self.channel_name = channel_name self.waiting_time = 0 # ç­‰å¾…æ—¶é—´ class Pool: def __init__(self): self.players = [] def add_player(self, player): self.players.append(player) def check_match(self, a, b): dt = abs(a.score - b.score) a_max_dif = a.waiting_time * 50 b_max_dif = b.waiting_time * 50 return dt \u003c= a_max_dif and dt \u003c= b_max_dif def match_success(self, ps): print(\"Match Success: %s %s %s\" % (ps[0].username, ps[1].username, ps[2].username)) room_name = \"room-%s-%s-%s\" % (ps[0].uuid, ps[1].uuid, ps[2].uuid) players = [] for p in ps: async_to_sync(channel_layer.group_add)(room_name, p.channel_name) players.append({ 'uuid': p.uuid, 'username': p.username, 'photo': p.photo, 'hp': 100, }) cache.set(room_name, players, 3600) # æœ‰æ•ˆæ—¶é—´ï¼š1å°æ—¶ for p in ps: async_to_sync(channel_layer.group_send)( room_name, { 'type': \"group_send_event\", 'event': \"create_player\", 'uuid': p.uuid, 'username': p.username, 'photo': p.photo, } ) def increase_waiting_time(self): for player in self.players: player.waiting_time += 1 def match(self): while len(self.players) \u003e= 3: self.players = sorted(self.players, key=lambda p: p.score) flag = False for i in range(len(self.players) - 2): a, b, c = self.players[i], self.players[i + 1], self.players[i + 2] if self.check_match(a, b) and self.check_match(a, c) and self.check_match(b, c): self.match_success([a, b, c]) self.players = self.players[:i] + self.players[i + 3:] flag = True break if not flag: break self.increase_waiting_time() class MatchHandler: def add_player(self, score, uuid, username, photo, channel_name): print(\"Add Player: %s %d\" % (username, score)) player = Player(score, uuid, username, photo, channel_name) queue.put(player) return 0 def get_player_from_queue(): try: return queue.get_nowait() except: return None def worker(): pool = Pool() while True: player = get_player_from_queue() if player: pool.add_player(player) else: pool.match() sleep(1) if __name__ == '__main__': handler = MatchHandler() processor = Match.Processor(handler) transport = TSocket.TServerSocket(host='127.0.0.1', port=9090) tfactory = TTransport.TBufferedTransportFactory() pfactory = TBinaryProtocol.TBinaryProtocolFactory() server = TServer.TThreadedServer( processor, transport, tfactory, pfactory) Thread(target=worker, daemon=True).start() print('Starting the server...') server.serve() print('done.') å®¢æˆ·ç«¯ æ‰©å±•æ•°æ®åº“è¡¨ï¼Œè®©å…¶å¯ä»¥å­˜æ”¾ rankåˆ† çš„ä¿¡æ¯\ngame/models/player/player.py ... class Player(models.Model): ... score = models.IntegerField(default=1500) ... consumers/multiplayer/index.py from channels.generic.websocket import AsyncWebsocketConsumer import json from django.conf import settings from django.core.cache import cache from thrift import Thrift from thrift.transport import TSocket from thrift.transport import TTransport from thrift.protocol import TBinaryProtocol from match_system.src.match_server.match_service import Match from game.models.player.player import Player from channels.db import database_sync_to_async class MultiPlayer(AsyncWebsocketConsumer): async def connect(self): await self.accept() async def disconnect(self, close_code): if self.room_name: await self.channel_layer.group_discard(self.room_name, self.channel_name) async def create_player(self, data): self.room_name = None self.uuid = data['uuid'] # Make socket transport = TSocket.TSocket('127.0.0.1', 9090) # Buffering is critical. Raw sockets are very slow transport = TTransport.TBufferedTransport(transport) # Wrap in a protocol protocol = TBinaryProtocol.TBinaryProtocol(transport) # Create a client to use the protocol encoder client = Match.Client(protocol) def db_get_player(): return Player.objects.get(user__username=data['username']) player = await database_sync_to_async(db_get_player)() # Connect! transport.open() client.add_player(player.score, data['uuid'], data['username'], data['photo'], self.channel_name) # Close! transport.close() async def group_send_event(self, data): if not self.room_name: keys = cache.keys('*%s*' % (self.uuid)) if keys: self.room_name = keys[0] await self.send(text_data=json.dumps(data)) ... é¡¹ç›®æ”¶å°¾à® åŠ å¯†ã€å‹ç¼©jsä»£ç  å®‰è£… terser :\nsudo apt-get update sudo apt-get install npm sudo npm install terser -g terser ä¸ä»…æ”¯æŒæ–‡ä»¶è¾“å…¥ï¼Œä¹Ÿæ”¯æŒæ ‡å‡†è¾“å…¥ã€‚ç»“æœä¼šè¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºä¸­ã€‚\nä½¿ç”¨æ–¹å¼ï¼š\nterser xxx.js -c -m æˆ‘ä»¬å°†æ•´åˆ js æ–‡ä»¶çš„è„šæœ¬ä¿®æ”¹ä¸€ä¸‹å³å¯ï¼š\nscripts/compress_game_js.sh #! /bin/bash JS_PATH=/home/acs/acapp/game/static/js/ JS_PATH_DIST=${JS_PATH}dist/ JS_PATH_SRC=${JS_PATH}src/ find $JS_PATH_SRC -type f -name '*.js' | sort | xargs cat | terser -c -m \u003e ${JS_PATH_DIST}game.js echo \"yes\" | python3 manage.py collectstatic æ¸…ç†ç›‘å¬å‡½æ•° åœ¨AcAPPå…³é—­ä¹‹å‰è§¦å‘çš„äº‹ä»¶å¯ä»¥é€šè¿‡å¦‚ä¸‹apiæ·»åŠ ï¼š\nAcWingOS.api.window.on_close(func); æ³¨æ„ï¼š\nåŒä¸€ä¸ªé¡µé¢ä¸­ï¼Œå¤šä¸ª acapp å¼•å…¥çš„ js ä»£ç åªä¼šåŠ è½½ä¸€æ¬¡ï¼Œå› æ­¤ AC_GAME_OBJECTS ç­‰å…¨å±€å˜é‡æ˜¯åŒä¸€ä¸ªé¡µé¢ã€åŒä¸€ä¸ª acapp çš„æ‰€æœ‰çª—å£å…±ç”¨çš„ å„è‡ªåˆ›å»ºçš„å±€éƒ¨å˜é‡æ˜¯ç‹¬ç«‹çš„ï¼Œæ¯”å¦‚ new AcGame() åˆ›å»ºå‡ºçš„å¯¹è±¡å„ä¸ªçª—å£æ˜¯ç‹¬ç«‹çš„ æˆ‘ä»¬ç»™æ¯ä¸€ä¸ªçª—å£åˆ›å»ºä¸€ä¸ª uid ç„¶åæ ¹æ®ä¸åŒçš„ uid è¿›è¡Œäº‹ä»¶è§£ç»‘\nplayground/zbase.js class AcGamePlayground { ... create_uuid() { let res = \"\"; for (let i = 0; i \u003c 8; i ++ ) { let x = parseInt(Math.floor(Math.random() * 10)); //[0, 10) res += x; } return res; } start() { let outer = this; let uuid = this.create_uuid(); $(window).on(`resize.${uuid}`, function() { outer.resize(); }); if (this.root.AcWingOS) { outer.root.AcWingOS.api.window.on_close(function() { $(window).off(`resize.${uuid}`); }); } } ... } ç¼–å†™æ¯å±€æ¸¸æˆçš„ç»“æŸç•Œé¢ å•ç‹¬åˆ›å»ºä¸€ä¸ªç»“æŸç•Œé¢ï¼Œç„¶åæ¸¸æˆç»“æŸçš„æ—¶å€™æ¸²æŸ“å‡ºè¯¥ç»“æŸç•Œé¢å³å¯\nå› ä¸ºç»“æŸç•Œé¢è¦è¦†ç›–åœ¨æ¸¸æˆç•Œé¢ä¹‹ä¸Šï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å…ˆä¿®æ”¹ä¸€ä¸‹æ¸¸æˆå¼•æ“ï¼Œæ·»åŠ ä¸€ä¸ª late_update\nåœ¨æ¯ä¸€å¸§æ¸²æŸ“çš„å†…å®¹æœ€åå†æ¸²æŸ“ï¼Œä»è€Œå®ç°ç»“æŸç•Œé¢å åŠ åœ¨æ¸¸æˆç•Œé¢ä¹‹ä¸Šçš„æ•ˆæœ\nac_game_object/zbase.js ... class AcGameObject { ... late_update() { // æ¯ä¸€å¸§å‡ä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œä¸”åœ¨æ‰€æœ‰ update æ‰§è¡Œå®Œåæ‰æ‰§è¡Œ } ... } ... let AC_GAME_ANIMATION = function(timestamp) { ... for (let i = 0; i \u003c AC_GAME_OBJECTS.length; i ++ ) { let obj = AC_GAME_OBJECTS[i]; obj.late_update(); } ... } ... ç„¶åæˆ‘ä»¬åšä¸€ä¸ªæ¸²æŸ“å‡ºç»“æŸç•Œé¢çš„ç±»\nplayground/score_board/zbase.js class ScoreBoard extends AcGameObject { constructor(playground) { super(); this.playground = playground; this.ctx = this.playground.game_map.ctx; this.state = null; // win-èƒœåˆ©ï¼›lose-å¤±è´¥ this.win_img = new Image(); this.win_img.src = \"https://cdn.acwing.com/media/article/image/2021/12/17/1_8f58341a5e-win.png\"; this.lose_img = new Image(); this.lose_img.src = \"https://cdn.acwing.com/media/article/image/2021/12/17/1_9254b5f95e-lose.png\"; } start() { } add_listening_events() { // ç‚¹å‡»åï¼Œè¿”å›ä¸»é¡µé¢ let outer = this; let $canvas = this.playground.game_map.$canvas; $canvas.on('click', function() { outer.playground.hide(); outer.playground.root.menu.show(); }); } win() { this.state = \"win\"; let outer = this; setTimeout(function() { outer.add_listening_events(); }, 1000); // 1ç§’åç›‘å¬ç‚¹å‡»äº‹ä»¶ } lose() { this.state = \"lose\"; let outer = this; setTimeout(function() { outer.add_listening_events(); }, 1000); // 1ç§’åç›‘å¬ç‚¹å‡»äº‹ä»¶ } late_update() { this.render(); // æ¸²æŸ“åœ¨å›¾å±‚æœ€ä¸Šæ–¹ } render() { let len = this.playground.height / 2; if (this.state === \"win\") { this.ctx.drawImage(this.win_img, this.playground.width / 2 - len / 2, this.playground.height / 2 - len / 2, len, len); } else if (this.state === \"lose\") { this.ctx.drawImage(this.lose_img, this.playground.width / 2 - len / 2, this.playground.height / 2 - len / 2, len, len); } } } é€šè¿‡æ¸¸æˆç»“æŸçš„é€»è¾‘åˆ¤æ–­ï¼Œæ¸²æŸ“ç»“æŸç•Œé¢ï¼ŒåŒæ—¶åœ¨ç»“æŸå¹¶è¿”å›ä¸»èœå•çš„æ—¶å€™ï¼Œé‡ç½®æ¸¸æˆå…ƒç´ \næ¸¸æˆå…ƒç´ é‡ç½®\nplayground/zbase.js class AcGamePlayground { ... show(mode) { // æ‰“å¼€ playground ç•Œé¢ ... this.score_board = new ScoreBoard(this); ... } ... hide() { // æ¸…ç©ºæ‰€æœ‰æ¸¸æˆå…ƒç´  while (this.players \u0026\u0026 this.players.length \u003e 0) { this.players[0].destroy(); } if (this.game_map) { this.game_map.destroy(); this.game_map = null; } if (this.notice_board) { this.notice_board.destroy(); this.notice_board = null; } if (this.score_board) { this.score_board.destroy(); this.score_board = null; } this.$playground.empty(); // æ¸…ç©ºæ‰€æœ‰htmlæ ‡ç­¾ this.$playground.hide(); } } æ¸¸æˆç»“æŸçš„é€»è¾‘åˆ¤æ–­\nplayground/player/zbase.js class Player extends AcGameObject { ... update() { ... this.update_win(); ... } update_win() { // ç«èµ›çŠ¶æ€ï¼Œä¸”åªæœ‰ä¸€åç©å®¶ï¼Œä¸”æ”¹åç©å®¶å°±æ˜¯æˆ‘ï¼Œåˆ™èƒœåˆ© if (this.playground.state === \"fighting\" \u0026\u0026 this.character === \"me\" \u0026\u0026 this.playground.players.length === 1) { this.playground.state = \"over\"; this.playground.score_board.win(); } } ... on_destroy() { // æˆ‘æ­»äº¡ï¼Œä¸”æ¸¸æˆå¤„äºç«èµ›çŠ¶æ€ï¼Œåˆ™å¤±è´¥ if (this.character === \"me\" \u0026\u0026 this.playground.state === \"fighting\") { this.playground.state = \"over\" this.playground.score_board.lose(); } ... } } æ›´æ–°æˆ˜ç»© è¿™é‡Œæˆ‘ä»¬å®Œå…¨äº¤ç»™åç«¯æ¥åˆ¤æ–­\nåœ¨å¤„ç†å¹¿æ’­çš„ attack ä¿¡æ¯çš„æ—¶å€™ï¼Œå…ˆå‰æˆ‘ä»¬é¢å¤–ç•™äº†ä¸€ä¸ªå‚æ•° hp\nå›´ç»•è¯¥ hp è¿›è¡Œç»­å†™ï¼Œè‹¥å½“å‰æˆ¿é—´å†… hp å¤§äº 0 çš„ç©å®¶å°‘äºç­‰äº 1 ä¸ª\nåˆ™å¯¹äºæ‰€æœ‰ hp ä¸º 0 çš„ç©å®¶å‡ rank åˆ†ï¼Œå¤§äº 0 çš„ç©å®¶åŠ  rank åˆ†\nconsumers/multiplayer/index.py ... class MultiPlayer(AsyncWebsocketConsumer): ... async def attack(self, data): if not self.room_name: return players = cache.get(self.room_name) if not players: return for player in players: if player['uuid'] == data['attackee_uuid']: player['hp'] -= 25 remain_cnt = 0 for player in players: if player['hp'] \u003e 0: remain_cnt += 1 if remain_cnt \u003e 1: # ç»§ç»­è¿›è¡Œæ¸¸æˆ if self.room_name: cache.set(self.room_name, players, 3600) else: # ç»“ç®— def db_update_player_score(username, score): player = Player.objects.get(user__username=username) player.score += score player.save() for player in players: if player['hp'] \u003c= 0: await database_sync_to_async(db_update_player_score)(player['username'], -5) else: await database_sync_to_async(db_update_player_score)(player['username'], 10) ... ... æ·»åŠ favicon.ico è¿™æ˜¯ä¿®æ­£ä¸€ä¸ªå° BUGï¼Œä¹‹å‰ web ç«¯ä¸€ç›´æ²¡æœ‰ç½‘é¡µæ˜¾ç¤ºå›¾æ ‡ï¼Œè¿™é‡Œç»™ä»–åŠ ä¸Šå»\ngame/templates/multiends/web.html ... ... ... å„ç§ç¯å¢ƒå‘½ä»¤ å¯åŠ¨djangoé¡¹ç›®ï¼Œåœ¨~/acappç›®å½•ä¸‹æ‰§è¡Œï¼š python3 manage.py runserver 0.0.0.0:8000 æ¯æ¬¡ä¿®æ”¹å¥½ game/static ä¸‹çš„æ–‡ä»¶åï¼Œéœ€è¦åœ¨~/acappç›®å½•ä¸‹è¿è¡Œæ‰“åŒ…æ–‡ä»¶ï¼š ./scripts/compress_game_js.sh åœ¨å®šä¹‰å®Œä¸€ä¸ªæ•°æ®è¡¨ä¹‹åï¼Œéœ€è¦å°†åˆ›å»ºçš„æ•°æ®è¡¨æ›´æ–°åˆ° django çš„æ•°æ®åº“ä¸­å»ï¼š $ python3 manage.py makemigrations \u003e Migrations for 'game': \u003e game/migrations/0001_initial.py \u003e - Create model Player $ $ python3 manage.py migrate \u003e Operations to perform: \u003e Apply all migrations: admin, auth, contenttypes, game, sessions \u003e Running migrations: \u003e Applying game.0001_initial... OK å¯åŠ¨nginxæœåŠ¡ï¼Œç”¨äºåŸŸåè®¿é—®ï¼š sudo /etc/init.d/nginx start å¯åŠ¨uwsgiæœåŠ¡ï¼Œç”¨äºåŸŸåè®¿é—®ï¼š uwsgi --ini scripts/uwsgi.ini å…³é—­uwsgiæœåŠ¡ï¼š sudo pkill -f uwsgi -9 å¯åŠ¨ redis-serverï¼Œç”¨äºä¸€é”®ç™»å½•ï¼š sudo redis-server /etc/redis/redis.conf å¯åŠ¨ Django_channelsï¼Œç”¨äºè”æœºå¯¹æˆ˜ï¼Œåœ¨~/acappç›®å½•ä¸‹æ‰§è¡Œï¼š daphne -b 0.0.0.0 -p 5015 acapp.asgi:application å¯åŠ¨thriftæœåŠ¡ï¼Œç”¨äºåŒ¹é…ç³»ç»Ÿï¼Œåœ¨~/acapp/match_system/src/ç›®å½•ä¸‹æ‰§è¡Œï¼š ./main.py ç‰ˆæœ¬æ›´æ–°ï¼Œåœ¨æœ¯å£«ä¹‹æˆ˜ä¸­å°† jsåœ°å€ ä¸€æ æ›´æ–°ä¸ºï¼š // æœ¬åœ°æ–‡ä»¶å¤¹ä¸­å¯¹åº”çš„æ–‡ä»¶ä¹Ÿéœ€è¦æ›´æ”¹åå­— https://app2433.acapp.acwing.com.cn/static/js/dist/game-ç‰ˆæœ¬å·.js ",
  "wordCount" : "19964",
  "inLanguage": "en",
  "image":"https://Hugo-Chalnl.github.io/posts/tech/tech1/1.png","datePublished": "2023-02-21T12:20:21+08:00",
  "dateModified": "2023-02-21T12:20:21+08:00",
  "author":[{
    "@type": "Person",
    "name": "Sulv"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://Hugo-Chalnl.github.io/en/posts/tech/tech1/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Chalnl's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://Hugo-Chalnl.github.io/img/Q.gif"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    (function () {
        let  arr,reg = new RegExp("(^| )"+"change-themes"+"=([^;]*)(;|$)");
        if(arr = document.cookie.match(reg)) {
        } else {
            if (new Date().getHours() >= 19 || new Date().getHours() < 6) {
                document.body.classList.add('dark');
                localStorage.setItem("pref-theme", 'dark');
            } else {
                document.body.classList.remove('dark');
                localStorage.setItem("pref-theme", 'light');
            }
        }
    })()

    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }
</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://Hugo-Chalnl.github.io/en/" accesskey="h" title="Chalnl&#39;s Blog (Alt + H)">
            <img src="https://Hugo-Chalnl.github.io/img/Q.gif" alt="logo" aria-label="logo"
                 height="35">Chalnl&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://Hugo-Chalnl.github.io/en/search" title="ğŸ” æœç´¢ (Alt &#43; /)" accesskey=/>
                <span>ğŸ” æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://Hugo-Chalnl.github.io/en/" title="ğŸ  ä¸»é¡µ">
                <span>ğŸ  ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://Hugo-Chalnl.github.io/en/posts" title="ğŸ“š æ–‡ç« ">
                <span>ğŸ“š æ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://Hugo-Chalnl.github.io/en/tags" title="ğŸ§© æ ‡ç­¾">
                <span>ğŸ§© æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://Hugo-Chalnl.github.io/en/archives/" title="â±ï¸ æ—¶é—´è½´">
                <span>â±ï¸ æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://Hugo-Chalnl.github.io/en/about" title="ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº">
                <span>ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº</span>
                </a>
            </li>
            <li>
                <a href="https://Hugo-Chalnl.github.io/en/links" title="ğŸ¤ å‹é“¾">
                <span>ğŸ¤ å‹é“¾</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }
</style>

<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            <div class="breadcrumbs"><a href="https://Hugo-Chalnl.github.io/en/">ğŸ  Home</a>&nbsp;Â»&nbsp;<a href="https://Hugo-Chalnl.github.io/en/posts/">ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href="https://Hugo-Chalnl.github.io/en/posts/tech/">ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯</a></div>
            <h1 class="post-title">
                Tech1
            </h1>
            <div class="post-meta">

<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }

    .parent-post-meta {
        display: flex;
        flex-wrap: wrap;
        opacity: 0.8;
    }
</style>

<span class="parent-post-meta">
    <span id="post_meta_style_1">
        <span class="fa fa-calendar-check-o"></span>
        <span>2023-02-21
            &nbsp;&nbsp;
        </span>
    </span>
    
    
    
    
    
    
    
    <span id="post_meta_style_3">
        <span class="fa fa-file-word-o"></span>
        <span>19964å­—
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_4">
        <span class="fa fa-clock-o"></span>
        <span>40åˆ†é’Ÿ
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_5">
        <span class="fa fa-user-o"></span>
        <span>Sulv
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_6">
        <span class="fa fa-tags" style="opacity: 0.8"></span>
        <span>
            <span class="post-tags-meta">
            </span>
        </span>
    </span>
</span>
<span style="opacity: 0.8;">
                    <span id="post_meta_style_7">
                        &nbsp;&nbsp;
                        <span class="fa fa-eye" ></span>
                        <span>
                            <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span>
                            &nbsp;&nbsp;
                        </span>
                    </span>
                    <span id="post_meta_style_8">
                        <span class="fa fa-commenting-o"></span>
                        <span>
                            <script src="https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js"></script>
                            <script>
                                let url = document.documentURI
                                
                                let dnsUrl = "https://Hugo-Chalnl.github.io/"
                                let urlSplit = url.split(dnsUrl)
                                let finalUrl = urlSplit[1]
                                if (finalUrl[0] !== '/') {
                                    finalUrl = '/'+finalUrl
                                }
                                twikoo.getCommentsCount({
                                    envId:  null , 
                                region:  null , 
                                urls: [ 
                                    
                                    finalUrl,
                                ],
                                    includeReply: false 
                                }).then(function (res) {
                                    let count = res[0].count
                                    const obj = document.getElementById("comment_count");
                                    obj.innerText = count
                                    
                                    
                                    
                                }).catch(function (err) {
                                    
                                    console.error(err);
                                });
                            </script>
                            <span id="comment_count"></span>
                        </span>
                    </span>
                </span>

</div>
        </header> 
<figure class="entry-cover1"><img style="zoom:50%;" loading="lazy" src="https://Hugo-Chalnl.github.io/posts/tech/tech1/1.png" alt="">
    
</figure><aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#acwing-django-%e6%a1%86%e6%9e%b6%e8%af%be" aria-label="AcWing Django æ¡†æ¶è¯¾">AcWing Django æ¡†æ¶è¯¾</a></li>
                <li>
                    <a href="#django-%e9%a1%b9%e7%9b%ae%e5%88%9b%e5%bb%ba" aria-label="Django é¡¹ç›®åˆ›å»º">Django é¡¹ç›®åˆ›å»º</a><ul>
                        
                <li>
                    <a href="#%e5%90%af%e5%8a%a8%e5%88%9d%e5%a7%8b%e9%a1%b9%e7%9b%ae" aria-label="å¯åŠ¨åˆå§‹é¡¹ç›®">å¯åŠ¨åˆå§‹é¡¹ç›®</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e7%ae%a1%e7%90%86%e5%91%98%e7%99%bb%e5%bd%95%e9%a1%b5%e9%9d%a2" aria-label="åˆ›å»ºç®¡ç†å‘˜ç™»å½•é¡µé¢">åˆ›å»ºç®¡ç†å‘˜ç™»å½•é¡µé¢</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e7%94%a8%e6%88%b7%e7%99%bb%e5%bd%95%e9%a1%b5%e9%9d%a2" aria-label="åˆ›å»ºç”¨æˆ·ç™»å½•é¡µé¢">åˆ›å»ºç”¨æˆ·ç™»å½•é¡µé¢</a><ul>
                        
                <li>
                    <a href="#game-%e4%b8%8b%e7%9a%84%e5%90%84%e4%b8%aa%e6%96%87%e4%bb%b6%e4%bd%9c%e7%94%a8" aria-label="game ä¸‹çš„å„ä¸ªæ–‡ä»¶ä½œç”¨"><code>game</code> ä¸‹çš„å„ä¸ªæ–‡ä»¶ä½œç”¨</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e8%b7%af%e7%94%b1%e9%87%8d%e5%ae%9a%e5%90%91" aria-label="å®ç°ä¸€ä¸ªè·¯ç”±é‡å®šå‘">å®ç°ä¸€ä¸ªè·¯ç”±é‡å®šå‘</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e8%8f%9c%e5%8d%95%e7%95%8c%e9%9d%a2" aria-label="åˆ›å»ºèœå•ç•Œé¢">åˆ›å»ºèœå•ç•Œé¢</a><ul>
                        
                <li>
                    <a href="#%e6%9e%84%e5%bb%ba%e9%a1%b9%e7%9b%ae%e6%a1%86%e6%9e%b6" aria-label="æ„å»ºé¡¹ç›®æ¡†æ¶">æ„å»ºé¡¹ç›®æ¡†æ¶</a><ul>
                        
                <li>
                    <a href="#%e9%a1%b9%e7%9b%ae%e7%b3%bb%e7%bb%9f%e8%ae%be%e8%ae%a1" aria-label="é¡¹ç›®ç³»ç»Ÿè®¾è®¡">é¡¹ç›®ç³»ç»Ÿè®¾è®¡</a></li>
                <li>
                    <a href="#%e9%a1%b9%e7%9b%ae%e6%96%87%e4%bb%b6%e7%bb%93%e6%9e%84" aria-label="é¡¹ç›®æ–‡ä»¶ç»“æ„">é¡¹ç›®æ–‡ä»¶ç»“æ„</a><ul>
                        
                <li>
                    <a href="#js-%e6%96%87%e4%bb%b6%e7%ae%a1%e7%90%86" aria-label="js æ–‡ä»¶ç®¡ç†"><code>js</code> æ–‡ä»¶ç®¡ç†</a></li>
                <li>
                    <a href="#html-%e6%96%87%e4%bb%b6%e7%ae%a1%e7%90%86" aria-label="html æ–‡ä»¶ç®¡ç†"><code>html</code> æ–‡ä»¶ç®¡ç†</a></li>
                <li>
                    <a href="#views-%e8%a7%86%e5%9b%be%e7%ae%a1%e7%90%86" aria-label="views è§†å›¾ç®¡ç†"><code>views</code> è§†å›¾ç®¡ç†</a></li>
                <li>
                    <a href="#urls-%e8%b7%af%e7%94%b1%e7%ae%a1%e7%90%86" aria-label="urls è·¯ç”±ç®¡ç†"><code>urls</code> è·¯ç”±ç®¡ç†</a></li>
                <li>
                    <a href="#%e7%bd%91%e9%a1%b5%e6%b8%b2%e6%9f%93%e6%b5%81%e7%a8%8b" aria-label="ç½‘é¡µæ¸²æŸ“æµç¨‹">ç½‘é¡µæ¸²æŸ“æµç¨‹</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%bf%ae%e6%94%b9%e5%85%a8%e5%b1%80%e9%85%8d%e7%bd%ae" aria-label="ä¿®æ”¹å…¨å±€é…ç½®">ä¿®æ”¹å…¨å±€é…ç½®</a><ul>
                        
                <li>
                    <a href="#%e8%ae%be%e7%bd%ae%e6%97%b6%e5%8c%ba" aria-label="è®¾ç½®æ—¶åŒº">è®¾ç½®æ—¶åŒº</a></li>
                <li>
                    <a href="#%e6%b7%bb%e5%8a%a0%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" aria-label="æ·»åŠ é…ç½®æ–‡ä»¶">æ·»åŠ é…ç½®æ–‡ä»¶</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e8%8f%9c%e5%8d%95-menu-%e7%95%8c%e9%9d%a2" aria-label="åˆ›å»ºèœå• menu ç•Œé¢">åˆ›å»ºèœå• <code>menu</code> ç•Œé¢</a><ul>
                        
                <li>
                    <a href="#%e6%90%ad%e5%bb%ba%e8%8f%9c%e5%8d%95-menu-%e7%95%8c%e9%9d%a2%e7%9a%84%e6%a1%86%e6%9e%b6" aria-label="æ­å»ºèœå• menu ç•Œé¢çš„æ¡†æ¶">æ­å»ºèœå• <code>menu</code> ç•Œé¢çš„æ¡†æ¶</a></li>
                <li>
                    <a href="#%e8%ae%be%e7%bd%ae%e8%8f%9c%e5%8d%95-menu-%e9%a1%b5%e9%9d%a2%e7%9a%84%e5%86%85%e5%ae%b9" aria-label="è®¾ç½®èœå• menu é¡µé¢çš„å†…å®¹">è®¾ç½®èœå• <code>menu</code> é¡µé¢çš„å†…å®¹</a></li>
                <li>
                    <a href="#%e6%b7%bb%e5%8a%a0-%e5%8d%95%e4%ba%ba%e6%a8%a1%e5%bc%8f-%e7%9b%91%e5%90%ac%e5%87%bd%e6%95%b0--%e6%89%93%e5%bc%80%e6%b8%b8%e6%88%8f%e7%95%8c%e9%9d%a2-%e5%8a%9f%e8%83%bd" aria-label="æ·»åŠ  â€˜å•äººæ¨¡å¼â€™ ç›‘å¬å‡½æ•° â€”â€” æ‰“å¼€æ¸¸æˆç•Œé¢ åŠŸèƒ½">æ·»åŠ  â€˜å•äººæ¨¡å¼â€™ ç›‘å¬å‡½æ•° â€”â€” æ‰“å¼€æ¸¸æˆç•Œé¢ åŠŸèƒ½</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e6%b8%b8%e6%88%8f%e7%95%8c%e9%9d%a2" aria-label="åˆ›å»ºæ¸¸æˆç•Œé¢">åˆ›å»ºæ¸¸æˆç•Œé¢</a><ul>
                        
                <li>
                    <a href="#%e5%89%8d%e7%ab%af%e7%9a%84%e6%a8%a1%e5%9d%97%e5%8c%96%e5%bc%95%e5%85%a5" aria-label="å‰ç«¯çš„æ¨¡å—åŒ–å¼•å…¥">å‰ç«¯çš„æ¨¡å—åŒ–å¼•å…¥</a></li>
                <li>
                    <a href="#%e6%9e%84%e5%bb%ba%e6%b8%b8%e6%88%8f%e7%95%8c%e9%9d%a2%e6%a1%86%e6%9e%b6" aria-label="æ„å»ºæ¸¸æˆç•Œé¢æ¡†æ¶">æ„å»ºæ¸¸æˆç•Œé¢æ¡†æ¶</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e6%b8%b8%e6%88%8f%e5%bc%95%e6%93%8e%e6%a1%86%e6%9e%b6" aria-label="å®ç°æ¸¸æˆå¼•æ“æ¡†æ¶">å®ç°æ¸¸æˆå¼•æ“æ¡†æ¶</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e6%b8%b8%e6%88%8f%e5%9c%b0%e5%9b%be%e5%8a%9f%e8%83%bd" aria-label="å®ç°æ¸¸æˆåœ°å›¾åŠŸèƒ½">å®ç°æ¸¸æˆåœ°å›¾åŠŸèƒ½</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e7%8e%a9%e5%ae%b6%e6%98%be%e7%a4%ba%e5%8a%9f%e8%83%bd" aria-label="å®ç°ç©å®¶æ˜¾ç¤ºåŠŸèƒ½">å®ç°ç©å®¶æ˜¾ç¤ºåŠŸèƒ½</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e7%8e%a9%e5%ae%b6%e7%a7%bb%e5%8a%a8%e5%8a%9f%e8%83%bd" aria-label="å®ç°ç©å®¶ç§»åŠ¨åŠŸèƒ½">å®ç°ç©å®¶ç§»åŠ¨åŠŸèƒ½</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e7%81%ab%e7%90%83%e6%8a%80%e8%83%bd%e7%9a%84%e5%8a%9f%e8%83%bd" aria-label="å®ç°ç«çƒæŠ€èƒ½çš„åŠŸèƒ½">å®ç°ç«çƒæŠ€èƒ½çš„åŠŸèƒ½</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e5%8d%95%e4%ba%ba%e6%a8%a1%e5%bc%8f%e4%b8%8b%e7%9a%84%e4%ba%ba%e6%9c%ba%e5%8a%9f%e8%83%bd" aria-label="å®ç°å•äººæ¨¡å¼ä¸‹çš„äººæœºåŠŸèƒ½">å®ç°å•äººæ¨¡å¼ä¸‹çš„äººæœºåŠŸèƒ½</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e6%8a%80%e8%83%bd%e5%91%bd%e4%b8%ad%e6%95%88%e6%9e%9c%e7%a2%b0%e6%92%9e%e6%a3%80%e6%b5%8b%e5%8a%9f%e8%83%bd" aria-label="å®ç°æŠ€èƒ½å‘½ä¸­æ•ˆæœï¼ˆç¢°æ’æ£€æµ‹åŠŸèƒ½ï¼‰">å®ç°æŠ€èƒ½å‘½ä¸­æ•ˆæœï¼ˆç¢°æ’æ£€æµ‹åŠŸèƒ½ï¼‰</a></li>
                <li>
                    <a href="#%e8%a2%ab%e5%87%bb%e4%b8%ad%e4%bb%a5%e5%90%8e%e7%9a%84%e7%b2%92%e5%ad%90%e6%95%88%e6%9e%9c%e7%89%b9%e6%95%88" aria-label="è¢«å‡»ä¸­ä»¥åçš„ç²’å­æ•ˆæœç‰¹æ•ˆ">è¢«å‡»ä¸­ä»¥åçš„ç²’å­æ•ˆæœç‰¹æ•ˆ</a></li>
                <li>
                    <a href="#%e4%b8%80%e4%ba%9b%e5%b0%8f%e4%bc%98%e5%8c%96" aria-label="ä¸€äº›å°ä¼˜åŒ–">ä¸€äº›å°ä¼˜åŒ–</a><ul>
                        
                <li>
                    <a href="#%e4%ba%ba%e6%9c%ba%e9%9a%8f%e6%9c%ba%e9%a2%9c%e8%89%b2" aria-label="äººæœºéšæœºé¢œè‰²">äººæœºéšæœºé¢œè‰²</a></li>
                <li>
                    <a href="#%e4%ba%ba%e6%9c%baai%e9%9a%8f%e6%9c%ba%e6%94%bb%e5%87%bb%e6%93%8d%e4%bd%9c" aria-label="äººæœºAIéšæœºæ”»å‡»æ“ä½œ">äººæœºAIéšæœºæ”»å‡»æ“ä½œ</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e9%83%a8%e7%bd%b2nginx%e4%b8%8e%e5%af%b9%e6%8e%a5acapp%e0%ae%90" aria-label="éƒ¨ç½²nginxä¸å¯¹æ¥acappà®">éƒ¨ç½²nginxä¸å¯¹æ¥acappà®</a><ul>
                        
                <li>
                    <a href="#nginx%e6%98%af%e4%bb%80%e4%b9%88" aria-label="Nginxæ˜¯ä»€ä¹ˆï¼Ÿ">Nginxæ˜¯ä»€ä¹ˆï¼Ÿ</a></li>
                <li>
                    <a href="#uwsgi%e6%98%af%e4%bb%80%e4%b9%88" aria-label="uWSGIæ˜¯ä»€ä¹ˆï¼Ÿ">uWSGIæ˜¯ä»€ä¹ˆï¼Ÿ</a></li>
                <li>
                    <a href="#nginxuwsgidiango-%e5%b7%a5%e4%bd%9c%e6%b5%81%e7%a8%8b" aria-label="Nginx&#43;uWSGI&#43;Diango å·¥ä½œæµç¨‹">Nginx+uWSGI+Diango å·¥ä½œæµç¨‹</a></li>
                <li>
                    <a href="#uwsgi%e6%9c%8d%e5%8a%a1%e7%9a%84%e5%bc%80%e5%90%af%e5%85%b3%e9%97%ad" aria-label="uwsgiæœåŠ¡çš„å¼€å¯&amp;amp;&amp;amp;å…³é—­">uwsgiæœåŠ¡çš„å¼€å¯&amp;&amp;å…³é—­</a></li>
                <li>
                    <a href="#%e9%92%88%e5%af%b9-acapp-%e7%9a%84%e4%bc%98%e5%8c%96" aria-label="é’ˆå¯¹ acapp çš„ä¼˜åŒ–">é’ˆå¯¹ acapp çš„ä¼˜åŒ–</a><ul>
                        
                <li>
                    <a href="#%e6%89%93%e5%8c%85%e8%84%9a%e6%9c%ac%e4%bc%98%e5%8c%96" aria-label="æ‰“åŒ…è„šæœ¬ä¼˜åŒ–">æ‰“åŒ…è„šæœ¬ä¼˜åŒ–</a></li>
                <li>
                    <a href="#%e9%bc%a0%e6%a0%87%e7%82%b9%e5%87%bb%e4%ba%8b%e4%bb%b6%e7%9a%84%e7%9b%b8%e5%af%b9%e5%81%8f%e7%a7%bb" aria-label="é¼ æ ‡ç‚¹å‡»äº‹ä»¶çš„ç›¸å¯¹åç§»">é¼ æ ‡ç‚¹å‡»äº‹ä»¶çš„ç›¸å¯¹åç§»</a></li>
                <li>
                    <a href="#%e5%b0%86%e8%8f%9c%e5%8d%95%e7%95%8c%e9%9d%a2%e9%87%8d%e6%96%b0%e8%ae%be%e4%b8%ba%e4%b8%bb%e7%95%8c%e9%9d%a2" aria-label="å°†èœå•ç•Œé¢é‡æ–°è®¾ä¸ºä¸»ç•Œé¢">å°†èœå•ç•Œé¢é‡æ–°è®¾ä¸ºä¸»ç•Œé¢</a></li>
                <li>
                    <a href="#%e8%b0%83%e6%95%b4-css-%e6%96%87%e4%bb%b6%e9%80%82%e5%ba%94%e7%aa%97%e5%8f%a3" aria-label="è°ƒæ•´ css æ–‡ä»¶ï¼Œé€‚åº”çª—å£">è°ƒæ•´ css æ–‡ä»¶ï¼Œé€‚åº”çª—å£</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e8%b4%a6%e5%8f%b7%e7%b3%bb%e7%bb%9f" aria-label="åˆ›å»ºè´¦å·ç³»ç»Ÿ">åˆ›å»ºè´¦å·ç³»ç»Ÿ</a><ul>
                        
                <li>
                    <a href="#%e7%94%a8%e6%88%b7%e5%90%8d%e5%af%86%e7%a0%81%e7%99%bb%e5%bd%95" aria-label="ç”¨æˆ·åå¯†ç ç™»å½•">ç”¨æˆ·åå¯†ç ç™»å½•</a><ul>
                        
                <li>
                    <a href="#%e5%ae%a2%e6%88%b7%e7%ab%af%e8%af%b7%e6%b1%82%e4%b8%8edjango%e5%93%8d%e5%ba%94%e6%b5%81%e7%a8%8b" aria-label="å®¢æˆ·ç«¯è¯·æ±‚ä¸Djangoå“åº”æµç¨‹">å®¢æˆ·ç«¯è¯·æ±‚ä¸Djangoå“åº”æµç¨‹</a></li>
                <li>
                    <a href="#%e5%89%8d%e6%9c%9f%e5%87%86%e5%a4%87%e5%b7%a5%e4%bd%9c" aria-label="å‰æœŸå‡†å¤‡å·¥ä½œ">å‰æœŸå‡†å¤‡å·¥ä½œ</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e7%94%a8%e6%88%b7%e8%a1%a8" aria-label="åˆ›å»ºç”¨æˆ·è¡¨">åˆ›å»ºç”¨æˆ·è¡¨</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e5%ae%a2%e6%88%b7%e7%ab%af%e7%9a%84%e7%b1%bb%e5%9e%8b%e5%88%a4%e5%88%abacapp-or-web" aria-label="å®ç°å®¢æˆ·ç«¯çš„ç±»å‹åˆ¤åˆ«ï¼ˆACAPP or WEBï¼‰">å®ç°å®¢æˆ·ç«¯çš„ç±»å‹åˆ¤åˆ«ï¼ˆACAPP or WEBï¼‰</a></li>
                <li>
                    <a href="#%e6%9e%84%e5%bb%ba%e7%99%bb%e5%bd%95%e5%8a%9f%e8%83%bd%e6%a1%86%e6%9e%b6" aria-label="æ„å»ºç™»å½•åŠŸèƒ½æ¡†æ¶">æ„å»ºç™»å½•åŠŸèƒ½æ¡†æ¶</a><ul>
                        
                <li>
                    <a href="#views" aria-label="views">views</a></li>
                <li>
                    <a href="#urls" aria-label="urls">urls</a></li>
                <li>
                    <a href="#js" aria-label="js">js</a></li>
                <li>
                    <a href="#%e5%ae%8c%e5%96%84-http-%e8%af%b7%e6%b1%82%e7%9a%84%e5%87%bd%e6%95%b0" aria-label="å®Œå–„ HTTP è¯·æ±‚çš„å‡½æ•°">å®Œå–„ HTTP è¯·æ±‚çš„å‡½æ•°</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%b0%86%e7%94%a8%e6%88%b7%e5%a4%b4%e5%83%8f%e6%b8%b2%e6%9f%93%e5%88%b0%e7%8e%a9%e5%ae%b6%e4%b8%8a" aria-label="å°†ç”¨æˆ·å¤´åƒæ¸²æŸ“åˆ°ç©å®¶ä¸Š">å°†ç”¨æˆ·å¤´åƒæ¸²æŸ“åˆ°ç©å®¶ä¸Š</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e7%99%bb%e5%bd%95%e7%95%8c%e9%9d%a2%e7%9a%84%e5%89%8d%e7%ab%af" aria-label="å®ç°ç™»å½•ç•Œé¢çš„å‰ç«¯">å®ç°ç™»å½•ç•Œé¢çš„å‰ç«¯</a><ul>
                        
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e5%89%8d%e7%ab%af%e7%9a%84%e5%9f%ba%e7%a1%80%e6%a1%86%e6%9e%b6" aria-label="å®ç°å‰ç«¯çš„åŸºç¡€æ¡†æ¶">å®ç°å‰ç«¯çš„åŸºç¡€æ¡†æ¶</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e7%99%bb%e5%bd%95%e6%b3%a8%e5%86%8c%e7%9a%84%e7%9b%b8%e4%ba%92%e5%88%87%e6%8d%a2" aria-label="å®ç°ç™»å½•/æ³¨å†Œçš„ç›¸äº’åˆ‡æ¢">å®ç°ç™»å½•/æ³¨å†Œçš„ç›¸äº’åˆ‡æ¢</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e7%99%bb%e5%bd%95%e5%8a%9f%e8%83%bd" aria-label="å®ç°ç™»å½•åŠŸèƒ½">å®ç°ç™»å½•åŠŸèƒ½</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e7%99%bb%e5%87%ba%e5%8a%9f%e8%83%bd" aria-label="å®ç°ç™»å‡ºåŠŸèƒ½">å®ç°ç™»å‡ºåŠŸèƒ½</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e6%b3%a8%e5%86%8c%e5%8a%9f%e8%83%bd" aria-label="å®ç°æ³¨å†ŒåŠŸèƒ½">å®ç°æ³¨å†ŒåŠŸèƒ½</a></li></ul>
                </li>
                <li>
                    <a href="#redis%e0%ae%90" aria-label="Redisà®">Redisà®</a><ul>
                        
                <li>
                    <a href="#redis%e6%98%af%e4%bb%80%e4%b9%88" aria-label="Redisæ˜¯ä»€ä¹ˆï¼Ÿ">Redisæ˜¯ä»€ä¹ˆï¼Ÿ</a></li>
                <li>
                    <a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e8%a6%81%e4%bd%bf%e7%94%a8redis" aria-label="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨Redis?">ä¸ºä»€ä¹ˆè¦ä½¿ç”¨Redis?</a></li>
                <li>
                    <a href="#%e5%9c%a8django%e4%b8%ad%e9%9b%86%e6%88%90redis" aria-label="åœ¨Djangoä¸­é›†æˆRedis">åœ¨Djangoä¸­é›†æˆRedis</a></li>
                <li>
                    <a href="#%e5%9c%a8-django-%e5%90%8e%e5%8f%b0%e9%87%8c%e6%93%8d%e7%ba%b5-redis" aria-label="åœ¨ Django åå°é‡Œæ“çºµ Redis">åœ¨ Django åå°é‡Œæ“çºµ Redis</a></li></ul>
                </li>
                <li>
                    <a href="#web%e7%ab%afacwing%e4%b8%80%e9%94%ae%e7%99%bb%e5%bd%95%e0%ae%90" aria-label="Webç«¯AcWingä¸€é”®ç™»å½•à®">Webç«¯AcWingä¸€é”®ç™»å½•à®</a></li>
                <li>
                    <a href="#acapp%e7%ab%afacwing%e4%b8%80%e9%94%ae%e7%99%bb%e5%bd%95%e0%ae%90" aria-label="AcAppç«¯AcWingä¸€é”®ç™»å½•à®">AcAppç«¯AcWingä¸€é”®ç™»å½•à®</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e8%81%94%e6%9c%ba%e5%af%b9%e6%88%98%e0%ae%90" aria-label="å®ç°è”æœºå¯¹æˆ˜à®">å®ç°è”æœºå¯¹æˆ˜à®</a><ul>
                        
                <li>
                    <a href="#%e7%bb%9f%e4%b8%80%e9%95%bf%e5%ba%a6%e5%8d%95%e4%bd%8d" aria-label="ç»Ÿä¸€é•¿åº¦å•ä½">ç»Ÿä¸€é•¿åº¦å•ä½</a><ul>
                        
                <li>
                    <a href="#%e5%9c%b0%e5%9b%be%e6%b8%b2%e6%9f%93" aria-label="åœ°å›¾æ¸²æŸ“">åœ°å›¾æ¸²æŸ“</a><ul>
                        
                <li>
                    <a href="#%e5%9c%b0%e5%9b%be-169-%e7%ad%89%e6%af%94%e4%be%8b%e7%bc%a9%e6%94%be" aria-label="åœ°å›¾ 16:9 ç­‰æ¯”ä¾‹ç¼©æ”¾">åœ°å›¾ 16:9 ç­‰æ¯”ä¾‹ç¼©æ”¾</a></li>
                <li>
                    <a href="#%e5%9c%b0%e5%9b%be%e5%b1%85%e4%b8%ad" aria-label="åœ°å›¾å±…ä¸­">åœ°å›¾å±…ä¸­</a></li>
                <li>
                    <a href="#%e8%a7%a3%e5%86%b3%e5%9c%b0%e5%9b%be-resize-%e6%97%b6%e4%bc%9a%e5%87%ba%e7%8e%b0%e6%b8%90%e5%8f%98%e6%88%90%e9%bb%91%e8%89%b2%e7%9a%84%e6%83%85%e5%86%b5" aria-label="è§£å†³åœ°å›¾ resize æ—¶ï¼Œä¼šå‡ºç°æ¸å˜æˆé»‘è‰²çš„æƒ…å†µ">è§£å†³åœ°å›¾ resize æ—¶ï¼Œä¼šå‡ºç°æ¸å˜æˆé»‘è‰²çš„æƒ…å†µ</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%85%83%e7%b4%a0%e6%b8%b2%e6%9f%93" aria-label="å…ƒç´ æ¸²æŸ“">å…ƒç´ æ¸²æŸ“</a><ul>
                        
                <li>
                    <a href="#%e7%8e%a9%e5%ae%b6-player" aria-label="ç©å®¶ Player">ç©å®¶ Player</a></li>
                <li>
                    <a href="#%e7%81%ab%e7%90%83-fireball" aria-label="ç«çƒ Fireball">ç«çƒ Fireball</a></li>
                <li>
                    <a href="#%e7%b2%92%e5%ad%90-particle" aria-label="ç²’å­ Particle">ç²’å­ Particle</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%a2%9e%e5%8a%a0%e8%81%94%e6%9c%ba%e5%af%b9%e6%88%98%e6%a8%a1%e5%bc%8f" aria-label="å¢åŠ â€œè”æœºå¯¹æˆ˜â€æ¨¡å¼">å¢åŠ â€œè”æœºå¯¹æˆ˜â€æ¨¡å¼</a></li>
                <li>
                    <a href="#django_channels" aria-label="Django_channels">Django_channels</a><ul>
                        
                <li>
                    <a href="#django_channels%e6%98%af%e4%bb%80%e4%b9%88" aria-label="Django_channelsæ˜¯ä»€ä¹ˆï¼Ÿ">Django_channelsæ˜¯ä»€ä¹ˆï¼Ÿ</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%aedjango_channels" aria-label="é…ç½®Django_channels">é…ç½®Django_channels</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%bc%96%e5%86%99%e5%90%8c%e6%ad%a5%e5%87%bd%e6%95%b0" aria-label="ç¼–å†™åŒæ­¥å‡½æ•°">ç¼–å†™åŒæ­¥å‡½æ•°</a><ul>
                        
                <li>
                    <a href="#create-player" aria-label="create-player">create-player</a><ul>
                        
                <li>
                    <a href="#%e5%89%8d%e7%ab%af" aria-label="å‰ç«¯">å‰ç«¯</a></li>
                <li>
                    <a href="#%e5%90%8e%e7%ab%af" aria-label="åç«¯">åç«¯</a></li>
                <li>
                    <a href="#redis-%e8%b0%83%e8%af%95%e8%af%ad%e5%8f%a5" aria-label="redis è°ƒè¯•è¯­å¥">redis è°ƒè¯•è¯­å¥</a></li></ul>
                </li>
                <li>
                    <a href="#move-to" aria-label="move-to">move-to</a><ul>
                        
                <li>
                    <a href="#%e5%89%8d%e7%ab%af-1" aria-label="å‰ç«¯">å‰ç«¯</a></li>
                <li>
                    <a href="#%e5%90%8e%e7%ab%af-1" aria-label="åç«¯">åç«¯</a></li></ul>
                </li>
                <li>
                    <a href="#shoot-fireball" aria-label="shoot-fireball">shoot-fireball</a><ul>
                        
                <li>
                    <a href="#%e5%89%8d%e7%ab%af-2" aria-label="å‰ç«¯">å‰ç«¯</a></li>
                <li>
                    <a href="#%e5%90%8e%e7%ab%af-2" aria-label="åç«¯">åç«¯</a></li></ul>
                </li>
                <li>
                    <a href="#attack" aria-label="attack">attack</a><ul>
                        
                <li>
                    <a href="#%e5%89%8d%e7%ab%af-3" aria-label="å‰ç«¯">å‰ç«¯</a></li>
                <li>
                    <a href="#%e5%90%8e%e7%ab%af-3" aria-label="åç«¯">åç«¯</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e6%b8%b8%e6%88%8f%e7%9a%84%e5%b0%8f%e4%bc%98%e5%8c%96" aria-label="æ¸¸æˆçš„å°ä¼˜åŒ–">æ¸¸æˆçš„å°ä¼˜åŒ–</a><ul>
                        
                <li>
                    <a href="#%e5%a4%9a%e4%ba%ba%e6%a8%a1%e5%bc%8f%e4%b8%8b%e6%b8%b8%e6%88%8f%e6%b2%a1%e6%9c%89%e5%bc%80%e5%a7%8b%e5%89%8d%e7%8e%a9%e5%ae%b6%e4%b8%8d%e5%8f%af%e4%bb%a5%e7%a7%bb%e5%8a%a8" aria-label="å¤šäººæ¨¡å¼ä¸‹æ¸¸æˆæ²¡æœ‰å¼€å§‹å‰ï¼Œç©å®¶ä¸å¯ä»¥ç§»åŠ¨">å¤šäººæ¨¡å¼ä¸‹æ¸¸æˆæ²¡æœ‰å¼€å§‹å‰ï¼Œç©å®¶ä¸å¯ä»¥ç§»åŠ¨</a></li>
                <li>
                    <a href="#%e6%8a%80%e8%83%bdcd" aria-label="æŠ€èƒ½CD">æŠ€èƒ½CD</a></li>
                <li>
                    <a href="#%e7%94%a8%e5%9b%be%e7%89%87%e6%9d%a5%e6%b8%b2%e6%9f%93%e6%8a%80%e8%83%bdcd" aria-label="ç”¨å›¾ç‰‡æ¥æ¸²æŸ“æŠ€èƒ½CD">ç”¨å›¾ç‰‡æ¥æ¸²æŸ“æŠ€èƒ½CD</a></li>
                <li>
                    <a href="#%e6%b7%bb%e5%8a%a0%e4%b8%80%e4%b8%aa%e9%97%aa%e7%8e%b0%e6%8a%80%e8%83%bd" aria-label="æ·»åŠ ä¸€ä¸ªé—ªç°æŠ€èƒ½">æ·»åŠ ä¸€ä¸ªé—ªç°æŠ€èƒ½</a><ul>
                        
                <li>
                    <a href="#%e5%8d%95%e6%9c%ba%e9%83%a8%e5%88%86" aria-label="å•æœºéƒ¨åˆ†">å•æœºéƒ¨åˆ†</a></li>
                <li>
                    <a href="#%e8%81%94%e6%9c%ba%e9%83%a8%e5%88%86" aria-label="è”æœºéƒ¨åˆ†">è”æœºéƒ¨åˆ†</a></li></ul>
                </li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e8%81%8a%e5%a4%a9%e7%b3%bb%e7%bb%9f%e0%ae%90" aria-label="å®ç°èŠå¤©ç³»ç»Ÿà®">å®ç°èŠå¤©ç³»ç»Ÿà®</a><ul>
                        
                <li>
                    <a href="#%e4%bc%98%e5%8c%96%e9%94%ae%e7%9b%98%e7%bb%91%e5%ae%9a%e4%ba%8b%e4%bb%b6" aria-label="ä¼˜åŒ–é”®ç›˜ç»‘å®šäº‹ä»¶">ä¼˜åŒ–é”®ç›˜ç»‘å®šäº‹ä»¶</a></li>
                <li>
                    <a href="#%e6%9c%ac%e5%9c%b0%e5%89%8d%e7%ab%af" aria-label="æœ¬åœ°å‰ç«¯">æœ¬åœ°å‰ç«¯</a></li>
                <li>
                    <a href="#%e8%81%94%e6%9c%ba%e8%81%8a%e5%a4%a9%e7%aa%97" aria-label="è”æœºèŠå¤©çª—">è”æœºèŠå¤©çª—</a><ul>
                        
                <li>
                    <a href="#%e5%89%8d%e7%ab%af-4" aria-label="å‰ç«¯">å‰ç«¯</a></li>
                <li>
                    <a href="#%e5%90%8e%e7%ab%af-4" aria-label="åç«¯">åç«¯</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e5%8c%b9%e9%85%8d%e7%b3%bb%e7%bb%9f%e0%ae%90" aria-label="å®ç°åŒ¹é…ç³»ç»Ÿà®">å®ç°åŒ¹é…ç³»ç»Ÿà®</a><ul>
                        
                <li>
                    <a href="#%e6%9c%8d%e5%8a%a1%e7%ab%af" aria-label="æœåŠ¡ç«¯">æœåŠ¡ç«¯</a></li>
                <li>
                    <a href="#%e5%ae%a2%e6%88%b7%e7%ab%af" aria-label="å®¢æˆ·ç«¯">å®¢æˆ·ç«¯</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%a1%b9%e7%9b%ae%e6%94%b6%e5%b0%be%e0%ae%90" aria-label="é¡¹ç›®æ”¶å°¾à®">é¡¹ç›®æ”¶å°¾à®</a><ul>
                        
                <li>
                    <a href="#%e5%8a%a0%e5%af%86%e5%8e%8b%e7%bc%a9js%e4%bb%a3%e7%a0%81" aria-label="åŠ å¯†ã€å‹ç¼©jsä»£ç ">åŠ å¯†ã€å‹ç¼©jsä»£ç </a></li>
                <li>
                    <a href="#%e6%b8%85%e7%90%86%e7%9b%91%e5%90%ac%e5%87%bd%e6%95%b0" aria-label="æ¸…ç†ç›‘å¬å‡½æ•°">æ¸…ç†ç›‘å¬å‡½æ•°</a></li>
                <li>
                    <a href="#%e7%bc%96%e5%86%99%e6%af%8f%e5%b1%80%e6%b8%b8%e6%88%8f%e7%9a%84%e7%bb%93%e6%9d%9f%e7%95%8c%e9%9d%a2" aria-label="ç¼–å†™æ¯å±€æ¸¸æˆçš„ç»“æŸç•Œé¢">ç¼–å†™æ¯å±€æ¸¸æˆçš„ç»“æŸç•Œé¢</a></li>
                <li>
                    <a href="#%e6%9b%b4%e6%96%b0%e6%88%98%e7%bb%a9" aria-label="æ›´æ–°æˆ˜ç»©">æ›´æ–°æˆ˜ç»©</a></li>
                <li>
                    <a href="#%e6%b7%bb%e5%8a%a0faviconico" aria-label="æ·»åŠ favicon.ico">æ·»åŠ favicon.ico</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%90%84%e7%a7%8d%e7%8e%af%e5%a2%83%e5%91%bd%e4%bb%a4" aria-label="å„ç§ç¯å¢ƒå‘½ä»¤">å„ç§ç¯å¢ƒå‘½ä»¤</a>
                </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        if (elements) {
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                    (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                    return element;
                }
            }) || activeElement

            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                if (element === activeElement){
                    document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
                } else {
                    document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
                }
            })
        }
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        <div class="post-content"><h1 id="acwing-django-æ¡†æ¶è¯¾">AcWing Django æ¡†æ¶è¯¾<a hidden class="anchor" aria-hidden="true" href="#acwing-django-æ¡†æ¶è¯¾">#</a></h1>
<hr>
<h1 id="django-é¡¹ç›®åˆ›å»º">Django é¡¹ç›®åˆ›å»º<a hidden class="anchor" aria-hidden="true" href="#django-é¡¹ç›®åˆ›å»º">#</a></h1>
<hr>
<h2 id="å¯åŠ¨åˆå§‹é¡¹ç›®">å¯åŠ¨åˆå§‹é¡¹ç›®<a hidden class="anchor" aria-hidden="true" href="#å¯åŠ¨åˆå§‹é¡¹ç›®">#</a></h2>
<ol>
<li>
<p><code>django-admin startproject acapp</code>ï¼šåœ¨å½“å‰ç›®å½•ä¸‹åˆ›å»ºåä¸º<code>acapp</code>çš„<code>django</code>é¡¹ç›®</p>
</li>
<li>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>python3 manage.py runserver 0.0.0.0:8000
</span></span></code></pre></div><p>ï¼šå¯åŠ¨é¡¹ç›®</p>
<ol>
<li>æ‰“å¼€<code>settings.py</code>ï¼Œæ‰¾åˆ°<code>ALLOWED_HOSTS=[]</code>ï¼Œä¿®æ”¹æˆ<code>ALLOWED_HOSTS=[&quot;è‡ªå·±çš„æœåŠ¡å™¨çš„å…¬ç½‘IP&quot;]</code></li>
<li>é€šè¿‡<code>è‡ªå·±çš„æœåŠ¡å™¨å…¬ç½‘IP:8000</code> æ‰“å¼€Djangoé¡µé¢</li>
</ol>
</li>
</ol>
<h2 id="åˆ›å»ºç®¡ç†å‘˜ç™»å½•é¡µé¢">åˆ›å»ºç®¡ç†å‘˜ç™»å½•é¡µé¢<a hidden class="anchor" aria-hidden="true" href="#åˆ›å»ºç®¡ç†å‘˜ç™»å½•é¡µé¢">#</a></h2>
<ol>
<li>åœ¨ä¸€çº§<code>acapp</code>æ–‡ä»¶å¤¹ä¸‹ï¼Œ<code>python3 manage.py startapp XXX</code>ï¼Œ<code>XXX</code>æ˜¯å¯ä»¥è‡ªå®šä¹‰çš„appåï¼Œè¿™é‡Œç”¨<code>game</code>ç¤ºä¾‹ï¼Œè¿™æ—¶å€™ä¼šå¤šä¸€ä¸ªæ–‡ä»¶å¤¹<code>game</code>ï¼Œæ ‘å½¢ç»“æ„å¦‚å›¾ï¼š</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>|-- game
</span></span><span style="display:flex;"><span>|   |-- __init__.py
</span></span><span style="display:flex;"><span>|   |-- admin.py          # ç®¡ç†å‘˜é¡µé¢
</span></span><span style="display:flex;"><span>|   |-- apps.py           # ç”¨çš„ä¸å¤š
</span></span><span style="display:flex;"><span>|   |-- migrations        # å­˜å‚¨æ•°æ®åº“
</span></span><span style="display:flex;"><span>|   |   `-- __init__.py
</span></span><span style="display:flex;"><span>|   |-- models.py         # å®šä¹‰ç½‘ç«™é‡Œçš„æ•°æ®åº“è¡¨
</span></span><span style="display:flex;"><span>|   |-- tests.py
</span></span><span style="display:flex;"><span>|   `-- views.py          # è§†å›¾ï¼Œå³å‡½æ•°
</span></span></code></pre></div><ol>
<li><code>python3 manage.py migrate</code>ï¼šå°†æ‰€æœ‰ä¿®æ”¹æ›´æ–°è¿›æ•°æ®åº“</li>
<li>åˆ›å»ºä¸€ä¸ª <strong>ç®¡ç†å‘˜ç”¨æˆ·</strong>ï¼š</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ python3 manage.py createsuperuser
</span></span><span style="display:flex;"><span>&gt; Username (leave blank to use &#39;acs&#39;): admin
</span></span><span style="display:flex;"><span>&gt; Email address: 
</span></span><span style="display:flex;"><span>&gt; Password: 123456
</span></span><span style="display:flex;"><span>&gt; Password (again): 123456
</span></span><span style="display:flex;"><span>&gt; Superuser created successfully.
</span></span></code></pre></div><p>ç„¶ååˆ©ç”¨è¯¥ <strong>ç®¡ç†å‘˜ç”¨æˆ·</strong> ç™»å½• <code>admin</code> é¡µé¢ï¼Œå³å¯æˆåŠŸç™»é™†</p>
<h2 id="åˆ›å»ºç”¨æˆ·ç™»å½•é¡µé¢">åˆ›å»ºç”¨æˆ·ç™»å½•é¡µé¢<a hidden class="anchor" aria-hidden="true" href="#åˆ›å»ºç”¨æˆ·ç™»å½•é¡µé¢">#</a></h2>
<h3 id="game-ä¸‹çš„å„ä¸ªæ–‡ä»¶ä½œç”¨"><code>game</code> ä¸‹çš„å„ä¸ªæ–‡ä»¶ä½œç”¨<a hidden class="anchor" aria-hidden="true" href="#game-ä¸‹çš„å„ä¸ªæ–‡ä»¶ä½œç”¨">#</a></h3>
<ol>
<li><code>templates</code>ç›®å½•ï¼šç®¡ç† <code>html</code> æ–‡ä»¶</li>
<li><code>urls</code>ç›®å½•ï¼šç®¡ç†è·¯ç”±ï¼Œå³é“¾æ¥ä¸å‡½æ•°çš„å¯¹åº”å…³ç³» (æ¥æ”¶é“¾æ¥ï¼Œè°ƒç”¨ç›¸å¯¹åº”çš„å‡½æ•°)</li>
<li><code>views</code>ç›®å½•ï¼šç®¡ç† <code>http</code> å‡½æ•°ï¼ˆæ¥æ”¶æµè§ˆå™¨è¯·æ±‚ï¼Œè¿”å›å­—ç¬¦ä¸²è‡³æµè§ˆå™¨ï¼‰</li>
<li><code>models</code>ç›®å½•ï¼šç®¡ç†æ•°æ®åº“æ•°æ®</li>
<li><code>static</code>ç›®å½•ï¼šç®¡ç†é™æ€æ–‡ä»¶</li>
<li><code>consumers</code>ç›®å½•ï¼šç®¡ç†<code>websocket</code>å‡½æ•°</li>
</ol>
<h3 id="å®ç°ä¸€ä¸ªè·¯ç”±é‡å®šå‘">å®ç°ä¸€ä¸ªè·¯ç”±é‡å®šå‘<a hidden class="anchor" aria-hidden="true" href="#å®ç°ä¸€ä¸ªè·¯ç”±é‡å®šå‘">#</a></h3>
<ul>
<li><code>url</code> è¾“å…¥ç½‘å€ -&gt; <code>acapp.urls</code> -&gt; <code>game.urls</code> -&gt; <code>game.views.index</code> -&gt; å±•ç¤ºé¡µé¢</li>
</ul>
<p><strong>game.views</strong></p>
<p>è¿™å…¶ä¸­ï¼Œ<code>HttpResponse()</code>å†…éƒ¨ä½¿ç”¨<code>html</code>çš„è¯­æ³•ï¼Œè¿”å›çš„å“åº”å°±ç›´æ¥ç”¨è¿™ä¸ªå­—ç¬¦ä¸²ä½œä¸ºé¡µé¢ï¼Œè½¬æ¢æˆ<code>html</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>from django.http import HttpResponse
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def index(request):
</span></span><span style="display:flex;"><span>    line1 = &#39;&lt;h1 style=&#34;text-align: center&#34;&gt; ç¬¬ä¸€ä¸ªç½‘é¡µ &lt;/h1&gt;&#39;
</span></span><span style="display:flex;"><span>    return HttpResponse(line1)
</span></span></code></pre></div><p><strong>game.urls</strong></p>
<p>è¿™å…¶ä¸­ï¼Œ<code>path('PATH', function, name)</code>çš„å«ä¹‰æ˜¯ï¼Œåœ¨ç”¨æˆ·è®¿é—®ç½‘ç«™çš„æ—¶å€™ï¼Œå¦‚æœæ˜¯<code>ç½‘ç«™/game/PATH</code>ï¼Œå°±ä¼šè°ƒç”¨<code>function</code>ï¼Œåå­—ä¸º<code>name</code>ï¼Œè¿™æ˜¯åœ¨<code>/game/</code>ç›®å½•ä¸‹çš„è°ƒç”¨ï¼Œæ‰€ä»¥è¿™ä¸ª<code>PATH</code>æ˜¯åœ¨<code>/game/</code>çš„åŸºç¡€ä¸Šçš„<strong>ç›¸å¯¹è·¯å¾„</strong>ï¼Œæ‰€ä»¥ä»–çš„<strong>ç»å¯¹è·¯å¾„</strong>æ˜¯<code>ç½‘ç«™/game/PATH</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>from django.urls import path
</span></span><span style="display:flex;"><span>from game.views import index
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>urlpatterns = [ 
</span></span><span style="display:flex;"><span>    path(&#34;&#34;, index, name=&#34;index&#34;),
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p><strong>acapp.urls</strong></p>
<p>è¿™å…¶ä¸­ï¼Œ<code>path('PATH', include('game.urls'))</code>çš„å«ä¹‰æ˜¯ï¼šåœ¨ç”¨æˆ·è®¿é—®ç½‘ç«™çš„æ—¶å€™ï¼Œå¦‚æœæ˜¯<code>ç½‘ç«™/PATH</code>ï¼Œå°±ä¼šèµ°åˆ°<code>/game/urls</code>ï¼Œå¹¶æ ¹æ®<code>/game/urls.py</code>æ¥è·‘è·¯ç”±ï¼Œå°±æ˜¯è¯´ï¼Œç”¨æˆ·åœ¨è®¿é—®<code>ç½‘ç«™/</code>çš„æ—¶å€™ï¼Œç”±äºæ­¤æ—¶è°ƒç”¨çš„å‡½æ•°æ˜¯<code>include('game.urls')</code>ï¼Œæ‰€ä»¥è®¿é—®<code>ç½‘ç«™/</code>ç›¸å½“äºæ ¹æ®<code>game/urls</code>è®¿é—®</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>from django.contrib import admin
</span></span><span style="display:flex;"><span>from django.urls import path, include
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>urlpatterns = [ 
</span></span><span style="display:flex;"><span>    path(&#39;&#39;, include(&#39;game.urls&#39;)),
</span></span><span style="display:flex;"><span>    path(&#39;admin/&#39;, admin.site.urls),
</span></span><span style="display:flex;"><span>] 
</span></span></code></pre></div><p>ç„¶åç›´æ¥æ‰“å¼€ <code>ip:socket</code> å¯ä»¥ç›´æ¥æ˜¾ç¤º <code>index</code> è¿”å›çš„ç½‘é¡µ</p>
<h1 id="åˆ›å»ºèœå•ç•Œé¢">åˆ›å»ºèœå•ç•Œé¢<a hidden class="anchor" aria-hidden="true" href="#åˆ›å»ºèœå•ç•Œé¢">#</a></h1>
<ul>
<li><a href="https://www.acwing.com/file_system/file/content/whole/index/content/3199626/">3. åˆ›å»ºèœå•ç•Œé¢ | è®²ä¹‰</a></li>
<li><a href="https://www.acwing.com/solution/content/73121/">3.1 ä¸Šè¯¾ç¬”è®° | å¤§å®¶å¥½ä»Šå¤©æ˜¯</a></li>
<li><a href="https://www.acwing.com/solution/content/73707/">3.1 ä¸Šè¯¾ç¬”è®° | æ </a></li>
</ul>
<hr>
<h2 id="æ„å»ºé¡¹ç›®æ¡†æ¶">æ„å»ºé¡¹ç›®æ¡†æ¶<a hidden class="anchor" aria-hidden="true" href="#æ„å»ºé¡¹ç›®æ¡†æ¶">#</a></h2>
<h3 id="é¡¹ç›®ç³»ç»Ÿè®¾è®¡">é¡¹ç›®ç³»ç»Ÿè®¾è®¡<a hidden class="anchor" aria-hidden="true" href="#é¡¹ç›®ç³»ç»Ÿè®¾è®¡">#</a></h3>
<ul>
<li><code>menu</code>ï¼šèœå•é¡µé¢</li>
<li><code>playground</code>ï¼šæ¸¸æˆç•Œé¢</li>
<li><code>settings</code>ï¼šè®¾ç½®ç•Œé¢</li>
</ul>
<h3 id="é¡¹ç›®æ–‡ä»¶ç»“æ„">é¡¹ç›®æ–‡ä»¶ç»“æ„<a hidden class="anchor" aria-hidden="true" href="#é¡¹ç›®æ–‡ä»¶ç»“æ„">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>|-- README.md
</span></span><span style="display:flex;"><span>|-- acapp
</span></span><span style="display:flex;"><span>|   |-- __init__.py    # æ–‡ä»¶å¤¹åœ¨åŠ ä¸Š __init__.py æ–‡ä»¶åï¼Œpython ä¾¿å¯ä»¥é€šè¿‡ import æ¥å¼•ç”¨è¯¥æ–‡ä»¶å¤¹
</span></span><span style="display:flex;"><span>|   |-- asgi.py
</span></span><span style="display:flex;"><span>|   |-- settings.py
</span></span><span style="display:flex;"><span>|   |-- urls.py
</span></span><span style="display:flex;"><span>|   `-- wsgi.py
</span></span><span style="display:flex;"><span>|-- db.sqlite3
</span></span><span style="display:flex;"><span>|-- game
</span></span><span style="display:flex;"><span>|   |-- __init__.py
</span></span><span style="display:flex;"><span>|   |-- admin.py
</span></span><span style="display:flex;"><span>|   |-- apps.py
</span></span><span style="display:flex;"><span>|   |-- migrations
</span></span><span style="display:flex;"><span>|   |   `-- __init__.py
</span></span><span style="display:flex;"><span>|   |-- models
</span></span><span style="display:flex;"><span>|   |   `-- __init__.py
</span></span><span style="display:flex;"><span>|   |-- static
</span></span><span style="display:flex;"><span>|   |   |-- css
</span></span><span style="display:flex;"><span>|   |   |   `-- game.css    # ä¸€èˆ¬ä¸€ä¸ªå·¥ç¨‹ï¼Œåªæœ‰ä¸€ä¸ª css æ–‡ä»¶å°±è¶³å¤Ÿäº†
</span></span><span style="display:flex;"><span>|   |   |-- image
</span></span><span style="display:flex;"><span>|   |   |   `-- menu
</span></span><span style="display:flex;"><span>|   |   |       `-- background.gif
</span></span><span style="display:flex;"><span>|   |   `-- js
</span></span><span style="display:flex;"><span>|   |       |-- dist
</span></span><span style="display:flex;"><span>|   |       |   `-- game.js
</span></span><span style="display:flex;"><span>|   |       `-- src
</span></span><span style="display:flex;"><span>|   |           `-- zbase.js    # æ€»çš„ js æ–‡ä»¶ï¼Œå‘½åä»¥ z å¼€å¤´ä¼šè‡ªåŠ¨åœ¨å­—å…¸åºæœ€å
</span></span><span style="display:flex;"><span>|   |-- templates
</span></span><span style="display:flex;"><span>|   |   `-- multiends
</span></span><span style="display:flex;"><span>|   |       `-- web.html
</span></span><span style="display:flex;"><span>|   |-- tests.py
</span></span><span style="display:flex;"><span>|   |-- urls
</span></span><span style="display:flex;"><span>|   |   |-- __init__.py
</span></span><span style="display:flex;"><span>|   |   |-- index.py
</span></span><span style="display:flex;"><span>|   |   |-- menu
</span></span><span style="display:flex;"><span>|   |   |   |-- __init__.py
</span></span><span style="display:flex;"><span>|   |   |   `-- index.py
</span></span><span style="display:flex;"><span>|   |   |-- playground
</span></span><span style="display:flex;"><span>|   |   |   |-- __init__.py
</span></span><span style="display:flex;"><span>|   |   |   `-- index.py
</span></span><span style="display:flex;"><span>|   |   `-- settings
</span></span><span style="display:flex;"><span>|   |       |-- __init__.py
</span></span><span style="display:flex;"><span>|   |       `-- index.py
</span></span><span style="display:flex;"><span>|   `-- views
</span></span><span style="display:flex;"><span>|       |-- __init__.py
</span></span><span style="display:flex;"><span>|       |-- index.py
</span></span><span style="display:flex;"><span>|       |-- menu
</span></span><span style="display:flex;"><span>|       |   `-- __init__.py
</span></span><span style="display:flex;"><span>|       |-- playground
</span></span><span style="display:flex;"><span>|       |   `-- __init__.py
</span></span><span style="display:flex;"><span>|       `-- settings
</span></span><span style="display:flex;"><span>|           `-- __init__.py
</span></span><span style="display:flex;"><span>|-- manage.py
</span></span><span style="display:flex;"><span>`-- scripts
</span></span><span style="display:flex;"><span>    `-- compress_game_js.sh
</span></span></code></pre></div><h4 id="js-æ–‡ä»¶ç®¡ç†"><code>js</code> æ–‡ä»¶ç®¡ç†<a hidden class="anchor" aria-hidden="true" href="#js-æ–‡ä»¶ç®¡ç†">#</a></h4>
<p>ä¸€èˆ¬ä¸€ä¸ªå·¥ç¨‹ä¼šæœ‰å¾ˆå¤šä¸ª <code>.js</code> æºæ–‡ä»¶ï¼Œä¸ºäº†åŠ å¿«ç½‘ç»œçš„ä¼ è¾“ï¼Œä¹Ÿä¸ºäº†æ¯æ¬¡å†™æ–°çš„ <code>.js</code> æ–‡ä»¶ä¸ç”¨æ¯ä¸ª <code>html</code> éƒ½é¢å¤–å¼•å…¥ä¸€æ¬¡</p>
<p>è€ƒè™‘ç”¨ä¸€ä¸ª <code>src</code> æºæ–‡ä»¶å¤¹æ¥å­˜å‚¨æ‰€æœ‰çš„ <code>.js</code> æºæ–‡ä»¶</p>
<p>ç„¶åç”¨ <code>dist</code> æ–‡ä»¶å¤¹æ¥å­˜æ”¾ç”± <code>src</code> ä¸‹æ‰€æœ‰æºæ–‡ä»¶æ•´åˆç”Ÿæˆçš„ä¸€ä¸ªç›®æ ‡ <code>.js</code> æ–‡ä»¶</p>
<p>è¿™æ ·æ—¢å®ç°äº†å¿«é€Ÿä¼ è¾“çš„å¥½å¤„ï¼Œä¹Ÿæ–¹ä¾¿äº†åç»­ç¼–å†™ <code>html</code> æ–‡ä»¶æ—¶ï¼Œå¼•å…¥ <code>.js</code> çš„ä¾¿åˆ©</p>
<p>åˆ›å»ºä¸€ä¸ªè„šæœ¬å®ç°ä¸Šè¿° <strong>æ•´åˆ</strong> çš„åŠŸèƒ½ <code>~/acapp/scripts/compress_game_js.sh</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#! /bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>JS_PATH<span style="color:#f92672">=</span>/home/acs/acapp/game/static/js/
</span></span><span style="display:flex;"><span>JS_PATH_DIST<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>JS_PATH<span style="color:#e6db74">}</span>dist/
</span></span><span style="display:flex;"><span>JS_PATH_SRC<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>JS_PATH<span style="color:#e6db74">}</span>src/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>find $JS_PATH_SRC -type f -name <span style="color:#e6db74">&#39;*.js&#39;</span> | sort | xargs cat &gt; <span style="color:#e6db74">${</span>JS_PATH_DIST<span style="color:#e6db74">}</span>game.js
</span></span></code></pre></div><h4 id="html-æ–‡ä»¶ç®¡ç†"><code>html</code> æ–‡ä»¶ç®¡ç†<a hidden class="anchor" aria-hidden="true" href="#html-æ–‡ä»¶ç®¡ç†">#</a></h4>
<p>åœ¨ <code>templates</code> æ–‡ä»¶å¤¹ä¸‹åˆ›å»º <code>menu</code>ã€<code>playground</code>ã€<code>settings</code>ã€<code>multiends</code> å››ä¸ªæ–‡ä»¶å¤¹ï¼Œç”¨äºå­˜å‚¨ä¸‰ä¸ªæ¨¡å—å’Œç»ˆç«¯çš„ <code>html</code> æ–‡ä»¶</p>
<p>åœ¨ <code>multiends</code> ä¸‹åˆ›å»º <code>web.html</code> æ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>{% load static %}
</span></span><span style="display:flex;"><span>&lt;!-- Django ä¸­å¼•å…¥å…¨å±€settingé‡Œçš„å˜é‡ static çš„è¯­æ³•--&gt;
</span></span><span style="display:flex;"><span>&lt;head&gt;
</span></span><span style="display:flex;"><span>    &lt;link rel=&#34;stylesheet&#34; href=&#34;https://cdn.acwing.com/static/jquery-ui-dist/jquery-ui.min.css&#34;&gt;
</span></span><span style="display:flex;"><span>    &lt;script src=&#34;https://cdn.acwing.com/static/jquery/js/jquery-3.3.1.min.js&#34;&gt;&lt;/script&gt;
</span></span><span style="display:flex;"><span>    &lt;!-- ä¸Šè¿°ä¸¤å¥å¼•å…¥ jQuery åº“ --&gt;
</span></span><span style="display:flex;"><span>    &lt;!-- ä½¿ç”¨å¼•å…¥çš„å˜é‡ static çš„è¯­æ³•å¦‚ä¸‹ --&gt;
</span></span><span style="display:flex;"><span>    &lt;link rel=&#34;stylesheet&#34; href=&#34;{% static &#39;css/game.css&#39; %}&#34;&gt;
</span></span><span style="display:flex;"><span>    &lt;script src=&#34;{% static &#39;js/dist/game.js&#39; %}&#34;&gt;&lt;/script&gt;
</span></span><span style="display:flex;"><span>    &lt;!-- åˆ†åˆ«å¼•å…¥ css æ–‡ä»¶å’Œæ€»çš„ js æ–‡ä»¶ --&gt;
</span></span><span style="display:flex;"><span>&lt;/head&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;body style=&#34;margin: 0&#34;&gt;
</span></span><span style="display:flex;"><span>    &lt;div id=&#34;ac_game_12345678&#34;&gt;&lt;/div&gt;
</span></span><span style="display:flex;"><span>    &lt;script&gt;
</span></span><span style="display:flex;"><span>        $(document).ready(function(){
</span></span><span style="display:flex;"><span>            let ac_game = new AcGame(&#34;ac_game_12345678&#34;)
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>    &lt;/script&gt;
</span></span><span style="display:flex;"><span>&lt;/body&gt;
</span></span></code></pre></div><h4 id="views-è§†å›¾ç®¡ç†"><code>views</code> è§†å›¾ç®¡ç†<a hidden class="anchor" aria-hidden="true" href="#views-è§†å›¾ç®¡ç†">#</a></h4>
<p>åœ¨ <code>views</code> æ–‡ä»¶å¤¹ä¸‹æ–°å»ºä¸‰ä¸ªæ¨¡å—çš„è§†å›¾æ–‡ä»¶å¤¹</p>
<p>å†™ä¸€ä¸ª <code>index.py</code> æ–‡ä»¶ï¼Œç›®çš„æ˜¯åœ¨ <code>web</code> ç«¯è¢«è®¿é—®æ—¶ï¼Œè¿”å›ä¸Šé¢å†™çš„ <code>web.html</code> æ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>from django.shortcuts import render
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def index(request):
</span></span><span style="display:flex;"><span>  return render(request, &#34;multiends/web.html&#34;)
</span></span></code></pre></div><h4 id="urls-è·¯ç”±ç®¡ç†"><code>urls</code> è·¯ç”±ç®¡ç†<a hidden class="anchor" aria-hidden="true" href="#urls-è·¯ç”±ç®¡ç†">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>                                     /-- &#34;&#34; -- index
</span></span><span style="display:flex;"><span>                                    / -- &#34;menu/&#34; -- menu.index
</span></span><span style="display:flex;"><span>             / &#34;&#34; --&gt; &#34;game.url&#34; --&gt; 
</span></span><span style="display:flex;"><span>            /                       \ -- &#34;playground/&#34; -- playground.index
</span></span><span style="display:flex;"><span>id:scoket -&gt;                         \-- &#34;settings/&#34; -- settings.index
</span></span><span style="display:flex;"><span>            \
</span></span><span style="display:flex;"><span>             \ &#34;/admin&#34; -- åˆ°è¾¾ç®¡ç†å‘˜é¡µé¢
</span></span><span style="display:flex;"><span>~/acapp/acapp/urls.py
</span></span><span style="display:flex;"><span>from django.contrib import admin
</span></span><span style="display:flex;"><span>from django.urls import path, include
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>urlpatterns = [
</span></span><span style="display:flex;"><span>  path(&#39;&#39;, include(&#39;game.urls.index&#39;)),
</span></span><span style="display:flex;"><span>  path(&#39;admin/&#39;, admin.site.urls),
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>~/acapp/game/urls/index.py
</span></span><span style="display:flex;"><span>from django.urls import path, include
</span></span><span style="display:flex;"><span>from game.views.index import index
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>urlpatterns = [ 
</span></span><span style="display:flex;"><span>    path(&#34;&#34;, index, name=&#34;index&#34;),
</span></span><span style="display:flex;"><span>    path(&#34;menu/&#34;, include(&#34;game.urls.menu.index&#34;)),
</span></span><span style="display:flex;"><span>    path(&#34;playground/&#34;, include(&#34;game.urls.playground.index&#34;)),
</span></span><span style="display:flex;"><span>    path(&#34;settings/&#34;, include(&#34;game.urls.settings.index&#34;))
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><h4 id="ç½‘é¡µæ¸²æŸ“æµç¨‹">ç½‘é¡µæ¸²æŸ“æµç¨‹<a hidden class="anchor" aria-hidden="true" href="#ç½‘é¡µæ¸²æŸ“æµç¨‹">#</a></h4>
<p>æ ¹æ®ç”¨æˆ·çš„é“¾æ¥ï¼Œé¦–å…ˆè¿›å…¥<code>acapp/urls.py</code>ï¼Œæ ¹æ®<code>path</code>å†è¿›å…¥<code>game/urls/index.py</code>ï¼Œå†æ ¹æ®<code>path</code>è¿›å…¥ä¸‹ä¸€å±‚<code>url</code>æˆ–è°ƒç”¨ç›¸å¯¹åº”çš„<code>views</code>ä¸­çš„<code>index.py</code>å‡½æ•°ï¼Œå‡½æ•°æ¥æ”¶å‚æ•°ï¼Œåœ¨ç½‘é¡µç«¯æ¸²æŸ“<code>templates/multiends</code>ä¸‹çš„<code>web.html</code>ï¼Œ<code>html</code>ä¸­æœ‰<code>JS</code>æ‰§è¡Œ</p>
<p>æ³¨æ„ï¼šæœ¬é¡¹ç›®ä¸ºå‰åç«¯åˆ†ç¦»ï¼Œå³é€šè¿‡<code>JS</code>åœ¨<code>client</code>ä¸­æ¸²æŸ“é¡¹ç›®(åŠ¨æ€ç”Ÿæˆé¡µé¢)ï¼Œè€Œä¸æ˜¯åœ¨<code>server</code>æ¸²æŸ“é¡¹ç›®</p>
<h3 id="ä¿®æ”¹å…¨å±€é…ç½®">ä¿®æ”¹å…¨å±€é…ç½®<a hidden class="anchor" aria-hidden="true" href="#ä¿®æ”¹å…¨å±€é…ç½®">#</a></h3>
<h4 id="è®¾ç½®æ—¶åŒº">è®¾ç½®æ—¶åŒº<a hidden class="anchor" aria-hidden="true" href="#è®¾ç½®æ—¶åŒº">#</a></h4>
<p>ä¿®æ”¹é¡¹ç›®çš„ <strong>UTC</strong> æ—¶é—´ä¸º <strong>CN</strong> æ—¶é—´</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ vim /acapp/settings.py
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>******
</span></span><span style="display:flex;"><span>TIME_ZONE = &#39;Asia/Shanghai&#39; # åŸæ¥é»˜è®¤æ˜¯ UTC
</span></span><span style="display:flex;"><span>******
</span></span></code></pre></div><h4 id="æ·»åŠ é…ç½®æ–‡ä»¶">æ·»åŠ é…ç½®æ–‡ä»¶<a hidden class="anchor" aria-hidden="true" href="#æ·»åŠ é…ç½®æ–‡ä»¶">#</a></h4>
<p>å°†æ–°åˆ›å»ºçš„ <code>game</code> ä¸‹çš„ <code>apps.py</code> ä¸­çš„ <code>GameConfig</code> åŠ åˆ° <code>settings.py</code> ä¸‹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ vim /acapp/settings.py
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>******
</span></span><span style="display:flex;"><span>INSTALLED_APPS = [
</span></span><span style="display:flex;"><span>  &#39;game.apps.GameConfig&#39;,
</span></span><span style="display:flex;"><span>  ......
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>******
</span></span></code></pre></div><p>å£°æ˜å°†é™æ€æ–‡ä»¶è·¯å¾„ <code>STATIC_ROOT</code> å’Œ <code>MEDIA_ROOT</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ vim /acapp/settings.py
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>******
</span></span><span style="display:flex;"><span>import os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>......
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>STATIC_ROOT = os.path.join(BASE_DIR, &#39;static&#39;)
</span></span><span style="display:flex;"><span>STATIC_URL = &#39;/static/&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>MEDIA_ROOT = os.path.join(BASE_DIR, &#39;media&#39;)
</span></span><span style="display:flex;"><span>MEDIA_URL = &#39;/media/&#39;
</span></span><span style="display:flex;"><span>******
</span></span></code></pre></div><h2 id="åˆ›å»ºèœå•-menu-ç•Œé¢">åˆ›å»ºèœå• <code>menu</code> ç•Œé¢<a hidden class="anchor" aria-hidden="true" href="#åˆ›å»ºèœå•-menu-ç•Œé¢">#</a></h2>
<h3 id="æ­å»ºèœå•-menu-ç•Œé¢çš„æ¡†æ¶">æ­å»ºèœå• <code>menu</code> ç•Œé¢çš„æ¡†æ¶<a hidden class="anchor" aria-hidden="true" href="#æ­å»ºèœå•-menu-ç•Œé¢çš„æ¡†æ¶">#</a></h3>
<p>æˆ‘ä»¬é‡‡ç”¨çš„ <strong>å‰åç«¯åˆ†ç¦»å¼</strong> å¼€å‘ï¼Œæ‰€æœ‰çš„ <strong>html</strong> æ¸²æŸ“éƒ½è¦æ±‚åœ¨å‰ç«¯å®Œæˆ</p>
<p>å¼€å‘æµç¨‹å°±æ˜¯ï¼Œå…ˆåœ¨ <strong>html</strong> é‡Œåˆ›å»ºå¥½ä¸€ä¸ªæœ‰ <strong>id</strong> çš„ <strong>div</strong></p>
<p>ç„¶ååˆ©ç”¨ <strong>js</strong> æ–‡ä»¶ï¼Œæ•è·åˆ°è¯¥ <strong>div</strong>ï¼Œå¹¶è¿›è¡Œ <strong>æ¸²æŸ“</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>/templates/multiends/web.html
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>    &lt;div id=&#34;ac_game_12345678&#34;&gt;&lt;/div&gt;
</span></span><span style="display:flex;"><span>    &lt;script&gt;
</span></span><span style="display:flex;"><span>        $(document).ready(function(){
</span></span><span style="display:flex;"><span>            let ac_game = new AcGame(&#34;ac_game_12345678&#34;)
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>    &lt;/script&gt;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>js/src/zbase.js
</span></span><span style="display:flex;"><span>class AcGame {
</span></span><span style="display:flex;"><span>    constructor(id) {
</span></span><span style="display:flex;"><span>        this.id = id; 
</span></span><span style="display:flex;"><span>        this.$ac_game = $(&#39;#&#39; + id);
</span></span><span style="display:flex;"><span>        this.menu = new AcGameMenu(this);
</span></span><span style="display:flex;"><span>    }   
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>js/src/menu/zbase.js
</span></span><span style="display:flex;"><span>class AcGameMenu {
</span></span><span style="display:flex;"><span>    constructor(root) {
</span></span><span style="display:flex;"><span>        this.root = root;
</span></span><span style="display:flex;"><span>        this.$menu = $(` 
</span></span><span style="display:flex;"><span>&lt;div class=&#34;ac-game-menu&#34;&gt;
</span></span><span style="display:flex;"><span>&lt;/div&gt;
</span></span><span style="display:flex;"><span>`);
</span></span><span style="display:flex;"><span>        this.root.$ac_game.append(this.$menu); 
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>css/game.css
</span></span><span style="display:flex;"><span>.ac-game-menu {
</span></span><span style="display:flex;"><span>    width: 100%;
</span></span><span style="display:flex;"><span>    height: 100%;
</span></span><span style="display:flex;"><span>    background-image: url(&#39;/static/image/menu/background.gif&#39;);
</span></span><span style="display:flex;"><span>    background-size: 100% 100%;
</span></span><span style="display:flex;"><span>    user-select: none;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>è¿™é‡Œçš„ <strong>ä»£ç é€»è¾‘</strong> å¦‚ä¸‹ï¼š</p>
<ol>
<li><code>html</code> é¡µé¢æ‰§è¡Œåˆ° <code>js</code> ä»£ç ï¼Œåˆ©ç”¨ <code>AcGameç±»</code> åˆ›å»ºå¯¹è±¡ <code>ac_game</code> åŒæ—¶ä¼ é€’å‚æ•° <code>div</code> çš„ <code>id</code></li>
<li><code>AcGame</code> å¼€å§‹æ‰§è¡Œæ„é€ å‡½æ•°ï¼Œåœ¨æ„é€ å‡½æ•°ä¸­ï¼Œæ•è· <code>html</code> æ ‡ç­¾ï¼Œå¹¶åˆ©ç”¨ <code>AcGameMenuç±»</code> åˆ›å»ºå¯¹è±¡ <code>menu</code>ï¼Œå¹¶å°†æ•´ä¸ªå¯¹è±¡ä½œä¸ºå‚æ•°ä¸‹ä¼ </li>
<li><code>AcGameMenu</code> å¼€å§‹æ‰§è¡Œæ„é€ å‡½æ•°ï¼Œç„¶ååˆ›å»º <code>html</code> ä»£ç ï¼ŒåŠ åˆ°æ•è·åˆ°çš„ <code>html</code> ä»£ç ä¸‹</li>
<li>æœ€ç»ˆæˆåŠŸæ¸²æŸ“å‡ºèƒŒæ™¯å›¾ç‰‡</li>
</ol>
<h3 id="è®¾ç½®èœå•-menu-é¡µé¢çš„å†…å®¹">è®¾ç½®èœå• <code>menu</code> é¡µé¢çš„å†…å®¹<a hidden class="anchor" aria-hidden="true" href="#è®¾ç½®èœå•-menu-é¡µé¢çš„å†…å®¹">#</a></h3>
<p>ä¸»è¦å†…å®¹å°±æ˜¯åœ¨ä¸»é¡µé¢ä¸­ï¼Œæ˜¾ç¤ºï¼šå•äººæ¨¡å¼ã€å¤šäººæ¨¡å¼ã€è®¾ç½®ï¼Œä¸‰ä¸ªæŒ‰é’®çš„é€‰é¡¹ <code>js/src/menu/zbase.js</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>class AcGameMenu {
</span></span><span style="display:flex;"><span>    constructor(root) {
</span></span><span style="display:flex;"><span>        this.root = root;
</span></span><span style="display:flex;"><span>        this.$menu = $(`
</span></span><span style="display:flex;"><span>&lt;div class=&#34;ac-game-menu&#34;&gt;
</span></span><span style="display:flex;"><span>    &lt;div class=&#34;ac-game-menu-field&#34;&gt;
</span></span><span style="display:flex;"><span>        &lt;div class=&#34;ac-game-menu-field-item ac-game-menu-field-item-single-mode&#34;&gt;
</span></span><span style="display:flex;"><span>            å•äººæ¨¡å¼
</span></span><span style="display:flex;"><span>        &lt;/div&gt;
</span></span><span style="display:flex;"><span>        &lt;div class=&#34;ac-game-menu-field-item ac-game-menu-field-item-multi-mode&#34;&gt;
</span></span><span style="display:flex;"><span>            å¤šäººæ¨¡å¼
</span></span><span style="display:flex;"><span>        &lt;/div&gt;
</span></span><span style="display:flex;"><span>        &lt;div class=&#34;ac-game-menu-field-item ac-game-menu-field-item-settings-mode&#34;&gt;
</span></span><span style="display:flex;"><span>            è®¾ç½®
</span></span><span style="display:flex;"><span>        &lt;/div&gt;
</span></span><span style="display:flex;"><span>    &lt;/div&gt;
</span></span><span style="display:flex;"><span>&lt;/div&gt;
</span></span><span style="display:flex;"><span>`);
</span></span><span style="display:flex;"><span>        this.root.$ac_game.append(this.$menu);
</span></span><span style="display:flex;"><span>        this.$single_mode = this.$menu.find(&#39;.ac-game-menu-field-item-single-mode&#39;);
</span></span><span style="display:flex;"><span>        this.$multi_mode = this.$menu.find(&#39;.ac-game-menu-field-item-multi-mode&#39;);
</span></span><span style="display:flex;"><span>        this.$settings_mode = this.$menu.find(&#39;.ac-game-menu-field-item-settings-mode&#39;);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>css/game.css
</span></span><span style="display:flex;"><span>.ac-game-menu {
</span></span><span style="display:flex;"><span>    width: 100%;
</span></span><span style="display:flex;"><span>    height: 100%;
</span></span><span style="display:flex;"><span>    background-image: url(&#39;/static/image/menu/background.gif&#39;);
</span></span><span style="display:flex;"><span>    background-size: 100% 100%;
</span></span><span style="display:flex;"><span>    user-select: none;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>.ac-game-menu-field {
</span></span><span style="display:flex;"><span>    width: 20vw;
</span></span><span style="display:flex;"><span>    position: relative;
</span></span><span style="display:flex;"><span>    top: 40vh;
</span></span><span style="display:flex;"><span>    left: 19vh;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>.ac-game-menu-field-item {
</span></span><span style="display:flex;"><span>    height: 7vh;
</span></span><span style="display:flex;"><span>    width: 18vw;
</span></span><span style="display:flex;"><span>    color: white;
</span></span><span style="display:flex;"><span>    font-size: 6vh;
</span></span><span style="display:flex;"><span>    font-style: italic;
</span></span><span style="display:flex;"><span>    padding: 2vh;
</span></span><span style="display:flex;"><span>    margin: 1vh 0;
</span></span><span style="display:flex;"><span>    cursor: pointer;
</span></span><span style="display:flex;"><span>    text-align: center;
</span></span><span style="display:flex;"><span>    background-color: rgba(39, 21, 28, 0.6);
</span></span><span style="display:flex;"><span>    border-radius: 10px;
</span></span><span style="display:flex;"><span>    letter-spacing: 0.5vw;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>.ac-game-menu-field-item:hover {
</span></span><span style="display:flex;"><span>    transform: scale(1.2);
</span></span><span style="display:flex;"><span>    transition: 100ms;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="æ·»åŠ -å•äººæ¨¡å¼-ç›‘å¬å‡½æ•°--æ‰“å¼€æ¸¸æˆç•Œé¢-åŠŸèƒ½">æ·»åŠ  â€˜å•äººæ¨¡å¼â€™ ç›‘å¬å‡½æ•° â€”â€” æ‰“å¼€æ¸¸æˆç•Œé¢ åŠŸèƒ½<a hidden class="anchor" aria-hidden="true" href="#æ·»åŠ -å•äººæ¨¡å¼-ç›‘å¬å‡½æ•°--æ‰“å¼€æ¸¸æˆç•Œé¢-åŠŸèƒ½">#</a></h3>
<p>è¿™é‡Œè¦å®ç°çš„ <strong>é€»è¾‘</strong>ï¼š</p>
<ol>
<li>ç‚¹å‡» â€˜å•äººæ¨¡å¼â€™ æŒ‰é’®è§¦å‘ <code>click</code> äº‹ä»¶ï¼Œéšå³è§¦å‘ç›‘å¬å‡½æ•°ï¼Œå¼€å§‹æ‰§è¡Œ</li>
<li>å…³é—­ <code>menu</code> é¡µé¢</li>
<li>æ‰“å¼€ <code>playground</code> é¡µé¢</li>
</ol>
<p>å› æ­¤ï¼Œæˆ‘ä»¬å…ˆç®€æ˜“çš„å®ç°ä¸€ä¸ª <code>playground</code> é¡µé¢ï¼Œæ–¹ä¾¿è°ƒè¯•è¯¥åŠŸèƒ½ <code>js/src/playground/zbase.js</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>class AcGamePlayground {
</span></span><span style="display:flex;"><span>    constructor(root) {
</span></span><span style="display:flex;"><span>        this.root = root;
</span></span><span style="display:flex;"><span>        this.$playground = $(`&lt;div&gt;æ¸¸æˆç•Œé¢&lt;/div&gt;`);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        this.hide();
</span></span><span style="display:flex;"><span>        this.root.$ac_game.append(this.$playground);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        this.start();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    start() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    show() {    //æ‰“å¼€ playground ç•Œé¢
</span></span><span style="display:flex;"><span>        this.$playground.show();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    hide() {    //å…³é—­ playground ç•Œé¢
</span></span><span style="display:flex;"><span>        this.$playground.hide();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>åœ¨å®ç°ç›‘å¬å‡½æ•°åŠŸèƒ½ä¹‹å‰ï¼Œå…ˆåœ¨ <code>/src/zbase.js</code> å³ä¸» <code>js</code> æ–‡ä»¶ä¸‹ï¼Œåˆ©ç”¨ <code>AcGamePlayground</code> ç±»åˆ›å»ºå¥½ <code>playground</code> å¯¹è±¡</p>
<p>è¿™æ ·æˆ‘ä»¬å°±èƒ½åœ¨å‰ç«¯ï¼Œæ¸²æŸ“å‡ºä¸¤ä¸ªç•Œé¢äº†ï¼Œåˆ†åˆ«æ˜¯ï¼š<code>menu</code> å’Œ <code>playground</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>js/src/zbase.js
</span></span><span style="display:flex;"><span>class AcGame {
</span></span><span style="display:flex;"><span>    constructor(id) {
</span></span><span style="display:flex;"><span>        this.id = id;
</span></span><span style="display:flex;"><span>        this.$ac_game = $(&#39;#&#39; + id);
</span></span><span style="display:flex;"><span>        this.menu = new AcGameMenu(this);
</span></span><span style="display:flex;"><span>        // æŠŠ playground å¯¹è±¡ä¹Ÿå»ºå¥½ï¼Œè¿™æ ·æˆ‘ä»¬å°±åŒæ—¶æœ‰ä¸¤ä¸ªç•Œé¢äº†
</span></span><span style="display:flex;"><span>        this.playground = new AcGamePlayground(this);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        this.start();
</span></span><span style="display:flex;"><span>    }                    
</span></span><span style="display:flex;"><span>    start() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç„¶åï¼Œæˆ‘ä»¬å¼€å§‹å®ç° <code>ac-game-menu-field-item-single-mode</code> æ ‡ç­¾çš„ <code>click</code> äº‹ä»¶çš„ç›‘å¬å‡½æ•°</p>
<p>å…¶åŠŸèƒ½ä¹‹å‰è®²è¿‡äº†ï¼Œå°±æ˜¯å…³é—­ <code>menu</code> é¡µé¢ï¼Œæ‰“å¼€ <code>playground</code> é¡µé¢</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>js/src/menu/zbase.js
</span></span><span style="display:flex;"><span>class AcGameMenu {
</span></span><span style="display:flex;"><span>    constructor(root) {
</span></span><span style="display:flex;"><span>        this.root = root;
</span></span><span style="display:flex;"><span>        this.$menu = $(`
</span></span><span style="display:flex;"><span>&lt;div class=&#34;ac-game-menu&#34;&gt;
</span></span><span style="display:flex;"><span>    &lt;div class=&#34;ac-game-menu-field&#34;&gt;
</span></span><span style="display:flex;"><span>        &lt;div class=&#34;ac-game-menu-field-item ac-game-menu-field-item-single-mode&#34;&gt;
</span></span><span style="display:flex;"><span>            å•äººæ¨¡å¼
</span></span><span style="display:flex;"><span>        &lt;/div&gt;
</span></span><span style="display:flex;"><span>        &lt;div class=&#34;ac-game-menu-field-item ac-game-menu-field-item-multi-mode&#34;&gt;
</span></span><span style="display:flex;"><span>            å¤šäººæ¨¡å¼
</span></span><span style="display:flex;"><span>        &lt;/div&gt;
</span></span><span style="display:flex;"><span>        &lt;div class=&#34;ac-game-menu-field-item ac-game-menu-field-item-settings-mode&#34;&gt;
</span></span><span style="display:flex;"><span>            è®¾ç½®
</span></span><span style="display:flex;"><span>        &lt;/div&gt;
</span></span><span style="display:flex;"><span>    &lt;/div&gt;
</span></span><span style="display:flex;"><span>&lt;/div&gt;
</span></span><span style="display:flex;"><span>`);
</span></span><span style="display:flex;"><span>        this.root.$ac_game.append(this.$menu);
</span></span><span style="display:flex;"><span>        this.$single_mode = this.$menu.find(&#39;.ac-game-menu-field-item-single-mode&#39;);
</span></span><span style="display:flex;"><span>        this.$multi_mode = this.$menu.find(&#39;.ac-game-menu-field-item-multi-mode&#39;);
</span></span><span style="display:flex;"><span>        this.$settings_mode = this.$menu.find(&#39;.ac-game-menu-field-item-settings-mode&#39;);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        this.start();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    start() {
</span></span><span style="display:flex;"><span>        this.add_listening_events();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    add_listening_events() {
</span></span><span style="display:flex;"><span>        let outer = this;
</span></span><span style="display:flex;"><span>        this.$single_mode.click(function(){
</span></span><span style="display:flex;"><span>            outer.hide();   // å…³é—­ä¸»é¡µé¢
</span></span><span style="display:flex;"><span>            outer.root.playground.show();   // æ‰“å¼€æ¸¸æˆç•Œé¢
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    show() {    //æ˜¾ç¤ºmenuç•Œé¢
</span></span><span style="display:flex;"><span>        this.$menu.show();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    hide() {    //éšè—menuç•Œé¢
</span></span><span style="display:flex;"><span>        this.$menu.hide();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="åˆ›å»ºæ¸¸æˆç•Œé¢">åˆ›å»ºæ¸¸æˆç•Œé¢<a hidden class="anchor" aria-hidden="true" href="#åˆ›å»ºæ¸¸æˆç•Œé¢">#</a></h1>
<hr>
<blockquote>
<p><strong>è‹¥ä¿®æ”¹<code>staticæ–‡ä»¶å¤¹</code>ä¸‹çš„ç›¸å…³æ–‡ä»¶ï¼Œéœ€åœ¨<code>~/acapp</code>ä¸‹æ‰§è¡Œ<code>./scripts/compress_game_js.sh</code>æ¥æ‰“åŒ…æ–‡ä»¶</strong></p>
</blockquote>
<h2 id="å‰ç«¯çš„æ¨¡å—åŒ–å¼•å…¥">å‰ç«¯çš„æ¨¡å—åŒ–å¼•å…¥<a hidden class="anchor" aria-hidden="true" href="#å‰ç«¯çš„æ¨¡å—åŒ–å¼•å…¥">#</a></h2>
<p>ç”±äºåœ¨ <code>html</code> ä»£ç éƒ¨åˆ†ï¼Œæ˜¯å°†æ•´ä¸ª <code>game.js</code> æ–‡ä»¶å¼•å…¥</p>
<p>è¿™æ ·ä¼šå¯¼è‡´åœ¨ <code>game.js</code> ä¸­å®šä¹‰çš„å˜é‡ï¼Œä¼šå˜æˆæ•´ä¸ªç½‘é¡µçš„ <strong>å…¨å±€å˜é‡</strong>ï¼ˆä¹‹åå¯èƒ½ä¼šå¼•èµ·å˜é‡é‡åçš„è¯¸å¤šé—®é¢˜ï¼‰</p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬è€ƒè™‘ä½¿ç”¨ <strong>æ¨¡å—åŒ–å¼•å…¥</strong> çš„åŠŸèƒ½ï¼Œè®©ç½‘é¡µåªå¼•å…¥åœ¨ <code>html</code> ä¸­éœ€è¦çš„éƒ¨åˆ†</p>
<p>ä¿®æ”¹ <code>web.html</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;!-- é¦–å…ˆï¼Œå…ˆåˆ æ‰ä¸Šé¢æ•´ä¸ªå¼•å…¥ game.js çš„éƒ¨åˆ† --&gt;
</span></span><span style="display:flex;"><span>&lt;!-- ç„¶åï¼Œä¸‹æ–¹åˆ›å»ºå¯¹è±¡çš„éƒ¨åˆ†ï¼Œå…ˆä½¿ç”¨æ¨¡å—åŒ–å¼•å…¥ --&gt;
</span></span><span style="display:flex;"><span>......
</span></span><span style="display:flex;"><span>    &lt;script type=&#34;module&#34;&gt;
</span></span><span style="display:flex;"><span>        import {AcGame} from &#34;{% static &#39;js/dist/game.js&#39; %}&#34;
</span></span><span style="display:flex;"><span>        $(document).ready(function(){
</span></span><span style="display:flex;"><span>            let ac_game = new AcGame(&#34;ac_game_12345678&#34;)
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>    &lt;/script&gt;
</span></span><span style="display:flex;"><span>......
</span></span></code></pre></div><p>æ­¤å¤–ï¼Œè¿˜æœ‰ä¿®æ”¹å¼•å…¥çš„ç±»ï¼Œåœ¨å‰é¢åŠ ä¸Š <code>export</code>ï¼Œå¦‚ä¸‹ä¿®æ”¹ <code>js/src/zbase.js</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>export class AcGame {
</span></span><span style="display:flex;"><span>    ......
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>è¿™æ ·ï¼Œåœ¨å…¨å±€ä¸­ï¼Œåªä¼šå‡ºç°å¼•å…¥çš„æ¨¡å—ï¼Œå…¶ä»–çš„ <code>.js</code> ä»£ç ä¸ä¼šå‡ºç°åœ¨å…¨å±€ä¸­</p>
<h2 id="æ„å»ºæ¸¸æˆç•Œé¢æ¡†æ¶">æ„å»ºæ¸¸æˆç•Œé¢æ¡†æ¶<a hidden class="anchor" aria-hidden="true" href="#æ„å»ºæ¸¸æˆç•Œé¢æ¡†æ¶">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>static/js/src/playground/zbase.js
</span></span><span style="display:flex;"><span>......
</span></span><span style="display:flex;"><span>    this.$playground = $(`&lt;div class=&#34;ac-game-playground&#34;&gt;&lt;/div&gt;`);
</span></span><span style="display:flex;"><span>......
</span></span><span style="display:flex;"><span>game.css
</span></span><span style="display:flex;"><span>......
</span></span><span style="display:flex;"><span>.ac-game-playground {
</span></span><span style="display:flex;"><span>    height: 100%;
</span></span><span style="display:flex;"><span>    width: 100%;
</span></span><span style="display:flex;"><span>    user-select: none;  // ç¦ç”¨å³é”®å¼¹èœå•
</span></span><span style="display:flex;"><span>} 
</span></span></code></pre></div><h2 id="å®ç°æ¸¸æˆå¼•æ“æ¡†æ¶">å®ç°æ¸¸æˆå¼•æ“æ¡†æ¶<a hidden class="anchor" aria-hidden="true" href="#å®ç°æ¸¸æˆå¼•æ“æ¡†æ¶">#</a></h2>
<p>æ¸¸æˆä¸­ï¼Œç‰©ä½“åœ¨ç§»åŠ¨ï¼Œå…¶å®ç°åŸç†æ˜¯ï¼šæ¯ä¸€ä¸ªåŠ¨ä½œéƒ½ä¼šæ¸²æŸ“å¤šå¼ å›¾ç‰‡å‡ºæ¥ï¼Œç„¶åå›¾ç‰‡å¿«é€Ÿçš„åˆ‡æ¢ï¼Œä»è€Œå®ç°åŠ¨çš„è¿‡ç¨‹</p>
<p>å› æ­¤ï¼Œéœ€è¦å…ˆå®ç°ä¸€ä¸ªæ¸¸æˆå¼•æ“çš„åŸºç±» <code>AcGameObject</code> ï¼Œä½¿å¾—æ¯å¸§èƒ½æ¸²æŸ“ä¸€å¼ å›¾ç‰‡å‡ºæ¥</p>
<p>è¯¥åŸºç±»éœ€è¦å…·å¤‡çš„åŠŸèƒ½æœ‰ï¼š</p>
<ol>
<li><code>start()</code> åœ¨æ¸¸æˆå¼€å§‹çš„ç¬¬ä¸€å¸§æ—¶éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼ˆä¸€èˆ¬æ˜¯åˆ›å»ºå¯¹è±¡ï¼‰</li>
<li><code>update()</code> åœ¨æ¸¸æˆå¼€å§‹åçš„æ¯ä¸€å¸§å‡ä¼šæ‰§è¡Œçš„ä»»åŠ¡ï¼ˆä¸€èˆ¬æ˜¯æ¸²æŸ“å½“å‰å¯¹è±¡çš„å„ç§çŠ¶æ€ï¼‰</li>
<li><code>on_destroy()</code> åˆ æ‰è¯¥ç‰©ä½“å‰éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼ˆä¸€èˆ¬æ˜¯åˆ æ‰åŠ¨ç”»ï¼Œæˆ–è€…ç»™å¯¹æ‰‹åŠ åˆ†ï¼‰</li>
<li><code>destroy()</code> åˆ æ‰è¯¥ç‰©ä½“</li>
</ol>
<p>æ ¹æ®ä¸Šè¿°é€»è¾‘ï¼Œæˆ‘ä»¬å°±å¯ä»¥åŸºæœ¬æ­å»ºå‡ºæ¥ä¸€ä¸ªæ¸¸æˆå¼•æ“çš„åŸºç±»äº†ï¼Œå…·ä½“å¦‚ä¸‹ï¼š <code>/static/js/playground/ac_game_object/zbase.js</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">AC_GAME_OBJECTS</span> <span style="color:#f92672">=</span> [];   <span style="color:#75715e">// ç”¨äºè®°å½•å½“å‰ç”»å¸ƒä¸­ï¼Œéœ€è¦æ¸²æŸ“çš„å¯¹è±¡æœ‰å“ªäº›
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AcGameObject</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">constructor</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">AC_GAME_OBJECTS</span>.<span style="color:#a6e22e">push</span>(<span style="color:#66d9ef">this</span>);  <span style="color:#75715e">// å°†å½“å‰æ–°å»ºçš„å¯¹è±¡ï¼ŒåŠ å…¥åˆ°å…¨å±€çš„ç”»å¸ƒä¸­å»ï¼Œå‚ä¸æ¸²æŸ“
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">has_called_start</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;  <span style="color:#75715e">// æ˜¯å¦æ‰§è¡Œè¿‡ start å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">timedelta</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;             <span style="color:#75715e">// å½“å‰å¸§è·ç¦»ä¸Šä¸€å¸§çš„æ—¶é—´é—´éš”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// è¯¥æ•°æ®è®°å½•æ˜¯ä¸ºäº†åç»­è®¡ç®—é€Ÿåº¦ç­‰å‚æ•°çš„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">start</span>() {   <span style="color:#75715e">// åªä¼šåœ¨ç¬¬ä¸€å¸§æ‰§è¡Œä¸€æ¬¡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">update</span>() {  <span style="color:#75715e">// æ¯ä¸€å¸§å‡ä¼šæ‰§è¡Œä¸€æ¬¡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">on_destroy</span>() {  <span style="color:#75715e">// åœ¨è¢«é”€æ¯å‰æ‰§è¡Œä¸€æ¬¡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">destroy</span>() { <span style="color:#75715e">// åˆ æ‰è¯¥ç‰©ä½“
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">on_destroy</span>();  <span style="color:#75715e">//åˆ æ‰è¯¥ç‰©ä½“å‰ï¼Œæ‰§è¡Œåˆ å‰çš„æ“ä½œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// åœ¨å…¨å±€æ¸²æŸ“ç‰©ä½“ä¸­ï¼Œæ‰¾åˆ°è¯¥ç‰©ä½“ï¼Œå¹¶å°†å…¶åˆ æ‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">AC_GAME_OBJECTS</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">++</span> ) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">AC_GAME_OBJECTS</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">===</span> <span style="color:#66d9ef">this</span>) {  <span style="color:#75715e">// ä¸‰ç­‰å·ï¼Œåœ¨jsé‡Œé¢å¤–åŠ äº†ä¸€å±‚ç±»å‹ç›¸ç­‰çº¦æŸ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#a6e22e">AC_GAME_OBJECTS</span>.<span style="color:#a6e22e">splice</span>(<span style="color:#a6e22e">i</span>, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">last_timestamp</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">AC_GAME_ANIMATION</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">timestamp</span>) {  <span style="color:#75715e">// å›è°ƒå‡½æ•°ï¼Œå®ç°ï¼šæ¯ä¸€å¸§é‡ç»˜æ—¶ï¼Œéƒ½ä¼šæ‰§è¡Œä¸€é
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">AC_GAME_OBJECTS</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">++</span> ) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">obj</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">AC_GAME_OBJECTS</span>[<span style="color:#a6e22e">i</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">has_called_start</span>) { <span style="color:#75715e">// å¦‚æœè¿˜æœªæ‰§è¡Œåˆå§‹å¸§åŠ¨ä½œï¼Œå°±å…ˆæ‰§è¡Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">start</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">has_called_start</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> {  <span style="color:#75715e">// æ‰§è¡Œè¿‡åˆå§‹å¸§ï¼Œå°±æ‰§è¡Œæ¯ä¸€å¸§çš„ä»»åŠ¡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">timedelta</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">timestamp</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">last_timestamp</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">update</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">last_timestamp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">timestamp</span>; <span style="color:#75715e">// æ›´æ–°æœ€åä¸€æ¬¡æ—¶é—´æˆ³
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">requestAnimationFrame</span>(<span style="color:#a6e22e">AC_GAME_ANIMATION</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">requestAnimationFrame</span>(<span style="color:#a6e22e">AC_GAME_ANIMATION</span>);   <span style="color:#75715e">// JSçš„APIï¼Œå¯ä»¥è°ƒç”¨1å¸§é‡Œé¢çš„å‡½æ•°ã€‚(æœ‰äº›æµè§ˆå™¨çš„ä¸€ç§’å¸§æ•°ä¸ä¸€å®šç›¸ç­‰)
</span></span></span></code></pre></div><blockquote>
<p><strong>æ¥ä¸‹æ¥æ‰€æœ‰çš„ä¸€åˆ‡æ¸¸æˆï¼Œéƒ½æ˜¯åŸºäºè¿™ä¸ªå¼•æ“çš„åŸºç±»å®Œæˆçš„</strong></p>
</blockquote>
<h2 id="å®ç°æ¸¸æˆåœ°å›¾åŠŸèƒ½">å®ç°æ¸¸æˆåœ°å›¾åŠŸèƒ½<a hidden class="anchor" aria-hidden="true" href="#å®ç°æ¸¸æˆåœ°å›¾åŠŸèƒ½">#</a></h2>
<p>ç›®æ ‡ï¼šå®ç°ä¸€ä¸ªæ¯ä¸€ç§’éƒ½åœ¨æ¸²æŸ“çš„çº¯é»‘èƒŒæ™¯</p>
<p>è™½ç„¶ç°é˜¶æ®µè¦å®ç°çš„åœ°å›¾è¾ƒä¸ºç®€å•ï¼Œä½†ä¸ºäº†åæœŸçš„æ‹“å±•æ€§ï¼Œæ•…è¿˜æ˜¯è€ƒè™‘æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹æ¥å®Œæˆ</p>
<p>ç„¶ååœ¨ <code>js</code> ä¸­ï¼Œå·²ç»å°è£…å¥½äº†ä¸€ä¸ª <code>canvas</code> çš„ <code>api</code> æ¥å¸®åŠ©å®ç°èƒŒæ™¯ç”»å¸ƒï¼Œç›´æ¥è°ƒç”¨å³å¯</p>
<p>å…ˆé“ºå¼€ç”»å¸ƒï¼Œç„¶åè®¾ç½®ä¸ºé»‘è‰²</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>static/js/playground/zbase.js
</span></span><span style="display:flex;"><span>class AcGamePlayground {
</span></span><span style="display:flex;"><span>    constructor(root) {
</span></span><span style="display:flex;"><span>        ......
</span></span><span style="display:flex;"><span>        // $(&#39;.playground&#39;)å¯¹è±¡å·²ç»åœ¨ css æ–‡ä»¶é‡Œæ¸²æŸ“å‡ºé«˜å®½äº†
</span></span><span style="display:flex;"><span>        // ç°åœ¨æŠŠä»–çš„é«˜å®½å­˜ä¸‹æ¥ï¼Œå¾€ä¸‹ä¼ é€’
</span></span><span style="display:flex;"><span>        this.width = this.$playground.width();
</span></span><span style="display:flex;"><span>        this.height = this.$playground.height();
</span></span><span style="display:flex;"><span>        this.game_map = new GameMap(this);
</span></span><span style="display:flex;"><span>        ......
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    .....
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>static/js/playground/game-map/zbase.js
</span></span><span style="display:flex;"><span>class GameMap extends AcGameObject {    // ç»§æ‰¿è‡ªæ¸¸æˆå¼•æ“åŸºç±»
</span></span><span style="display:flex;"><span>    constructor(playground) {
</span></span><span style="display:flex;"><span>        super();    // è‡ªå‡½æ•°åŠŸèƒ½ï¼šè°ƒç”¨åŸºç±»çš„æ„é€ å‡½æ•°
</span></span><span style="display:flex;"><span>        this.playground = playground;
</span></span><span style="display:flex;"><span>        this.$canvas = $(`&lt;canvas&gt;&lt;/canvas&gt;`); // åˆ›å»ºä¸€ä¸ªcanvasçš„jQueryå¯¹è±¡ï¼Œå°±æ˜¯æˆ‘ä»¬è¦å®ç°çš„ç”»å¸ƒ
</span></span><span style="display:flex;"><span>        this.ctx = this.$canvas[0].getContext(&#39;2d&#39;); // jQueryå¯¹è±¡æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œç¬¬ä¸€ä¸ªç´¢å¼•æ˜¯htmlå¯¹è±¡
</span></span><span style="display:flex;"><span>        // è®¾ç½®ç”»å¸ƒçš„å®½é«˜
</span></span><span style="display:flex;"><span>        this.ctx.canvas.width = this.playground.width;
</span></span><span style="display:flex;"><span>        this.ctx.canvas.height = this.playground.height;
</span></span><span style="display:flex;"><span>        this.playground.$playground.append(this.$canvas);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    start() {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    update() {  // æ¸¸æˆåœ°å›¾æ¯å¸§éƒ½è¦æ¸²æŸ“
</span></span><span style="display:flex;"><span>        this.render();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    render() {
</span></span><span style="display:flex;"><span>        this.ctx.fillStyle = &#34;rgba(0, 0, 0, 0.2)&#34;;
</span></span><span style="display:flex;"><span>        this.ctx.fillRect(0, 0, this.ctx.canvas.width, this.ctx.canvas.height);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span> }
</span></span></code></pre></div><h2 id="å®ç°ç©å®¶æ˜¾ç¤ºåŠŸèƒ½">å®ç°ç©å®¶æ˜¾ç¤ºåŠŸèƒ½<a hidden class="anchor" aria-hidden="true" href="#å®ç°ç©å®¶æ˜¾ç¤ºåŠŸèƒ½">#</a></h2>
<p>æ¯›å¯ç‰ˆç©å®¶æ˜¾ç¤ºï¼Œæ¯ä¸ªç©å®¶å®šä¹‰æˆä¸€ä¸ªåœ†ï¼Œç„¶åæ¸²æŸ“åœ¨å‰ç«¯</p>
<p>éœ€è¦å¯¹äºç©å®¶ç±»å®šä¹‰å¤šä¸ªå‚æ•°ï¼Œä»¥æ–¹ä¾¿æ—¥åæ‹“å±•ï¼š</p>
<ol>
<li><code>x</code> å½“å‰ä½ç½®çš„æ¨ªåæ ‡</li>
<li><code>y</code> å½“å‰ä½ç½®çš„çºµåæ ‡</li>
<li><code>radius</code> å½“å‰çš„åŠå¾„</li>
<li><code>speed</code> å½“å‰çš„é€Ÿåº¦</li>
<li><code>is_me</code> è¯¥å¯¹è±¡æ˜¯å¦æ˜¯å½“å‰ç©å®¶æ“æ§çš„å¯¹è±¡ï¼ˆä¸€æ˜¯åŒºåˆ«äº botï¼ŒäºŒæ˜¯åŒºåˆ«äº æ—¥åè”æœºçš„å…¶ä»–ç©å®¶ï¼‰</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>static/js/playground/zbase.js
</span></span><span style="display:flex;"><span>class AcGamePlayground {
</span></span><span style="display:flex;"><span>    constructor(root) {
</span></span><span style="display:flex;"><span>        ......
</span></span><span style="display:flex;"><span>        this.players = [];  // å­˜æ”¾å½“å‰æ¸¸æˆä¸­çš„æ‰€æœ‰ç©å®¶
</span></span><span style="display:flex;"><span>        // å°†ç©å®¶åŠ å…¥æ¸¸æˆä¸­
</span></span><span style="display:flex;"><span>        this.players.push(new Player(this, this.width / 2, this.height / 2, this.height * 0.05, &#34;white&#34;, this.height * 0.15, true));
</span></span><span style="display:flex;"><span>        ......
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    .....
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>static/js/playground/player/zbase.js
</span></span><span style="display:flex;"><span>class Player extends AcGameObject {
</span></span><span style="display:flex;"><span>    constructor(playground, x, y, radius, color, speed, is_me) {
</span></span><span style="display:flex;"><span>        super();
</span></span><span style="display:flex;"><span>        // æŠŠä¿¡æ¯éƒ½å­˜ä¸‹æ¥
</span></span><span style="display:flex;"><span>        this.playground = playground;
</span></span><span style="display:flex;"><span>        this.ctx = this.playground.game_map.ctx;
</span></span><span style="display:flex;"><span>        this.x = x;
</span></span><span style="display:flex;"><span>        this.y = y;
</span></span><span style="display:flex;"><span>        this.color = color;
</span></span><span style="display:flex;"><span>        this.speed = speed;
</span></span><span style="display:flex;"><span>        this.radius = radius;
</span></span><span style="display:flex;"><span>        this.is_me = is_me;
</span></span><span style="display:flex;"><span>        // ç”¨äºæµ®ç‚¹æ•°è¿ç®—
</span></span><span style="display:flex;"><span>        this.eps = 0.1;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    start() {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    update() {
</span></span><span style="display:flex;"><span>        this.render();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    render() {  // æ¸²æŸ“ä¸€ä¸ªåœ†
</span></span><span style="display:flex;"><span>        this.ctx.beginPath();
</span></span><span style="display:flex;"><span>        this.ctx.arc(this.x, this.y, this.radius, 0, 2 * Math.PI, false);
</span></span><span style="display:flex;"><span>        this.ctx.fillStyle = this.color;
</span></span><span style="display:flex;"><span>        this.ctx.fill();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    on_destroy() {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="å®ç°ç©å®¶ç§»åŠ¨åŠŸèƒ½">å®ç°ç©å®¶ç§»åŠ¨åŠŸèƒ½<a hidden class="anchor" aria-hidden="true" href="#å®ç°ç©å®¶ç§»åŠ¨åŠŸèƒ½">#</a></h2>
<p>ç§»åŠ¨çš„å®ç°é€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯è®©æ¯å¸§æ¸²æŸ“çš„åœ†çš„ä½ç½®å‘ç”Ÿç§»åŠ¨å³å¯</p>
<p>ä¸Šè¿°ç®€å•é€»è¾‘çš„å®ç°å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Player</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">AcGameObject</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">constructor</span>(....)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">vx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">vy</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">update</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">x</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">x</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">y</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">y</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">render</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç„¶åæˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªå‘é¼ æ ‡ç‚¹å‡»ä½ç½®ç§»åŠ¨çš„åŠŸèƒ½</p>
<p>è¿™å°±éœ€è¦è®¾ç½®ä¸€ä¸ª <code>click</code> äº‹ä»¶çš„ç›‘å¬å‡½æ•°ï¼Œåˆ†åˆ«ä¼ é€’ï¼š</p>
<ol>
<li>é¼ æ ‡ç‚¹å‡»äº‹ä»¶</li>
<li>é¼ æ ‡ç‚¹å‡»ä½ç½®çš„æ¨ªåæ ‡</li>
<li>é¼ æ ‡ç‚¹å‡»ä½ç½®çš„çºµåæ ‡</li>
</ol>
<p>ç„¶åå¼€å§‹è®©åœ†çš„ä½ç½®é€æ­¥å‘é¼ æ ‡ç‚¹å‡»ä½ç½®è¿›è¡Œç§»åŠ¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">start</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">is_me</span>) {   <span style="color:#75715e">// å¯¹äºç”¨æˆ·ç©å®¶ï¼ŒåŠ ä¸Šç›‘å¬å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">add_listening_events</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">add_listening_events</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">outer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æŠŠé¼ æ ‡å³é”®è°ƒå‡ºèœå•æ çš„åŠŸèƒ½å…³æ‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">playground</span>.<span style="color:#a6e22e">game_map</span>.<span style="color:#a6e22e">$canvas</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#34;contextmenu&#34;</span>, <span style="color:#66d9ef">function</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æŠŠå³é”®æ§åˆ¶ç§»åŠ¨åŠŸèƒ½åŠ ä¸Š
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">playground</span>.<span style="color:#a6e22e">game_map</span>.<span style="color:#a6e22e">$canvas</span>.<span style="color:#a6e22e">mousedown</span>(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">e</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å·¦é”®:1 ä¸­é”®:2 å³é”®:3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">which</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">3</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">outer</span>.<span style="color:#a6e22e">move_to</span>(<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">clientX</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">clientY</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç„¶åï¼Œæˆ‘ä»¬æ¥å®ç°ç§»åŠ¨åŠŸèƒ½çš„å‡½æ•° <code>move_to(tx, ty)</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">constructor</span>(...){
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">vx</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;    <span style="color:#75715e">// xæ–¹å‘ä¸Šçš„ç§»åŠ¨é€Ÿåº¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">vy</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;    <span style="color:#75715e">// yæ–¹å‘ä¸Šçš„ç§»åŠ¨é€Ÿåº¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">move_length</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;   <span style="color:#75715e">// å‰©ä½™ç§»åŠ¨è·ç¦»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">get_dist</span> (<span style="color:#a6e22e">x1</span>, <span style="color:#a6e22e">y1</span>, <span style="color:#a6e22e">x2</span>, <span style="color:#a6e22e">y2</span>) { <span style="color:#75715e">// æ±‚ä¸¤ç‚¹çš„æ¬§å‡ é‡Œå¾—è·ç¦»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">dx</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">x2</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">x1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">dy</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">y2</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">y1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> Math.<span style="color:#a6e22e">sqrt</span>(<span style="color:#a6e22e">dx</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">dx</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">dy</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">dy</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">move_to</span>(<span style="color:#a6e22e">tx</span>, <span style="color:#a6e22e">ty</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// è®¡ç®—ç§»åŠ¨è·ç¦»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">move_length</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">get_dist</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">x</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">y</span>, <span style="color:#a6e22e">tx</span>, <span style="color:#a6e22e">ty</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// è®¡ç®—ç§»åŠ¨è§’åº¦ï¼Œapiæ¥å£ï¼šatan2(dy, dx)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">angle</span> <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">atan2</span>(<span style="color:#a6e22e">ty</span> <span style="color:#f92672">-</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">y</span>, <span style="color:#a6e22e">tx</span> <span style="color:#f92672">-</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">x</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ä½ç§» 1 ä¸ªå•ä½é•¿åº¦ï¼ˆå‘ç€çŸ¢é‡æ–¹å‘ç§»åŠ¨åˆ°å•ä½åœ†ä¸Šï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">vx</span> <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">cos</span>(<span style="color:#a6e22e">angle</span>);  <span style="color:#75715e">// æç›´äº’åŒ–
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">vy</span> <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">sin</span>(<span style="color:#a6e22e">angle</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">update</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æµ®ç‚¹æ•°ç²¾åº¦è¿ç®—
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">move_length</span> <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">eps</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">move_length</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">vx</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">vy</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// è®¡ç®—å•ä½å¸§é‡Œçš„ç§»åŠ¨è·ç¦»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">moved</span> <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">min</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">move_length</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">speed</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">timedelta</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">1000</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">x</span> <span style="color:#f92672">+=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">vx</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">moved</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">y</span> <span style="color:#f92672">+=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">vy</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">moved</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// è¿˜è¦å‡æ‰ç§»åŠ¨çš„è·ç¦»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">move_length</span> <span style="color:#f92672">-=</span> <span style="color:#a6e22e">moved</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">render</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>è¿™æ ·å°±å®ç°äº†ç©å®¶çš„ç§»åŠ¨åŠŸèƒ½äº†ï¼Œå¯ä»¥ç™»å½• <code>id:socket</code> è°ƒè¯•è¯¥åŠŸèƒ½</p>
<h2 id="å®ç°ç«çƒæŠ€èƒ½çš„åŠŸèƒ½">å®ç°ç«çƒæŠ€èƒ½çš„åŠŸèƒ½<a hidden class="anchor" aria-hidden="true" href="#å®ç°ç«çƒæŠ€èƒ½çš„åŠŸèƒ½">#</a></h2>
<p>ç«çƒå¯¹è±¡çš„å»ºç«‹ä¸ç©å®¶åŸºæœ¬ä¸€è‡´ï¼Œç›´æ¥ç…§æ¬ï¼Œåœ¨ä»ç»†èŠ‚ä¸Šæ”¹æ”¹å³å¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>js/src/playground/skill/fireball/zbase.js
</span></span><span style="display:flex;"><span>class FireBall extends AcGameObject {
</span></span><span style="display:flex;"><span>    constructor(playground, player, x, y, radius, vx, vy, color, speed, move_length, damage) {
</span></span><span style="display:flex;"><span>        super();
</span></span><span style="display:flex;"><span>        this.playground = playground;
</span></span><span style="display:flex;"><span>        this.ctx = this.playground.game_map.ctx;
</span></span><span style="display:flex;"><span>        this.player = player;
</span></span><span style="display:flex;"><span>        this.x = x;
</span></span><span style="display:flex;"><span>        this.y = y;
</span></span><span style="display:flex;"><span>        this.vx = vx;
</span></span><span style="display:flex;"><span>        this.vy = vy;
</span></span><span style="display:flex;"><span>        this.radius = radius;
</span></span><span style="display:flex;"><span>        this.color = color;
</span></span><span style="display:flex;"><span>        this.speed = speed;
</span></span><span style="display:flex;"><span>        this.move_length = move.length;
</span></span><span style="display:flex;"><span>        this.damage = damage;
</span></span><span style="display:flex;"><span>        this.eps = 0.1;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    start() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    update() {
</span></span><span style="display:flex;"><span>        if (this.move_length &lt; this.eps) {
</span></span><span style="display:flex;"><span>            this.destroy();
</span></span><span style="display:flex;"><span>            return false;
</span></span><span style="display:flex;"><span>        } else {
</span></span><span style="display:flex;"><span>            let moved = Math.min(this.move_length, this.speed * this.timedelta / 1000);
</span></span><span style="display:flex;"><span>            this.x += this.vx * moved;
</span></span><span style="display:flex;"><span>            this.y += this.vy * moved;
</span></span><span style="display:flex;"><span>            this.move_length -= moved;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        this.render();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    render() {
</span></span><span style="display:flex;"><span>        this.ctx.beginPath();
</span></span><span style="display:flex;"><span>        this.ctx.arc(this.x, this.y, this.radius, 0, 2 * Math * Pi, false);
</span></span><span style="display:flex;"><span>        this.ctx.fillStyle = this.color;
</span></span><span style="display:flex;"><span>        this.ctx.fill();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>} 
</span></span></code></pre></div><p>ç„¶ååœ¨ç©å®¶èº«ä¸Šå®ç°å‘ç«çƒçš„åŠŸèƒ½</p>
<p>åŸºæœ¬å®ç°é€»è¾‘ï¼šå½“å‰é€‰ä¸­äº†ç«çƒæŠ€èƒ½ï¼Œé¼ æ ‡å·¦é”®ç‚¹å‡»ä¸€å¤„ï¼Œå‘è¯¥å¤„å‘å°„ä¸€ä¸ªç«çƒ</p>
<p>å› æ­¤ï¼Œä¸ºäº†çŸ¥é“ç”¨æˆ·æ˜¯å¦é€‰æ‹©äº†æŠ€èƒ½ï¼Œéœ€è¦åŠ ä¸€ä¸ªé”®ç›˜è§¦å‘äº‹ä»¶ç›‘å¬å‡½æ•°ï¼Œç„¶ååŠ ä¸€ä¸ªé¼ æ ‡å·¦é”®è§¦å‘äº‹ä»¶ç›‘å¬å‡½æ•°</p>
<p>ç„¶åå‘å°„ä¸€ä¸ªç«çƒå³å¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>js/src/playground/player/zbase.js
</span></span><span style="display:flex;"><span>constructor(...) {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    this.cur_skill = null;  // è®°å½•å½“å‰é€‰æ‹©çš„æŠ€èƒ½
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>add_listening_events() {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    this.playground.game_map.$canvas.mousedown(function(e) {
</span></span><span style="display:flex;"><span>        // å·¦é”®:1 ä¸­é”®:2 å³é”®:3
</span></span><span style="display:flex;"><span>        if (e.which === 3) {
</span></span><span style="display:flex;"><span>            outer.move_to(e.clientX, e.clientY);
</span></span><span style="display:flex;"><span>        } else if (e.which === 1) {     // é¼ æ ‡å·¦é”®äº‹ä»¶
</span></span><span style="display:flex;"><span>            if (outer.cur_skill === &#34;fireball&#34;) {   // å½“å‰å·²ç»é€‰ä¸­ç«çƒæŠ€èƒ½
</span></span><span style="display:flex;"><span>                outer.shoot_fireball(e.clientX, e.clientY);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        outer.cur_skill = null; // æ¸…ç©ºå½“å‰æŠ€èƒ½
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>    $(window).keydown(function(e) {
</span></span><span style="display:flex;"><span>        if (e.which === 81) {       // é”®ç›˜æŒ‰ä¸‹äº‹ä»¶
</span></span><span style="display:flex;"><span>            outer.cur_skill = &#34;fireball&#34;;
</span></span><span style="display:flex;"><span>            return false;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>shoot_fireball(tx, ty) {
</span></span><span style="display:flex;"><span>    // ç¡®å®šç«çƒçš„å‚æ•°
</span></span><span style="display:flex;"><span>    let x = this.x, y = this.y; // ç«çƒå‘å°„ç‚¹å°±æ˜¯å½“å‰ç©å®¶çš„ä½ç½®
</span></span><span style="display:flex;"><span>    let radius = this.playground.height * 0.01;
</span></span><span style="display:flex;"><span>    let angle = Math.atan2(ty - this.y, tx - this.x);
</span></span><span style="display:flex;"><span>    let vx = Math.cos(angle), vy = Math.sin(angle);
</span></span><span style="display:flex;"><span>    let color = &#34;orange&#34;;
</span></span><span style="display:flex;"><span>    let speed = this.playground.height * 0.5;
</span></span><span style="display:flex;"><span>    let move_length = this.playground.height * 1.0;
</span></span><span style="display:flex;"><span>    let damage = this.playground.height * 0.01;
</span></span><span style="display:flex;"><span>    new FireBall(this.playground, this, x, y, radius, vx, vy, color, speed, move_length, damage);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>è¿™æ ·å°±æˆåŠŸå®ç°äº†ç©å®¶å‘å°„ç«çƒçš„åŠŸèƒ½äº†</p>
<h2 id="å®ç°å•äººæ¨¡å¼ä¸‹çš„äººæœºåŠŸèƒ½">å®ç°å•äººæ¨¡å¼ä¸‹çš„äººæœºåŠŸèƒ½<a hidden class="anchor" aria-hidden="true" href="#å®ç°å•äººæ¨¡å¼ä¸‹çš„äººæœºåŠŸèƒ½">#</a></h2>
<p>å…ˆåˆ›å»ºå¥½ 5 ä¸ªäººæœº <code>playground/zbase.js</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#75715e">//åˆ›å»ºå¥½ 5 ä¸ªäººæœº
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span> (<span style="color:#a6e22e">len</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">5</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">++</span> ) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">players</span>.<span style="color:#a6e22e">push</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Player</span>(<span style="color:#66d9ef">this</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">width</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">height</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">height</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.05</span>, <span style="color:#e6db74">&#34;blue&#34;</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">height</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.15</span>, <span style="color:#66d9ef">false</span>));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>è¿™æ ·åˆ›å»ºå‡ºæ¥çš„ 5 ä¸ªäººæœºæ˜¯ä¸ä¼šè¡ŒåŠ¨çš„</p>
<p>æˆ‘ä»¬å†™ä¸€ä¸ªç®€æ˜“çš„ AI ç¨‹åºï¼Œè®©ä»–ä»¬ä¹Ÿä¼šç§»åŠ¨</p>
<p>è¿™é‡Œå®ç°çš„é€»è¾‘æ˜¯ï¼šæ¯æ¬¡éšæœºä¸€ä¸ªç›®çš„åœ°ï¼Œå‘ç›®çš„åœ°ç§»åŠ¨ï¼Œç„¶åå†éšæœºä¸€ä¸ªç›®çš„åœ°ï¼Œå¾ªç¯ä¸‹å»</p>
<p>æ ¹æ®è¯¥é€»è¾‘ï¼Œä¿®æ”¹ä¸¤ä¸ªå‡½æ•°å³å¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>playground/player/zbase.js
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>start() {
</span></span><span style="display:flex;"><span>    if (this.is_me) {   // å¯¹äºç”¨æˆ·ç©å®¶ï¼ŒåŠ ä¸Šç›‘å¬å‡½æ•°
</span></span><span style="display:flex;"><span>        this.add_listening_events();
</span></span><span style="display:flex;"><span>    } else {
</span></span><span style="display:flex;"><span>        let tx = Math.random() * this.playground.width;
</span></span><span style="display:flex;"><span>        let ty = Math.random() * this.playground.height;
</span></span><span style="display:flex;"><span>        this.move_to(tx, ty);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span> update() {
</span></span><span style="display:flex;"><span>    if (this.move_length &lt; this.eps) {
</span></span><span style="display:flex;"><span>        this.move_length = 0;
</span></span><span style="display:flex;"><span>        this.vx = this.vy = 0;
</span></span><span style="display:flex;"><span>        if (!this.is_me) {   // å¦‚æœæ˜¯äººæœºï¼Œåœä¸‹æ¥æ—¶å†éšæœºä¸€ä¸ªæ–¹å‘å‰è¿›
</span></span><span style="display:flex;"><span>            let tx = Math.random() * this.playground.width;
</span></span><span style="display:flex;"><span>            let ty = Math.random() * this.playground.height;
</span></span><span style="display:flex;"><span>            this.move_to(tx, ty);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>on_destroy() {
</span></span><span style="display:flex;"><span>    for (let i = 0; i &lt; this.playground.players.length; i ++ ) {
</span></span><span style="display:flex;"><span>        if (this.playground.players[i] === this) {
</span></span><span style="display:flex;"><span>            this.playground.players.splice(i, 1);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="å®ç°æŠ€èƒ½å‘½ä¸­æ•ˆæœç¢°æ’æ£€æµ‹åŠŸèƒ½">å®ç°æŠ€èƒ½å‘½ä¸­æ•ˆæœï¼ˆç¢°æ’æ£€æµ‹åŠŸèƒ½ï¼‰<a hidden class="anchor" aria-hidden="true" href="#å®ç°æŠ€èƒ½å‘½ä¸­æ•ˆæœç¢°æ’æ£€æµ‹åŠŸèƒ½">#</a></h2>
<p>å®ç°é€»è¾‘ï¼šæ£€æµ‹ä¸¤ä¸ªåœ†çš„ä¸­å¿ƒè·ç¦»æ˜¯å¦å°äºä¸¤ä¸ªåœ†çš„åŠå¾„ä¹‹å’Œ</p>
<p>å°äºç­‰äºæ—¶ï¼Œä»£è¡¨å‘ç”Ÿç¢°æ’ï¼Œå¼€å§‹æ‰§è¡Œå‘½ä¸­æ•ˆæœï¼š</p>
<ol>
<li>è¢«å‡»ä¸­ç”¨æˆ·æ‰è¡€</li>
<li>è¢«å‡»ä¸­ç”¨æˆ·æ”¶åˆ°å‘åå‡»é€€æ•ˆæœ</li>
</ol>
<p>ç¢°æ’æ£€æµ‹å†™åœ¨ç«çƒç±»é‡Œï¼Œå‡»é€€æ•ˆæœå†™åœ¨ç©å®¶ç±»é‡Œ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>fireball/zbase.js
</span></span><span style="display:flex;"><span>update() {
</span></span><span style="display:flex;"><span>    if (...) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    } else {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        // ç¢°æ’æ£€æµ‹
</span></span><span style="display:flex;"><span>        for (let i = 0; i &lt; this.playground.players.length; i ++ ) {
</span></span><span style="display:flex;"><span>            let player = this.playground.players[i];
</span></span><span style="display:flex;"><span>            if (this.player !== player &amp;&amp; this.is_collision(player)) {  // ç¢°æ’å‘ç”Ÿä¸€å®šæ˜¯åœ¨éæ–½æ³•è€…èº«ä¸Š
</span></span><span style="display:flex;"><span>                this.attack(player);    // ç«çƒå‘½ä¸­ï¼Œç›®æ ‡ç©å®¶æ‰§è¡Œå‡»é€€æ•ˆæœ
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    this.render();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>get_dist(x1, y1, x2, y2) {  // è·å¾—ä¸¤ç‚¹çš„æ¬§å‡ é‡Œå¾—è·ç¦»
</span></span><span style="display:flex;"><span>        let dx = x2 - x1;
</span></span><span style="display:flex;"><span>        let dy = y2 - y1;
</span></span><span style="display:flex;"><span>        return Math.sqrt(dx * dx + dy * dy);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>is_collision(player) {  // æ£€æµ‹ä¸¤ä¸ªåœ†çš„ä¸­å¿ƒè·ç¦»æ˜¯å¦å°äºä¸¤ä¸ªåœ†çš„åŠå¾„ä¹‹å’Œ
</span></span><span style="display:flex;"><span>    let distance = this.get_dist(this.x, this.y, player.x, player.y);
</span></span><span style="display:flex;"><span>    if (distance &lt; (this.radius + player.radius))
</span></span><span style="display:flex;"><span>        return true;
</span></span><span style="display:flex;"><span>    return false;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>attack(player) {    // ç«çƒå‘½ä¸­ï¼Œç›®æ ‡ç©å®¶æ‰§è¡Œå‡»é€€æ•ˆæœ
</span></span><span style="display:flex;"><span>    let angle = Math.atan2(player.y - this.y, player.x - this.x);   // è®¡ç®—è§’åº¦
</span></span><span style="display:flex;"><span>    player.is_attacked(angle, this.damage); // ç«çƒå‘½ä¸­ï¼Œç›®æ ‡ç©å®¶æ‰§è¡Œå‡»é€€æ•ˆæœ
</span></span><span style="display:flex;"><span>    this.destroy(); // ç«çƒå‘½ä¸­åï¼Œè‡ªç„¶æ¶ˆå¤±
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>è¢«å‡»é€€çš„æ—¶å€™ï¼ŒåŸæ¥çš„ç§»åŠ¨é€Ÿåº¦åº”è¯¥ç½®ä¸º 0ï¼Œå½“å‰çš„ç§»åŠ¨åº”è¯¥è½¬ä¸ºå‘è¢«å‡»ä¸­æ–¹å‘ä¸Šçš„ç§»åŠ¨</strong> <code>player/zbase.js</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">is_attacked</span>(<span style="color:#a6e22e">angle</span>, <span style="color:#a6e22e">damage</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">radius</span> <span style="color:#f92672">-=</span> <span style="color:#a6e22e">damage</span>;  <span style="color:#75715e">// å—ä¼¤ï¼ŒåŠå¾„å‡å°‘
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">radius</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">10</span>) { <span style="color:#75715e">// å½“åŠå¾„å°äº10åƒç´ æ—¶ï¼Œä»£è¡¨æ­»äº¡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">destroy</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å¼€å§‹æ‰§è¡Œå‡»é€€æ•ˆæœ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">damage_vx</span> <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">cos</span>(<span style="color:#a6e22e">angle</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">damage_vy</span> <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">sin</span>(<span style="color:#a6e22e">angle</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">damage_speed</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">damage</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">100</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">speed</span> <span style="color:#f92672">*=</span> <span style="color:#ae81ff">0.5</span>;  <span style="color:#75715e">// è¢«å‡»ä¸­ä»¥åç§»åŠ¨é€Ÿåº¦å‡åŠ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">update</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">damage_speed</span> <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">eps</span>) {   <span style="color:#75715e">// å½“å‰ä»å¤„äºå‡»é€€æ•ˆæœä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">vx</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">vy</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">move_length</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">x</span> <span style="color:#f92672">+=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">damage_vx</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">damage_speed</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">timedelta</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">1000</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">y</span> <span style="color:#f92672">+=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">damage_vy</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">damage_speed</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">timedelta</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">1000</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">damage_speed</span> <span style="color:#f92672">*=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">friction</span>; <span style="color:#75715e">// å‡»é€€é€Ÿåº¦ä¹˜ä»¥æ‘©æ“¦ç³»æ•°ï¼Œå·²è¾¾åˆ°å‰Šå‡çš„ç›®çš„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="è¢«å‡»ä¸­ä»¥åçš„ç²’å­æ•ˆæœç‰¹æ•ˆ">è¢«å‡»ä¸­ä»¥åçš„ç²’å­æ•ˆæœç‰¹æ•ˆ<a hidden class="anchor" aria-hidden="true" href="#è¢«å‡»ä¸­ä»¥åçš„ç²’å­æ•ˆæœç‰¹æ•ˆ">#</a></h2>
<p>å®ç°é€»è¾‘ï¼šè¢«å‡»ä¸­ä»¥åï¼Œåœ¨ç©å®¶é™„è¿‘éšæœºç”Ÿæˆä¸€äº›ç²’å­å°çƒ</p>
<p>å› æ­¤æˆ‘ä»¬è¦å…ˆå®ç° ç²’å­å°çƒ å¯¹è±¡</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>static/js/src/playground/particle/zbase.js
</span></span><span style="display:flex;"><span>class Particle extends AcGameObject {
</span></span><span style="display:flex;"><span>    constructor(playground, x, y, radius, vx, vy, color, speed) {
</span></span><span style="display:flex;"><span>        super();
</span></span><span style="display:flex;"><span>        this.playground = playground;
</span></span><span style="display:flex;"><span>        this.ctx = this.playground.game_map.ctx;
</span></span><span style="display:flex;"><span>        this.x = x;
</span></span><span style="display:flex;"><span>        this.y = y;
</span></span><span style="display:flex;"><span>        this.radius = radius;
</span></span><span style="display:flex;"><span>        this.vx = vx;
</span></span><span style="display:flex;"><span>        this.vy = vy;
</span></span><span style="display:flex;"><span>        this.color = color;
</span></span><span style="display:flex;"><span>        this.speed = speed;
</span></span><span style="display:flex;"><span>        this.friction = 0.9;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    start() {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    update() {
</span></span><span style="display:flex;"><span>        if (this.speed &lt; this.eps) {
</span></span><span style="display:flex;"><span>            this.destroy;
</span></span><span style="display:flex;"><span>            return false;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        this.x += this.vx * this.speed * this.timedelta / 1000;
</span></span><span style="display:flex;"><span>        this.y += this.vy * this.speed * this.timedelta / 1000;
</span></span><span style="display:flex;"><span>        this.speed *= this.friction;
</span></span><span style="display:flex;"><span>        this.render();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    render() {
</span></span><span style="display:flex;"><span>        this.ctx.beginPath();
</span></span><span style="display:flex;"><span>        this.ctx.arc(this.x, this.y, this.radius, 0, 2 * Math.PI, false);
</span></span><span style="display:flex;"><span>        this.ctx.fillStyle = this.color;
</span></span><span style="display:flex;"><span>        this.ctx.fill();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>} 
</span></span></code></pre></div><p>ç„¶åæˆ‘ä»¬åœ¨è¢«å‡»é€€åŠŸèƒ½æ¨¡å—ï¼Œå®ç°ç”Ÿæˆç²’å­å°çƒçš„æ•ˆæœ</p>
<ul>
<li>ç²’å­å°çƒé‡Šæ”¾å¼§åº¦ä¸º $[0,2Ï€)$ çš„éšæœºæ•°
<ul>
<li>ç²’å­å°çƒçš„ x, y åˆ†é‡æ¯”ç‡æ ¹æ®å¼§åº¦æ¥è®¾å®š</li>
</ul>
</li>
<li>ç²’å­å°çƒçš„èµ·å§‹åæ ‡åº”ä¸ç©å®¶çš„åæ ‡ç›¸åŒ</li>
<li>ç²’å­å°çƒçš„é¢œè‰²ä¸ç©å®¶é¢œè‰²ç›¸åŒ</li>
<li>ç²’å­å°çƒçš„é€Ÿåº¦ä¸ºç©å®¶ç§»åŠ¨é€Ÿåº¦çš„ $10$ å€</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>js/src/playground/player/zbase.js
</span></span><span style="display:flex;"><span>is_attacked(angle, damage) {
</span></span><span style="display:flex;"><span>    // ç²’å­å°çƒæ•ˆæœ
</span></span><span style="display:flex;"><span>    for (let i = 0; i &lt; 10 + Math.random() * 5; i ++ ) {
</span></span><span style="display:flex;"><span>        let x = this.x, y = this.y;
</span></span><span style="display:flex;"><span>        let radius = this.radius * Math.random() * 0.1;
</span></span><span style="display:flex;"><span>        let angle = 2 * Math.PI * Math.random();
</span></span><span style="display:flex;"><span>        let vx = Math.cos(angle), vy = Math.sin(angle);
</span></span><span style="display:flex;"><span>        let color = this.color;
</span></span><span style="display:flex;"><span>        let speed = this.speed * 10;
</span></span><span style="display:flex;"><span>        new Particle(this.playground, x, y, radius, vx, vy, color, speed);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="ä¸€äº›å°ä¼˜åŒ–">ä¸€äº›å°ä¼˜åŒ–<a hidden class="anchor" aria-hidden="true" href="#ä¸€äº›å°ä¼˜åŒ–">#</a></h2>
<h3 id="äººæœºéšæœºé¢œè‰²">äººæœºéšæœºé¢œè‰²<a hidden class="anchor" aria-hidden="true" href="#äººæœºéšæœºé¢œè‰²">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>js/src/playground/zbase.js
</span></span><span style="display:flex;"><span>constructor(root) {
</span></span><span style="display:flex;"><span>    ......
</span></span><span style="display:flex;"><span>    // åˆ›å»ºå¥½ 5 ä¸ªäººæœº
</span></span><span style="display:flex;"><span>    for (let i = 0; i &lt; 5; i ++ ) {
</span></span><span style="display:flex;"><span>        this.players.push(new Player(this, this.width / 2, this.height / 2, this.height * 0.05, this.get_random_color(), this.height * 0.15, false));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ......
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>get_random_color() {
</span></span><span style="display:flex;"><span>    let colors = [&#34;blue&#34;, &#34;red&#34;, &#34;pink&#34;, &#34;grey&#34;, &#34;green&#34;];
</span></span><span style="display:flex;"><span>    return colors[Math.floor(Math.random() * 5)];
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="äººæœºaiéšæœºæ”»å‡»æ“ä½œ">äººæœºAIéšæœºæ”»å‡»æ“ä½œ<a hidden class="anchor" aria-hidden="true" href="#äººæœºaiéšæœºæ”»å‡»æ“ä½œ">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>js/src/playground/player/zbase.js
</span></span><span style="display:flex;"><span>constructor (...) {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    this.spent_time = 0;    // åˆå§‹äººæœºå†·å´æ”»å‡»æ—¶é—´
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>update() {
</span></span><span style="display:flex;"><span>    this.spent_time += this.timedelta / 1000;
</span></span><span style="display:flex;"><span>    if (!this.is_me &amp;&amp; this.spent_time &gt; 4 &amp;&amp; Math.random() * 180 &lt; 1) {
</span></span><span style="display:flex;"><span>        let player = this.playground.players[Math.floor(Math.random() * this.playground.players.length)];
</span></span><span style="display:flex;"><span>        this.shoot_fireball(player.x, player.y);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="éƒ¨ç½²nginxä¸å¯¹æ¥acappà®">éƒ¨ç½²nginxä¸å¯¹æ¥acappà®<a hidden class="anchor" aria-hidden="true" href="#éƒ¨ç½²nginxä¸å¯¹æ¥acappà®">#</a></h1>
<hr>
<h2 id="nginxæ˜¯ä»€ä¹ˆ">Nginxæ˜¯ä»€ä¹ˆï¼Ÿ<a hidden class="anchor" aria-hidden="true" href="#nginxæ˜¯ä»€ä¹ˆ">#</a></h2>
<blockquote>
<p><strong>Nginxæ˜¯ä¸€æ¬¾è‡ªç”±çš„ã€å¼€æºçš„ã€é«˜æ€§èƒ½çš„HTTPæœåŠ¡å™¨å’Œåå‘ä»£ç†æœåŠ¡å™¨</strong></p>
<p><strong>Nginxå¯ä»¥ä½œä¸ºä¸€ä¸ªHTTPæœåŠ¡å™¨è¿›è¡Œç½‘ç«™çš„å‘å¸ƒå¤„ç†ï¼Œå¦å¤–Nginxå¯ä»¥ä½œä¸ºåå‘ä»£ç†è¿›è¡Œè´Ÿè½½å‡è¡¡çš„å®ç°</strong></p>
<p><strong>Nginxä¸­HttpUwsgiModuleçš„ä½œç”¨æ˜¯ä¸uWSGIæœåŠ¡å™¨è¿›è¡Œäº¤æ¢</strong></p>
</blockquote>
<h2 id="uwsgiæ˜¯ä»€ä¹ˆ">uWSGIæ˜¯ä»€ä¹ˆï¼Ÿ<a hidden class="anchor" aria-hidden="true" href="#uwsgiæ˜¯ä»€ä¹ˆ">#</a></h2>
<blockquote>
<p><strong>uWSGIæ˜¯ä¸€ä¸ªå…¨åŠŸèƒ½çš„HTTPæœåŠ¡å™¨ï¼Œå®ç°äº†WSGIã€uwsgiã€httpç­‰åè®®</strong></p>
<p><strong>å®ƒè¦åšçš„å°±æ˜¯æŠŠHTTPåè®®è½¬åŒ–æˆè¯­è¨€æ”¯æŒçš„ç½‘ç»œåè®®ã€‚æ¯”å¦‚æŠŠHTTPåè®®è½¬åŒ–æˆWSGIåè®®ï¼Œè®©Pythonå¯ä»¥ç›´æ¥ä½¿ç”¨</strong></p>
<p><strong>WSGIåè®®æ˜¯Python è¯­è¨€å®šä¹‰çš„ Web æœåŠ¡å™¨å’Œ Web åº”ç”¨ç¨‹åºæˆ–æ¡†æ¶ä¹‹é—´çš„ä¸€ç§ç®€å•è€Œé€šç”¨çš„æ¥å£</strong></p>
<p><strong>ç®€å•æ¥è¯´uWSGIå°±æ˜¯ç”¨æ¥æ²Ÿé€šnginxå’Œdjangoçš„ä¸€åº§æ¡¥æ¢</strong></p>
</blockquote>
<h2 id="nginxuwsgidiango-å·¥ä½œæµç¨‹">Nginx+uWSGI+Diango å·¥ä½œæµç¨‹<a hidden class="anchor" aria-hidden="true" href="#nginxuwsgidiango-å·¥ä½œæµç¨‹">#</a></h2>
<blockquote>
<p><strong><code>nginx</code> æ˜¯å¯¹å¤–çš„æœåŠ¡æ¥å£ï¼Œå¤–éƒ¨æµè§ˆå™¨é€šè¿‡<code>url</code>è®¿é—®<code>nginx</code></strong></p>
<p><strong><code>nginx</code> æ¥æ”¶åˆ°æµè§ˆå™¨å‘é€è¿‡æ¥çš„<code>http</code>è¯·æ±‚ï¼Œå°†åŒ…è¿›è¡Œè§£æ</strong></p>
<p><strong>åˆ†æ<code>url</code>ï¼Œå¦‚æœæ˜¯é™æ€æ–‡ä»¶è¯·æ±‚å°±ç›´æ¥è®¿é—®ç”¨æˆ·ç»™<code>nginx</code>é…ç½®çš„é™æ€æ–‡ä»¶ç›®å½•ï¼Œç›´æ¥è¿”å›ç”¨æˆ·è¯·æ±‚çš„é™æ€æ–‡ä»¶</strong></p>
<p><strong>å¦‚æœä¸æ˜¯é™æ€æ–‡ä»¶ï¼Œè€Œæ˜¯ä¸€ä¸ªåŠ¨æ€çš„è¯·æ±‚ï¼Œé‚£ä¹ˆ<code>nginx</code>å°±å°†è¯·æ±‚è½¬å‘ç»™<code>uwsgi</code>ï¼Œ<code>uwsgi</code> æ¥æ”¶åˆ°è¯·æ±‚ä¹‹åå°†åŒ…è¿›è¡Œå¤„ç†ï¼Œå¤„ç†æˆ<code>wsgi</code>å¯ä»¥æ¥å—çš„æ ¼å¼ï¼Œå¹¶å‘ç»™<code>wsgi</code>ï¼Œ<code>wsgi</code> æ ¹æ®è¯·æ±‚è°ƒç”¨åº”ç”¨ç¨‹åºçš„æŸä¸ªæ–‡ä»¶ï¼ŒæŸä¸ªæ–‡ä»¶çš„æŸä¸ªå‡½æ•°ï¼Œæœ€åå¤„ç†å®Œå°†è¿”å›å€¼å†æ¬¡äº¤ç»™<code>wsgi</code>ï¼Œ<code>wsgi</code>å°†è¿”å›å€¼è¿›è¡Œæ‰“åŒ…ï¼Œæ‰“åŒ…æˆ<code>uwsgi</code>èƒ½å¤Ÿæ¥æ”¶çš„æ ¼å¼ï¼Œ<code>uwsgi</code>æ¥æ”¶<code>wsgi</code> å‘é€çš„è¯·æ±‚ï¼Œå¹¶è½¬å‘ç»™<code>nginx</code>, <code>nginx</code>æœ€ç»ˆå°†è¿”å›å€¼è¿”å›ç»™æµè§ˆå™¨</strong></p>
</blockquote>
<h2 id="uwsgiæœåŠ¡çš„å¼€å¯å…³é—­">uwsgiæœåŠ¡çš„å¼€å¯&amp;&amp;å…³é—­<a hidden class="anchor" aria-hidden="true" href="#uwsgiæœåŠ¡çš„å¼€å¯å…³é—­">#</a></h2>
<ul>
<li>åœ¨<code>~/acapp</code>å¯åŠ¨uwsgiæœåŠ¡ï¼š<strong><code>uwsgi --ini scripts/uwsgi.ini</code></strong></li>
<li>å…³é—­uwsgiæœåŠ¡ï¼š<code>sudo pkill -f uwsgi -9</code></li>
</ul>
<h2 id="é’ˆå¯¹-acapp-çš„ä¼˜åŒ–">é’ˆå¯¹ acapp çš„ä¼˜åŒ–<a hidden class="anchor" aria-hidden="true" href="#é’ˆå¯¹-acapp-çš„ä¼˜åŒ–">#</a></h2>
<h3 id="æ‰“åŒ…è„šæœ¬ä¼˜åŒ–">æ‰“åŒ…è„šæœ¬ä¼˜åŒ–<a hidden class="anchor" aria-hidden="true" href="#æ‰“åŒ…è„šæœ¬ä¼˜åŒ–">#</a></h3>
<p>ç”±äºç°åœ¨ <strong>å‘å¸ƒç‰ˆæœ¬çš„è„šæœ¬æ–‡ä»¶</strong> ç”¨çš„æ˜¯æ‰“åŒ…åœ¨æ ¹ç›®å½•é‡Œçš„ <strong>static</strong> æ–‡ä»¶å¤¹</p>
<p>æ¯æ¬¡ä¿®æ”¹å¥½ <strong>static</strong> æ–‡ä»¶å¤¹åï¼Œä¸ä»…éœ€è¦å¯¹ <strong>js</strong> æ–‡ä»¶æ‰“åŒ…ï¼Œè¿˜éœ€è¦å¯¹ <strong>static</strong> æ–‡ä»¶å¤¹æ‰“åŒ…</p>
<p>ä¸æ”¾æŠŠ â€œå°†staticæ–‡ä»¶å¤¹æ‰“åŒ…â€ çš„ <strong>shell</strong> ä»£ç ä¸€èµ·åŠ å…¥ <strong>js</strong> æ‰“åŒ…è„šæœ¬ä¸­ï¼Œä»è€Œå®ç°ä¸€é”®æ‰“åŒ…</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>scripts/compress_game_js.sh
</span></span><span style="display:flex;"><span><span style="color:#75715e">#! /bin/bash</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>JS_PATH<span style="color:#f92672">=</span>/home/acs/acapp/game/static/js/
</span></span><span style="display:flex;"><span>JS_PATH_DIST<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>JS_PATH<span style="color:#e6db74">}</span>dist/
</span></span><span style="display:flex;"><span>JS_PATH_SRC<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>JS_PATH<span style="color:#e6db74">}</span>src/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>find $JS_PATH_SRC -type f -name <span style="color:#e6db74">&#39;*.js&#39;</span> | sort | xargs cat &gt; <span style="color:#e6db74">${</span>JS_PATH_DIST<span style="color:#e6db74">}</span>game.js
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;yes&#34;</span> | python3 manage.py collectstatic
</span></span></code></pre></div><h3 id="é¼ æ ‡ç‚¹å‡»äº‹ä»¶çš„ç›¸å¯¹åç§»">é¼ æ ‡ç‚¹å‡»äº‹ä»¶çš„ç›¸å¯¹åç§»<a hidden class="anchor" aria-hidden="true" href="#é¼ æ ‡ç‚¹å‡»äº‹ä»¶çš„ç›¸å¯¹åç§»">#</a></h3>
<p>ç”±äºå†™æ¸¸æˆç•Œé¢çš„æ—¶å€™ï¼Œç©å®¶ç§»åŠ¨æ˜¯æŒ‰ç…§é¼ æ ‡ç›¸å¯¹äºå½“å‰æ•´ä¸ªæµè§ˆå™¨å–çš„ä½ç½®å‚æ•° <code>e.clientX</code></p>
<p>è€Œ <code>acapp</code> é‡Œï¼Œæ¯ä¸ªåº”ç”¨æ˜¯ä¸€ä¸ªå°çª—å£ï¼Œé¼ æ ‡ç‚¹å‡»ä½ç½®çš„å‚æ•°åº”å½“æ˜¯ <strong>ç›¸å¯¹äºæ•´ä¸ªæ¸¸æˆçª—å£çš„ä½ç½®å‚æ•°</strong></p>
<p>æ‰€æœ‰ä¼šå¯¼è‡´å‡ºç°ï¼Œç‚¹å‡»çš„ä½ç½®ä¸ç§»åŠ¨çš„ä½ç½®ä¸åŒï¼Œè¿™é‡Œéœ€è¦åšå‡ºå°ä¼˜åŒ–</p>
<p>ä¼˜åŒ–çš„é€»è¾‘ :</p>
<ol>
<li>$clientXâˆ’çª—å£å·¦ä¾§åˆ°æµè§ˆå™¨å·¦ä¾§çš„è·ç¦»=ç©å®¶çš„ç›®æ ‡X$</li>
<li>$clientYâˆ’çª—å£ä¸Šä¾§åˆ°æµè§ˆå™¨ä¸Šä¾§çš„è·ç¦»=ç©å®¶çš„ç›®æ ‡Y$ è¿™å°±è¦ç”¨åˆ°ä¸€ä¸ª <code>js</code> çš„ <code>API</code> äº† : <code>getBoundingClientRect()</code></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">rectObject</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">getBoundingClientRect</span>();
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rectObject</span>.<span style="color:#a6e22e">top</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">å…ƒç´ ä¸Šè¾¹åˆ°è§†çª—ä¸Šè¾¹çš„è·ç¦»</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rectObject</span>.<span style="color:#a6e22e">right</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">å…ƒç´ å³è¾¹åˆ°è§†çª—å·¦è¾¹çš„è·ç¦»</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rectObject</span>.<span style="color:#a6e22e">bottom</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">å…ƒç´ ä¸‹è¾¹åˆ°è§†çª—ä¸Šè¾¹çš„è·ç¦»</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rectObject</span>.<span style="color:#a6e22e">left</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">å…ƒç´ å·¦è¾¹åˆ°è§†çª—å·¦è¾¹çš„è·ç¦»</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rectObject</span>.<span style="color:#a6e22e">width</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">æ˜¯å…ƒç´ è‡ªèº«çš„å®½</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rectObject</span>.<span style="color:#a6e22e">height</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">æ˜¯å…ƒç´ è‡ªèº«çš„é«˜</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">player</span><span style="color:#f92672">/</span><span style="color:#a6e22e">zbase</span>.<span style="color:#a6e22e">js</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">add_listening_events</span>() {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">playground</span>.<span style="color:#a6e22e">game_map</span>.<span style="color:#a6e22e">$canvas</span>.<span style="color:#a6e22e">mousedown</span>(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">e</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// åˆ›å»º rect å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">rect</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">outer</span>.<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">canvas</span>.<span style="color:#a6e22e">getBoundingClientRect</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">which</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">3</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// è°ƒæ•´åç§»é‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">outer</span>.<span style="color:#a6e22e">move_to</span>(<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">clientX</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">rect</span>.<span style="color:#a6e22e">left</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">clientY</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">rect</span>.<span style="color:#a6e22e">top</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">which</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">outer</span>.<span style="color:#a6e22e">cur_skill</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;fireball&#34;</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// è°ƒæ•´åç§»é‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#a6e22e">outer</span>.<span style="color:#a6e22e">shoot_fireball</span>(<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">clientX</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">rect</span>.<span style="color:#a6e22e">left</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">clientY</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">rect</span>.<span style="color:#a6e22e">top</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><h3 id="å°†èœå•ç•Œé¢é‡æ–°è®¾ä¸ºä¸»ç•Œé¢">å°†èœå•ç•Œé¢é‡æ–°è®¾ä¸ºä¸»ç•Œé¢<a hidden class="anchor" aria-hidden="true" href="#å°†èœå•ç•Œé¢é‡æ–°è®¾ä¸ºä¸»ç•Œé¢">#</a></h3>
<p><code>js/zbase.js</code> çš„æ³¨é‡Šå–æ¶ˆï¼Œä½¿ä¹‹åˆ›å»ºå‡º <strong>menu</strong> å¯¹è±¡</p>
<p><code>js/playground/zbase.js</code> çš„æ³¨é‡Šå–æ¶ˆï¼Œå¹¶è®¾ç½®é€»è¾‘ï¼Œè®© <strong>playground</strong> æ‰“å¼€åï¼Œæ‰è¿›è¡Œæ¸¸æˆç•Œé¢åˆå§‹åŒ–</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AcGamePlayground</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">constructor</span>(<span style="color:#a6e22e">root</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">root</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">root</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">$playground</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">$</span>(<span style="color:#e6db74">`&lt;div class=&#34;ac-game-playground&#34;&gt;&lt;/div&gt;`</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">hide</span>();    <span style="color:#75715e">// åˆå§‹æ—¶éšè—
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// æ¸¸æˆç•Œé¢ç”Ÿæˆä»£ç åœ¨ä¸‹é¢å±•ç¤º playground æ—¶æ‰§è¡Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">start</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">show</span>() {    <span style="color:#75715e">// æ‰“å¼€ playground ç•Œé¢
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">$playground</span>.<span style="color:#a6e22e">show</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// å¼€å§‹ç”Ÿæˆæ¸¸æˆç•Œé¢
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">root</span>.<span style="color:#a6e22e">$ac_game</span>.<span style="color:#a6e22e">append</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">$playground</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">width</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">$playground</span>.<span style="color:#a6e22e">width</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">height</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">$playground</span>.<span style="color:#a6e22e">height</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">game_map</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">GameMap</span>(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">players</span> <span style="color:#f92672">=</span> [];  <span style="color:#75715e">// å­˜æ”¾å½“å‰æ¸¸æˆä¸­çš„æ‰€æœ‰ç©å®¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// å°†ç©å®¶åŠ å…¥æ¸¸æˆä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">players</span>.<span style="color:#a6e22e">push</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Player</span>(<span style="color:#66d9ef">this</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">width</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">height</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">height</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.05</span>, <span style="color:#e6db74">&#34;white&#34;</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">height</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.15</span>, <span style="color:#66d9ef">true</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// åˆ›å»ºå¥½ 5 ä¸ªäººæœº
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">5</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">++</span> ) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">players</span>.<span style="color:#a6e22e">push</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Player</span>(<span style="color:#66d9ef">this</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">width</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">height</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">height</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.05</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">get_random_color</span>(), <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">height</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.15</span>, <span style="color:#66d9ef">false</span>));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="è°ƒæ•´-css-æ–‡ä»¶é€‚åº”çª—å£">è°ƒæ•´ css æ–‡ä»¶ï¼Œé€‚åº”çª—å£<a hidden class="anchor" aria-hidden="true" href="#è°ƒæ•´-css-æ–‡ä»¶é€‚åº”çª—å£">#</a></h3>
<p>åœ¨è®¾ç½® <code>web</code> ç½‘é¡µçš„æ—¶å€™ï¼Œæœ‰äº›è®¾ç½®äº†ç»å¯¹å€¼ï¼Œå¯èƒ½å¯¹äºçª—å£åŒ–çš„ <code>acapp</code> æ˜¾ç¤ºæ•ˆæœå·®</p>
<p>å°†ä»–ä»¬ä¿®æ”¹æˆç›¸å¯¹æ•°å€¼</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>game.css
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>.ac-game-menu-field {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    top: 40%;
</span></span><span style="display:flex;"><span>    left: 20%;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>.ac-game-menu-field-item {
</span></span><span style="display:flex;"><span>    height: 6vh;
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    font-size: 4vh;
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><h1 id="åˆ›å»ºè´¦å·ç³»ç»Ÿ">åˆ›å»ºè´¦å·ç³»ç»Ÿ<a hidden class="anchor" aria-hidden="true" href="#åˆ›å»ºè´¦å·ç³»ç»Ÿ">#</a></h1>
<p><a href="https://www.acwing.com/file_system/file/content/whole/index/content/3294700/">6. åˆ›å»ºè´¦å·ç³»ç»Ÿ | è®²ä¹‰</a></p>
<hr>
<h2 id="ç”¨æˆ·åå¯†ç ç™»å½•">ç”¨æˆ·åå¯†ç ç™»å½•<a hidden class="anchor" aria-hidden="true" href="#ç”¨æˆ·åå¯†ç ç™»å½•">#</a></h2>
<hr>
<h3 id="å®¢æˆ·ç«¯è¯·æ±‚ä¸djangoå“åº”æµç¨‹">å®¢æˆ·ç«¯è¯·æ±‚ä¸Djangoå“åº”æµç¨‹<a hidden class="anchor" aria-hidden="true" href="#å®¢æˆ·ç«¯è¯·æ±‚ä¸djangoå“åº”æµç¨‹">#</a></h3>
<blockquote>
<p><strong>ç”¨æˆ·åœ¨å®¢æˆ·ç«¯é€šè¿‡<code>$.ajax</code>å‘é€è¯·æ±‚ï¼Œæ ¹æ®<code>urls</code>è·¯ç”±åˆ°å¯¹åº”çš„<code>views</code>ä¸­çš„å‡½æ•°ï¼Œå¤„ç†<code>request</code>åè¿”å›<code>JsonResponse</code> è‡³å®¢æˆ·ç«¯</strong></p>
</blockquote>
<h3 id="å‰æœŸå‡†å¤‡å·¥ä½œ">å‰æœŸå‡†å¤‡å·¥ä½œ<a hidden class="anchor" aria-hidden="true" href="#å‰æœŸå‡†å¤‡å·¥ä½œ">#</a></h3>
<p>åšå¼€å‘ï¼Œå…ˆå¼€å¯è°ƒè¯•æ¨¡å¼ï¼Œå¦‚æœä¸å¼€å¯ï¼ŒæœåŠ¡å™¨ä¸€æ—¦è¿è¡Œé”™è¯¯ï¼Œå°±åªè¿”å› <code>Error</code> æŠ¥é”™ <code>settings.py</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>DEBUG <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span></code></pre></div><p>ä¸è¿‡ <code>django</code> è‡ªå¸¦çš„ <code>User</code> è¡¨å¹¶ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦è‡ªå·±é¢å¤–å»ºè¡¨</p>
<h3 id="åˆ›å»ºç”¨æˆ·è¡¨">åˆ›å»ºç”¨æˆ·è¡¨<a hidden class="anchor" aria-hidden="true" href="#åˆ›å»ºç”¨æˆ·è¡¨">#</a></h3>
<p>æ‰€æœ‰çš„æ•°æ®è¡¨éƒ½å­˜åœ¨ <code>models</code> é‡Œ</p>
<p>æˆ‘ä»¬åœ¨ <code>models</code> é‡Œåˆ›å»ºä¸€ä¸ª <code>player</code> æ–‡ä»¶å¤¹ï¼Œç”¨äºå­˜å‚¨æ‰€æœ‰çš„ <code>player</code> ç›¸å…³çš„è¡¨</p>
<p>ç„¶åå¯¹æ–‡ä»¶å¤¹åˆå§‹åŒ– <code>__init__.py</code>ï¼Œæ¥ç€æ‰©å……æˆä¸€ä¸ªæˆ‘ä»¬éœ€è¦çš„æ•°æ®è¡¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>game/models/player/player.py
</span></span><span style="display:flex;"><span>from django.db import models
</span></span><span style="display:flex;"><span>from django.contrib.auth.models import User
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>class Player(models.Model): # Player ç±»ç»§æ‰¿è‡ª Model ç±»
</span></span><span style="display:flex;"><span>    user = models.OneToOneField(User, on_delete=models.CASCADE)
</span></span><span style="display:flex;"><span>    # è¯´æ˜Playeræ˜¯ä»Userè¡¨æ‰©å……è¿‡æ¥çš„ï¼Œæ¯ä¸€ä¸ªplayeréƒ½ä¸ä¸€ä¸ªuseræ˜¯ä¸€ä¸€å¯¹åº”å…³è”å…³ç³»
</span></span><span style="display:flex;"><span>    # åä¸€ä¸ªå‚æ•°æ˜¯æŒ‡ï¼Œå½“userè¢«åˆ é™¤åï¼Œå¯¹åº”çš„playerä¹Ÿè¦è¢«åˆ é™¤
</span></span><span style="display:flex;"><span>    # ï¼ˆæ„Ÿè§‰å°±æ˜¯å¤–é”®çš„æ„æ€ï¼‰
</span></span><span style="display:flex;"><span>    photo = models.URLField(max_length=256, blank=True)
</span></span><span style="display:flex;"><span>    # ç”¨äºå­˜å‚¨ç”¨æˆ·çš„å¤´åƒçš„url
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    # æŒ‡å®šæ¯ä¸ªplayeræ•°æ®å±•ç¤ºåœ¨å‰å°çš„æ•°æ®
</span></span><span style="display:flex;"><span>    def __str__(self):
</span></span><span style="display:flex;"><span>        return str(self.user)    # å±•ç¤ºç”¨æˆ·çš„ç”¨æˆ·å
</span></span></code></pre></div><p>å°†å®šä¹‰çš„è¡¨ï¼Œæ³¨å†Œåˆ°åå° <code>admin</code> é¡µé¢ä¸­</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>game/admin.py
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>from game.models.player.player import Player
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>admin.site.register(Player)
</span></span></code></pre></div><p>ç„¶åå°†åˆ›å»ºçš„æ•°æ®è¡¨æ›´æ–°åˆ° <code>django</code> çš„æ•°æ®åº“ä¸­å»</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> python3 manage<span style="color:#f92672">.</span>py makemigrations
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> Migrations <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;game&#39;</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;</span>   game<span style="color:#f92672">/</span>migrations<span style="color:#f92672">/</span><span style="color:#ae81ff">0001</span>_initial<span style="color:#f92672">.</span>py
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;</span>     <span style="color:#f92672">-</span> Create model Player
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> 
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> python3 manage<span style="color:#f92672">.</span>py migrate
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> Operations to perform:
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;</span>   Apply all migrations: admin, auth, contenttypes, game, sessions
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> Running migrations:
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;</span>   Applying game<span style="color:#ae81ff">.0001</span>_initial<span style="color:#f92672">...</span> OK
</span></span></code></pre></div><p>ç„¶åé‡å¯ä¸€ä¸‹æœåŠ¡ï¼Œå°±å¯ä»¥åœ¨ç®¡ç†å‘˜é¡µé¢çœ‹åˆ°æ–°å»ºçš„æ•°æ®åº“äº†</p>
<h3 id="å®ç°å®¢æˆ·ç«¯çš„ç±»å‹åˆ¤åˆ«acapp-or-web">å®ç°å®¢æˆ·ç«¯çš„ç±»å‹åˆ¤åˆ«ï¼ˆACAPP or WEBï¼‰<a hidden class="anchor" aria-hidden="true" href="#å®ç°å®¢æˆ·ç«¯çš„ç±»å‹åˆ¤åˆ«acapp-or-web">#</a></h3>
<p>ç”±äºæˆ‘ä»¬å®ç°çš„é¡¹ç›®æ˜¯å‰åç«¯åˆ†ç¦»ç±»å‹ï¼Œå› æ­¤å¯¹äºä¸åŒçš„å®¢æˆ·ç«¯ï¼Œå‰ç«¯è¦æ§åˆ¶ç”Ÿæˆä¸åŒçš„é¡µé¢</p>
<p>ä¸ºäº†å¢å¼ºæ‰©å±•æ€§ï¼Œæ•…è¿™é‡Œè¦å®ç°å®¢æˆ·ç«¯ç±»å‹çš„åˆ¤åˆ«</p>
<p><strong>yæ€»</strong> å·²ç»æå‰å†™å¥½äº† <strong>ACAPP</strong> çš„æ¥å£ï¼Œå¦‚æœç”¨æˆ·ç”¨çš„æ˜¯ <strong>ACAPP</strong> è®¿é—®ï¼Œåˆ™åœ¨æ–°å»ºå¯¹è±¡ <strong>ac_game</strong> æ—¶ï¼Œä¼šé¢å¤–ä¼ é€’ä¸€ä¸ªå‚æ•°</p>
<p>æˆ‘ä»¬åªéœ€æŒ‰ç…§è¿™ä¸ªæ¥å£å»å®Œæˆæ‰©å……å³å¯</p>
<blockquote>
<p><strong>ä¹‹åå†™å°ç¨‹åºä¹‹ç±»çš„åŒç†ï¼Œé¢å¤–ä¼ ä¸€ä¸ªæ¥å£</strong></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>js/zbase.js
</span></span><span style="display:flex;"><span>export class AcGame {
</span></span><span style="display:flex;"><span>    constructor(id, AcWingOS) {
</span></span><span style="display:flex;"><span>        this.id = id;
</span></span><span style="display:flex;"><span>        this.$ac_game = $(&#39;#&#39; + id);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        this.AcWingOS = AcWingOS;   //å¦‚æœæ˜¯acappç«¯ï¼Œè¯¥å˜é‡å°±ä¼šå¸¦ç€ä¸€ç³»åˆ—yæ€»æä¾›çš„æ¥å£
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        this.menu = new AcGameMenu(this);
</span></span><span style="display:flex;"><span>        this.playground = new AcGamePlayground(this);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        this.start();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    start() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="æ„å»ºç™»å½•åŠŸèƒ½æ¡†æ¶">æ„å»ºç™»å½•åŠŸèƒ½æ¡†æ¶<a hidden class="anchor" aria-hidden="true" href="#æ„å»ºç™»å½•åŠŸèƒ½æ¡†æ¶">#</a></h3>
<p>åŸºæœ¬é€»è¾‘ : ç”¨æˆ·è®¿é—®é¡µé¢ -&gt; è¿›å…¥ç™»å½•é¡µé¢ -&gt; æäº¤ç™»å½•ä¿¡æ¯ -&gt; æ ¸å¯¹ç™»å½•ä¿¡æ¯ -&gt; è¿”å›ç™»é™†ç»“æœå’Œå…¶ä»–ä¿¡æ¯</p>
<p>æ¯å®ç°ä¸€ä¸ªå‡½æ•°ï¼Œå°±éœ€è¦å®ç°ä¸‰ä¸ªéƒ¨åˆ†ï¼š</p>
<ol>
<li><code>views</code> : å®ç°å…·ä½“çš„è°ƒç”¨æ•°æ®åº“çš„é€»è¾‘</li>
<li><code>urls</code> : å®ç°ä¸€ä¸ªè·¯ç”±</li>
<li><code>js</code> : å‰ç«¯å®ç°GETä¸Šè¿°æ¥å£çš„è¿‡ç¨‹</li>
</ol>
<p>æ¬²å®ç°æµç¨‹ :</p>
<ol>
<li>ç”¨æˆ·è®¿é—®ç½‘ç«™ï¼Œé€šè¿‡å…ˆå‰å®Œæˆçš„è·¯ç”±ï¼Œè®¿é—®åˆ° <code>web.html</code></li>
<li><code>web.html</code> ä¸­çš„ <code>js</code> éƒ¨åˆ†åˆ›å»ºäº†ä¸€ä¸ª <code>AcGame</code> å¯¹è±¡</li>
<li><code>AcGame</code> å¯¹è±¡åˆ›å»ºçš„è¿‡ç¨‹ä¸­ï¼Œç”Ÿæˆäº† <code>Settings</code> å¯¹è±¡</li>
<li><code>Settings</code> å¯¹è±¡åˆ›å»ºå®Œæˆåï¼Œè°ƒç”¨ <code>Settings.start()</code> å‡½æ•°</li>
<li><code>Settings.start()</code> å‡½æ•°è°ƒç”¨äº† <code>Settings.getinfo()</code> å‡½æ•°</li>
<li><code>Settings.getinfo()</code> å‡½æ•°ä¸­æ‰§è¡Œäº† <code>ajax</code> å‘ <code>getinfo</code> æ¥å£å‘èµ·ä¸€ä¸ªå«å‚æ•° <code>platform</code> çš„ <code>GET</code> è¯·æ±‚</li>
<li>é€šè¿‡ <code>urls</code> è·¯ç”±çš„å®ç°ï¼Œæœ€ç»ˆå®šä½åˆ° <code>views/settings/getinfo.py</code> æ–‡ä»¶çš„ <code>getinfo(request)</code> å‡½æ•°</li>
<li>æ ¹æ®ä¼ é€’è¿‡æ¥çš„ <code>platform</code> å‡½æ•°ï¼Œå®ç°ä¸åŒçš„ <code>JsonResponse</code> è¿”å›</li>
<li><code>Settings.getinfo()</code> æ¥å—åˆ°äº† <code>response</code> å®Œæˆä¸Šè¿°åŸºæœ¬é€»è¾‘</li>
</ol>
<h4 id="views">views<a hidden class="anchor" aria-hidden="true" href="#views">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>views/settings/getinfo.py
</span></span><span style="display:flex;"><span>from django.http import JsonResponse
</span></span><span style="display:flex;"><span>from game.models.player.player import Player
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def getinfo_acapp(request):
</span></span><span style="display:flex;"><span>    player = Player.objects.all()[0]    # å–å‡ºæ•°æ®åº“ä¸­ç¬¬ä¸€ä¸ªç”¨æˆ·(è°ƒè¯•è¯¥åŠŸèƒ½)
</span></span><span style="display:flex;"><span>    return JsonResponse({
</span></span><span style="display:flex;"><span>        &#39;result&#39;: &#34;success&#34;,
</span></span><span style="display:flex;"><span>        &#39;username&#39;: player.user.username,
</span></span><span style="display:flex;"><span>        &#39;photo&#39;: player.photo,
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def getinfo_web(request):
</span></span><span style="display:flex;"><span>    player = Player.objects.all()[0]    # å–å‡ºæ•°æ®åº“ä¸­ç¬¬ä¸€ä¸ªç”¨æˆ·(è°ƒè¯•è¯¥åŠŸèƒ½)
</span></span><span style="display:flex;"><span>    return JsonResponse({
</span></span><span style="display:flex;"><span>        &#39;result&#39;: &#34;success&#34;,
</span></span><span style="display:flex;"><span>        &#39;username&#39;: player.user.username,
</span></span><span style="display:flex;"><span>        &#39;photo&#39;: player.photo,
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def getinfo(request):   # å¤„ç†è¯·æ±‚
</span></span><span style="display:flex;"><span>    platform = request.GET.get(&#39;platform&#39;)  # æ ¹æ®è¯·æ±‚çš„å¹³å°ä¸åŒï¼Œè¿›è¡Œä¸åŒè¿”å›å¤„ç†
</span></span><span style="display:flex;"><span>    if platform == &#34;ACAPP&#34;:
</span></span><span style="display:flex;"><span>        return getinfo_acapp(request)
</span></span><span style="display:flex;"><span>    elif platform == &#34;WEB&#34;:
</span></span><span style="display:flex;"><span>        return getinfo_web(request)
</span></span></code></pre></div><h4 id="urls">urls<a hidden class="anchor" aria-hidden="true" href="#urls">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>urls/settings/index.py
</span></span><span style="display:flex;"><span>from django.urls import path
</span></span><span style="display:flex;"><span>from game.views.settings.getinfo import getinfo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>urlpatterns = [
</span></span><span style="display:flex;"><span>    path(&#34;getinfo/&#34;, getinfo, name=&#34;settings_getinfo&#34;),
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p>è·¯ç”±å»ºç«‹å¥½ä»¥åï¼Œè®¿é—® <code>xxxx/settings/getinfo</code>ï¼Œå¯ä»¥çœ‹åˆ° <code>getinfo.py</code> è¿”å›çš„ <code>JSON</code> ç±»å‹çš„ <code>JSONResponse</code></p>
<h4 id="js">js<a hidden class="anchor" aria-hidden="true" href="#js">#</a></h4>
<p>ç½‘é¡µåˆšè®¿é—®æ—¶ï¼Œåº”å…ˆå°† <code>menu</code> å…³é—­ï¼Œç„¶åæ‰“å¼€ç™»å½•ç•Œé¢ï¼Œéšæ„å…ˆä¿®æ”¹ä¸€ä¸ªè®© <code>menu</code> åˆå§‹å…³é—­</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>static/js/src/menu/zbase.js
</span></span><span style="display:flex;"><span>class AcGameMenu {
</span></span><span style="display:flex;"><span>    constructor(root) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        this.$menu.hide();
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>static/js/src/settings/zbase.js
</span></span><span style="display:flex;"><span>class Settings {
</span></span><span style="display:flex;"><span>    constructor(root) {
</span></span><span style="display:flex;"><span>        this.root = root;
</span></span><span style="display:flex;"><span>        this.platform = &#34;WEB&#34;;
</span></span><span style="display:flex;"><span>        if (this.root.AcWingOS) this.platform = &#34;ACAPP&#34;;
</span></span><span style="display:flex;"><span>        this.start();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    start() {
</span></span><span style="display:flex;"><span>        this.getinfo();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    register() {    // æ‰“å¼€æ³¨å†Œç•Œé¢
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    login() {       // æ‰“å¼€ç™»å½•ç•Œé¢
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    getinfo() {
</span></span><span style="display:flex;"><span>        let outer = this;
</span></span><span style="display:flex;"><span>        $.ajax({
</span></span><span style="display:flex;"><span>            url: &#34;https://app1117.acapp.acwing.com.cn/settings/getinfo/&#34;,
</span></span><span style="display:flex;"><span>            type: &#34;GET&#34;,
</span></span><span style="display:flex;"><span>            data: {
</span></span><span style="display:flex;"><span>                platform: outer.platform,
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            success: function(resp) {
</span></span><span style="display:flex;"><span>                console.log(resp);
</span></span><span style="display:flex;"><span>                if (resp.result === &#34;success&#34;) {    // ç™»å½•æˆåŠŸï¼Œå…³é—­ç™»å½•ç•Œé¢ï¼Œæ‰“å¼€ä¸»èœå•
</span></span><span style="display:flex;"><span>                    outer.hide();
</span></span><span style="display:flex;"><span>                    outer.root.menu.show();
</span></span><span style="display:flex;"><span>                } else {
</span></span><span style="display:flex;"><span>                    outer.login();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    hide() {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    show() {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç„¶åä¸è¦å¿˜è®°åœ¨ <code>æ ¹js</code> ä¸‹åˆ›å»ºå¯¹è±¡</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AcGame</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">constructor</span>(<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">AcWingOS</span>) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">settings</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Settings</span>(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>è¿™æ ·åŸºæœ¬æ¡†æ¶å°±å®Œæˆäº†</p>
<h4 id="å®Œå–„-http-è¯·æ±‚çš„å‡½æ•°">å®Œå–„ HTTP è¯·æ±‚çš„å‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#å®Œå–„-http-è¯·æ±‚çš„å‡½æ•°">#</a></h4>
<p>å¦‚æœç”¨æˆ·æœªç™»å½•ï¼Œè¿”å›ä¿¡æ¯ â€œnot loginâ€</p>
<p>å¦‚æœç”¨æˆ·ç™»å½•ï¼Œè¿”å›ä¿¡æ¯ â€œsuccessâ€ ä»¥åŠç”¨æˆ·åå’Œå¤´åƒ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>views/setting/getinfo.py
</span></span><span style="display:flex;"><span>def getinfo_web(request):
</span></span><span style="display:flex;"><span>    user = request.user
</span></span><span style="display:flex;"><span>    if not user.is_authenticated:   # æœªç™»å½•
</span></span><span style="display:flex;"><span>        return JsonResponse({
</span></span><span style="display:flex;"><span>            &#39;result&#39;: &#34;not login&#34;
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>    else:                           # å·²ç™»å½•
</span></span><span style="display:flex;"><span>        player = Player.objects.get(user=user)
</span></span><span style="display:flex;"><span>        return JsonResponse({
</span></span><span style="display:flex;"><span>            &#39;result&#39;: &#34;success&#34;,
</span></span><span style="display:flex;"><span>            &#39;username&#39;: player.user.username,
</span></span><span style="display:flex;"><span>            &#39;photo&#39;: player.photo,
</span></span><span style="display:flex;"><span>        })
</span></span></code></pre></div><p>æ³¨æ„å‰åå°æ˜¯ä¸€ä¸ªç™»å½•ç³»ç»Ÿï¼Œå› æ­¤è¦å…ˆé€€æ‰åå°ï¼Œå†æµ‹è¯•</p>
<h3 id="å°†ç”¨æˆ·å¤´åƒæ¸²æŸ“åˆ°ç©å®¶ä¸Š">å°†ç”¨æˆ·å¤´åƒæ¸²æŸ“åˆ°ç©å®¶ä¸Š<a hidden class="anchor" aria-hidden="true" href="#å°†ç”¨æˆ·å¤´åƒæ¸²æŸ“åˆ°ç©å®¶ä¸Š">#</a></h3>
<p>å°†è¿”å›çš„ <code>JsonResponse</code> å­˜åˆ° <code>Settings</code> ç±»çš„å˜é‡ä¸­ <code>settings/zbase.js</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Settings</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">constructor</span>(<span style="color:#a6e22e">root</span>) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">username</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">photo</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">getinfo</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">outer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">ajax</span>({
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">success</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">resp</span>) {
</span></span><span style="display:flex;"><span>                ...
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">result</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;success&#34;</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">outer</span>.<span style="color:#a6e22e">username</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">username</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">outer</span>.<span style="color:#a6e22e">photo</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">photo</span>;
</span></span><span style="display:flex;"><span>                    ...
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                ..
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç„¶ååœ¨ <code>Player</code> é‡ŒæŠŠç”¨æˆ·çš„å¤´åƒæ¸²æŸ“åˆ°å¯¹åº”çš„ç©å®¶ä¸Š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>playground/player/zbase.js
</span></span><span style="display:flex;"><span>class Player {
</span></span><span style="display:flex;"><span>    constructor(...) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        this.img = new Image();
</span></span><span style="display:flex;"><span>        this.img.src = this.playground.root.settings.photo;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    render() {
</span></span><span style="display:flex;"><span>        if (this.is_me) {
</span></span><span style="display:flex;"><span>            this.ctx.save();
</span></span><span style="display:flex;"><span>            this.ctx.beginPath();
</span></span><span style="display:flex;"><span>            this.ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2, false);
</span></span><span style="display:flex;"><span>            this.ctx.stroke();
</span></span><span style="display:flex;"><span>            this.ctx.clip();
</span></span><span style="display:flex;"><span>            this.ctx.drawImage(this.img, this.x - this.radius, this.y - this.radius, 
</span></span><span style="display:flex;"><span>                               this.radius * 2, this.radius * 2);
</span></span><span style="display:flex;"><span>            this.ctx.restore();
</span></span><span style="display:flex;"><span>        } else {
</span></span><span style="display:flex;"><span>            this.ctx.beginPath();
</span></span><span style="display:flex;"><span>            this.ctx.arc(this.x, this.y, this.radius, 0, 2 * Math.PI, false);
</span></span><span style="display:flex;"><span>            this.ctx.fillStyle = this.color;
</span></span><span style="display:flex;"><span>            this.ctx.fill();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="å®ç°ç™»å½•ç•Œé¢çš„å‰ç«¯">å®ç°ç™»å½•ç•Œé¢çš„å‰ç«¯<a hidden class="anchor" aria-hidden="true" href="#å®ç°ç™»å½•ç•Œé¢çš„å‰ç«¯">#</a></h3>
<p>å…ˆå®Œæˆç™»å½•ç•Œé¢æ˜¾ç¤ºçš„é€»è¾‘</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>settings/zbase.js
</span></span><span style="display:flex;"><span>class Settings {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    register() {  // æ‰“å¼€æ³¨å†Œç•Œé¢
</span></span><span style="display:flex;"><span>        this.$login.hide();
</span></span><span style="display:flex;"><span>        this.$register.show();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    login() {  // æ‰“å¼€ç™»å½•ç•Œé¢
</span></span><span style="display:flex;"><span>        this.$register.hide();
</span></span><span style="display:flex;"><span>        this.$login.show();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    hide() {
</span></span><span style="display:flex;"><span>        this.$settings.hide();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    show() {
</span></span><span style="display:flex;"><span>        this.$settings.show();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="å®ç°å‰ç«¯çš„åŸºç¡€æ¡†æ¶">å®ç°å‰ç«¯çš„åŸºç¡€æ¡†æ¶<a hidden class="anchor" aria-hidden="true" href="#å®ç°å‰ç«¯çš„åŸºç¡€æ¡†æ¶">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>settings/zbase.js
</span></span><span style="display:flex;"><span>class Settings {
</span></span><span style="display:flex;"><span>    constructor(root) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        this.$settings = $(`
</span></span><span style="display:flex;"><span>&lt;div class=&#34;ac-game-settings&#34;&gt;
</span></span><span style="display:flex;"><span>    &lt;div class=&#34;ac-game-settings-login&#34;&gt;
</span></span><span style="display:flex;"><span>        &lt;div class=&#34;ac-game-settings-title&#34;&gt;
</span></span><span style="display:flex;"><span>            ç™»å½•
</span></span><span style="display:flex;"><span>        &lt;/div&gt;
</span></span><span style="display:flex;"><span>        &lt;div class=&#34;ac-game-settings-username&#34;&gt;
</span></span><span style="display:flex;"><span>            &lt;div class=&#34;ac-game-settings-item&#34;&gt;
</span></span><span style="display:flex;"><span>                &lt;input type=&#34;text&#34; placeholder=&#34;ç”¨æˆ·å&#34;&gt;
</span></span><span style="display:flex;"><span>            &lt;/div&gt;
</span></span><span style="display:flex;"><span>        &lt;/div&gt;
</span></span><span style="display:flex;"><span>        &lt;div class=&#34;ac-game-settings-password&#34;&gt;
</span></span><span style="display:flex;"><span>            &lt;div class=&#34;ac-game-settings-item&#34;&gt;
</span></span><span style="display:flex;"><span>                &lt;input type=&#34;password&#34; placeholder=&#34;å¯†ç &#34;&gt;
</span></span><span style="display:flex;"><span>            &lt;/div&gt;
</span></span><span style="display:flex;"><span>        &lt;/div&gt;
</span></span><span style="display:flex;"><span>        &lt;div class=&#34;ac-game-settings-submit&#34;&gt;
</span></span><span style="display:flex;"><span>            &lt;div class=&#34;ac-game-settings-item&#34;&gt;
</span></span><span style="display:flex;"><span>                &lt;button&gt;ç™»å½•&lt;/button&gt;
</span></span><span style="display:flex;"><span>            &lt;/div&gt;
</span></span><span style="display:flex;"><span>        &lt;/div&gt;
</span></span><span style="display:flex;"><span>        &lt;div class=&#34;ac-game-settings-error-message&#34;&gt;
</span></span><span style="display:flex;"><span>        &lt;/div&gt;
</span></span><span style="display:flex;"><span>        &lt;div class=&#34;ac-game-settings-option&#34;&gt;
</span></span><span style="display:flex;"><span>            æ³¨å†Œ
</span></span><span style="display:flex;"><span>        &lt;/div&gt;
</span></span><span style="display:flex;"><span>        &lt;br&gt;
</span></span><span style="display:flex;"><span>        &lt;div class=&#34;ac-game-settings-acwing&#34;&gt;
</span></span><span style="display:flex;"><span>            &lt;img width=&#34;30&#34; src=&#34;https://app165.acapp.acwing.com.cn/static/image/settings/acwing_logo.png&#34;&gt;
</span></span><span style="display:flex;"><span>            &lt;br&gt;
</span></span><span style="display:flex;"><span>            &lt;div&gt;
</span></span><span style="display:flex;"><span>                AcWingä¸€é”®ç™»å½•
</span></span><span style="display:flex;"><span>            &lt;/div&gt;
</span></span><span style="display:flex;"><span>        &lt;/div&gt;
</span></span><span style="display:flex;"><span>    &lt;/div&gt;
</span></span><span style="display:flex;"><span>    &lt;div class=&#34;ac-game-settings-register&#34;&gt;
</span></span><span style="display:flex;"><span>        &lt;div class=&#34;ac-game-settings-title&#34;&gt;
</span></span><span style="display:flex;"><span>            æ³¨å†Œ
</span></span><span style="display:flex;"><span>        &lt;/div&gt;
</span></span><span style="display:flex;"><span>        &lt;div class=&#34;ac-game-settings-username&#34;&gt;
</span></span><span style="display:flex;"><span>            &lt;div class=&#34;ac-game-settings-item&#34;&gt;
</span></span><span style="display:flex;"><span>                &lt;input type=&#34;text&#34; placeholder=&#34;ç”¨æˆ·å&#34;&gt;
</span></span><span style="display:flex;"><span>            &lt;/div&gt;
</span></span><span style="display:flex;"><span>        &lt;/div&gt;
</span></span><span style="display:flex;"><span>        &lt;div class=&#34;ac-game-settings-password ac-game-settings-password-first&#34;&gt;
</span></span><span style="display:flex;"><span>            &lt;div class=&#34;ac-game-settings-item&#34;&gt;
</span></span><span style="display:flex;"><span>                &lt;input type=&#34;password&#34; placeholder=&#34;å¯†ç &#34;&gt;
</span></span><span style="display:flex;"><span>            &lt;/div&gt;
</span></span><span style="display:flex;"><span>        &lt;/div&gt;
</span></span><span style="display:flex;"><span>        &lt;div class=&#34;ac-game-settings-password ac-game-settings-password-second&#34;&gt;
</span></span><span style="display:flex;"><span>            &lt;div class=&#34;ac-game-settings-item&#34;&gt;
</span></span><span style="display:flex;"><span>                &lt;input type=&#34;password&#34; placeholder=&#34;ç¡®è®¤å¯†ç &#34;&gt;
</span></span><span style="display:flex;"><span>            &lt;/div&gt;
</span></span><span style="display:flex;"><span>        &lt;/div&gt;
</span></span><span style="display:flex;"><span>        &lt;div class=&#34;ac-game-settings-submit&#34;&gt;
</span></span><span style="display:flex;"><span>            &lt;div class=&#34;ac-game-settings-item&#34;&gt;
</span></span><span style="display:flex;"><span>                &lt;button&gt;æ³¨å†Œ&lt;/button&gt;
</span></span><span style="display:flex;"><span>            &lt;/div&gt;
</span></span><span style="display:flex;"><span>        &lt;/div&gt;
</span></span><span style="display:flex;"><span>        &lt;div class=&#34;ac-game-settings-error-message&#34;&gt;
</span></span><span style="display:flex;"><span>        &lt;/div&gt;
</span></span><span style="display:flex;"><span>        &lt;div class=&#34;ac-game-settings-option&#34;&gt;
</span></span><span style="display:flex;"><span>            ç™»å½•
</span></span><span style="display:flex;"><span>        &lt;/div&gt;
</span></span><span style="display:flex;"><span>        &lt;br&gt;
</span></span><span style="display:flex;"><span>        &lt;div class=&#34;ac-game-settings-acwing&#34;&gt;
</span></span><span style="display:flex;"><span>            &lt;img width=&#34;30&#34; src=&#34;https://app165.acapp.acwing.com.cn/static/image/settings/acwing_logo.png&#34;&gt;
</span></span><span style="display:flex;"><span>            &lt;br&gt;
</span></span><span style="display:flex;"><span>            &lt;div&gt;
</span></span><span style="display:flex;"><span>                AcWingä¸€é”®ç™»å½•
</span></span><span style="display:flex;"><span>            &lt;/div&gt;
</span></span><span style="display:flex;"><span>        &lt;/div&gt;
</span></span><span style="display:flex;"><span>    &lt;/div&gt;
</span></span><span style="display:flex;"><span>&lt;/div&gt;
</span></span><span style="display:flex;"><span>`);
</span></span><span style="display:flex;"><span>        this.$login = this.$settings.find(&#34;.ac-game-settings-login&#34;);
</span></span><span style="display:flex;"><span>        this.$login_username = this.$login.find(&#34;.ac-game-settings-username input&#34;);
</span></span><span style="display:flex;"><span>        this.$login_password = this.$login.find(&#34;.ac-game-settings-password input&#34;);
</span></span><span style="display:flex;"><span>        this.$login_submit = this.$login.find(&#34;.ac-game-settings-submit button&#34;);
</span></span><span style="display:flex;"><span>        this.$login_error_message = this.$login.find(&#34;.ac-game-settings-error-message&#34;);
</span></span><span style="display:flex;"><span>        this.$login_register = this.$login.find(&#34;.ac-game-settings-option&#34;);
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        this.$login.hide();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        this.$register = this.$settings.find(&#34;.ac-game-settings-register&#34;);
</span></span><span style="display:flex;"><span>        this.$register_username = this.$register.find(&#34;.ac-game-settings-username input&#34;);
</span></span><span style="display:flex;"><span>        this.$register_password = this.$register.find(&#34;.ac-game-settings-password-first input&#34;);
</span></span><span style="display:flex;"><span>        this.$register_password_confirm = this.$register.find(&#34;.ac-game-settings-password-second input&#34;);
</span></span><span style="display:flex;"><span>        this.$register_submit = this.$register.find(&#34;.ac-game-settings-submit button&#34;);
</span></span><span style="display:flex;"><span>        this.$register_error_message = this.$register.find(&#34;.ac-game-settings-error-message&#34;);
</span></span><span style="display:flex;"><span>        this.$register_login = this.$register.find(&#34;.ac-game-settings-option&#34;);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        this.$register.hide();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        this.root.$ac_game.append(this.$settings);
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯¹åº”çš„ <code>css</code> æ–‡ä»¶éƒ¨åˆ†ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>css/game.css
</span></span><span style="display:flex;"><span>.ac-game-settings {
</span></span><span style="display:flex;"><span>    width: 100%;
</span></span><span style="display:flex;"><span>    height: 100%;
</span></span><span style="display:flex;"><span>    background-image: url(&#34;/static/image/menu/background.gif&#34;);
</span></span><span style="display:flex;"><span>    background-size: 100% 100%;
</span></span><span style="display:flex;"><span>    user-select: none;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>.ac-game-settings-login {
</span></span><span style="display:flex;"><span>    height: 41vh;
</span></span><span style="display:flex;"><span>    width: 20vw;
</span></span><span style="display:flex;"><span>    position: relative;
</span></span><span style="display:flex;"><span>    top: 50%;
</span></span><span style="display:flex;"><span>    left: 50%;
</span></span><span style="display:flex;"><span>    transform: translate(-50%, -50%);
</span></span><span style="display:flex;"><span>    background-color: rgba(0, 0, 0, 0.7);
</span></span><span style="display:flex;"><span>    border-radius: 5px;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>.ac-game-settings-title {
</span></span><span style="display:flex;"><span>    color: white;
</span></span><span style="display:flex;"><span>    font-size: 3vh;
</span></span><span style="display:flex;"><span>    text-align: center;
</span></span><span style="display:flex;"><span>    padding-top: 2vh;
</span></span><span style="display:flex;"><span>    margin-bottom: 2vh;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>.ac-game-settings-username {
</span></span><span style="display:flex;"><span>    display: block;
</span></span><span style="display:flex;"><span>    height: 7vh;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>.ac-game-settings-password {
</span></span><span style="display:flex;"><span>    display: block;
</span></span><span style="display:flex;"><span>    height: 7vh;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>.ac-game-settings-submit {
</span></span><span style="display:flex;"><span>    display: block;
</span></span><span style="display:flex;"><span>    height: 7vh;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>.ac-game-settings-acwing {
</span></span><span style="display:flex;"><span>    display: block;
</span></span><span style="display:flex;"><span>    height: 7vh;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>.ac-game-settings-item {
</span></span><span style="display:flex;"><span>    width: 100%;
</span></span><span style="display:flex;"><span>    height: 100%;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>.ac-game-settings-item &gt; input {
</span></span><span style="display:flex;"><span>    width: 90%;
</span></span><span style="display:flex;"><span>    line-height: 3vh;
</span></span><span style="display:flex;"><span>    position: relative;
</span></span><span style="display:flex;"><span>    top: 50%;
</span></span><span style="display:flex;"><span>    left: 50%;
</span></span><span style="display:flex;"><span>    transform: translate(-50%, -50%);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>.ac-game-settings-item &gt; button {
</span></span><span style="display:flex;"><span>    color: white;
</span></span><span style="display:flex;"><span>    width: 90%;
</span></span><span style="display:flex;"><span>    line-height: 3vh;
</span></span><span style="display:flex;"><span>    position: relative;
</span></span><span style="display:flex;"><span>    top: 50%;
</span></span><span style="display:flex;"><span>    left: 50%;
</span></span><span style="display:flex;"><span>    transform: translate(-50%, -50%);
</span></span><span style="display:flex;"><span>    background-color: #4CAF50;
</span></span><span style="display:flex;"><span>    border-radius: 5px;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>.ac-game-settings-error-message {
</span></span><span style="display:flex;"><span>    color: red;
</span></span><span style="display:flex;"><span>    font-size: 0.8vh;
</span></span><span style="display:flex;"><span>    display: inline;
</span></span><span style="display:flex;"><span>    float: left;
</span></span><span style="display:flex;"><span>    padding-left: 1vw;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>.ac-game-settings-option {
</span></span><span style="display:flex;"><span>    color: white;
</span></span><span style="display:flex;"><span>    font-size: 2vh;
</span></span><span style="display:flex;"><span>    display: inline;
</span></span><span style="display:flex;"><span>    float: right;
</span></span><span style="display:flex;"><span>    padding-right: 1vw;
</span></span><span style="display:flex;"><span>    cursor: pointer;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>.ac-game-settings-acwing &gt; img {
</span></span><span style="display:flex;"><span>    position: relative;
</span></span><span style="display:flex;"><span>    top: 50%;
</span></span><span style="display:flex;"><span>    left: 50%;
</span></span><span style="display:flex;"><span>    transform: translate(-50%, -50%);
</span></span><span style="display:flex;"><span>    cursor: pointer;
</span></span><span style="display:flex;"><span>    display: block;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>.ac-game-settings-acwing &gt; div {
</span></span><span style="display:flex;"><span>    color: white;
</span></span><span style="display:flex;"><span>    font-size: 1.5vh;
</span></span><span style="display:flex;"><span>    text-align: center;
</span></span><span style="display:flex;"><span>    display: block;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>.ac-game-settings-register {
</span></span><span style="display:flex;"><span>    height: 49vh;
</span></span><span style="display:flex;"><span>    width: 20vw;
</span></span><span style="display:flex;"><span>    position: relative;
</span></span><span style="display:flex;"><span>    top: 50%;
</span></span><span style="display:flex;"><span>    left: 50%;
</span></span><span style="display:flex;"><span>    transform: translate(-50%, -50%);
</span></span><span style="display:flex;"><span>    background-color: rgba(0, 0, 0, 0.7);
</span></span><span style="display:flex;"><span>    border-radius: 5px;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="å®ç°ç™»å½•æ³¨å†Œçš„ç›¸äº’åˆ‡æ¢">å®ç°ç™»å½•/æ³¨å†Œçš„ç›¸äº’åˆ‡æ¢<a hidden class="anchor" aria-hidden="true" href="#å®ç°ç™»å½•æ³¨å†Œçš„ç›¸äº’åˆ‡æ¢">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Settings</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">constructor</span>(<span style="color:#a6e22e">root</span>) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">start</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getinfo</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">add_listening_events</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">add_listening_events</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">add_listening_events_login</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">add_listening_events_register</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">add_listening_events_login</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">outer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">$login_register</span>.<span style="color:#a6e22e">click</span>(<span style="color:#66d9ef">function</span>() {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">outer</span>.<span style="color:#a6e22e">register</span>();   <span style="color:#75715e">// è·³åˆ°æ³¨å†Œç•Œé¢
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">add_listening_events_register</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">outer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">$register_login</span>.<span style="color:#a6e22e">click</span>(<span style="color:#66d9ef">function</span>() {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">outer</span>.<span style="color:#a6e22e">login</span>();      <span style="color:#75715e">// è·³åˆ°ç™»å½•ç•Œé¢
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        })
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="å®ç°ç™»å½•åŠŸèƒ½">å®ç°ç™»å½•åŠŸèƒ½<a hidden class="anchor" aria-hidden="true" href="#å®ç°ç™»å½•åŠŸèƒ½">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>views/settings/login.py
</span></span><span style="display:flex;"><span>from django.http import JsonResponse
</span></span><span style="display:flex;"><span>from django.contrib.auth import authenticate, login
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def signin(request):
</span></span><span style="display:flex;"><span>    data = request.GET
</span></span><span style="display:flex;"><span>    username = data.get(&#39;username&#39;)
</span></span><span style="display:flex;"><span>    password = data.get(&#39;password&#39;)
</span></span><span style="display:flex;"><span>    user = authenticate(username=username, password=password)
</span></span><span style="display:flex;"><span>    if not user:
</span></span><span style="display:flex;"><span>        return JsonResponse({
</span></span><span style="display:flex;"><span>            &#39;result&#39;: &#34;ç”¨æˆ·åæˆ–å¯†ç ä¸æ­£ç¡®&#34;
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>    login(request, user)
</span></span><span style="display:flex;"><span>    return JsonResponse({
</span></span><span style="display:flex;"><span>        &#39;result&#39;: &#34;success&#34;
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>urls/settings/index.py
</span></span><span style="display:flex;"><span>from django.urls import path
</span></span><span style="display:flex;"><span>from game.views.settings.getinfo import getinfo
</span></span><span style="display:flex;"><span>from game.views.settings.login import signin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>urlpatterns = [
</span></span><span style="display:flex;"><span>    path(&#34;getinfo/&#34;, getinfo, name=&#34;settings_getinfo&#34;),
</span></span><span style="display:flex;"><span>    path(&#34;login/&#34;, signin, name=&#34;settings_login&#34;),
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>settings/zbase.js
</span></span><span style="display:flex;"><span>class Settings{
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    add_listening_events_login() {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        this.$login_submit.click(function() {
</span></span><span style="display:flex;"><span>            outer.login_on_remote();
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    login_on_remote() {     // åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šç™»å½•
</span></span><span style="display:flex;"><span>        let outer = this;
</span></span><span style="display:flex;"><span>        let username = this.$login_username.val();
</span></span><span style="display:flex;"><span>        let password = this.$login_password.val();
</span></span><span style="display:flex;"><span>        this.$login_error_message.empty();
</span></span><span style="display:flex;"><span>        $.ajax({
</span></span><span style="display:flex;"><span>            url: &#34;https://app1117.acapp.acwing.com.cn/settings/login/&#34;,
</span></span><span style="display:flex;"><span>            type: &#34;GET&#34;,
</span></span><span style="display:flex;"><span>            data: {
</span></span><span style="display:flex;"><span>                username: username,
</span></span><span style="display:flex;"><span>                password: password,
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            success: function(resp) {
</span></span><span style="display:flex;"><span>                console.log(resp);
</span></span><span style="display:flex;"><span>                if (resp.result === &#34;success&#34;) {
</span></span><span style="display:flex;"><span>                    location.reload();
</span></span><span style="display:flex;"><span>                } else {
</span></span><span style="display:flex;"><span>                    outer.$login_error_message.html(resp.result);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="å®ç°ç™»å‡ºåŠŸèƒ½">å®ç°ç™»å‡ºåŠŸèƒ½<a hidden class="anchor" aria-hidden="true" href="#å®ç°ç™»å‡ºåŠŸèƒ½">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>views/settings/logout.py
</span></span><span style="display:flex;"><span>from django.http import JsonResponse
</span></span><span style="display:flex;"><span>from django.contrib.auth import logout
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def signout(request):
</span></span><span style="display:flex;"><span>    user = request.user
</span></span><span style="display:flex;"><span>    if not user.is_authenticated:
</span></span><span style="display:flex;"><span>        return JsonResponse({
</span></span><span style="display:flex;"><span>            &#39;result&#39;: &#34;success&#34;,
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>    logout(request)
</span></span><span style="display:flex;"><span>    return JsonResponse({
</span></span><span style="display:flex;"><span>        &#39;result&#39;: &#34;success&#34;,
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>urls/settings/index.py
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>from game.views.settings.logout import signout
</span></span><span style="display:flex;"><span>urlpatterns = [
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    path(&#34;logout/&#34;, signout, name=&#34;settings_logout&#34;),
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>settings/zbase.js
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>login_on_remote() {     // åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šç™»å½•
</span></span><span style="display:flex;"><span>    let outer = this;
</span></span><span style="display:flex;"><span>    let username = this.$login_username.val();
</span></span><span style="display:flex;"><span>    let password = this.$login_password.val();
</span></span><span style="display:flex;"><span>    this.$login_error_message.empty();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    $.ajax({
</span></span><span style="display:flex;"><span>        url: &#34;https://app1117.acapp.acwing.com.cn/settings/login/&#34;,
</span></span><span style="display:flex;"><span>        type: &#34;GET&#34;,
</span></span><span style="display:flex;"><span>        data: {
</span></span><span style="display:flex;"><span>            username: username,
</span></span><span style="display:flex;"><span>            password: password,
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        success: function(resp) {
</span></span><span style="display:flex;"><span>            console.log(resp);
</span></span><span style="display:flex;"><span>            if (resp.result === &#34;success&#34;) {
</span></span><span style="display:flex;"><span>                location.reload();
</span></span><span style="display:flex;"><span>            } else {
</span></span><span style="display:flex;"><span>                outer.$login_error_message.html(resp.result);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>å†é¡ºä¾¿å°† <code>menu</code> èœå•é¡µé¢é‡Œçš„ <code>è®¾ç½®</code> æŒ‰é’®ä¹Ÿç»‘å®šä¸Šç™»å‡ºåŠŸèƒ½</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>menu/zbase.js
</span></span><span style="display:flex;"><span>add_listening_events() {
</span></span><span style="display:flex;"><span>    let outer = this;
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    this.$settings_mode.click(function() {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        outer.root.settings.logout_on_remote();
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="å®ç°æ³¨å†ŒåŠŸèƒ½">å®ç°æ³¨å†ŒåŠŸèƒ½<a hidden class="anchor" aria-hidden="true" href="#å®ç°æ³¨å†ŒåŠŸèƒ½">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>views/settings/register.py
</span></span><span style="display:flex;"><span>from django.http import JsonResponse
</span></span><span style="display:flex;"><span>from django.contrib.auth import login
</span></span><span style="display:flex;"><span>from django.contrib.auth.models import User
</span></span><span style="display:flex;"><span>from game.models.player.player import Player
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def register(request):
</span></span><span style="display:flex;"><span>    data = request.GET
</span></span><span style="display:flex;"><span>    username = data.get(&#34;username&#34;, &#34;&#34;).strip()
</span></span><span style="display:flex;"><span>    password = data.get(&#34;password&#34;, &#34;&#34;).strip()
</span></span><span style="display:flex;"><span>    password_confirm = data.get(&#34;password_confirm&#34;, &#34;&#34;).strip()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    if not username or not password:
</span></span><span style="display:flex;"><span>        return JsonResponse({
</span></span><span style="display:flex;"><span>            &#39;result&#39;: &#34;ç”¨æˆ·åæˆ–å¯†ç ä¸èƒ½ä¸ºç©º&#34;,
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>    if password != password_confirm:
</span></span><span style="display:flex;"><span>        return JsonResponse({
</span></span><span style="display:flex;"><span>            &#39;result&#39;: &#34;ä¸¤ä¸ªå¯†ç ä¸ä¸€è‡´&#34;,
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>    if User.objects.filter(username=username).exists():
</span></span><span style="display:flex;"><span>        return JsonResponse({
</span></span><span style="display:flex;"><span>            &#39;result&#39;: &#34;ç”¨æˆ·åå·²å­˜åœ¨&#34;,
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>    user = User(username=username)
</span></span><span style="display:flex;"><span>    user.set_password(password)
</span></span><span style="display:flex;"><span>    user.save()
</span></span><span style="display:flex;"><span>    Player.objects.create(user=user, photo=&#34;https://cdn.acwing.com/media/user/profile/photo/42832_lg_f999efc3c8.png&#34;)
</span></span><span style="display:flex;"><span>    login(request, user)
</span></span><span style="display:flex;"><span>    return JsonResponse({
</span></span><span style="display:flex;"><span>        &#39;result&#39;: &#34;success&#34;,
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>urls/settings/index.py
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>from game.views.settings.register import register
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>urlpatterns = [
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    path(&#34;register/&#34;, register, name=&#34;settings_register&#34;),
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>settings/zbase.js
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>add_listening_events_register() {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    this.$register_submit.click(function() {
</span></span><span style="display:flex;"><span>        outer.register_on_remote();
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>register_on_remote() {  // åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šæ³¨å†Œ
</span></span><span style="display:flex;"><span>    let outer = this;
</span></span><span style="display:flex;"><span>    let username = this.$register_username.val();
</span></span><span style="display:flex;"><span>    let password = this.$register_password.val();
</span></span><span style="display:flex;"><span>    let password_confirm = this.$register_password_confirm.val();
</span></span><span style="display:flex;"><span>    this.$register_error_message.empty();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    $.ajax({
</span></span><span style="display:flex;"><span>        url: &#34;https://app1117.acapp.acwing.com.cn/settings/register/&#34;,
</span></span><span style="display:flex;"><span>        type: &#34;GET&#34;,
</span></span><span style="display:flex;"><span>        data: {
</span></span><span style="display:flex;"><span>            username: username,
</span></span><span style="display:flex;"><span>            password: password,
</span></span><span style="display:flex;"><span>            password_confirm: password_confirm,
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        success: function(resp) {
</span></span><span style="display:flex;"><span>            console.log(resp);
</span></span><span style="display:flex;"><span>            if (resp.result === &#34;success&#34;) {
</span></span><span style="display:flex;"><span>                location.reload();
</span></span><span style="display:flex;"><span>            } else {
</span></span><span style="display:flex;"><span>                outer.$register_error_message.html(resp.result);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><h2 id="redisà®">Redisà®<a hidden class="anchor" aria-hidden="true" href="#redisà®">#</a></h2>
<h3 id="redisæ˜¯ä»€ä¹ˆ">Redisæ˜¯ä»€ä¹ˆï¼Ÿ<a hidden class="anchor" aria-hidden="true" href="#redisæ˜¯ä»€ä¹ˆ">#</a></h3>
<blockquote>
<p><strong><code>Redis</code> æ˜¯ä¸€æ¬¾å†…å­˜é«˜é€Ÿç¼“å­˜æ•°æ®åº“</strong></p>
</blockquote>
<h3 id="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨redis">ä¸ºä»€ä¹ˆè¦ä½¿ç”¨Redis?<a hidden class="anchor" aria-hidden="true" href="#ä¸ºä»€ä¹ˆè¦ä½¿ç”¨redis">#</a></h3>
<blockquote>
<p><strong>æˆ‘ä»¬ç›®å‰ç”¨çš„æ˜¯<code>Django</code>è‡ªå¸¦çš„æ•°æ®åº“<code>Sqlite</code>ã€‚<code>Django</code>æ˜¯å¾ˆå®¹æ˜“å°†æ•°æ®åº“è¿ç§»åˆ°<code>mySQL</code>çš„ã€‚ä½†æ˜¯å­˜å‚¨æ•ˆç‡ä¸å¦‚<code>redis</code>ï¼Œå› ä¸º<code>redis</code>æ˜¯å†…å­˜æ•°æ®åº“ï¼Œæ‰€ä»¥è°ƒç”¨ä¸œè¥¿éƒ½éå¸¸å¿«ï¼Œå­˜çš„æ˜¯ä¸€ä¸ªä¸€ä¸ªçš„<code>&lt;key, value&gt;</code>ï¼Œè€Œä¸”æ˜¯å•çº¿ç¨‹çš„</strong></p>
</blockquote>
<h3 id="åœ¨djangoä¸­é›†æˆredis">åœ¨Djangoä¸­é›†æˆRedis<a hidden class="anchor" aria-hidden="true" href="#åœ¨djangoä¸­é›†æˆredis">#</a></h3>
<ol>
<li>å®‰è£… <code>django_redis</code></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>pip install django_redis
</span></span></code></pre></div><ol>
<li>é…ç½® <code>settings.py</code></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>CACHES = { 
</span></span><span style="display:flex;"><span>    &#39;default&#39;: {
</span></span><span style="display:flex;"><span>        &#39;BACKEND&#39;: &#39;django_redis.cache.RedisCache&#39;,
</span></span><span style="display:flex;"><span>        &#39;LOCATION&#39;: &#39;redis://127.0.0.1:6379/1&#39;,
</span></span><span style="display:flex;"><span>        &#34;OPTIONS&#34;: {
</span></span><span style="display:flex;"><span>            &#34;CLIENT_CLASS&#34;: &#34;django_redis.client.DefaultClient&#34;,
</span></span><span style="display:flex;"><span>        },  
</span></span><span style="display:flex;"><span>    },  
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>USER_AGENTS_CACHE = &#39;default&#39;
</span></span></code></pre></div><ol>
<li>å¯åŠ¨ <code>redis-server</code></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>sudo redis-server /etc/redis/redis.conf
</span></span></code></pre></div><h3 id="åœ¨-django-åå°é‡Œæ“çºµ-redis">åœ¨ Django åå°é‡Œæ“çºµ Redis<a hidden class="anchor" aria-hidden="true" href="#åœ¨-django-åå°é‡Œæ“çºµ-redis">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ python3 manage.py shell&#39;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [1]: from django.core.cache import cache # å¼•å…¥redis
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [2]: cache.keys(&#39;*&#39;)                     # æŸ¥è¯¢redisé‡Œæ‰€æœ‰çš„å…³é”®å­—
</span></span><span style="display:flex;"><span>Out[2]: []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [3]: cache.set(&#39;yxc&#39;, 1, 5)              # æ’å…¥ä¸€ä¸ªkey-valï¼Œå­˜åœ¨ 5 s
</span></span><span style="display:flex;"><span>Out[3]: True
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [4]: cache.keys(&#39;*&#39;)                     # æŸ¥è¯¢redisé‡Œæ‰€æœ‰çš„å…³é”®å­—
</span></span><span style="display:flex;"><span>Out[4]: [&#39;yxc&#39;]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [5]: cache.set(&#39;yxc&#39;, 2, None)           # æ’å…¥ä¸€ä¸ªkey-valï¼Œä¸ä¼šè¿‡æœŸ
</span></span><span style="display:flex;"><span>Out[5]: True
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [6]: cache.set(&#39;abc&#39;, 3, None)
</span></span><span style="display:flex;"><span>Out[6]: True
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [7]: cache.keys(&#39;y*&#39;)
</span></span><span style="display:flex;"><span>Out[7]: [&#39;yxc&#39;]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [8]: cache.has_key(&#39;abc&#39;)
</span></span><span style="display:flex;"><span>Out[8]: True
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [9]: cache.has_key(&#39;abcd&#39;)
</span></span><span style="display:flex;"><span>Out[9]: False
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [10]: cache.get(&#39;yxc&#39;)
</span></span><span style="display:flex;"><span>Out[10]: 2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [11]: cache.delete(&#39;yxc&#39;)
</span></span><span style="display:flex;"><span>Out[11]: True
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [12]: cache.keys(&#39;*&#39;)
</span></span><span style="display:flex;"><span>Out[12]: [&#39;abc&#39;]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>In [13]:
</span></span></code></pre></div><h2 id="webç«¯acwingä¸€é”®ç™»å½•à®">Webç«¯AcWingä¸€é”®ç™»å½•à®<a hidden class="anchor" aria-hidden="true" href="#webç«¯acwingä¸€é”®ç™»å½•à®">#</a></h2>
<hr>
<blockquote>
<p><strong>ç”¨æˆ·ç‚¹å‡»<code>AcWingä¸€é”®ç™»å½•</code>ï¼Œé€šè¿‡<code>urls &amp; views</code>è°ƒç”¨<code>apply_code</code>å‡½æ•°ï¼Œå°†<code>state</code>æ”¾åˆ°<code>redis</code>ä¸­ï¼Œå°†<code>appid &amp; redirect_uri &amp; scope &amp; state</code> ä¼ å…¥<code>apply_code_url</code>é“¾æ¥ï¼Œè¿”å›å¹¶é‡å®šå‘è‡³<code>apply_code_url</code>å‘ç”¨æˆ·è¯¢é—®æ˜¯å¦æˆæƒ</strong></p>
<p><strong>ç”¨æˆ·ç‚¹å‡»<code>åŒæ„</code>åï¼Œé‡å®šå‘è‡³<code>redirect_uri</code>é“¾æ¥ï¼Œè¿”å›å‚æ•°ä¸º<code>code</code>å’Œ<code>state</code>ï¼Œé€šè¿‡<code>urls &amp; views</code>è°ƒç”¨<code>receive_code</code>å‡½æ•°</strong></p>
<p><strong>è‹¥éªŒè¯<code>state</code>å¤±è´¥ï¼Œç›´æ¥é‡å®šå‘è‡³åˆå§‹ç•Œé¢</strong></p>
<p><strong>è‹¥éªŒè¯<code>state</code>æˆåŠŸï¼Œå°†<code>appid &amp; code &amp; secret</code>å‘é€è‡³<code>AcWingæœåŠ¡å™¨</code>ï¼Œç”³è¯·æˆæƒä»¤ç‰Œ<code>access_token</code>å’Œç”¨æˆ·çš„<code>openid</code></strong></p>
<p><strong>è‹¥ç”³è¯·ä»¤ç‰ŒæˆåŠŸï¼Œå°†<code>access_token &amp; openid</code>å‘é€è‡³<code>AcWingæœåŠ¡å™¨</code>ï¼Œå¾—åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œåˆ›å»ºå¹¶ç™»å½•ç”¨æˆ·ï¼Œæœ€åé‡å®šå‘è‡³åˆå§‹ç•Œé¢</strong></p>
</blockquote>
<h2 id="acappç«¯acwingä¸€é”®ç™»å½•à®">AcAppç«¯AcWingä¸€é”®ç™»å½•à®<a hidden class="anchor" aria-hidden="true" href="#acappç«¯acwingä¸€é”®ç™»å½•à®">#</a></h2>
<hr>
<h1 id="å®ç°è”æœºå¯¹æˆ˜à®">å®ç°è”æœºå¯¹æˆ˜à®<a hidden class="anchor" aria-hidden="true" href="#å®ç°è”æœºå¯¹æˆ˜à®">#</a></h1>
<ul>
<li><a href="https://www.acwing.com/file_system/file/content/whole/index/content/3357332/">7. å®ç°è”æœºå¯¹æˆ˜ | è®²ä¹‰</a></li>
<li><a href="https://www.acwing.com/solution/content/89506/">7.1 ä¸Šè¯¾ç¬”è®° | å¤§èœç‹—</a></li>
<li><a href="https://www.acwing.com/solution/content/88801/">7.2 ä¸Šè¯¾ç¬”è®° | èŠèŠ±</a></li>
</ul>
<hr>
<h2 id="ç»Ÿä¸€é•¿åº¦å•ä½">ç»Ÿä¸€é•¿åº¦å•ä½<a hidden class="anchor" aria-hidden="true" href="#ç»Ÿä¸€é•¿åº¦å•ä½">#</a></h2>
<p>ç”±äºè”æœºå¯¹æˆ˜çš„æ—¶å€™ï¼Œæ¯ä¸ªç”¨æˆ·çš„å®¢æˆ·ç«¯é•¿å®½ä¸ä¸€æ ·</p>
<p>åœ¨ä¹‹å‰å®Œæˆçš„æ¸¸æˆç•Œé¢é‡Œï¼Œæˆ‘ä»¬ä¼šæ ¹æ®å½“å‰å®¢æˆ·ç«¯çš„å¤§å°ï¼Œè¿›è¡Œæ¸²æŸ“</p>
<p>ä½†æ˜¯åœ¨è”æœºå¯¹æˆ˜çš„æ—¶å€™ï¼Œåº”å½“è®©æ‰€æœ‰ç©å®¶çš„æ¸¸æˆç•Œé¢ä¿æŒåŒæ­¥æ‰å¯ä»¥</p>
<p>æ‰€æœ‰ï¼Œå°±å¼•å…¥äº† <strong>ç»Ÿä¸€é•¿åº¦å•ä½</strong> çš„ç›®æ ‡</p>
<h3 id="åœ°å›¾æ¸²æŸ“">åœ°å›¾æ¸²æŸ“<a hidden class="anchor" aria-hidden="true" href="#åœ°å›¾æ¸²æŸ“">#</a></h3>
<h4 id="åœ°å›¾-169-ç­‰æ¯”ä¾‹ç¼©æ”¾">åœ°å›¾ 16:9 ç­‰æ¯”ä¾‹ç¼©æ”¾<a hidden class="anchor" aria-hidden="true" href="#åœ°å›¾-169-ç­‰æ¯”ä¾‹ç¼©æ”¾">#</a></h4>
<p>å®ç°é€»è¾‘ï¼šæ ¹æ®å½“å‰ç”¨æˆ·çš„å®¢æˆ·ç«¯å¤§å°ï¼Œç»Ÿä¸€æ¸²æŸ“æˆ <strong>16:9</strong> çš„æ¸¸æˆç•Œé¢ï¼Œä¸”éšç€ç”¨æˆ·è°ƒæ•´çª—å£å¤§å°ï¼Œä¹ŸåŠ¨æ€è°ƒæ•´</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>js/src/playground/zbase.js
</span></span><span style="display:flex;"><span>class AcGamePlayground {
</span></span><span style="display:flex;"><span>    constructor(root) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        this.root.$ac_game.append(this.$playground);// æœªæ¥å¯èƒ½ä¼šå¤šæ¬¡ show å› æ­¤æŠŠåˆ›å»ºåœºæ™¯æŒªåˆ°è¿™é‡Œ
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    start() {
</span></span><span style="display:flex;"><span>        let outer = this;
</span></span><span style="display:flex;"><span>        $(window).resize(function() {
</span></span><span style="display:flex;"><span>            outer.resize();
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    resize() {
</span></span><span style="display:flex;"><span>        this.width = this.$playground.width();
</span></span><span style="display:flex;"><span>        this.height = this.$playground.height();
</span></span><span style="display:flex;"><span>        let unit = Math.min(this.width / 16, this.height / 9);  // ä»¥æœ€å°çš„ä½œä¸ºåŸºå‡†ï¼Œæ¸²æŸ“
</span></span><span style="display:flex;"><span>        this.width = unit * 16;
</span></span><span style="display:flex;"><span>        this.height = unit * 9;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        this.resize();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        this.scale = this.height;   // resizeæ—¶ï¼Œå…¶ä»–å…ƒç´ çš„æ¸²æŸ“å¤§å°éƒ½ä»¥å½“å‰æ¸²æŸ“çš„é«˜åº¦ä¸ºåŸºå‡†ï¼Œå­˜ä¸º scale å˜é‡
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        if (this.game_map) this.game_map.resize();  //å¦‚æœæ­¤æ—¶åœ°å›¾å·²åˆ›å»ºï¼Œåˆ™resizeä¸€ä¸‹
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    show() {    // æ‰“å¼€ playground ç•Œé¢
</span></span><span style="display:flex;"><span>        this.$playground.show();
</span></span><span style="display:flex;"><span>        this.resize();
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>js/src/playground/game_map/zbase.js
</span></span><span style="display:flex;"><span>class GameMap extends AcGameObject {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    resize() {
</span></span><span style="display:flex;"><span>        this.ctx.canvas.width = this.playground.width;
</span></span><span style="display:flex;"><span>        this.ctx.canvas.height = this.playground.height;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="åœ°å›¾å±…ä¸­">åœ°å›¾å±…ä¸­<a hidden class="anchor" aria-hidden="true" href="#åœ°å›¾å±…ä¸­">#</a></h4>
<p>ç›´æ¥æŠŠ <code>canvas</code> å…ƒç´ ï¼Œç”¨ç›¸å¯¹ä½ç½®å±…ä¸­å³å¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>css/game.css
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>.ac-game-playground {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    background-color: grey;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>.ac-game-playground &gt; canvas {
</span></span><span style="display:flex;"><span>    position: relative;
</span></span><span style="display:flex;"><span>    top: 50%;
</span></span><span style="display:flex;"><span>    left: 50%;
</span></span><span style="display:flex;"><span>    transform: translate(-50%, -50%);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="è§£å†³åœ°å›¾-resize-æ—¶ä¼šå‡ºç°æ¸å˜æˆé»‘è‰²çš„æƒ…å†µ">è§£å†³åœ°å›¾ resize æ—¶ï¼Œä¼šå‡ºç°æ¸å˜æˆé»‘è‰²çš„æƒ…å†µ<a hidden class="anchor" aria-hidden="true" href="#è§£å†³åœ°å›¾-resize-æ—¶ä¼šå‡ºç°æ¸å˜æˆé»‘è‰²çš„æƒ…å†µ">#</a></h4>
<p>åŸç”±æ˜¯å› ä¸ºæˆ‘ä»¬çš„å®ç°é€»è¾‘æ˜¯ï¼šæ¯å¸§ä¼šæ¸²æŸ“ä¸€å±‚åŠé€æ˜çš„é»‘è‰²èƒŒæ™¯</p>
<p>ä¹Ÿå°±é€ å°±äº†ä¸€å¼€å§‹ä¼šå‡ºç°ç°å±çš„æƒ…å†µï¼Œè§£å†³æ–¹æ³•å¾ˆç®€å•ï¼Œç›´æ¥ resize å®Œï¼Œå¼ºåˆ¶æ¶‚ä¸€å±‚ä¸é€æ˜çš„é»‘è‰²å³å¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>js/src/playground/game_map/zbase.js
</span></span><span style="display:flex;"><span>class GameMap extends AcGameObject {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    resize() {
</span></span><span style="display:flex;"><span>        this.ctx.canvas.width = this.playground.width;
</span></span><span style="display:flex;"><span>        this.ctx.canvas.height = this.playground.height;
</span></span><span style="display:flex;"><span>        this.ctx.fillStyle = &#34;rgba(0, 0, 0, 1)&#34;;    // resize å®Œï¼Œæ¶‚ä¸€å±‚ä¸é€æ˜çš„å³å¯
</span></span><span style="display:flex;"><span>        this.ctx.fillRect(0, 0, this.ctx.canvas.width, this.ctx.canvas.height);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="å…ƒç´ æ¸²æŸ“">å…ƒç´ æ¸²æŸ“<a hidden class="anchor" aria-hidden="true" href="#å…ƒç´ æ¸²æŸ“">#</a></h3>
<p>åœ°å›¾éšç€å°ºå¯¸ç­‰æ¯”ä¾‹æ”¾å¤§ç¼©å°çš„åŒæ—¶ï¼Œåœ°å›¾å†…çš„å…¶ä»–å…ƒç´ ä¹Ÿåº”ä¸èƒŒæ™¯ä¸€åŒç­‰æ¯”ä¾‹æ”¾å¤§ç¼©å°</p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬åªéœ€æŠŠå…ƒç´ å…¨éƒ¨è®¾ä¸ºç›¸å¯¹å¤§å°å³å¯ï¼Œç”¨æˆ‘ä»¬å…ˆå‰è®¾ç½®çš„ playground.scale å€¼å³å¯</p>
<h4 id="ç©å®¶-player">ç©å®¶ Player<a hidden class="anchor" aria-hidden="true" href="#ç©å®¶-player">#</a></h4>
<p>åˆå§‹åŒ–çš„æ—¶å€™ï¼Œè½¬ä¸ºä¼ é€’ <strong>scale</strong> çš„æ¯”ä¾‹å€¼</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>js/src/playground/zbase.js
</span></span><span style="display:flex;"><span>class AcGamePlayground {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    show() {    // æ‰“å¼€ playground ç•Œé¢
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        this.players.push(new Player(this, this.width / 2 / this.scale, 0.5, 0.05, &#34;white&#34;, 0.15, true));
</span></span><span style="display:flex;"><span>        for (let i = 0; i &lt; 5; i ++ ) {
</span></span><span style="display:flex;"><span>            this.players.push(new Player(this, this.width / 2 / this.scale, 0.5, 0.05, this.get_random_color(), 0.15, false));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>js/src/playground/player/zbase.js
</span></span><span style="display:flex;"><span>class Player {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    start() {
</span></span><span style="display:flex;"><span>        if (this.is_me) {
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>        } else {
</span></span><span style="display:flex;"><span>            let tx = Math.random() * this.playground.width / this.playground.scale;
</span></span><span style="display:flex;"><span>            let ty = Math.random() * this.playground.height / this.playground.scale;
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    add_listening_events() {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        this.playground.game_map.$canvas.mousedown(function(e) {
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>            if (e.which === 3) {
</span></span><span style="display:flex;"><span>                outer.move_to((e.clientX - rect.left) / outer.playground.scale, (e.clientY - rect.top) / outer.playground.scale);
</span></span><span style="display:flex;"><span>            } else if (e.which === 1) {
</span></span><span style="display:flex;"><span>                if (outer.cur_skill === &#34;fireball&#34;) {
</span></span><span style="display:flex;"><span>                    outer.shoot_fireball((e.clientX - rect.left) / outer.playground.scale, (e.clientY - rect.top) / outer.playground.scale);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    shoot_fireball(tx, ty) {
</span></span><span style="display:flex;"><span>        let x = this.x, y = this.y;
</span></span><span style="display:flex;"><span>        let radius = 0.01;
</span></span><span style="display:flex;"><span>        let angle = Math.atan2(ty - this.y, tx - this.x);
</span></span><span style="display:flex;"><span>        let vx = Math.cos(angle), vy = Math.sin(angle);
</span></span><span style="display:flex;"><span>        let color = &#34;orange&#34;;
</span></span><span style="display:flex;"><span>        let speed = 0.5;
</span></span><span style="display:flex;"><span>        let move_length = 1.0;
</span></span><span style="display:flex;"><span>        let damage = 0.01;
</span></span><span style="display:flex;"><span>        new FireBall(this.playground, this, x, y, radius, vx, vy, color, speed, move_length, damage);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    update() {
</span></span><span style="display:flex;"><span>        this.update_move();
</span></span><span style="display:flex;"><span>        this.render();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    update_move() { // æ›´æ–°ç©å®¶ç§»åŠ¨
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        if (!this.is_me &amp;&amp; this.spent_time &gt; 4 &amp;&amp; Math.random() * 180 &lt; 1) {
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        if (this.damage_speed &gt; this.eps) {
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>        } else {
</span></span><span style="display:flex;"><span>            if (this.move_length &lt; this.eps) {
</span></span><span style="display:flex;"><span>                ...
</span></span><span style="display:flex;"><span>                if (!this.is_me) {
</span></span><span style="display:flex;"><span>                    let tx = Math.random() * this.playground.width / this.playground.scale;
</span></span><span style="display:flex;"><span>                    let ty = Math.random() * this.playground.height / this.playground.scale;
</span></span><span style="display:flex;"><span>                    ...
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            } else {
</span></span><span style="display:flex;"><span>                ...
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    render() {
</span></span><span style="display:flex;"><span>        let scale = this.playground.scale;
</span></span><span style="display:flex;"><span>        if (this.is_me) {
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>            this.ctx.arc(this.x * scale, this.y * scale, this.radius * scale, 0, Math.PI * 2, false);
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>            this.ctx.drawImage(this.img, (this.x - this.radius) * scale, (this.y - this.radius) * scale, this.radius * 2 * scale, this.radius * 2 * scale);
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>        } else {
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>            this.ctx.arc(this.x * scale, this.y * scale, this.radius * scale, 0, 2 * Math.PI, false);
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="ç«çƒ-fireball">ç«çƒ Fireball<a hidden class="anchor" aria-hidden="true" href="#ç«çƒ-fireball">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>js/src/playground/skill/fireball/zbase.js
</span></span><span style="display:flex;"><span>class Fireball {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    render() {
</span></span><span style="display:flex;"><span>        let scale = this.playground.scale;
</span></span><span style="display:flex;"><span>        this.ctx.beginPath();
</span></span><span style="display:flex;"><span>        this.ctx.arc(this.x * scale, this.y * scale, this.radius * scale, 0, 2 * Math.PI, false);
</span></span><span style="display:flex;"><span>        this.ctx.fillStyle = this.color;
</span></span><span style="display:flex;"><span>        this.ctx.fill();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="ç²’å­-particle">ç²’å­ Particle<a hidden class="anchor" aria-hidden="true" href="#ç²’å­-particle">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>js/src/playground/particle/zbase.js
</span></span><span style="display:flex;"><span>class Particle {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    render() {
</span></span><span style="display:flex;"><span>        let scale = this.playground.scale;
</span></span><span style="display:flex;"><span>        this.ctx.beginPath();
</span></span><span style="display:flex;"><span>        this.ctx.arc(this.x * scale, this.y * scale, this.radius * scale, 0, 2 * Math.PI, false);
</span></span><span style="display:flex;"><span>        this.ctx.fillStyle = this.color;
</span></span><span style="display:flex;"><span>        this.ctx.fill();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="å¢åŠ è”æœºå¯¹æˆ˜æ¨¡å¼">å¢åŠ â€œè”æœºå¯¹æˆ˜â€æ¨¡å¼<a hidden class="anchor" aria-hidden="true" href="#å¢åŠ è”æœºå¯¹æˆ˜æ¨¡å¼">#</a></h2>
<p>ä¸ºäº†åŒºåˆ†ï¼šç”¨æˆ·è‡ªå·±ï¼Œæœºå™¨äººï¼Œè”æœºç©å®¶</p>
<p>éœ€è¦æŠŠ <code>is_me</code> æ”¹æˆå­—ç¬¦ä¸²ï¼Œç”¨ä»¥è¡¨ç¤ºä¸åŒ <strong>Player</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>menu/zbase.js
</span></span><span style="display:flex;"><span>class AcGameMenu{
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    add_listening_events() {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        this.$single_mode.click(function(){
</span></span><span style="display:flex;"><span>            outer.hide();
</span></span><span style="display:flex;"><span>            outer.root.playground.show(&#34;single mode&#34;);
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>        this.$multi_mode.click(function() {
</span></span><span style="display:flex;"><span>            outer.hide();
</span></span><span style="display:flex;"><span>            outer.root.playground.show(&#34;multi mode&#34;);
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>playground/zbase.js
</span></span><span style="display:flex;"><span>class Playground {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    show(mode) {    // æ‰“å¼€ playground ç•Œé¢
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        this.players.push(new Player(this, this.width / 2 / this.scale, 0.5, 0.05, &#34;white&#34;, 0.15, &#34;me&#34;, this.root.settings.username, this.root.settings.photo)));
</span></span><span style="display:flex;"><span>        if (mode === &#34;single mode&#34;) {
</span></span><span style="display:flex;"><span>            for (let i = 0; i &lt; 5; i ++ ) {
</span></span><span style="display:flex;"><span>                this.players.push(new Player(this, this.width / 2 / this.scale, 0.5, 0.05, this.get_random_color(), 0.15, &#34;robot&#34;));
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } else if (mode === &#34;multi mode&#34;) {
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>playground/player/zbase.js
</span></span><span style="display:flex;"><span>class Player extends AcGameObject {
</span></span><span style="display:flex;"><span>    constructor(playground, x, y, radius, color, speed, character, username, photo) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        this.character = character;
</span></span><span style="display:flex;"><span>        this.username = username;
</span></span><span style="display:flex;"><span>        this.photo = photo;
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        if (this.character !== &#34;robot&#34;) {
</span></span><span style="display:flex;"><span>            this.img = new Image();
</span></span><span style="display:flex;"><span>            this.img.src = this.photo;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    // åŒç†ï¼Œæ ¹æ®å¯¹åº”çš„é€»è¾‘ï¼Œä¿®æ”¹åé¢æ‰€æœ‰çš„ is_me ä¸º character
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="django_channels">Django_channels<a hidden class="anchor" aria-hidden="true" href="#django_channels">#</a></h2>
<ul>
<li><a href="https://www.jianshu.com/p/bcefda55bce4">è°ˆè°ˆWebsocket</a></li>
<li><a href="https://www.cnblogs.com/dreamroute/p/6247726.html">HTTP/TCP</a></li>
</ul>
<hr>
<h3 id="django_channelsæ˜¯ä»€ä¹ˆ">Django_channelsæ˜¯ä»€ä¹ˆï¼Ÿ<a hidden class="anchor" aria-hidden="true" href="#django_channelsæ˜¯ä»€ä¹ˆ">#</a></h3>
<blockquote>
<p><strong>Django_Channels æ˜¯ä¸€ä¸ªä¸ºDjango æä¾›å¼‚æ­¥æ‰©å±•çš„åº“ï¼Œé€šå¸¸ä¸»è¦ç”¨æ¥æä¾›WebSocket æ”¯æŒå’Œåå°ä»»åŠ¡</strong></p>
<p><strong><code>WSS</code> æ˜¯ <code>Web Socket</code> åè®®çš„å®‰å…¨æ¨¡å¼ï¼Œæ”¯æŒ <code>C/S</code> ä¸‹çš„åŒå‘é€šä¿¡ï¼ˆHTTPåè®®åªæ”¯æŒå•å‘é€šä¿¡ï¼‰</strong></p>
</blockquote>
<h3 id="é…ç½®django_channels">é…ç½®Django_channels<a hidden class="anchor" aria-hidden="true" href="#é…ç½®django_channels">#</a></h3>
<ol>
<li>å®‰è£… <code>channels_redis</code></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>pip install channels_redis
</span></span></code></pre></div><ol>
<li>é…ç½® <code>acapp/asgi.py</code></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>import os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>from channels.auth import AuthMiddlewareStack
</span></span><span style="display:flex;"><span>from channels.routing import ProtocolTypeRouter, URLRouter
</span></span><span style="display:flex;"><span>from django.core.asgi import get_asgi_application
</span></span><span style="display:flex;"><span>from game.routing import websocket_urlpatterns
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>os.environ.setdefault(&#39;DJANGO_SETTINGS_MODULE&#39;, &#39;acapp.settings&#39;)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>application = ProtocolTypeRouter({
</span></span><span style="display:flex;"><span>    &#34;http&#34;: get_asgi_application(),
</span></span><span style="display:flex;"><span>    &#34;websocket&#34;: AuthMiddlewareStack(URLRouter(websocket_urlpatterns))
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><ol>
<li>é…ç½® <code>acapp/settings.py</code></li>
</ol>
<p>åœ¨ <code>INSTALLED_APPS</code> ä¸­æ·»åŠ  <code>channels</code> ï¼Œæ·»åŠ åå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>INSTALLED_APPS = [ 
</span></span><span style="display:flex;"><span>    &#39;channels&#39;,
</span></span><span style="display:flex;"><span>    &#39;game.apps.GameConfig&#39;,
</span></span><span style="display:flex;"><span>    &#39;django.contrib.admin&#39;,
</span></span><span style="display:flex;"><span>    &#39;django.contrib.auth&#39;,
</span></span><span style="display:flex;"><span>    &#39;django.contrib.contenttypes&#39;,
</span></span><span style="display:flex;"><span>    &#39;django.contrib.sessions&#39;,
</span></span><span style="display:flex;"><span>    &#39;django.contrib.messages&#39;,
</span></span><span style="display:flex;"><span>    &#39;django.contrib.staticfiles&#39;,
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p>ç„¶ååœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ASGI_APPLICATION = &#39;acapp.asgi.application&#39;
</span></span><span style="display:flex;"><span>CHANNEL_LAYERS = {
</span></span><span style="display:flex;"><span>    &#34;default&#34;: {
</span></span><span style="display:flex;"><span>        &#34;BACKEND&#34;: &#34;channels_redis.core.RedisChannelLayer&#34;,
</span></span><span style="display:flex;"><span>        &#34;CONFIG&#34;: {
</span></span><span style="display:flex;"><span>            &#34;hosts&#34;: [(&#34;127.0.0.1&#34;, 6379)],
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ol>
<li>é…ç½® <code>game/routing.py</code> è¿™ä¸€éƒ¨åˆ†çš„ä½œç”¨ç›¸å½“äº <code>http</code> çš„ <code>urls</code></li>
</ol>
<p>å†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>from django.urls import path
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>websocket_urlpatterns = [
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><ol>
<li>ç¼–å†™ <code>game/consumers</code> è¿™ä¸€éƒ¨åˆ†çš„ä½œç”¨ç›¸å½“äº <code>http</code> çš„ <code>views</code></li>
</ol>
<p>å‚è€ƒç¤ºä¾‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>consumers/multiplayer/index.py
</span></span><span style="display:flex;"><span>from channels.generic.websocket import AsyncWebsocketConsumer
</span></span><span style="display:flex;"><span>import json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>class MultiPlayer(AsyncWebsocketConsumer):
</span></span><span style="display:flex;"><span>    async def connect(self):
</span></span><span style="display:flex;"><span>        await self.accept()
</span></span><span style="display:flex;"><span>        print(&#39;accept&#39;)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self.room_name = &#34;room&#34;
</span></span><span style="display:flex;"><span>        await self.channel_layer.group_add(self.room_name, self.channel_name)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    async def disconnect(self, close_code):
</span></span><span style="display:flex;"><span>        print(&#39;disconnect&#39;)
</span></span><span style="display:flex;"><span>        await self.channel_layer.group_discard(self.room_name, self.channel_name);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    async def receive(self, text_data):
</span></span><span style="display:flex;"><span>        data = json.loads(text_data)
</span></span><span style="display:flex;"><span>        print(data)
</span></span></code></pre></div><ol>
<li>å¯åŠ¨ <code>django_channels</code></li>
</ol>
<p>åœ¨ <code>~/acapp</code> ç›®å½•ä¸‹æ‰§è¡Œï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>daphne -b 0.0.0.0 -p 5015 acapp.asgi:application
</span></span></code></pre></div><ol>
<li>å»ºç«‹ <strong>WSS</strong> è¿æ¥</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>game/routing.py
</span></span><span style="display:flex;"><span>from django.urls import path
</span></span><span style="display:flex;"><span>from game.consumers.multiplayer.index import MultiPlayer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>websocket_urlpatterns = [
</span></span><span style="display:flex;"><span>    path(&#34;wss/multiplayer/&#34;, MultiPlayer.as_asgi(), name=&#34;wss_multiplayer&#34;),
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>playground/zbase.js
</span></span><span style="display:flex;"><span>class AcGamePlayground {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    show(mode) {    // æ‰“å¼€ playground ç•Œé¢
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        if (mode === &#34;single mode&#34;) {
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>        } else if (mode === &#34;multi mode&#34;) {
</span></span><span style="display:flex;"><span>            this.mps = new MultiPlayerSocket(this);
</span></span><span style="display:flex;"><span>            this.mps.ws.onopen = function() {
</span></span><span style="display:flex;"><span>                outer.mps.send_create_player();
</span></span><span style="display:flex;"><span>            };
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>playground/socket/multiplayer/zbase.js
</span></span><span style="display:flex;"><span>class MultiPlayerSocket {
</span></span><span style="display:flex;"><span>    constructor(playground) {
</span></span><span style="display:flex;"><span>        this.playground = playground;
</span></span><span style="display:flex;"><span>        this.ws = new WebSocket(&#34;wss://app1117.acapp.acwing.com.cn/wss/multiplayer/&#34;);
</span></span><span style="display:flex;"><span>        this.start();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    start() {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    send_create_player() {
</span></span><span style="display:flex;"><span>        this.ws.send(JSON.stringify({
</span></span><span style="display:flex;"><span>            &#39;message&#39;: &#39;hello acapp server&#39;,
</span></span><span style="display:flex;"><span>        }));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    receive_create_player() {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="ç¼–å†™åŒæ­¥å‡½æ•°">ç¼–å†™åŒæ­¥å‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#ç¼–å†™åŒæ­¥å‡½æ•°">#</a></h2>
<p>ä¸€å…±éœ€è¦å®Œæˆå››ä¸ªé€šä¿¡ï¼š</p>
<p>ï¼ˆé€šä¿¡çš„é€»è¾‘åŸºæœ¬éƒ½æ˜¯å…ˆåœ¨æœ¬åœ°å®Œæˆï¼Œç„¶åå°†ç»“æœè¿”å›ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å†åˆ†å‘ç»™å…¶ä»–å®¢æˆ·ç«¯ï¼Œè¾¾æˆåŒæ­¥ï¼‰</p>
<ol>
<li><strong>create-player</strong> : åœ¨æ‰€æœ‰ç©å®¶çš„æ¸¸æˆç•Œé¢ï¼Œåˆ›å»ºä¸€ä¸ªæ–°åŠ å…¥çš„ç©å®¶</li>
<li><strong>move-to</strong> : åœ¨æ‰€æœ‰ç©å®¶çš„æ¸¸æˆç•Œé¢ï¼Œå°†ä¸€ä¸ªè§’è‰²ç§»åŠ¨åˆ°ä¸€ä¸ªä½ç½®</li>
<li><strong>shoot-fireball</strong> : åœ¨æ‰€æœ‰ç©å®¶çš„æ¸¸æˆç•Œé¢ï¼Œè®©ä¸€ä¸ªè§’è‰²å‘å°„ä¸€ä¸ªç«çƒ</li>
<li><strong>attack</strong> : åœ¨æ‰€æœ‰ç©å®¶çš„æ¸¸æˆç•Œé¢ï¼Œè®©ä¸€ä¸ªè§’è‰²è¢«æ”»å‡»</li>
</ol>
<p>ä¸€åœºæ¸¸æˆé‡Œï¼Œæ‰€æœ‰çš„å…ƒç´ ï¼ˆç©å®¶ï¼Œç«çƒç­‰ï¼‰éƒ½éœ€è¦å”¯ä¸€çš„æ ‡è¯†ï¼Œæ¥æ–¹ä¾¿åŒæ­¥</p>
<p>ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä¿®æ”¹ä¸€ä¸‹æ¸¸æˆå¼•æ“ï¼Œå¯¹äºæ¯ä¸ªå…ƒç´ éƒ½åˆ›å»ºæˆ‘ä»¬éœ€è¦çš„å”¯ä¸€æ ‡è¯†</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>playground/ac-game-object/zbase.js
</span></span><span style="display:flex;"><span>class AcGameObject {
</span></span><span style="display:flex;"><span>    constructor() {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        this.uuid = this.create_uuid();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    create_uuid() {
</span></span><span style="display:flex;"><span>        let res = &#34;&#34;;
</span></span><span style="display:flex;"><span>        for (let i = 0; i &lt; 8; i ++ ) {
</span></span><span style="display:flex;"><span>            let x = parseInt(Math.floor(Math.random() * 10));   // [0, 10)
</span></span><span style="display:flex;"><span>            res += x;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        return res;
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>playground/zbase.js
</span></span><span style="display:flex;"><span>class AcGamePlayground {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    show(mode) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        if (mode === &#34;single mode&#34;) {
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>        } else if (mode === &#34;multi mode&#34;) {
</span></span><span style="display:flex;"><span>            this.mps = new MultiPlayerSocket(this);
</span></span><span style="display:flex;"><span>            this.mps.uuid = this.players[0].uuid;
</span></span><span style="display:flex;"><span>            this.mps.ws.onopen = function() {
</span></span><span style="display:flex;"><span>                outer.mps.send_create_player();
</span></span><span style="display:flex;"><span>            };
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>playground/socket/multiplayer/zbase.js
</span></span><span style="display:flex;"><span>class MultiPlayerSocket {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    send_create_player() {
</span></span><span style="display:flex;"><span>        let outer = this;
</span></span><span style="display:flex;"><span>        this.ws.send(JSON.stringify({
</span></span><span style="display:flex;"><span>            &#39;event&#39;: &#39;create_player&#39;,
</span></span><span style="display:flex;"><span>            &#39;uuid&#39;: outer.uuid,
</span></span><span style="display:flex;"><span>        }));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æ¥ç€ï¼Œåˆ©ç”¨é€šä¿¡çš„æ–¹å¼ï¼Œä½¿å¾—æ¯ä¸ªçª—å£å†…ï¼Œé€»è¾‘ä¸Šç›¸åŒçš„å…ƒç´ ï¼Œå…¶ <code>uid</code> ä¹Ÿç›¸åŒå³å¯</p>
<p>åŸåˆ™æ˜¯ï¼šå“ªä¸ªçª—å£åˆ›å»ºçš„å…ƒç´ ï¼Œå°±ç”¨ä»–åˆ›å»ºæ—¶çš„ <code>uid</code> ä½œä¸ºæ•´ä¸ªé¡¹ç›®è¿è¡Œæ—¶çš„ <code>uid</code></p>
<p>ç„¶åï¼Œæˆ‘ä»¬æ‰“ç®—ç”¨ <strong>redis</strong> æ¥å®ç°å­˜å‚¨æ¯ä¸ªæ¸¸æˆæˆ¿é—´ï¼Œä»¥åŠå…ƒç´ ï¼Œå¹¶åˆå§‹é»˜è®¤è®¾å®šæ¯ä¸ªæˆ¿é—´ä¸Šé™ 3 äºº</p>
<h3 id="create-player">create-player<a hidden class="anchor" aria-hidden="true" href="#create-player">#</a></h3>
<h4 id="å‰ç«¯">å‰ç«¯<a hidden class="anchor" aria-hidden="true" href="#å‰ç«¯">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>game/static/js/src/playground/socket/multiplayer/zbase.js
</span></span><span style="display:flex;"><span>class MultiPlayerSocket {
</span></span><span style="display:flex;"><span>    constructor(playground) {
</span></span><span style="display:flex;"><span>        this.playground = playground;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        this.ws = new WebSocket(&#34;wss://app1117.acapp.acwing.com.cn/wss/multiplayer/&#34;);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        this.start();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    start() {
</span></span><span style="display:flex;"><span>        this.receive();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    receive() {
</span></span><span style="display:flex;"><span>        let outer = this;
</span></span><span style="display:flex;"><span>        this.ws.onmessage = function(e) {
</span></span><span style="display:flex;"><span>            let data = JSON.parse(e.data);
</span></span><span style="display:flex;"><span>            let uuid = data.uuid;
</span></span><span style="display:flex;"><span>            if (uuid === outer.uuid) return false;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            let event = data.event;
</span></span><span style="display:flex;"><span>            if (event === &#34;create_player&#34;) {
</span></span><span style="display:flex;"><span>                outer.receive_create_player(uuid, data.username, data.photo);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    send_create_player(username, photo) {
</span></span><span style="display:flex;"><span>        let outer = this;
</span></span><span style="display:flex;"><span>        this.ws.send(JSON.stringify({
</span></span><span style="display:flex;"><span>            &#39;event&#39;: &#39;create_player&#39;,
</span></span><span style="display:flex;"><span>            &#39;uuid&#39;: outer.uuid,
</span></span><span style="display:flex;"><span>            &#39;username&#39;: username,
</span></span><span style="display:flex;"><span>            &#39;photo&#39;: photo,
</span></span><span style="display:flex;"><span>        }));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    receive_create_player(uuid, username, photo) {
</span></span><span style="display:flex;"><span>        let player = new Player(
</span></span><span style="display:flex;"><span>            this.playground,
</span></span><span style="display:flex;"><span>            this.playground.width / 2 / this.playground.scale,
</span></span><span style="display:flex;"><span>            0.5,
</span></span><span style="display:flex;"><span>            0.05,
</span></span><span style="display:flex;"><span>            &#34;white&#34;,
</span></span><span style="display:flex;"><span>            0.15,
</span></span><span style="display:flex;"><span>            &#34;enemy&#34;,
</span></span><span style="display:flex;"><span>            username,
</span></span><span style="display:flex;"><span>            photo,
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        player.uuid = uuid;
</span></span><span style="display:flex;"><span>        this.playground.players.push(player);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="åç«¯">åç«¯<a hidden class="anchor" aria-hidden="true" href="#åç«¯">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>settings.py
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>ROOM_CAPACITY = 3
</span></span><span style="display:flex;"><span>consumers/multiplayer/index.py
</span></span><span style="display:flex;"><span>from channels.generic.websocket import AsyncWebsocketConsumer
</span></span><span style="display:flex;"><span>import json
</span></span><span style="display:flex;"><span>from django.conf import settings
</span></span><span style="display:flex;"><span>from django.core.cache import cache
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>class MultiPlayer(AsyncWebsocketConsumer):
</span></span><span style="display:flex;"><span>    async def connect(self):
</span></span><span style="display:flex;"><span>        self.room_name = None
</span></span><span style="display:flex;"><span>        for i in range(1000):   # ä¸Šé™ 1k ä¸ªæˆ¿é—´
</span></span><span style="display:flex;"><span>            name = &#34;room-%d&#34; % (i)
</span></span><span style="display:flex;"><span>            # å½“å‰æˆ¿é—´ä¸ºç©ºï¼Œæˆ–æˆ¿é—´å†…ç©å®¶äººæ•°ä¸åˆ° ROOM_CAPACITY
</span></span><span style="display:flex;"><span>            if not cache.has_key(name) or len(cache.get(name)) &lt; settings.ROOM_CAPACITY:
</span></span><span style="display:flex;"><span>                self.room_name = name
</span></span><span style="display:flex;"><span>                break
</span></span><span style="display:flex;"><span>        if not self.room_name:
</span></span><span style="display:flex;"><span>            return
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        await self.accept()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        if not cache.has_key(self.room_name):   # å¦‚æœæˆ¿é—´ä¸å­˜åœ¨ï¼Œåˆ™æ–°å»ºæˆ¿é—´
</span></span><span style="display:flex;"><span>            cache.set(self.room_name, [], 3600) # æœ‰æ•ˆæœŸ 1 å°æ—¶
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        for player in cache.get(self.room_name):    # å¯¹è¯¥æˆ¿é—´å·²å­˜åœ¨çš„ç”¨æˆ·ï¼Œåˆ›å»ºåˆ°æ–°åŠ å…¥çš„ç”¨æˆ·çš„æ¸¸æˆç•Œé¢ä¸­
</span></span><span style="display:flex;"><span>            await self.send(text_data=json.dumps({
</span></span><span style="display:flex;"><span>                &#39;event&#39;: &#34;create_player&#34;,
</span></span><span style="display:flex;"><span>                &#39;uuid&#39;: player[&#39;uuid&#39;],
</span></span><span style="display:flex;"><span>                &#39;username&#39;: player[&#39;username&#39;],
</span></span><span style="display:flex;"><span>                &#39;photo&#39;: player[&#39;photo&#39;],
</span></span><span style="display:flex;"><span>            }))
</span></span><span style="display:flex;"><span>        await self.channel_layer.group_add(self.room_name, self.channel_name)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    async def disconnect(self, close_code):
</span></span><span style="display:flex;"><span>        print(&#39;disconnect&#39;)
</span></span><span style="display:flex;"><span>        await self.channel_layer.group_discard(self.room_name, self.channel_name);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    async def create_player(self, data):
</span></span><span style="display:flex;"><span>        players = cache.get(self.room_name)
</span></span><span style="display:flex;"><span>        players.append({
</span></span><span style="display:flex;"><span>            &#39;uuid&#39;: data[&#39;uuid&#39;],
</span></span><span style="display:flex;"><span>            &#39;username&#39;: data[&#39;username&#39;],
</span></span><span style="display:flex;"><span>            &#39;photo&#39;: data[&#39;photo&#39;],
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>        cache.set(self.room_name, players, 3600) # æ›´æ–°æˆ¿é—´å­˜åœ¨æ—¶é—´ä¸º 1 å°æ—¶ï¼ˆæœ€åä¸€æ¬¡åŠ å…¥ä¸€åç©å®¶æ—¶ï¼‰
</span></span><span style="display:flex;"><span>        # ç¾¤å‘æ¶ˆæ¯æ›´æ–°
</span></span><span style="display:flex;"><span>        await self.channel_layer.group_send(
</span></span><span style="display:flex;"><span>            self.room_name,
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                &#39;type&#39;: &#34;group_create_player&#34;,  # ç¾¤å‘è¯¥æ¶ˆæ¯åï¼Œä½œä¸ºå®¢æˆ·ç«¯æ¥å—è€…ï¼Œæ‰€æ¥å—ç”¨çš„å‡½æ•°å
</span></span><span style="display:flex;"><span>                &#39;event&#39;: &#34;create_player&#34;,
</span></span><span style="display:flex;"><span>                &#39;uuid&#39;: data[&#39;uuid&#39;],
</span></span><span style="display:flex;"><span>                &#39;username&#39;: data[&#39;username&#39;],
</span></span><span style="display:flex;"><span>                &#39;photo&#39;: data[&#39;photo&#39;],
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    async def group_create_player(self, data):
</span></span><span style="display:flex;"><span>        await self.send(text_data=json.dumps(data))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    async def receive(self, text_data):
</span></span><span style="display:flex;"><span>        data = json.loads(text_data)
</span></span><span style="display:flex;"><span>        event = data[&#39;event&#39;]
</span></span><span style="display:flex;"><span>        if event == &#34;create_player&#34;:
</span></span><span style="display:flex;"><span>            await self.create_player(data)
</span></span></code></pre></div><h4 id="redis-è°ƒè¯•è¯­å¥">redis è°ƒè¯•è¯­å¥<a hidden class="anchor" aria-hidden="true" href="#redis-è°ƒè¯•è¯­å¥">#</a></h4>
<p>æ‰“å¼€ shell äº¤äº’</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>python3 manage.py shell
</span></span></code></pre></div><p>ç„¶åç”¨ py3 äº¤äº’è¿›è¡Œ cache è°ƒè¯•</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>from django.core.cache import cache
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def clear():
</span></span><span style="display:flex;"><span>    for key in cache.keys(&#39;*&#39;):
</span></span><span style="display:flex;"><span>        cache.delete(key)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cache.keys(&#39;*&#39;) # æŸ¥è¯¢å½“å‰ redis ä¸­æ‰€æœ‰ key
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cache.get(&#39;room-1&#39;) # æŸ¥è¯¢å½“å‰ redis ä¸­ key ä¸º room-1 çš„å€¼
</span></span></code></pre></div><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä¾¿å¯ä»¥åœ¨ä¸åŒçš„çª—å£æ¸²æŸ“åŒä¸€æ‰¹ç©å®¶äº†</p>
<h3 id="move-to">move-to<a hidden class="anchor" aria-hidden="true" href="#move-to">#</a></h3>
<h4 id="å‰ç«¯-1">å‰ç«¯<a hidden class="anchor" aria-hidden="true" href="#å‰ç«¯-1">#</a></h4>
<p>å®¢æˆ·ç«¯çš„é€šä¿¡çš„å‘å‡ºå’Œæ¥å—å‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>game/static/js/src/playground/socket/multiplayer/zbase.js
</span></span><span style="display:flex;"><span>class MultiPlayerSocket {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    receive() {
</span></span><span style="display:flex;"><span>        let outer = this;
</span></span><span style="display:flex;"><span>        this.ws.onmessage = function(e) {
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>            else if (event === &#34;move_to&#34;) {
</span></span><span style="display:flex;"><span>                outer.receive_move_to(uuid, data.tx, data.ty);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    send_move_to(tx, ty) {
</span></span><span style="display:flex;"><span>        let outer = this;
</span></span><span style="display:flex;"><span>        this.ws.send(JSON.stringify({
</span></span><span style="display:flex;"><span>            &#39;event&#39;: &#39;move_to&#39;,
</span></span><span style="display:flex;"><span>            &#39;uuid&#39;: outer.uuid,
</span></span><span style="display:flex;"><span>            &#39;tx&#39;: tx,
</span></span><span style="display:flex;"><span>            &#39;ty&#39;: ty,
</span></span><span style="display:flex;"><span>        }));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    get_player(uuid) {
</span></span><span style="display:flex;"><span>        let players = this.playground.players;
</span></span><span style="display:flex;"><span>        for (let i = 0; i &lt; players.length; i ++ ) {
</span></span><span style="display:flex;"><span>            let player = players[i];
</span></span><span style="display:flex;"><span>            if (player.uuid === uuid) {
</span></span><span style="display:flex;"><span>                return player;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        return null;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    receive_move_to(uuid, tx, ty) {
</span></span><span style="display:flex;"><span>        let player = this.get_player(uuid);
</span></span><span style="display:flex;"><span>        if (player) {
</span></span><span style="display:flex;"><span>            player.move_to(tx, ty);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ä¸ºäº†è®©æ¸¸æˆç•Œé¢ä¸­å¯¹äºè¦ç§»åŠ¨çš„å…ƒç´ åšå‡ºç§»åŠ¨åŠ¨ä½œï¼Œéœ€è¦å¯¹ <code>move_to</code> å‡½æ•°åšå‡ºä¸€äº›ä¿®æ”¹</p>
<p>é¦–å…ˆè¦æ ‡è¯†å‡ºå½“å‰ä¸ºå¤šäººæ¨¡å¼ï¼Œç„¶åæ¨¡å¼ä¸ºå¤šäººæ¨¡å¼æ—¶ï¼Œæ¯æ¬¡ç§»åŠ¨éƒ½ä¼šè§¦å‘ä¸€æ¬¡é€šä¿¡</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>playground/zbase.js
</span></span><span style="display:flex;"><span>class AcGamePlayground {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    show(mode) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        this.mode = mode;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>playground/player/zbase.js
</span></span><span style="display:flex;"><span>class Player extends AcGameObject {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    add_listening_events() {
</span></span><span style="display:flex;"><span>      ...
</span></span><span style="display:flex;"><span>       this.playground.game_map.$canvas.mousedown(function(e) {
</span></span><span style="display:flex;"><span>           ...
</span></span><span style="display:flex;"><span>           if (e.which === 3) {
</span></span><span style="display:flex;"><span>               let tx = (e.clientX - rect.left) / outer.playground.scale;
</span></span><span style="display:flex;"><span>               let ty = (e.clientY - rect.top) / outer.playground.scale;
</span></span><span style="display:flex;"><span>               outer.move_to(tx, ty);
</span></span><span style="display:flex;"><span>               if (outer.playground.mode === &#34;multi mode&#34;) {
</span></span><span style="display:flex;"><span>                   outer.playground.mps.send_move_to(tx, ty);
</span></span><span style="display:flex;"><span>               }
</span></span><span style="display:flex;"><span>           }
</span></span><span style="display:flex;"><span>           ...
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>   ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="åç«¯-1">åç«¯<a hidden class="anchor" aria-hidden="true" href="#åç«¯-1">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>consumers/multiplayer/index.py
</span></span><span style="display:flex;"><span>async def move_to(self, data):
</span></span><span style="display:flex;"><span>    await self.channel_layer.group_send(
</span></span><span style="display:flex;"><span>        self.room_name,
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            &#39;type&#39;: &#34;group_send_event&#34;,
</span></span><span style="display:flex;"><span>            &#39;event&#39;: &#34;move_to&#34;,
</span></span><span style="display:flex;"><span>            &#39;uuid&#39;: data[&#39;uuid&#39;],
</span></span><span style="display:flex;"><span>            &#39;tx&#39;: data[&#39;tx&#39;],
</span></span><span style="display:flex;"><span>            &#39;ty&#39;: data[&#39;ty&#39;],
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>async def group_send_event(self, data):
</span></span><span style="display:flex;"><span>    await self.send(text_data=json.dumps(data))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>async def receive(self, text_data):
</span></span><span style="display:flex;"><span>    data = json.loads(text_data)
</span></span><span style="display:flex;"><span>    event = data[&#39;event&#39;]
</span></span><span style="display:flex;"><span>    if event == &#34;create_player&#34;:
</span></span><span style="display:flex;"><span>        await self.create_player(data)
</span></span><span style="display:flex;"><span>    elif event == &#34;move_to&#34;:
</span></span><span style="display:flex;"><span>        await self.move_to(data)
</span></span></code></pre></div><h3 id="shoot-fireball">shoot-fireball<a hidden class="anchor" aria-hidden="true" href="#shoot-fireball">#</a></h3>
<h4 id="å‰ç«¯-2">å‰ç«¯<a hidden class="anchor" aria-hidden="true" href="#å‰ç«¯-2">#</a></h4>
<p>ç”¨ä¸€ä¸ªæ•°ç»„æ¥å­˜ä¸€ä¸ªç©å®¶å‘å°„çš„æ‰€æœ‰ç«çƒï¼Œä»¥ä¾¿äºå­å¼¹æ¶ˆå¤±æ—¶ï¼Œå°†ä»–ä»¬æ‰¾å‡ºå¹¶å¯¹åº”åˆ æ‰</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>playground/player/zbase.js
</span></span><span style="display:flex;"><span>class Player extends AcGameObject {
</span></span><span style="display:flex;"><span>    constructor(playground, x, y, radius, color, speed, character, username, photo) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        this.fireballs = [];    // å­˜è¯¥ç”¨æˆ·å‘å°„çš„æ‰€æœ‰ç«çƒ
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    add_listening_events() {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        this.playground.game_map.$canvas.mousedown(function(e) {
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>            else if (e.which === 1) {
</span></span><span style="display:flex;"><span>                let tx = (e.clientX - rect.left) / outer.playground.scale;
</span></span><span style="display:flex;"><span>                let ty = (e.clientY - rect.top) / outer.playground.scale;
</span></span><span style="display:flex;"><span>                if (outer.cur_skill === &#34;fireball&#34;) {
</span></span><span style="display:flex;"><span>                    let fireball = outer.shoot_fireball(tx, ty);
</span></span><span style="display:flex;"><span>                    if (outer.playground.mode === &#34;multi mode&#34;) {
</span></span><span style="display:flex;"><span>                        outer.playground.mps.send_shoot_fireball(tx, ty, fireball.uuid);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>        $(window).keydown(function(e) {
</span></span><span style="display:flex;"><span>            if (e.which === 81) {           // é”®ç›˜æŒ‰ä¸‹qäº‹ä»¶
</span></span><span style="display:flex;"><span>                outer.cur_skill = &#34;fireball&#34;;
</span></span><span style="display:flex;"><span>                return false;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    shoot_fireball(tx, ty) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        let fireball = new FireBall(this.playground, this, x, y, radius, vx, vy, color, speed, move_length, damage);
</span></span><span style="display:flex;"><span>        this.fireballs.push(fireball);
</span></span><span style="display:flex;"><span>        return fireball;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    destroy_fireball(uuid) {
</span></span><span style="display:flex;"><span>        for (let i = 0; i &lt; this.fireballs.length; i ++ ) {
</span></span><span style="display:flex;"><span>            let fireball = this.fireballs[i];
</span></span><span style="display:flex;"><span>            if (fireball.uuid == uuid) {
</span></span><span style="display:flex;"><span>                fireball.destroy();
</span></span><span style="display:flex;"><span>                break;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>playground/skill/fireball/zbase.js
</span></span><span style="display:flex;"><span>class FireBall extends AcGameObject {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    on_destory() {
</span></span><span style="display:flex;"><span>        let fireballs = this.player.fireballs;
</span></span><span style="display:flex;"><span>        for (let i = 0; i &lt; fireballs.length; i ++ ) {
</span></span><span style="display:flex;"><span>            if (fireballs[i] === this) {
</span></span><span style="display:flex;"><span>                fireballs.splice(i, 1);
</span></span><span style="display:flex;"><span>                break;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>game/static/js/src/playground/socket/multiplayer/zbase.js
</span></span><span style="display:flex;"><span>class MultiPlayerSocket {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    send_shoot_fireball(tx, ty, ball_uuid) {
</span></span><span style="display:flex;"><span>        let outer = this;
</span></span><span style="display:flex;"><span>        this.ws.send(JSON.stringify({
</span></span><span style="display:flex;"><span>            &#39;event&#39;: &#39;move_to&#39;,
</span></span><span style="display:flex;"><span>            &#39;uuid&#39;: outer.uuid,
</span></span><span style="display:flex;"><span>            &#39;tx&#39;: tx,
</span></span><span style="display:flex;"><span>            &#39;ty&#39;: ty,
</span></span><span style="display:flex;"><span>            &#39;ball_uuid&#39;: ball_uuid;
</span></span><span style="display:flex;"><span>        }));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    receive_shoot_fireball(uuid, tx, ty, ball_uuid) {
</span></span><span style="display:flex;"><span>        let player = this.get_player(uuid);
</span></span><span style="display:flex;"><span>        if (player) {
</span></span><span style="display:flex;"><span>            let fireball = player.shoot_fireball(tx, ty);
</span></span><span style="display:flex;"><span>            fireball.uuid = ball_uuid;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="åç«¯-2">åç«¯<a hidden class="anchor" aria-hidden="true" href="#åç«¯-2">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>consumers/multiplayer/index.py
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>class MultiPlayer(AsyncWebsocketConsumer):
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    async def shoot_fireball(self, data):
</span></span><span style="display:flex;"><span>        await self.channel_layer.group_send(
</span></span><span style="display:flex;"><span>            self.room_name,
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                &#39;type&#39;: &#34;group_send_event&#34;,
</span></span><span style="display:flex;"><span>                &#39;event&#39;: &#34;shoot_fireball&#34;,
</span></span><span style="display:flex;"><span>                &#39;uuid&#39;: data[&#39;uuid&#39;],
</span></span><span style="display:flex;"><span>                &#39;tx&#39;: data[&#39;tx&#39;],
</span></span><span style="display:flex;"><span>                &#39;ty&#39;: data[&#39;ty&#39;],
</span></span><span style="display:flex;"><span>                &#39;ball_uuid&#39;: data[&#39;ball_uuid&#39;],
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    async def receive(self, text_data):
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        elif event == &#34;shoot_fireball&#34;:
</span></span><span style="display:flex;"><span>            await self.shoot_fireball(data)
</span></span></code></pre></div><h3 id="attack">attack<a hidden class="anchor" aria-hidden="true" href="#attack">#</a></h3>
<p>ä¸ºäº†åªè®©ä¸€ä¸ªå®¢æˆ·ç«¯è¿›è¡Œæ”»å‡»å‘½ä¸­çš„åˆ¤æ–­ï¼Œå› æ­¤åªæœ‰å‘å‡ºæ–¹çš„ç«çƒæ‰åšç¢°æ’æ£€æµ‹</p>
<p>å…¶ä»–å®¢æˆ·ç«¯å¯¹äºè¯¥ç«çƒåªæœ‰åŠ¨ç”»æ•ˆæœ</p>
<p>åˆç”±äºç¢°æ’æ£€æµ‹æ˜¯åœ¨ä¸€å°å®¢æˆ·ç«¯ä¸Šè¿›è¡Œçš„ï¼Œå› æ­¤å¤šç«¯ä¹‹é—´å¯èƒ½ä¼šå­˜åœ¨åŒæ­¥ä¸Šçš„å»¶è¿Ÿ</p>
<p>ä¸ºæ­¤çš„è§£å†³æ–¹æ³•æ˜¯ï¼šç¢°æ’æ£€æµ‹æˆåŠŸæ—¶ï¼Œå¼ºåˆ¶æŠŠè¢«å‡»ä¸­ç©å®¶ç§»åŠ¨åˆ°å‘èµ·æ–¹å®¢æˆ·ç«¯ä¸­çš„ä½ç½®ï¼Œä»¥é¿å…å‡»ä¸­å»¶è¿Ÿä¸Šå‘ç”Ÿçš„äº‹æƒ…</p>
<h4 id="å‰ç«¯-3">å‰ç«¯<a hidden class="anchor" aria-hidden="true" href="#å‰ç«¯-3">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>playground/skill/fireball/zbase.js
</span></span><span style="display:flex;"><span>class FireBall extends AcGameObject {
</span></span><span style="display:flex;"><span>    update() {
</span></span><span style="display:flex;"><span>        if (this.move_length &lt; this.eps) {
</span></span><span style="display:flex;"><span>            this.destroy();
</span></span><span style="display:flex;"><span>            return false;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        this.update_move();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        if (this.player.character !== &#34;enemy&#34;) {
</span></span><span style="display:flex;"><span>            this.update_attack();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        this.render();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    attack(player) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        if (this.playground.mode === &#34;multi mode&#34;) {
</span></span><span style="display:flex;"><span>            this.playground.mps.send_attack(player.uuid, player.x, player.y, angle, this.damage, this.uuid);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>playground/player/zbase.js
</span></span><span style="display:flex;"><span>class Player extends AcGameObject {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    receive_attack(x, y, angle, damage, ball_uuid, attacker) {
</span></span><span style="display:flex;"><span>        attacker.destroy_fireball(ball_uuid);
</span></span><span style="display:flex;"><span>        this.x = x;
</span></span><span style="display:flex;"><span>        this.y = y;
</span></span><span style="display:flex;"><span>        this.is_attacked(angle, damage);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>game/static/js/src/playground/socket/multiplayer/zbase.js
</span></span><span style="display:flex;"><span>class MultiPlayerSocket {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    send_attack(attackee_uuid, x, y, angle, damage, ball_uuid) {
</span></span><span style="display:flex;"><span>        let outer = this;
</span></span><span style="display:flex;"><span>        this.ws.send(JSON.stringify({
</span></span><span style="display:flex;"><span>            &#39;event&#39;: &#34;attack&#34;,
</span></span><span style="display:flex;"><span>            &#39;uuid&#39;: outer.uuid,
</span></span><span style="display:flex;"><span>            &#39;attackee_uuid&#39;: attackee_uuid,
</span></span><span style="display:flex;"><span>            &#39;x&#39;: x,
</span></span><span style="display:flex;"><span>            &#39;y&#39;: y,
</span></span><span style="display:flex;"><span>            &#39;angle&#39;: angle,
</span></span><span style="display:flex;"><span>            &#39;damage&#39;: damage,
</span></span><span style="display:flex;"><span>            &#39;ball_uuid&#39;: ball_uuid,
</span></span><span style="display:flex;"><span>        }));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    receive_attack(uuid, attackee_uuid, x, y, angle, damage, ball_uuid) {
</span></span><span style="display:flex;"><span>        let attacker = this.get_player(uuid);
</span></span><span style="display:flex;"><span>        let attackee = this.get_player(attackee_uuid);
</span></span><span style="display:flex;"><span>        if (attacker &amp;&amp; attackee) {
</span></span><span style="display:flex;"><span>            attackee.receive_attack(x, y, angle, damage, ball_uuid, attacker);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="åç«¯-3">åç«¯<a hidden class="anchor" aria-hidden="true" href="#åç«¯-3">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>consumers/multiplayer/index.py
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>class MultiPlayer(AsyncWebsocketConsumer):
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    async def attack(self, data):
</span></span><span style="display:flex;"><span>        await self.channel_layer.group_send(
</span></span><span style="display:flex;"><span>            self.room_name,
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                &#39;type&#39;: &#34;group_send_event&#34;,
</span></span><span style="display:flex;"><span>                &#39;event&#39;: &#34;attack&#34;,
</span></span><span style="display:flex;"><span>                &#39;uuid&#39;: data[&#39;uuid&#39;],
</span></span><span style="display:flex;"><span>                &#39;x&#39;: data[&#39;x&#39;],
</span></span><span style="display:flex;"><span>                &#39;y&#39;: data[&#39;y&#39;],
</span></span><span style="display:flex;"><span>                &#39;angle&#39;: data[&#39;angle&#39;],
</span></span><span style="display:flex;"><span>                &#39;damage&#39;: data[&#39;damage&#39;],
</span></span><span style="display:flex;"><span>                &#39;ball_uuid&#39;: data[&#39;ball_uuid&#39;],
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    ...
</span></span></code></pre></div><h2 id="æ¸¸æˆçš„å°ä¼˜åŒ–">æ¸¸æˆçš„å°ä¼˜åŒ–<a hidden class="anchor" aria-hidden="true" href="#æ¸¸æˆçš„å°ä¼˜åŒ–">#</a></h2>
<h3 id="å¤šäººæ¨¡å¼ä¸‹æ¸¸æˆæ²¡æœ‰å¼€å§‹å‰ç©å®¶ä¸å¯ä»¥ç§»åŠ¨">å¤šäººæ¨¡å¼ä¸‹æ¸¸æˆæ²¡æœ‰å¼€å§‹å‰ï¼Œç©å®¶ä¸å¯ä»¥ç§»åŠ¨<a hidden class="anchor" aria-hidden="true" href="#å¤šäººæ¨¡å¼ä¸‹æ¸¸æˆæ²¡æœ‰å¼€å§‹å‰ç©å®¶ä¸å¯ä»¥ç§»åŠ¨">#</a></h3>
<p>ä¸ºæ­¤æˆ‘ä»¬å…ˆå¼•å…¥ä¸€ä¸ªçŠ¶æ€æœºï¼š<code>'waiting' -&gt; 'fighting' -&gt; 'over'</code> æ¥æ ‡è¯†å½“å‰æ¸¸æˆè¿›è¡Œçš„çŠ¶æ€</p>
<p>ç„¶åç”¨ä¸€ä¸ª <code>notice_board</code> è®¡åˆ†æ¿åœ¨å‰ç«¯æ˜¾ç¤ºå‡ºæ¥</p>
<p>å®ç°çš„é€»è¾‘å°±æ˜¯ï¼šæ¸¸æˆåˆå§‹æ—¶ä¸º <code>waiting</code> çŠ¶æ€ï¼Œæˆ¿é—´å†…äººæ•°æ»¡ 3 äººæ—¶ï¼Œæ‰ä¼šè¿›å…¥ <code>fighting</code>ï¼Œè§’è‰²æ­»äº¡æ—¶ä¸º <code>over</code></p>
<p>ä¸”å‘å°„ç«çƒï¼Œç§»åŠ¨ç­‰è¡Œä¸ºï¼Œå½“ä¸”ä»…å½“ç©å®¶çŠ¶æ€ä¸º <code>fighting</code> æ—¶ï¼Œæ‰å¯ä»¥åš</p>
<p>ç„¶åè®¾å®šç«çƒæŠ€èƒ½çš„ cd ä¸º 3 ç§’ï¼Œä¸”åœ¨æ¸¸æˆè¿›å…¥ <code>fighting</code> æ—¶ï¼Œå…ˆè‡ªåŠ¨è¿›å…¥ cd çŠ¶æ€</p>
<p>è¿™æ ·å°±å®ç°äº†åˆå§‹ 3 ç§’å†…ï¼Œä»»ä½•ç©å®¶ä¸å¯æ”»å‡»</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>js/src/playground/notice_board/zbase.js
</span></span><span style="display:flex;"><span>class NoticeBoard extends AcGameObject {
</span></span><span style="display:flex;"><span>    constructor(playground) {
</span></span><span style="display:flex;"><span>        super();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        this.playground = playground;
</span></span><span style="display:flex;"><span>        this.ctx = this.playground.game_map.ctx;
</span></span><span style="display:flex;"><span>        this.text = &#34;å·²å°±ç»ªï¼š0äºº&#34;;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    start() {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    write(text) {
</span></span><span style="display:flex;"><span>        this.text = text;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    update() {
</span></span><span style="display:flex;"><span>        this.render();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    render() {
</span></span><span style="display:flex;"><span>        this.ctx.font = &#34;20px serif&#34;;
</span></span><span style="display:flex;"><span>        this.ctx.fillStyle = &#34;white&#34;;
</span></span><span style="display:flex;"><span>        this.ctx.textAlign = &#34;center&#34;;
</span></span><span style="display:flex;"><span>        this.ctx.fillText(this.text, this.playground.width / 2, 20);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>js/src/playground/zbase.js
</span></span><span style="display:flex;"><span>class AcGamePlayground {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    show(mode) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        this.state = &#34;waiting&#34;;     // waiting -&gt; fighting -&gt; over
</span></span><span style="display:flex;"><span>        this.notice_board = new NoticeBoard(this);
</span></span><span style="display:flex;"><span>        this.player_count = 0;
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>js/src/playground/player/zbase.js
</span></span><span style="display:flex;"><span>class Player extends AcGameObject {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    add_listening_events() {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        this.playground.game_map.$canvas.mousedown(function(e) {
</span></span><span style="display:flex;"><span>            if (outer.playground.state !== &#34;fighting&#34;)
</span></span><span style="display:flex;"><span>                return false;
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        $(window).keydown(function(e) {
</span></span><span style="display:flex;"><span>            if (outer.playground.state !== &#34;fighting&#34;)
</span></span><span style="display:flex;"><span>                return false;
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    start() {
</span></span><span style="display:flex;"><span>        this.playground.player_count ++ ;
</span></span><span style="display:flex;"><span>        this.playground.notice_board.write(&#34;å·²å°±ç»ªï¼š&#34; + this.playground.player_count + &#34;äºº&#34;);
</span></span><span style="display:flex;"><span>        if (this.playground.player_count &gt;= 3) {
</span></span><span style="display:flex;"><span>            this.playground.state = &#34;fighting&#34;;
</span></span><span style="display:flex;"><span>            this.playground.notice_board.write(&#34;Fighting&#34;);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="æŠ€èƒ½cd">æŠ€èƒ½CD<a hidden class="anchor" aria-hidden="true" href="#æŠ€èƒ½cd">#</a></h3>
<p>ç»™ç«çƒæŠ€èƒ½è®¾ç½® 3s çš„ cdï¼Œå®ç°é€»è¾‘å¾ˆç®€å•ï¼Œè®¾å®šä¸€ä¸ª cool_time å˜é‡ï¼Œæ¯æ¬¡æ¸²æŸ“çš„æ—¶å€™å‡å»ä¸Šæ¬¡æ¸²æŸ“çš„æ—¶é—´é—´éš”</p>
<p>ç„¶å cool_time ä¸º 0 æ—¶ï¼ŒæŠ€èƒ½æ‰å¯ä»¥æˆåŠŸé‡Šæ”¾</p>
<p>å¦å¤–ä¿®æ”¹å†·å´æ—¶é—´ï¼Œåªç”¨ä¿®æ”¹è‡ªå·±çš„å³å¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>js/src/playground/player/zbase.js
</span></span><span style="display:flex;"><span>class Player extends AcGameObject {
</span></span><span style="display:flex;"><span>    constructor(...) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        if (this.character === &#34;me&#34;) {
</span></span><span style="display:flex;"><span>            this.fireball_coldtime = 3; // å•ä½ï¼šs
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    add_listening_events() {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        this.playground.game_map.$canvas.mousedown(function(e) {
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>            else if (e.which === 1) {
</span></span><span style="display:flex;"><span>                ...
</span></span><span style="display:flex;"><span>                if (outer.cur_skill === &#34;fireball&#34;) {
</span></span><span style="display:flex;"><span>                    ...
</span></span><span style="display:flex;"><span>                    if (outer.playground.mode === &#34;multi mode&#34;) {
</span></span><span style="display:flex;"><span>                        outer.playground.mps.send_shoot_fireball(tx, ty, fireball.uuid);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    outer.fireball_coldtime = 3;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>        $(window).keydown(function(e) {
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>            if (outer.fireball_coldtime &gt;= outer.eps)
</span></span><span style="display:flex;"><span>                return false;
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    update() {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        if (this.character === &#34;me&#34; &amp;&amp; this.playground.state === &#34;fighting&#34;) {
</span></span><span style="display:flex;"><span>            this.update_coldtime();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    update_coldtime() {
</span></span><span style="display:flex;"><span>        this.fireball_coldtime -= this.timedelta / 1000;
</span></span><span style="display:flex;"><span>        this.fireball_coldtime = Math.max(0, this.fireball_coldtime);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="ç”¨å›¾ç‰‡æ¥æ¸²æŸ“æŠ€èƒ½cd">ç”¨å›¾ç‰‡æ¥æ¸²æŸ“æŠ€èƒ½CD<a hidden class="anchor" aria-hidden="true" href="#ç”¨å›¾ç‰‡æ¥æ¸²æŸ“æŠ€èƒ½cd">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>js/src/playground/player/zbase.js
</span></span><span style="display:flex;"><span>class Player extends AcGameObject {
</span></span><span style="display:flex;"><span>    constructor(...) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        if (this.character === &#34;me&#34;) {
</span></span><span style="display:flex;"><span>            this.fireball_coldtime = 3; // å•ä½ï¼šs
</span></span><span style="display:flex;"><span>            this.fireball_img = new Image();
</span></span><span style="display:flex;"><span>            this.fireball_img.src = &#34;https://cdn.acwing.com/media/article/image/2021/12/02/1_9340c86053-fireball.png&#34;;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    render() {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        if (this.character === &#34;me&#34; &amp;&amp; this.playground.state === &#34;fighting&#34;) {
</span></span><span style="display:flex;"><span>            this.render_skill_coldtime();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>     render_skill_coldtime() {
</span></span><span style="display:flex;"><span>        let scale = this.playground.scale;
</span></span><span style="display:flex;"><span>        let x = 1.5, y = 0.9, r = 0.04;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        // æ¸²æŸ“æŠ€èƒ½å›¾æ ‡
</span></span><span style="display:flex;"><span>        this.ctx.save();
</span></span><span style="display:flex;"><span>        this.ctx.beginPath();
</span></span><span style="display:flex;"><span>        this.ctx.arc(x * scale, y * scale, r * scale, 0, Math.PI * 2, false);
</span></span><span style="display:flex;"><span>        this.ctx.stroke();
</span></span><span style="display:flex;"><span>        this.ctx.clip();
</span></span><span style="display:flex;"><span>        this.ctx.drawImage(this.fireball_img, (x - r) * scale, (y - r) * scale, r * 2 * scale, r * 2 * scale);
</span></span><span style="display:flex;"><span>        this.ctx.restore();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        // æ¸²æŸ“å†·å´æŒ‡ç¤º
</span></span><span style="display:flex;"><span>        if (this.fireball_coldtime &gt;= this.eps){
</span></span><span style="display:flex;"><span>            this.ctx.beginPath();
</span></span><span style="display:flex;"><span>            this.ctx.moveTo(x * scale, y * scale);
</span></span><span style="display:flex;"><span>            this.ctx.arc(x * scale, y * scale, r * scale, 0 - Math.PI / 2, Math.PI * 2 * (1 - this.fireball_coldtime / 3) - Math.PI / 2, true);
</span></span><span style="display:flex;"><span>            this.ctx.lineTo(x * scale, y * scale);
</span></span><span style="display:flex;"><span>            this.ctx.fillStyle = &#34;rgba(0, 0, 255, 0.6)&#34;;
</span></span><span style="display:flex;"><span>            this.ctx.fill();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span></code></pre></div><h3 id="æ·»åŠ ä¸€ä¸ªé—ªç°æŠ€èƒ½">æ·»åŠ ä¸€ä¸ªé—ªç°æŠ€èƒ½<a hidden class="anchor" aria-hidden="true" href="#æ·»åŠ ä¸€ä¸ªé—ªç°æŠ€èƒ½">#</a></h3>
<h4 id="å•æœºéƒ¨åˆ†">å•æœºéƒ¨åˆ†<a hidden class="anchor" aria-hidden="true" href="#å•æœºéƒ¨åˆ†">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>js/src/playground/player/zbase.js
</span></span><span style="display:flex;"><span>class Player extends AcGameObject {
</span></span><span style="display:flex;"><span>    constructor(...) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        if (this.character === &#34;me&#34;) {
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>            this.blink_coldtime = 5;
</span></span><span style="display:flex;"><span>            this.blink_img = new Image();
</span></span><span style="display:flex;"><span>            this.blink_img.src = &#34;https://cdn.acwing.com/media/article/image/2021/12/02/1_daccabdc53-blink.png&#34;;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    add_listening_events() {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        this.playground.game_map.$canvas.mousedown(function(e) {
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>            else if (e.which === 1) {
</span></span><span style="display:flex;"><span>                ...
</span></span><span style="display:flex;"><span>                else if (outer.cur_skill === &#34;blink&#34;) {
</span></span><span style="display:flex;"><span>                    outer.blink(tx, ty);
</span></span><span style="display:flex;"><span>                    // åŒæ­¥å‡½æ•°
</span></span><span style="display:flex;"><span>                    if (outer.playground.mode === &#34;multi mode&#34;) {
</span></span><span style="display:flex;"><span>                        outer.playground.mps.send_blink(tx, ty);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    outer.blink_coldtime = 5;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            outer.cur_skill = null; // æ¸…ç©ºå½“å‰æŠ€èƒ½
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>        $(window).keydown(function(e) {
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>            else if (e.which === 70) {    // fé”®
</span></span><span style="display:flex;"><span>                if (outer.blink_coldtime &gt;= outer.eps) return true;
</span></span><span style="display:flex;"><span>                outer.cur_skill = &#34;blink&#34;;
</span></span><span style="display:flex;"><span>                return false;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    blink(tx, ty) {
</span></span><span style="display:flex;"><span>        let d = this.get_dist(this.x, this.y, tx, ty);
</span></span><span style="display:flex;"><span>        d = Math.min(d, 0.5);
</span></span><span style="display:flex;"><span>        let angle = Math.atan2(ty - this.y, tx - this.x);
</span></span><span style="display:flex;"><span>        this.x += d * Math.cos(angle);
</span></span><span style="display:flex;"><span>        this.y += d * Math.sin(angle);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        this.move_length = 0;   // é—ªç°å®Œåœä¸‹æ¥
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    render_skill_coldtime() {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        x = 1.62, y = 0.9, r = 0.04;
</span></span><span style="display:flex;"><span>        // é—ªç°æŠ€èƒ½
</span></span><span style="display:flex;"><span>        // æ¸²æŸ“æŠ€èƒ½å›¾æ ‡
</span></span><span style="display:flex;"><span>        this.ctx.save();
</span></span><span style="display:flex;"><span>        this.ctx.beginPath();
</span></span><span style="display:flex;"><span>        this.ctx.arc(x * scale, y * scale, r * scale, 0, Math.PI * 2, false);
</span></span><span style="display:flex;"><span>        this.ctx.stroke();
</span></span><span style="display:flex;"><span>        this.ctx.clip();
</span></span><span style="display:flex;"><span>        this.ctx.drawImage(this.blink_img, (x - r) * scale, (y - r) * scale, r * 2 * scale, r * 2 * scale);
</span></span><span style="display:flex;"><span>        this.ctx.restore();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        // æ¸²æŸ“å†·å´æŒ‡ç¤º
</span></span><span style="display:flex;"><span>        if (this.blink_coldtime &gt;= this.eps){
</span></span><span style="display:flex;"><span>            this.ctx.beginPath();
</span></span><span style="display:flex;"><span>            this.ctx.moveTo(x * scale, y * scale);
</span></span><span style="display:flex;"><span>            this.ctx.arc(x * scale, y * scale, r * scale, 0 - Math.PI / 2, Math.PI * 2 * (1 - this.blink_coldtime / 5) - Math.PI / 2, true);
</span></span><span style="display:flex;"><span>            this.ctx.lineTo(x * scale, y * scale);
</span></span><span style="display:flex;"><span>            this.ctx.fillStyle = &#34;rgba(0, 0, 255, 0.6)&#34;;
</span></span><span style="display:flex;"><span>            this.ctx.fill();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="è”æœºéƒ¨åˆ†">è”æœºéƒ¨åˆ†<a hidden class="anchor" aria-hidden="true" href="#è”æœºéƒ¨åˆ†">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>game/static/js/src/playground/socket/multiplayer/zbase.js
</span></span><span style="display:flex;"><span>class MultiPlayerSocket {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    send_blink(tx, ty) {
</span></span><span style="display:flex;"><span>        let outer = this;
</span></span><span style="display:flex;"><span>        this.ws.send(JSON.stringify({
</span></span><span style="display:flex;"><span>            &#39;event&#39;: &#34;blink&#34;,
</span></span><span style="display:flex;"><span>            &#39;uuid&#39;: outer.uuid,
</span></span><span style="display:flex;"><span>            &#39;tx&#39;: tx,
</span></span><span style="display:flex;"><span>            &#39;ty&#39;: ty,
</span></span><span style="display:flex;"><span>        }));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    receive_blink(uuid, tx, ty) {
</span></span><span style="display:flex;"><span>        let player = this.get_player(uuid);
</span></span><span style="display:flex;"><span>        if (player) {
</span></span><span style="display:flex;"><span>            player.blink(tx, ty);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>consumers/multiplayer/index.py
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>class MultiPlayer(AsyncWebsocketConsumer):
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    async def blink(self, data):
</span></span><span style="display:flex;"><span>        await self.channel_layer.group_send(
</span></span><span style="display:flex;"><span>            self.room_name,
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                &#39;type&#39;: &#34;group_send_event&#34;,
</span></span><span style="display:flex;"><span>                &#39;event&#39;: &#34;blink&#34;,
</span></span><span style="display:flex;"><span>                &#39;uuid&#39;: data[&#39;uuid&#39;],
</span></span><span style="display:flex;"><span>                &#39;tx&#39;: data[&#39;tx&#39;],
</span></span><span style="display:flex;"><span>                &#39;ty&#39;: data[&#39;ty&#39;],
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        )
</span></span></code></pre></div><h1 id="å®ç°èŠå¤©ç³»ç»Ÿà®">å®ç°èŠå¤©ç³»ç»Ÿà®<a hidden class="anchor" aria-hidden="true" href="#å®ç°èŠå¤©ç³»ç»Ÿà®">#</a></h1>
<ul>
<li><a href="https://www.acwing.com/solution/content/89508/">8.1 ä¸Šè¯¾ç¬”è®° | å¤§èœç‹—</a></li>
</ul>
<hr>
<h2 id="ä¼˜åŒ–é”®ç›˜ç»‘å®šäº‹ä»¶">ä¼˜åŒ–é”®ç›˜ç»‘å®šäº‹ä»¶<a hidden class="anchor" aria-hidden="true" href="#ä¼˜åŒ–é”®ç›˜ç»‘å®šäº‹ä»¶">#</a></h2>
<p>è¿™éƒ¨åˆ†ç®—æ˜¯ä¹‹å‰çš„é—ç•™é—®é¢˜ï¼Œå…ˆå‰çš„ <code>keydown</code> ç›‘å¬äº‹ä»¶ç»‘å®šåœ¨äº† <code>window</code> ä¸Šä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜</p>
<p>å¦‚æœåœ¨ä¸€ä¸ªæµè§ˆå™¨å†…æ‰“å¼€å¤šä¸ª <code>ACAPP</code>ï¼Œæ­¤æ—¶æŒ‰ä¸‹é”®ä½è§¦å‘ <code>keydown</code> äº‹ä»¶ï¼Œä¼šè¢«æµè§ˆå™¨å†…æ‰€æœ‰çš„ <code>ACAPP</code> éƒ½æ•è·åˆ°</p>
<p>ä¹‹å‰å½±å“ä¸å¤§ï¼Œä½†å¯¹æ­¤æ¬¡è¦å®ç°çš„èŠå¤©ç³»ç»Ÿå°±æœ‰ç€è‡´å‘½çš„å½±å“ï¼Œå³æ‰“å¼€ä¸€ä¸ª <code>ACAPP</code> çš„èŠå¤©æ ï¼Œå…¶ä»–éƒ½ä¼šè¢«æ‰“å¼€</p>
<p>æ‰€æœ‰æˆ‘ä»¬è¦å°† <code>keydown</code> ç›‘å¬äº‹ä»¶ç»‘å®šåˆ° <code>canvas</code> ä¸Š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>playground/player/zbase.js
</span></span><span style="display:flex;"><span>class Player extends AcGameObject {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    add_listening_events() {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        this.playground.game_map.$canvas.keydown(function(e) {
</span></span><span style="display:flex;"><span>            if (outer.playground.state !== &#34;fighting&#34;)
</span></span><span style="display:flex;"><span>                return true;
</span></span><span style="display:flex;"><span>            if (e.which === 81) {           // é”®ç›˜æŒ‰ä¸‹qäº‹ä»¶
</span></span><span style="display:flex;"><span>                if (outer.fireball_coldtime &gt;= outer.eps) return true;
</span></span><span style="display:flex;"><span>                outer.cur_skill = &#34;fireball&#34;;
</span></span><span style="display:flex;"><span>                return false;
</span></span><span style="display:flex;"><span>            } else if (e.which === 70) {    // fé”®
</span></span><span style="display:flex;"><span>                if (outer.blink_coldtime &gt;= outer.eps) return true;
</span></span><span style="display:flex;"><span>                outer.cur_skill = &#34;blink&#34;;
</span></span><span style="display:flex;"><span>                return false;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>playground/game-map/zbase.js
</span></span><span style="display:flex;"><span>class GameMap extends AcGameObject {
</span></span><span style="display:flex;"><span>    constructor(playground) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        this.$canvas = $(`&lt;canvas tabindex=0&gt;&lt;/canvas&gt;`);
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    start() {
</span></span><span style="display:flex;"><span>        this.$canvas.focus();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="æœ¬åœ°å‰ç«¯">æœ¬åœ°å‰ç«¯<a hidden class="anchor" aria-hidden="true" href="#æœ¬åœ°å‰ç«¯">#</a></h2>
<p>è¦å®ç°ä¸¤ä¸ªéƒ¨åˆ†ï¼š 1. æ–‡æœ¬è¾“å…¥æ¡†ï¼ˆè®©ç”¨æˆ·è¾“å…¥è¦å‘é€çš„ä¿¡æ¯ï¼‰ 2. å†å²è®°å½•æ˜¾ç¤ºæ¡†ï¼ˆä¹‹å‰ç”¨æˆ·å‘é€çš„ä¿¡æ¯çš„æ˜¾ç¤ºæ¡†ï¼‰</p>
<p>æ¬²å®ç°é€»è¾‘ï¼šç”¨æˆ·æŒ‰ä¸‹ <code>&lt;Enter&gt;</code> åï¼Œæ¸¸æˆç•Œé¢å¼¹å‡ºæ–‡æœ¬è¾“å…¥æ¡†ï¼Œç„¶åèšç„¦äºæ–‡æœ¬è¾“å…¥æ¡†ï¼Œä¸”åŒæ—¶å¼¹å‡ºå†å²è®°å½•æ˜¾ç¤ºæ¡† 3 ç§’</p>
<p>ç„¶åç”¨æˆ·è¾“å…¥ä¿¡æ¯åï¼ŒæŒ‰ä¸‹ <code>&lt;Enter&gt;</code> åå‘å‡ºä¿¡æ¯ï¼Œæ¥ç€ä¿¡æ¯ä¼šæ˜¾ç¤ºåœ¨å†å²è®°å½•æ˜¾ç¤ºæ¡†æœ€ä¸‹æ–¹ï¼Œå¹¶å¼¹å‡ºå†å²è®°å½•æ˜¾ç¤ºæ¡† 3 ç§’</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>playground/chat_field/zbase.js
</span></span></code></pre></div><p><code>chat field</code> è´Ÿè´£ç®¡ç† æ–‡æœ¬è¾“å…¥æ¡† å’Œ å†å²è®°å½•æ˜¾ç¤ºæ¡†</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>class ChatField {
</span></span><span style="display:flex;"><span>    constructor(playground) {
</span></span><span style="display:flex;"><span>        this.playground = playground;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        this.$history = $(`&lt;div class=&#34;ac-game-chat-field-history&#34;&gt;&lt;/div&gt;`);
</span></span><span style="display:flex;"><span>        this.$input = $(`&lt;input type=&#34;text&#34; class=&#34;ac-game-chat-field-input&#34;&gt;`);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        this.$history.hide();
</span></span><span style="display:flex;"><span>        this.$input.hide();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        this.func_id = null;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        this.playground.$playground.append(this.$history);
</span></span><span style="display:flex;"><span>        this.playground.$playground.append(this.$input);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        this.start();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    start() {
</span></span><span style="display:flex;"><span>        this.add_listening_events();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    add_listening_events() {
</span></span><span style="display:flex;"><span>        let outer = this;
</span></span><span style="display:flex;"><span>        this.$input.keydown(function(e) {
</span></span><span style="display:flex;"><span>            if (e.which === 27) {   //ESC
</span></span><span style="display:flex;"><span>                outer.hide_input();
</span></span><span style="display:flex;"><span>                return false;
</span></span><span style="display:flex;"><span>            } else if (e.which === 13) {
</span></span><span style="display:flex;"><span>                let username = outer.playground.root.settings.username;
</span></span><span style="display:flex;"><span>                let text = outer.$input.val();
</span></span><span style="display:flex;"><span>                if (text) {
</span></span><span style="display:flex;"><span>                    outer.$input.val(&#34;&#34;);
</span></span><span style="display:flex;"><span>                    outer.add_message(username, text);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                return false;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    show_history() {
</span></span><span style="display:flex;"><span>        let outer = this;
</span></span><span style="display:flex;"><span>        this.$history.fadeIn();
</span></span><span style="display:flex;"><span>        if (this.func_id) clearTimeout(this.func_id);
</span></span><span style="display:flex;"><span>        this.func_id = setTimeout(function() {
</span></span><span style="display:flex;"><span>            outer.$history.fadeOut();
</span></span><span style="display:flex;"><span>            outer.func_id = null;
</span></span><span style="display:flex;"><span>        }, 3000);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    render_message(message) {
</span></span><span style="display:flex;"><span>        return $(`&lt;div&gt;${message}&lt;/div&gt;`);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    add_message(username, text) {
</span></span><span style="display:flex;"><span>        this.show_history();
</span></span><span style="display:flex;"><span>        let message = `[${username}] ${text}`;
</span></span><span style="display:flex;"><span>        this.$history.append(this.render_message(message));
</span></span><span style="display:flex;"><span>        this.$history.scrollTop(this.$history[0].scrollHeight);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    show_input() {
</span></span><span style="display:flex;"><span>        this.show_history();
</span></span><span style="display:flex;"><span>        this.$input.show();
</span></span><span style="display:flex;"><span>        this.$input.focus();    // è¾“å…¥æ—¶ï¼Œèšç„¦äºè¾“å…¥æ¡†
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    hide_input() {
</span></span><span style="display:flex;"><span>        this.$input.hide();
</span></span><span style="display:flex;"><span>        this.playground.game_map.$canvas.focus();   // é€€å‡ºæ—¶ï¼Œèšç„¦å›æ¸¸æˆç•Œé¢
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>playground/zbase.js
</span></span></code></pre></div><p>æŠŠå®ƒåˆ›å»ºå‡ºæ¥</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>class AcGamePlayground {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    show(mode) {    //æ‰“å¼€ playground ç•Œé¢
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        else if (mode === &#34;multi mode&#34;) {
</span></span><span style="display:flex;"><span>            this.chat_field = new ChatField(this);
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>playground/player/zbase.js
</span></span></code></pre></div><p>æ·»åŠ ç›‘å¬äº‹ä»¶</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>class Player extends AcGameObject {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    add_listening_events() {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        this.playground.game_map.$canvas.keydown(function(e) {
</span></span><span style="display:flex;"><span>            if (e.which === 13) {   // enter (æ˜¾ç¤ºå¯¹è¯æ¡†)
</span></span><span style="display:flex;"><span>                if (outer.playground.mode === &#34;multi mode&#34;) {
</span></span><span style="display:flex;"><span>                    outer.playground.chat_field.show_input();
</span></span><span style="display:flex;"><span>                    return false;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            } else if (e.which === 27) {    // escï¼ˆå…³é—­å¯¹è¯æ¡†ï¼‰
</span></span><span style="display:flex;"><span>                if (outer.playground.mode === &#34;multi mode&#34;) {
</span></span><span style="display:flex;"><span>                    outer.playground.char_field.hide_input();
</span></span><span style="display:flex;"><span>                    return false;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>game.css
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>.ac-game-chat-field-history {
</span></span><span style="display:flex;"><span>    position: absolute;
</span></span><span style="display:flex;"><span>    top: 66%;
</span></span><span style="display:flex;"><span>    left: 20%;
</span></span><span style="display:flex;"><span>    transform: translate(-50%, -50%);
</span></span><span style="display:flex;"><span>    width: 20%;
</span></span><span style="display:flex;"><span>    height: 32%;
</span></span><span style="display:flex;"><span>    color: white;
</span></span><span style="display:flex;"><span>    font-size: 2vh;
</span></span><span style="display:flex;"><span>    padding: 5px;
</span></span><span style="display:flex;"><span>    overflow: auto;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>.ac-game-chat-field-history::-webkit-scrollbar {
</span></span><span style="display:flex;"><span>    width: 0;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>.ac-game-chat-field-input {
</span></span><span style="display:flex;"><span>    position: absolute;
</span></span><span style="display:flex;"><span>    top: 86%;
</span></span><span style="display:flex;"><span>    left: 20%;
</span></span><span style="display:flex;"><span>    transform: translate(-50%, -50%);
</span></span><span style="display:flex;"><span>    width: 20%;
</span></span><span style="display:flex;"><span>    height: 3vh;
</span></span><span style="display:flex;"><span>    color: white;
</span></span><span style="display:flex;"><span>    font-size: 2vh;
</span></span><span style="display:flex;"><span>    background-color: rgba(222,225,230, 0.2);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="è”æœºèŠå¤©çª—">è”æœºèŠå¤©çª—<a hidden class="anchor" aria-hidden="true" href="#è”æœºèŠå¤©çª—">#</a></h2>
<h3 id="å‰ç«¯-4">å‰ç«¯<a hidden class="anchor" aria-hidden="true" href="#å‰ç«¯-4">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>playground/chat_field/zbase.js
</span></span><span style="display:flex;"><span>class ChatField {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    add_listening_events() {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        this.$input.keydown(function(e) {
</span></span><span style="display:flex;"><span>            ...
</span></span><span style="display:flex;"><span>            else if (e.which === 13) {
</span></span><span style="display:flex;"><span>                ...
</span></span><span style="display:flex;"><span>                if (text) {
</span></span><span style="display:flex;"><span>                    ...
</span></span><span style="display:flex;"><span>                    outer.playground.mps.send_message(text);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                ...
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>js/src/playground/socket/multiplayer/zbase.js
</span></span><span style="display:flex;"><span>class MultiPlayerSocket {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    send_message(text) {
</span></span><span style="display:flex;"><span>        let outer = this;
</span></span><span style="display:flex;"><span>        this.ws.send(JSON.stringify({
</span></span><span style="display:flex;"><span>            &#39;event&#39;: &#34;message&#34;,
</span></span><span style="display:flex;"><span>            &#39;uuid&#39;: outer.uuid,
</span></span><span style="display:flex;"><span>            &#39;username&#39;: outer.playground.root.settings.username,
</span></span><span style="display:flex;"><span>            &#39;text&#39;: text,
</span></span><span style="display:flex;"><span>        }));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    receive_message(username, text) {
</span></span><span style="display:flex;"><span>        this.playground.chat_field.add_message(username, text);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="åç«¯-4">åç«¯<a hidden class="anchor" aria-hidden="true" href="#åç«¯-4">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>consumers/multiplayer/index.py
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>class MultiPlayer(AsyncWebsocketConsumer):
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    async def message(self, data):
</span></span><span style="display:flex;"><span>        await self.channel_layer.group_send(
</span></span><span style="display:flex;"><span>            self.room_name,
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                &#39;type&#39;: &#34;group_send_event&#34;,
</span></span><span style="display:flex;"><span>                &#39;event&#39;: &#34;message&#34;,
</span></span><span style="display:flex;"><span>                &#39;uuid&#39;: data[&#39;uuid&#39;],
</span></span><span style="display:flex;"><span>                &#39;username&#39;: data[&#39;username&#39;],
</span></span><span style="display:flex;"><span>                &#39;text&#39;: data[&#39;text&#39;],
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        )
</span></span></code></pre></div><h1 id="å®ç°åŒ¹é…ç³»ç»Ÿà®">å®ç°åŒ¹é…ç³»ç»Ÿà®<a hidden class="anchor" aria-hidden="true" href="#å®ç°åŒ¹é…ç³»ç»Ÿà®">#</a></h1>
<ul>
<li><a href="https://www.acwing.com/file_system/file/content/whole/index/content/3435229/">9. å®ç°åŒ¹é…ç³»ç»Ÿ | è®²ä¹‰</a></li>
<li><a href="https://www.acwing.com/activity/content/code/content/2360556/">9.1 ä¸Šè¯¾ç¬”è®° | ä¸€åªé‡ç”Ÿå½©è‰²é“…ç¬”</a></li>
</ul>
<hr>
<p>æœ¬ç« èŠ‚å†…å®¹æ˜¯åˆ©ç”¨ <code>thrift</code> åˆ›å»ºå®¢æˆ·ç«¯-æœåŠ¡ç«¯äº¤äº’çš„æ¥å£</p>
<p>ç„¶ååˆ©ç”¨è¯¥æ¥å£å®Œæˆä¸€ä¸ªåŒ¹é…ç³»ç»Ÿ</p>
<p>åŒ¹é…ç³»ç»Ÿç”±ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ— + ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ + åŒ¹é…æ±  å®Œæˆ</p>
<p>åŸºæœ¬ä¸ LinuxåŸºç¡€è¯¾ é‡Œçš„éƒ¨åˆ†å®Œå…¨ä¸€è‡´</p>
<p>å½“æ—¶æˆ‘ä»¬æ˜¯æ‹¿ cpp æ¥å†™çš„ï¼Œå†™äº†å·®ä¸å¤š 200 è¡Œ</p>
<p>æœ¬èŠ‚ä¼šæ‹¿ py æ¥å®ç°ï¼Œå·®ä¸å¤š 140 è¡Œå³å¯</p>
<p><code>thrift</code> æ¥å£æ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>namespace py match_service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>service Match {
</span></span><span style="display:flex;"><span>    i32 add_player(1: i32 score, 2: string uuid, 3: string username, 4: string photo, 5: string channel_name),
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç„¶åç”¨è¯¥æºæ–‡ä»¶ç”Ÿæˆæ¥å£æ–‡ä»¶</p>
<h2 id="æœåŠ¡ç«¯">æœåŠ¡ç«¯<a hidden class="anchor" aria-hidden="true" href="#æœåŠ¡ç«¯">#</a></h2>
<p>é…ç½® <code>asgi.py</code> è®©æœåŠ¡ç«¯è¿›ç¨‹å¯ä»¥è°ƒç”¨å®¢æˆ·ç«¯è¿›ç¨‹é‡Œçš„å‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>acapp/acapp/asgi.py
</span></span><span style="display:flex;"><span>import os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>import django
</span></span><span style="display:flex;"><span>os.environ.setdefault(&#39;DJANGO_SETTINGS_MODULE&#39;, &#39;acapp.settings&#39;)
</span></span><span style="display:flex;"><span>django.setup()
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>from channels.layers import get_channel_layer
</span></span><span style="display:flex;"><span>channel_layer = get_channel_layer()
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>acapp/match_system/src/main.py
</span></span><span style="display:flex;"><span>#! /usr/bin/env python3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>import glob
</span></span><span style="display:flex;"><span>import sys
</span></span><span style="display:flex;"><span>sys.path.insert(0, glob.glob(&#39;../../&#39;)[0])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>from match_server.match_service import Match
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>from thrift.transport import TSocket
</span></span><span style="display:flex;"><span>from thrift.transport import TTransport
</span></span><span style="display:flex;"><span>from thrift.protocol import TBinaryProtocol
</span></span><span style="display:flex;"><span>from thrift.server import TServer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>from queue import Queue
</span></span><span style="display:flex;"><span>from time import sleep
</span></span><span style="display:flex;"><span>from threading import Thread
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>from acapp.asgi import channel_layer
</span></span><span style="display:flex;"><span>from asgiref.sync import async_to_sync
</span></span><span style="display:flex;"><span>from django.core.cache import cache
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>queue = Queue()  # æ¶ˆæ¯é˜Ÿåˆ—
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>class Player:
</span></span><span style="display:flex;"><span>    def __init__(self, score, uuid, username, photo, channel_name):
</span></span><span style="display:flex;"><span>        self.score = score
</span></span><span style="display:flex;"><span>        self.uuid = uuid
</span></span><span style="display:flex;"><span>        self.username = username
</span></span><span style="display:flex;"><span>        self.photo = photo
</span></span><span style="display:flex;"><span>        self.channel_name = channel_name
</span></span><span style="display:flex;"><span>        self.waiting_time = 0  # ç­‰å¾…æ—¶é—´
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>class Pool:
</span></span><span style="display:flex;"><span>    def __init__(self):
</span></span><span style="display:flex;"><span>        self.players = []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    def add_player(self, player):
</span></span><span style="display:flex;"><span>        self.players.append(player)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    def check_match(self, a, b):
</span></span><span style="display:flex;"><span>        dt = abs(a.score - b.score)
</span></span><span style="display:flex;"><span>        a_max_dif = a.waiting_time * 50
</span></span><span style="display:flex;"><span>        b_max_dif = b.waiting_time * 50
</span></span><span style="display:flex;"><span>        return dt &lt;= a_max_dif and dt &lt;= b_max_dif
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    def match_success(self, ps):
</span></span><span style="display:flex;"><span>        print(&#34;Match Success: %s %s %s&#34; % (ps[0].username, ps[1].username, ps[2].username))
</span></span><span style="display:flex;"><span>        room_name = &#34;room-%s-%s-%s&#34; % (ps[0].uuid, ps[1].uuid, ps[2].uuid)
</span></span><span style="display:flex;"><span>        players = []
</span></span><span style="display:flex;"><span>        for p in ps:
</span></span><span style="display:flex;"><span>            async_to_sync(channel_layer.group_add)(room_name, p.channel_name)
</span></span><span style="display:flex;"><span>            players.append({
</span></span><span style="display:flex;"><span>                &#39;uuid&#39;: p.uuid,
</span></span><span style="display:flex;"><span>                &#39;username&#39;: p.username,
</span></span><span style="display:flex;"><span>                &#39;photo&#39;: p.photo,
</span></span><span style="display:flex;"><span>                &#39;hp&#39;: 100,
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>        cache.set(room_name, players, 3600)  # æœ‰æ•ˆæ—¶é—´ï¼š1å°æ—¶
</span></span><span style="display:flex;"><span>        for p in ps:
</span></span><span style="display:flex;"><span>            async_to_sync(channel_layer.group_send)(
</span></span><span style="display:flex;"><span>                room_name,
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    &#39;type&#39;: &#34;group_send_event&#34;,
</span></span><span style="display:flex;"><span>                    &#39;event&#39;: &#34;create_player&#34;,
</span></span><span style="display:flex;"><span>                    &#39;uuid&#39;: p.uuid,
</span></span><span style="display:flex;"><span>                    &#39;username&#39;: p.username,
</span></span><span style="display:flex;"><span>                    &#39;photo&#39;: p.photo,
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    def increase_waiting_time(self):
</span></span><span style="display:flex;"><span>        for player in self.players:
</span></span><span style="display:flex;"><span>            player.waiting_time += 1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    def match(self):
</span></span><span style="display:flex;"><span>        while len(self.players) &gt;= 3:
</span></span><span style="display:flex;"><span>            self.players = sorted(self.players, key=lambda p: p.score)
</span></span><span style="display:flex;"><span>            flag = False
</span></span><span style="display:flex;"><span>            for i in range(len(self.players) - 2):
</span></span><span style="display:flex;"><span>                a, b, c = self.players[i], self.players[i + 1], self.players[i + 2]
</span></span><span style="display:flex;"><span>                if self.check_match(a, b) and self.check_match(a, c) and self.check_match(b, c):
</span></span><span style="display:flex;"><span>                    self.match_success([a, b, c])
</span></span><span style="display:flex;"><span>                    self.players = self.players[:i] + self.players[i + 3:]
</span></span><span style="display:flex;"><span>                    flag = True
</span></span><span style="display:flex;"><span>                    break
</span></span><span style="display:flex;"><span>            if not flag:
</span></span><span style="display:flex;"><span>                break
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self.increase_waiting_time()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>class MatchHandler:
</span></span><span style="display:flex;"><span>    def add_player(self, score, uuid, username, photo, channel_name):
</span></span><span style="display:flex;"><span>        print(&#34;Add Player: %s %d&#34; % (username, score))
</span></span><span style="display:flex;"><span>        player = Player(score, uuid, username, photo, channel_name)
</span></span><span style="display:flex;"><span>        queue.put(player)
</span></span><span style="display:flex;"><span>        return 0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def get_player_from_queue():
</span></span><span style="display:flex;"><span>    try:
</span></span><span style="display:flex;"><span>        return queue.get_nowait()
</span></span><span style="display:flex;"><span>    except:
</span></span><span style="display:flex;"><span>        return None
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>def worker():
</span></span><span style="display:flex;"><span>    pool = Pool()
</span></span><span style="display:flex;"><span>    while True:
</span></span><span style="display:flex;"><span>        player = get_player_from_queue()
</span></span><span style="display:flex;"><span>        if player:
</span></span><span style="display:flex;"><span>            pool.add_player(player)
</span></span><span style="display:flex;"><span>        else:
</span></span><span style="display:flex;"><span>            pool.match()
</span></span><span style="display:flex;"><span>            sleep(1)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>if __name__ == &#39;__main__&#39;:
</span></span><span style="display:flex;"><span>    handler = MatchHandler()
</span></span><span style="display:flex;"><span>    processor = Match.Processor(handler)
</span></span><span style="display:flex;"><span>    transport = TSocket.TServerSocket(host=&#39;127.0.0.1&#39;, port=9090)
</span></span><span style="display:flex;"><span>    tfactory = TTransport.TBufferedTransportFactory()
</span></span><span style="display:flex;"><span>    pfactory = TBinaryProtocol.TBinaryProtocolFactory()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    server = TServer.TThreadedServer(
</span></span><span style="display:flex;"><span>        processor, transport, tfactory, pfactory)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Thread(target=worker, daemon=True).start()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(&#39;Starting the server...&#39;)
</span></span><span style="display:flex;"><span>    server.serve()
</span></span><span style="display:flex;"><span>    print(&#39;done.&#39;)
</span></span></code></pre></div><h2 id="å®¢æˆ·ç«¯">å®¢æˆ·ç«¯<a hidden class="anchor" aria-hidden="true" href="#å®¢æˆ·ç«¯">#</a></h2>
<p>æ‰©å±•æ•°æ®åº“è¡¨ï¼Œè®©å…¶å¯ä»¥å­˜æ”¾ rankåˆ† çš„ä¿¡æ¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>game/models/player/player.py
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>class Player(models.Model):
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    score = models.IntegerField(default=1500)
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>consumers/multiplayer/index.py
</span></span><span style="display:flex;"><span>from channels.generic.websocket import AsyncWebsocketConsumer
</span></span><span style="display:flex;"><span>import json
</span></span><span style="display:flex;"><span>from django.conf import settings
</span></span><span style="display:flex;"><span>from django.core.cache import cache
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>from thrift import Thrift
</span></span><span style="display:flex;"><span>from thrift.transport import TSocket
</span></span><span style="display:flex;"><span>from thrift.transport import TTransport
</span></span><span style="display:flex;"><span>from thrift.protocol import TBinaryProtocol
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>from match_system.src.match_server.match_service import Match
</span></span><span style="display:flex;"><span>from game.models.player.player import Player
</span></span><span style="display:flex;"><span>from channels.db import database_sync_to_async
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>class MultiPlayer(AsyncWebsocketConsumer):
</span></span><span style="display:flex;"><span>    async def connect(self):
</span></span><span style="display:flex;"><span>        await self.accept()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    async def disconnect(self, close_code):
</span></span><span style="display:flex;"><span>        if self.room_name:
</span></span><span style="display:flex;"><span>            await self.channel_layer.group_discard(self.room_name, self.channel_name)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    async def create_player(self, data):
</span></span><span style="display:flex;"><span>        self.room_name = None
</span></span><span style="display:flex;"><span>        self.uuid = data[&#39;uuid&#39;]
</span></span><span style="display:flex;"><span>        # Make socket
</span></span><span style="display:flex;"><span>        transport = TSocket.TSocket(&#39;127.0.0.1&#39;, 9090)
</span></span><span style="display:flex;"><span>        # Buffering is critical. Raw sockets are very slow
</span></span><span style="display:flex;"><span>        transport = TTransport.TBufferedTransport(transport)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        # Wrap in a protocol
</span></span><span style="display:flex;"><span>        protocol = TBinaryProtocol.TBinaryProtocol(transport)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        # Create a client to use the protocol encoder
</span></span><span style="display:flex;"><span>        client = Match.Client(protocol)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        def db_get_player():
</span></span><span style="display:flex;"><span>            return Player.objects.get(user__username=data[&#39;username&#39;])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        player = await database_sync_to_async(db_get_player)()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        # Connect!
</span></span><span style="display:flex;"><span>        transport.open()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        client.add_player(player.score, data[&#39;uuid&#39;], data[&#39;username&#39;], data[&#39;photo&#39;], self.channel_name)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        # Close!
</span></span><span style="display:flex;"><span>        transport.close()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    async def group_send_event(self, data):
</span></span><span style="display:flex;"><span>        if not self.room_name:
</span></span><span style="display:flex;"><span>            keys = cache.keys(&#39;*%s*&#39; % (self.uuid))
</span></span><span style="display:flex;"><span>            if keys:
</span></span><span style="display:flex;"><span>                self.room_name = keys[0]
</span></span><span style="display:flex;"><span>        await self.send(text_data=json.dumps(data))
</span></span><span style="display:flex;"><span>    ...
</span></span></code></pre></div><h1 id="é¡¹ç›®æ”¶å°¾à®">é¡¹ç›®æ”¶å°¾à®<a hidden class="anchor" aria-hidden="true" href="#é¡¹ç›®æ”¶å°¾à®">#</a></h1>
<h2 id="åŠ å¯†å‹ç¼©jsä»£ç ">åŠ å¯†ã€å‹ç¼©jsä»£ç <a hidden class="anchor" aria-hidden="true" href="#åŠ å¯†å‹ç¼©jsä»£ç ">#</a></h2>
<p>å®‰è£… <code>terser</code> :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>sudo apt-get update
</span></span><span style="display:flex;"><span>sudo apt-get install npm
</span></span><span style="display:flex;"><span>sudo npm install terser -g
</span></span></code></pre></div><p><code>terser</code> ä¸ä»…æ”¯æŒæ–‡ä»¶è¾“å…¥ï¼Œä¹Ÿæ”¯æŒæ ‡å‡†è¾“å…¥ã€‚ç»“æœä¼šè¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºä¸­ã€‚</p>
<p>ä½¿ç”¨æ–¹å¼ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>terser xxx.js -c -m
</span></span></code></pre></div><p>æˆ‘ä»¬å°†æ•´åˆ <code>js</code> æ–‡ä»¶çš„è„šæœ¬ä¿®æ”¹ä¸€ä¸‹å³å¯ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>scripts/compress_game_js.sh
</span></span><span style="display:flex;"><span><span style="color:#75715e">#! /bin/bash</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>JS_PATH<span style="color:#f92672">=</span>/home/acs/acapp/game/static/js/
</span></span><span style="display:flex;"><span>JS_PATH_DIST<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>JS_PATH<span style="color:#e6db74">}</span>dist/
</span></span><span style="display:flex;"><span>JS_PATH_SRC<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>JS_PATH<span style="color:#e6db74">}</span>src/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>find $JS_PATH_SRC -type f -name <span style="color:#e6db74">&#39;*.js&#39;</span> | sort | xargs cat | terser -c -m &gt; <span style="color:#e6db74">${</span>JS_PATH_DIST<span style="color:#e6db74">}</span>game.js
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;yes&#34;</span> | python3 manage.py collectstatic
</span></span></code></pre></div><h2 id="æ¸…ç†ç›‘å¬å‡½æ•°">æ¸…ç†ç›‘å¬å‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#æ¸…ç†ç›‘å¬å‡½æ•°">#</a></h2>
<p>åœ¨AcAPPå…³é—­ä¹‹å‰è§¦å‘çš„äº‹ä»¶å¯ä»¥é€šè¿‡å¦‚ä¸‹apiæ·»åŠ ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>AcWingOS.api.window.on_close(func);
</span></span></code></pre></div><p>æ³¨æ„ï¼š</p>
<ul>
<li>åŒä¸€ä¸ªé¡µé¢ä¸­ï¼Œå¤šä¸ª <code>acapp</code> å¼•å…¥çš„ <code>js</code> ä»£ç åªä¼šåŠ è½½ä¸€æ¬¡ï¼Œå› æ­¤ <code>AC_GAME_OBJECTS</code> ç­‰å…¨å±€å˜é‡æ˜¯åŒä¸€ä¸ªé¡µé¢ã€åŒä¸€ä¸ª <code>acapp</code> çš„æ‰€æœ‰çª—å£å…±ç”¨çš„</li>
<li>å„è‡ªåˆ›å»ºçš„å±€éƒ¨å˜é‡æ˜¯ç‹¬ç«‹çš„ï¼Œæ¯”å¦‚ <code>new AcGame()</code> åˆ›å»ºå‡ºçš„å¯¹è±¡å„ä¸ªçª—å£æ˜¯ç‹¬ç«‹çš„</li>
</ul>
<p>æˆ‘ä»¬ç»™æ¯ä¸€ä¸ªçª—å£åˆ›å»ºä¸€ä¸ª <code>uid</code> ç„¶åæ ¹æ®ä¸åŒçš„ <code>uid</code> è¿›è¡Œäº‹ä»¶è§£ç»‘</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>playground/zbase.js
</span></span><span style="display:flex;"><span>class AcGamePlayground {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    create_uuid() {
</span></span><span style="display:flex;"><span>        let res = &#34;&#34;;
</span></span><span style="display:flex;"><span>        for (let i = 0; i &lt; 8; i ++ ) {
</span></span><span style="display:flex;"><span>            let x = parseInt(Math.floor(Math.random() * 10));   //[0, 10)
</span></span><span style="display:flex;"><span>            res += x;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        return res;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    start() {
</span></span><span style="display:flex;"><span>        let outer = this;
</span></span><span style="display:flex;"><span>        let uuid = this.create_uuid();
</span></span><span style="display:flex;"><span>        $(window).on(`resize.${uuid}`, function() {
</span></span><span style="display:flex;"><span>            outer.resize();
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        if (this.root.AcWingOS) {
</span></span><span style="display:flex;"><span>            outer.root.AcWingOS.api.window.on_close(function() {
</span></span><span style="display:flex;"><span>                $(window).off(`resize.${uuid}`);
</span></span><span style="display:flex;"><span>            });
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="ç¼–å†™æ¯å±€æ¸¸æˆçš„ç»“æŸç•Œé¢">ç¼–å†™æ¯å±€æ¸¸æˆçš„ç»“æŸç•Œé¢<a hidden class="anchor" aria-hidden="true" href="#ç¼–å†™æ¯å±€æ¸¸æˆçš„ç»“æŸç•Œé¢">#</a></h2>
<p>å•ç‹¬åˆ›å»ºä¸€ä¸ªç»“æŸç•Œé¢ï¼Œç„¶åæ¸¸æˆç»“æŸçš„æ—¶å€™æ¸²æŸ“å‡ºè¯¥ç»“æŸç•Œé¢å³å¯</p>
<p>å› ä¸ºç»“æŸç•Œé¢è¦è¦†ç›–åœ¨æ¸¸æˆç•Œé¢ä¹‹ä¸Šï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å…ˆä¿®æ”¹ä¸€ä¸‹æ¸¸æˆå¼•æ“ï¼Œæ·»åŠ ä¸€ä¸ª <code>late_update</code></p>
<p>åœ¨æ¯ä¸€å¸§æ¸²æŸ“çš„å†…å®¹æœ€åå†æ¸²æŸ“ï¼Œä»è€Œå®ç°ç»“æŸç•Œé¢å åŠ åœ¨æ¸¸æˆç•Œé¢ä¹‹ä¸Šçš„æ•ˆæœ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ac_game_object/zbase.js
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>class AcGameObject {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    late_update() { // æ¯ä¸€å¸§å‡ä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œä¸”åœ¨æ‰€æœ‰ update æ‰§è¡Œå®Œåæ‰æ‰§è¡Œ
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>let AC_GAME_ANIMATION = function(timestamp) {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    for (let i = 0; i &lt; AC_GAME_OBJECTS.length; i ++ ) {
</span></span><span style="display:flex;"><span>        let obj = AC_GAME_OBJECTS[i];
</span></span><span style="display:flex;"><span>        obj.late_update();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>ç„¶åæˆ‘ä»¬åšä¸€ä¸ªæ¸²æŸ“å‡ºç»“æŸç•Œé¢çš„ç±»</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>playground/score_board/zbase.js
</span></span><span style="display:flex;"><span>class ScoreBoard extends AcGameObject {
</span></span><span style="display:flex;"><span>    constructor(playground) {
</span></span><span style="display:flex;"><span>        super();
</span></span><span style="display:flex;"><span>        this.playground = playground;
</span></span><span style="display:flex;"><span>        this.ctx = this.playground.game_map.ctx;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        this.state = null;  // win-èƒœåˆ©ï¼›lose-å¤±è´¥
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        this.win_img = new Image();
</span></span><span style="display:flex;"><span>        this.win_img.src = &#34;https://cdn.acwing.com/media/article/image/2021/12/17/1_8f58341a5e-win.png&#34;;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        this.lose_img = new Image();
</span></span><span style="display:flex;"><span>        this.lose_img.src = &#34;https://cdn.acwing.com/media/article/image/2021/12/17/1_9254b5f95e-lose.png&#34;;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    start() {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    add_listening_events() {    // ç‚¹å‡»åï¼Œè¿”å›ä¸»é¡µé¢
</span></span><span style="display:flex;"><span>        let outer = this;
</span></span><span style="display:flex;"><span>        let $canvas = this.playground.game_map.$canvas;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        $canvas.on(&#39;click&#39;, function() {
</span></span><span style="display:flex;"><span>            outer.playground.hide();
</span></span><span style="display:flex;"><span>            outer.playground.root.menu.show();
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    win() {
</span></span><span style="display:flex;"><span>        this.state = &#34;win&#34;;
</span></span><span style="display:flex;"><span>        let outer = this;
</span></span><span style="display:flex;"><span>        setTimeout(function() {
</span></span><span style="display:flex;"><span>            outer.add_listening_events();
</span></span><span style="display:flex;"><span>        }, 1000);   // 1ç§’åç›‘å¬ç‚¹å‡»äº‹ä»¶
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    lose() {
</span></span><span style="display:flex;"><span>        this.state = &#34;lose&#34;;
</span></span><span style="display:flex;"><span>        let outer = this;
</span></span><span style="display:flex;"><span>        setTimeout(function() {
</span></span><span style="display:flex;"><span>            outer.add_listening_events();
</span></span><span style="display:flex;"><span>        }, 1000);   // 1ç§’åç›‘å¬ç‚¹å‡»äº‹ä»¶
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    late_update() {
</span></span><span style="display:flex;"><span>        this.render();  // æ¸²æŸ“åœ¨å›¾å±‚æœ€ä¸Šæ–¹
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    render() {
</span></span><span style="display:flex;"><span>        let len = this.playground.height / 2;
</span></span><span style="display:flex;"><span>        if (this.state === &#34;win&#34;) {
</span></span><span style="display:flex;"><span>            this.ctx.drawImage(this.win_img, this.playground.width / 2 - len / 2, this.playground.height / 2 - len / 2, len, len);
</span></span><span style="display:flex;"><span>        } else if (this.state === &#34;lose&#34;) {
</span></span><span style="display:flex;"><span>            this.ctx.drawImage(this.lose_img, this.playground.width / 2 - len / 2, this.playground.height / 2 - len / 2, len, len);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>é€šè¿‡æ¸¸æˆç»“æŸçš„é€»è¾‘åˆ¤æ–­ï¼Œæ¸²æŸ“ç»“æŸç•Œé¢ï¼ŒåŒæ—¶åœ¨ç»“æŸå¹¶è¿”å›ä¸»èœå•çš„æ—¶å€™ï¼Œé‡ç½®æ¸¸æˆå…ƒç´ </p>
<p>æ¸¸æˆå…ƒç´ é‡ç½®</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>playground/zbase.js
</span></span><span style="display:flex;"><span>class AcGamePlayground {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    show(mode) {    // æ‰“å¼€ playground ç•Œé¢
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        this.score_board = new ScoreBoard(this);
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    hide() {
</span></span><span style="display:flex;"><span>        // æ¸…ç©ºæ‰€æœ‰æ¸¸æˆå…ƒç´ 
</span></span><span style="display:flex;"><span>        while (this.players &amp;&amp; this.players.length &gt; 0) {
</span></span><span style="display:flex;"><span>            this.players[0].destroy();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        if (this.game_map) {
</span></span><span style="display:flex;"><span>            this.game_map.destroy();
</span></span><span style="display:flex;"><span>            this.game_map = null;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        if (this.notice_board) {
</span></span><span style="display:flex;"><span>            this.notice_board.destroy();
</span></span><span style="display:flex;"><span>            this.notice_board = null;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        if (this.score_board) {
</span></span><span style="display:flex;"><span>            this.score_board.destroy();
</span></span><span style="display:flex;"><span>            this.score_board = null;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        this.$playground.empty();   // æ¸…ç©ºæ‰€æœ‰htmlæ ‡ç­¾
</span></span><span style="display:flex;"><span>        this.$playground.hide();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æ¸¸æˆç»“æŸçš„é€»è¾‘åˆ¤æ–­</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>playground/player/zbase.js
</span></span><span style="display:flex;"><span>class Player extends AcGameObject {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    update() {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        this.update_win();
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    update_win() {
</span></span><span style="display:flex;"><span>        // ç«èµ›çŠ¶æ€ï¼Œä¸”åªæœ‰ä¸€åç©å®¶ï¼Œä¸”æ”¹åç©å®¶å°±æ˜¯æˆ‘ï¼Œåˆ™èƒœåˆ©
</span></span><span style="display:flex;"><span>        if (this.playground.state === &#34;fighting&#34; &amp;&amp; this.character === &#34;me&#34; &amp;&amp; this.playground.players.length === 1) {
</span></span><span style="display:flex;"><span>            this.playground.state = &#34;over&#34;;
</span></span><span style="display:flex;"><span>            this.playground.score_board.win();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    on_destroy() {
</span></span><span style="display:flex;"><span>        // æˆ‘æ­»äº¡ï¼Œä¸”æ¸¸æˆå¤„äºç«èµ›çŠ¶æ€ï¼Œåˆ™å¤±è´¥
</span></span><span style="display:flex;"><span>        if (this.character === &#34;me&#34; &amp;&amp; this.playground.state === &#34;fighting&#34;) {
</span></span><span style="display:flex;"><span>            this.playground.state = &#34;over&#34;
</span></span><span style="display:flex;"><span>            this.playground.score_board.lose();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="æ›´æ–°æˆ˜ç»©">æ›´æ–°æˆ˜ç»©<a hidden class="anchor" aria-hidden="true" href="#æ›´æ–°æˆ˜ç»©">#</a></h2>
<p>è¿™é‡Œæˆ‘ä»¬å®Œå…¨äº¤ç»™åç«¯æ¥åˆ¤æ–­</p>
<p>åœ¨å¤„ç†å¹¿æ’­çš„ <code>attack</code> ä¿¡æ¯çš„æ—¶å€™ï¼Œå…ˆå‰æˆ‘ä»¬é¢å¤–ç•™äº†ä¸€ä¸ªå‚æ•° <code>hp</code></p>
<p>å›´ç»•è¯¥ <code>hp</code> è¿›è¡Œç»­å†™ï¼Œè‹¥å½“å‰æˆ¿é—´å†… <code>hp</code> å¤§äº 0 çš„ç©å®¶å°‘äºç­‰äº 1 ä¸ª</p>
<p>åˆ™å¯¹äºæ‰€æœ‰ <code>hp</code> ä¸º 0 çš„ç©å®¶å‡ <code>rank</code> åˆ†ï¼Œå¤§äº 0 çš„ç©å®¶åŠ  <code>rank</code> åˆ†</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>consumers/multiplayer/index.py
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>class MultiPlayer(AsyncWebsocketConsumer):
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    async def attack(self, data):
</span></span><span style="display:flex;"><span>        if not self.room_name:
</span></span><span style="display:flex;"><span>            return
</span></span><span style="display:flex;"><span>        players = cache.get(self.room_name)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        if not players:
</span></span><span style="display:flex;"><span>            return
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        for player in players:
</span></span><span style="display:flex;"><span>            if player[&#39;uuid&#39;] == data[&#39;attackee_uuid&#39;]:
</span></span><span style="display:flex;"><span>                player[&#39;hp&#39;] -= 25
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        remain_cnt = 0
</span></span><span style="display:flex;"><span>        for player in players:
</span></span><span style="display:flex;"><span>            if player[&#39;hp&#39;] &gt; 0:
</span></span><span style="display:flex;"><span>                remain_cnt += 1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        if remain_cnt &gt; 1:  # ç»§ç»­è¿›è¡Œæ¸¸æˆ
</span></span><span style="display:flex;"><span>            if self.room_name:
</span></span><span style="display:flex;"><span>                cache.set(self.room_name, players, 3600)
</span></span><span style="display:flex;"><span>        else:   # ç»“ç®— 
</span></span><span style="display:flex;"><span>            def db_update_player_score(username, score):
</span></span><span style="display:flex;"><span>                player = Player.objects.get(user__username=username)
</span></span><span style="display:flex;"><span>                player.score += score
</span></span><span style="display:flex;"><span>                player.save()
</span></span><span style="display:flex;"><span>            for player in players:
</span></span><span style="display:flex;"><span>                if player[&#39;hp&#39;] &lt;= 0:
</span></span><span style="display:flex;"><span>                    await database_sync_to_async(db_update_player_score)(player[&#39;username&#39;], -5)
</span></span><span style="display:flex;"><span>                else:
</span></span><span style="display:flex;"><span>                    await database_sync_to_async(db_update_player_score)(player[&#39;username&#39;], 10)
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    ...
</span></span></code></pre></div><h2 id="æ·»åŠ faviconico">æ·»åŠ favicon.ico<a hidden class="anchor" aria-hidden="true" href="#æ·»åŠ faviconico">#</a></h2>
<p>è¿™æ˜¯ä¿®æ­£ä¸€ä¸ªå° BUGï¼Œä¹‹å‰ web ç«¯ä¸€ç›´æ²¡æœ‰ç½‘é¡µæ˜¾ç¤ºå›¾æ ‡ï¼Œè¿™é‡Œç»™ä»–åŠ ä¸Šå»</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>game/templates/multiends/web.html
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>&lt;head&gt;
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    &lt;link rel=&#34;icon&#34; href=&#34;https://cdn.acwing.com/media/article/image/2021/12/17/1_be4c11ce5f-acapp.png&#34;&gt;
</span></span><span style="display:flex;"><span>&lt;/head&gt;
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><h1 id="å„ç§ç¯å¢ƒå‘½ä»¤">å„ç§ç¯å¢ƒå‘½ä»¤<a hidden class="anchor" aria-hidden="true" href="#å„ç§ç¯å¢ƒå‘½ä»¤">#</a></h1>
<ol>
<li>å¯åŠ¨<code>django</code>é¡¹ç›®ï¼Œåœ¨<code>~/acapp</code>ç›®å½•ä¸‹æ‰§è¡Œï¼š</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>python3 manage.py runserver 0.0.0.0:8000
</span></span></code></pre></div><ol>
<li>æ¯æ¬¡ä¿®æ”¹å¥½ <code>game/static</code> ä¸‹çš„æ–‡ä»¶åï¼Œéœ€è¦åœ¨<code>~/acapp</code>ç›®å½•ä¸‹è¿è¡Œæ‰“åŒ…æ–‡ä»¶ï¼š</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>./scripts/compress_game_js.sh
</span></span></code></pre></div><ol>
<li>åœ¨å®šä¹‰å®Œä¸€ä¸ªæ•°æ®è¡¨ä¹‹åï¼Œéœ€è¦å°†åˆ›å»ºçš„æ•°æ®è¡¨æ›´æ–°åˆ° <code>django</code> çš„æ•°æ®åº“ä¸­å»ï¼š</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> python3 manage<span style="color:#f92672">.</span>py makemigrations
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> Migrations <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;game&#39;</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;</span>   game<span style="color:#f92672">/</span>migrations<span style="color:#f92672">/</span><span style="color:#ae81ff">0001</span>_initial<span style="color:#f92672">.</span>py
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;</span>     <span style="color:#f92672">-</span> Create model Player
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> 
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> python3 manage<span style="color:#f92672">.</span>py migrate
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> Operations to perform:
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;</span>   Apply all migrations: admin, auth, contenttypes, game, sessions
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> Running migrations:
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;</span>   Applying game<span style="color:#ae81ff">.0001</span>_initial<span style="color:#f92672">...</span> OK
</span></span></code></pre></div><ol>
<li>å¯åŠ¨<code>nginx</code>æœåŠ¡ï¼Œç”¨äºåŸŸåè®¿é—®ï¼š</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>sudo /etc/init.d/nginx start
</span></span></code></pre></div><ol>
<li>å¯åŠ¨<code>uwsgi</code>æœåŠ¡ï¼Œç”¨äºåŸŸåè®¿é—®ï¼š</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>uwsgi --ini scripts/uwsgi.ini
</span></span></code></pre></div><ol>
<li>å…³é—­<code>uwsgi</code>æœåŠ¡ï¼š</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>sudo pkill -f uwsgi -9
</span></span></code></pre></div><ol>
<li>å¯åŠ¨ <code>redis-server</code>ï¼Œç”¨äºä¸€é”®ç™»å½•ï¼š</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>sudo redis-server /etc/redis/redis.conf
</span></span></code></pre></div><ol>
<li>å¯åŠ¨ <code>Django_channels</code>ï¼Œç”¨äºè”æœºå¯¹æˆ˜ï¼Œåœ¨<code>~/acapp</code>ç›®å½•ä¸‹æ‰§è¡Œï¼š</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>daphne -b 0.0.0.0 -p 5015 acapp.asgi:application
</span></span></code></pre></div><ol>
<li>å¯åŠ¨<code>thrift</code>æœåŠ¡ï¼Œç”¨äºåŒ¹é…ç³»ç»Ÿï¼Œåœ¨<code>~/acapp/match_system/src/</code>ç›®å½•ä¸‹æ‰§è¡Œï¼š</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>./main.py
</span></span></code></pre></div><ol>
<li>ç‰ˆæœ¬æ›´æ–°ï¼Œåœ¨<a href="https://www.acwing.com/user/myspace/application/update/2433/">æœ¯å£«ä¹‹æˆ˜</a>ä¸­å°† <code>jsåœ°å€</code> ä¸€æ æ›´æ–°ä¸ºï¼š</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>// æœ¬åœ°æ–‡ä»¶å¤¹ä¸­å¯¹åº”çš„æ–‡ä»¶ä¹Ÿéœ€è¦æ›´æ”¹åå­—
</span></span><span style="display:flex;"><span>https://app2433.acapp.acwing.com.cn/static/js/dist/game-ç‰ˆæœ¬å·.js
</span></span></code></pre></div>

        </div>
        <div class="post-reward">
            <div style="padding: 0 0 0 0; margin: 0 0 0 0; width: 100%; font-size:16px; text-align: center;">
                <div id="QR" style="opacity: 0;">
                    <div id="wechat" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="wechat_qr" src="https://Hugo-Chalnl.github.io/img/wechat_pay.png" alt="wechat_pay"></a>
                        <p>å¾®ä¿¡</p>
                    </div>
                    <div id="alipay" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="alipay_qr" src="https://Hugo-Chalnl.github.io/img/alipay.png" alt="alipay"></a>
                        <p>æ”¯ä»˜å®</p>
                    </div>
                </div>
                <button id="rewardButton"
                        onclick="
                    var qr = document.getElementById('QR');
                    if (qr.style.opacity === '0') {
                        qr.style.opacity='1';
                    } else {
                        qr.style.opacity='0'
                    }"
                >
                    <span>ğŸ§§ é¼“åŠ±</span>
                </button>
            </div>
        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="next" href="https://Hugo-Chalnl.github.io/en/posts/blog/blog/">
    <span class="title">Next Â»</span>
    <br>
    <span>Blog</span>
  </a>
</nav>

        </footer>
    </div>

<style>
    .comments_details summary::marker {
        font-size: 20px;
        content: 'ğŸ‘‰å±•å¼€è¯„è®º';
        color: var(--content);
    }
    .comments_details[open] summary::marker{
        font-size: 20px;
        content: 'ğŸ‘‡å…³é—­è¯„è®º';
        color: var(--content);
    }
</style>


<div>
    <details class="comments_details">
        <summary style="cursor: pointer; margin: 50px 0 20px 0;width: 130px;">
            <span style="font-size: 20px;color: var(--content);">...</span>
        </summary>
        <div id="tcomment"></div>
    </details>
    <script src="https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js">
    </script>
    <script>
        twikoo.init({
            envId:  null ,
        el: "#tcomment",
            lang: 'zh-CN',
            region:  null ,
        path: window.TWIKOO_MAGIC_PATH||window.location.pathname,
        })
    </script>
</div>
</article>
</main>

<footer class="footer">
    <span>
        Copyright
        &copy;
        2023-2023
        <a href="https://Hugo-Chalnl.github.io/en/" style="color:#939393;">Chalnl&#39;s Blog</a>
        All Rights Reserved
    </span>
    <a href="https://beian.miit.gov.cn/" target="_blank" style="color:#939393;">å¡«å†™è‡ªå·±çš„å¤‡æ¡ˆå·</a>&nbsp;
    <span>
        <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null"
           style="display:inline-block;text-decoration:none;height:20px;color:#939393;">
            <img src="%e5%a1%ab%e8%87%aa%e5%b7%b1%e7%9a%84%e5%85%ac%e5%ae%89%e5%9b%be%e6%a0%87%e9%93%be%e6%8e%a5" style="float:left;margin: 0px 5px 0px 0px;"/>
            å¡«è‡ªå·±çš„å…¬ç½‘å®‰å¤‡
        </a>
    </span>
    <span id="busuanzi_container">
        <span class="fa fa-user"></span> <span id="busuanzi_value_site_uv"></span>
        <span class="fa fa-eye"></span> <span id="busuanzi_value_site_pv"></span>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });
</script>
<script>
    let mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        (function() {
            document.cookie = "change-themes" + "="+ escape ("false");
        })()

        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    });
</script>

<script>
    document.body.addEventListener('copy', function (e) {
        if (window.getSelection().toString() && window.getSelection().toString().length > 50) {
            let clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                e.preventDefault();
                let htmlData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"Chalnl's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                let textData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"Chalnl's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                clipboardData.setData('text/html', htmlData);
                clipboardData.setData('text/plain', textData);
            }
        }
    });
</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;
        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'copy';

        function copyingDone() {
            copybutton.innerText = 'copied!';
            setTimeout(() => {
                copybutton.innerText = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                let text = codeblock.textContent +
                    '\r\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"Chalnl's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                navigator.clipboard.writeText(text);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {}
            selection.removeRange(range);
        });

        let language = codeblock.className.replaceAll("language-", "")
        let macTool = document.createElement("div")
        let macTool1 = document.createElement("div")
        let macTool2 = document.createElement("div")
        let macTool3 = document.createElement("div")
        let languageType = document.createElement("div")
        languageType.innerText = language
        macTool.setAttribute('class', 'mac-tool')
        macTool1.setAttribute('class', 'mac bb1')
        macTool2.setAttribute('class', 'mac bb2')
        macTool3.setAttribute('class', 'mac bb3')
        languageType.setAttribute('class', 'language-type')
        macTool.appendChild(macTool1)
        macTool.appendChild(macTool2)
        macTool.appendChild(macTool3)
        macTool.appendChild(languageType)

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
            container.appendChild(macTool)
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        }
    });
</script>
</body>

</html>
